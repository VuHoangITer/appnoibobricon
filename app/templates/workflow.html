{% extends "base.html" %}

{% block title %}Lu·ªìng Giao Vi·ªác{% endblock %}
{% block page_title %}Ma Tr·∫≠n Lu·ªìng Giao Vi·ªác{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   WORKFLOW MATRIX VIEW
   ============================================ */
.workflow-container {
    background: #ffffff;
    border-radius: 8px;
    padding: 30px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow-x: auto;
}

.workflow-matrix {
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

/* Header cells */
.workflow-matrix thead th {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
}

.workflow-matrix thead th:first-child {
    background: #ffffff;
    border: none;
    position: sticky;
    left: 0;
    z-index: 11;
}

/* Top label row */
.workflow-matrix thead tr.label-row th {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 16px;
    font-size: 15px;
    font-weight: 700;
    color: #495057;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Corner cell - ng∆∞·ªùi giao vi·ªác */
.workflow-matrix thead tr.label-row th:first-child {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    text-align: center;
    position: sticky;
    left: 0;
    z-index: 11;
    font-size: 15px;
}

/* Row header (ng∆∞·ªùi giao) */
.workflow-matrix tbody th {
    background: #fff5f5;
    border: 1px solid #dee2e6;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
    position: sticky;
    left: 0;
    z-index: 5;
}

/* Group by role colors for rows */
.workflow-matrix tbody tr[data-role="director"] th {
    background: #ffe5e5;
    border-left: 4px solid #e74c3c;
}

.workflow-matrix tbody tr[data-role="manager"] th {
    background: #e3f2fd;
    border-left: 4px solid #3498db;
}

.workflow-matrix tbody tr[data-role="accountant"] th {
    background: #fff3e0;
    border-left: 4px solid #f39c12;
}

.workflow-matrix tbody tr[data-role="hr"] th {
    background: #e8f5e9;
    border-left: 4px solid #2ecc71;
}

/* Data cells */
.workflow-matrix tbody td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: center;
    background: #ffffff;
    min-width: 80px;
    transition: all 0.2s ease;
}

/* Role badges trong header */
.role-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 6px;
}

.role-badge.director {
    background: #e74c3c;
    color: #ffffff;
}

.role-badge.manager {
    background: #3498db;
    color: #ffffff;
}

.role-badge.accountant {
    background: #f39c12;
    color: #ffffff;
}

.role-badge.hr {
    background: #2ecc71;
    color: #ffffff;
}

/* Task count button - HEAT MAP */
.task-count {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    border: 2px solid transparent;
}

/* Heat map colors based on task count */
.task-count.has-tasks.level-1 {
    background: #f1f3f5;
    color: #495057;
    border-color: #dee2e6;
}

.task-count.has-tasks.level-2 {
    background: #d3d3d3;
    color: #212529;
    border-color: #adb5bd;
}

.task-count.has-tasks.level-3 {
    background: #a8a8a8;
    color: #212529;
    border-color: #6c757d;
}

.task-count.has-tasks.level-4 {
    background: #6c757d;
    color: #ffffff;
    border-color: #495057;
}

.task-count.has-tasks.level-5 {
    background: #495057;
    color: #ffffff;
    border-color: #212529;
}

.task-count.has-tasks:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    border-color: #212529;
}

.task-count.no-tasks {
    background: transparent;
    color: #dee2e6;
    cursor: default;
    font-size: 14px;
    border: none;
}

.task-count.locked {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
    border-color: #dee2e6;
}

.task-count.locked::before {
    content: "üîí ";
}

/* Hover effects */
.workflow-matrix tbody tr:hover th {
    background-color: #ffc107 !important;
    color: #000;
}

.workflow-matrix tbody td:hover {
    background: #fff9e6 !important;
    outline: 2px solid #ffc107;
}

/* Highlight row and column */
.workflow-matrix tbody tr.highlight-row th {
    background-color: #fff3cd !important;
}

.workflow-matrix tbody td.highlight-col {
    background-color: #e7f3ff !important;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.empty-state i {
    font-size: 48px;
    color: #dee2e6;
    margin-bottom: 16px;
}

/* Info box */
.info-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
}

.info-box h5 {
    color: #495057;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
}

.info-box ul {
    color: #6c757d;
    margin-bottom: 0;
    padding-left: 20px;
}

.info-box li {
    margin-bottom: 6px;
    line-height: 1.6;
}

.info-box li:last-child {
    margin-bottom: 0;
}

/* Legend */
.workflow-legend {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 24px;
}

.workflow-legend h5 {
    color: #495057;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    color: #6c757d;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-color {
    width: 50px;
    height: 32px;
    border-radius: 4px;
    border: 2px solid #dee2e6;
    flex-shrink: 0;
}

.legend-item span {
    font-size: 14px;
    line-height: 1.5;
}

/* Stats summary */
.stats-summary {
    display: flex;
    gap: 20px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.stat-card {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px 24px;
    flex: 1;
    min-width: 200px;
}

.stat-card h6 {
    color: #6c757d;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 8px;
}

.stat-card .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #495057;
}

/* Responsive */
@media (max-width: 768px) {
    .workflow-container {
        padding: 15px;
    }

    .workflow-matrix thead th,
    .workflow-matrix tbody th,
    .workflow-matrix tbody td {
        padding: 8px 4px;
        font-size: 12px;
    }

    .task-count {
        padding: 6px 12px;
        font-size: 14px;
    }

    .role-badge {
        display: block;
        margin-left: 0;
        margin-top: 4px;
    }
}
    /* Task c·∫ßn ƒë√°nh gi√° - m√†u v√†ng */
.task-count.needs-rating {
    background: #fff3cd !important;
    color: #856404 !important;
    border-color: #ffc107 !important;
}

.task-count.needs-rating::after {
    content: " ‚≠ê";
    font-size: 10px;
}
</style>
{% endblock %}

{% block content %}
<!-- Stats Summary -->
<div class="stats-summary">
    <div class="stat-card">
        <h6>T·ªïng C√¥ng Vi·ªác</h6>
        <div class="stat-value">{{ total_tasks }}</div>
    </div>
    <div class="stat-card">
        <h6>S·ªë Lu·ªìng ƒêang Ho·∫°t ƒê·ªông</h6>
        <div class="stat-value">{{ active_connections }}</div>
    </div>
    <div class="stat-card">
        <h6>T·ªïng S·ªë Ng∆∞·ªùi</h6>
        <div class="stat-value">{{ total_users }}</div>
    </div>
</div>

<!-- Info Box -->
<div class="row mb-4">
    <div class="col-12">
        <div class="info-box">
            <h5><i class="bi bi-info-circle"></i> H∆∞·ªõng d·∫´n ƒë·ªçc ma tr·∫≠n</h5>
            <ul>
                <li><strong>H√†ng b√™n tr√°i:</strong> Ng∆∞·ªùi giao vi·ªác</li>
                <li><strong>C·ªôt ph√≠a tr√™n:</strong> Ng∆∞·ªùi nh·∫≠n vi·ªác</li>
                <li><strong>√î giao nhau:</strong> S·ªë c√¥ng vi·ªác ƒë∆∞·ª£c giao</li>
                <li><strong>M√†u s·∫Øc:</strong> C√†ng ƒë·∫≠m = C√†ng nhi·ªÅu vi·ªác</li>
                <li><strong>Click v√†o s·ªë:</strong> Xem chi ti·∫øt c√¥ng vi·ªác</li>
            </ul>
        </div>
    </div>
</div>

<!-- Matrix Table -->
<div class="workflow-container">
    {% if all_users|length > 0 %}
    <table class="workflow-matrix">
        <thead>
            <!-- Label row -->
            <tr class="label-row">
                <th>NG∆Ø·ªúI GIAO VI·ªÜC</th>
                <th colspan="{{ all_users|length }}">NG∆Ø·ªúI NH·∫¨N VI·ªÜC</th>
            </tr>
            <!-- Name row -->
            <tr>
                <th style="background: #f8f9fa; border: 1px solid #dee2e6; color: #495057; font-size: 12px; font-weight: 600;">
                    T√™n v√† Ch·ª©c v·ª•
                </th>
                {% for to_user in all_users %}
                <th>
                    <div>{{ to_user.full_name }}</div>
                    <span class="role-badge {{ to_user.role }}">{{ role_names[to_user.role] }}</span>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for from_user in all_users %}
            <tr data-role="{{ from_user.role }}">
                <th>
                    <div>{{ from_user.full_name }}</div>
                    <span class="role-badge {{ from_user.role }}">{{ role_names[from_user.role] }}</span>
                </th>
{% for to_user in all_users %}
<td>
    {% if from_user.id == to_user.id %}
        <span class="task-count no-tasks">‚Äî</span>
    {% else %}
        {% set key = from_user.id|string ~ '->' ~ to_user.id|string %}
        {% if key in workflow_data %}
            {% set conn = workflow_data[key] %}
            {% if conn.can_view %}
                {% set level = 'level-1' %}
                {% if conn.count >= 20 %}
                    {% set level = 'level-5' %}
                {% elif conn.count >= 15 %}
                    {% set level = 'level-4' %}
                {% elif conn.count >= 10 %}
                    {% set level = 'level-3' %}
                {% elif conn.count >= 5 %}
                    {% set level = 'level-2' %}
                {% endif %}

                {# ===== S·ª¨A: Th√™m class needs-rating n·∫øu c√≥ tasks c·∫ßn ƒë√°nh gi√° ===== #}
                {% set extra_class = '' %}
                {% if conn.needs_rating > 0 %}
                    {% set extra_class = 'needs-rating' %}
                {% endif %}

                <a href="/workflow/{{ from_user.id }}/{{ to_user.id }}"
                   class="task-count has-tasks {{ level }} {{ extra_class }}"
                   title="{% if conn.active > 0 %}ƒêang giao: {{ conn.active }}{% endif %}{% if conn.active > 0 and conn.needs_rating > 0 %} | {% endif %}{% if conn.needs_rating > 0 %}C·∫ßn ƒë√°nh gi√°: {{ conn.needs_rating }}{% endif %}">
                    {{ conn.count }}
                </a>
            {% else %}
                <span class="task-count locked"
                      title="B·∫°n kh√¥ng c√≥ quy·ªÅn xem">
                    {{ conn.count }}
                </span>
            {% endif %}
        {% else %}
            <span class="task-count no-tasks">0</span>
        {% endif %}
    {% endif %}
</td>
{% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h5>Ch∆∞a c√≥ d·ªØ li·ªáu</h5>
        <p>Ch∆∞a c√≥ ng∆∞·ªùi d√πng ho·∫∑c c√¥ng vi·ªác n√†o trong h·ªá th·ªëng.</p>
    </div>
    {% endif %}
</div>

<!-- Legend -->
<div class="row mt-4">
    <div class="col-md-8 offset-md-2">
        <div class="workflow-legend">
            <h5><i class="bi bi-palette"></i> Ch√∫ th√≠ch vai tr√≤</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span><strong>Gi√°m ƒê·ªëc:</strong> Xem t·∫•t c·∫£</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span><strong>Tr∆∞·ªüng Ph√≤ng:</strong> Xem c·ªßa h·ªç</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span><strong>K·∫ø To√°n:</strong> Xem c·ªßa h·ªç</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2ecc71;"></div>
                        <span><strong>Nh√¢n Vi√™n:</strong> Xem c·ªßa h·ªç</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Th√™m tooltip cho c√°c √¥
document.addEventListener('DOMContentLoaded', function() {
    // Highlight row v√† column khi hover
    const cells = document.querySelectorAll('.workflow-matrix tbody td');

    cells.forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            const row = this.parentElement;
            const colIndex = Array.from(row.children).indexOf(this);

            // Highlight row
            row.classList.add('highlight-row');

            // Highlight column
            const rows = document.querySelectorAll('.workflow-matrix tbody tr');
            rows.forEach(r => {
                const cell = r.children[colIndex];
                if (cell) {
                    cell.classList.add('highlight-col');
                }
            });
        });

        cell.addEventListener('mouseleave', function() {
            document.querySelectorAll('.highlight-row, .highlight-col').forEach(el => {
                el.classList.remove('highlight-row', 'highlight-col');
            });
        });
    });
});
</script>
{% endblock %}