{% extends "base.html" %}

{% block title %}Thông báo{% endblock %}
{% block page_title %}Thông báo{% endblock %}

{% block extra_css %}
<style>
:root {
    --notif-bg: #f5f7fb;
    --notif-card-bg: #ffffff;
    --notif-border: #e5e7eb;
    --notif-text: #111827;
    --notif-muted: #6b7280;
    --notif-accent: #0d6efd;
    --notif-danger: #ef4444;
}

body {
    background: var(--notif-bg);
}

/* Card chính tối giản */
.card {
    border-radius: 14px;
    border: 1px solid var(--notif-border);
    box-shadow: none;
    background: var(--notif-card-bg);
}

/* Header trang */
.d-flex.justify-content-between.align-items-center.mb-4 {
    gap: 0.75rem;
}

.d-flex.justify-content-between.align-items-center.mb-4 h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--notif-text);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.d-flex.justify-content-between.align-items-center.mb-4 h2 .badge {
    font-size: 0.7rem;
    border-radius: 999px;
    font-weight: 500;
}

/* Animation cho item bị xóa */
@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(6px);
    }
}

.notification-removing {
    animation: fadeOut 0.25s ease-out forwards;
}

/* Toast notification tối giản */
.toast-notification {
    position: fixed;
    top: 18px;
    right: 18px;
    z-index: 9999;
    min-width: 260px;
    border-radius: 999px;
    padding: 0.5rem 0.9rem;
    box-shadow: 0 8px 30px rgba(15, 23, 42, 0.16);
    font-size: 0.875rem;
}

/* Button action mềm, không quá “nổi” */
.btn-action {
    border-radius: 999px !important;
    padding-inline: 0.65rem;
    padding-block: 0.35rem;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: background-color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
}

.btn-action i {
    font-size: 0.9rem;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(15, 23, 42, 0.12);
}

.btn-info.btn-action {
    background: #e0f2fe;
    border-color: transparent;
    color: #0369a1;
}

.btn-secondary.btn-action {
    background: #f3f4f6;
    border-color: transparent;
    color: #374151;
}

.btn-danger.btn-action {
    background: #fee2e2;
    border-color: transparent;
    color: #b91c1c;
}

/* Dropdown menu tinh gọn */
.dropdown-menu {
    border-radius: 10px;
    border: 1px solid var(--notif-border);
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
    font-size: 0.875rem;
}

/* Danh sách thông báo: dạng thẻ, có khoảng cách */
#notifications-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* Item thông báo – tối giản */
.list-group-item {
    border-radius: 12px !important;
    border: 1px solid var(--notif-border);
    margin-bottom: 0;
    padding: 0.7rem 0.9rem;
    background-color: #ffffff;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background-color 0.12s ease;
}

/* Gỡ style default của Bootstrap cho .list-group */
.list-group {
    border-radius: 0;
}

/* Trạng thái UNREAD – chỉ nhấn bằng border + chấm nhỏ, không tô nền đậm */
.list-group-item-primary {
    background-color:#86b7fe4d;
    color: var(--notif-text);
    border-color: rgba(13, 110, 253, 0.5);
    box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.1);
}

/* Hover tinh tế */
.list-group-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    border-color: rgba(148, 163, 184, 0.8);
}

/* Tiêu đề thông báo */
.list-group-item h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: var(--notif-text);
}

/* Nội dung thông báo */
.list-group-item p {
    font-size: 0.85rem;
    margin-bottom: 0.3rem;
    color: var(--notif-muted);
}

/* Thời gian */
.list-group-item small {
    font-size: 0.75rem;
    color: var(--notif-muted);
}

/* Nhóm nút bên phải */
.list-group-item .d-flex.gap-2.ms-3.flex-wrap {
    gap: 0.35rem !important;
}

/* Nút nhỏ trong item */
.list-group-item .btn-sm {
    border-radius: 999px;
    padding-inline: 0.45rem;
    padding-block: 0.25rem;
}

/* Nút “đánh dấu đã đọc” */
.list-group-item .btn-outline-success {
    border-color: rgba(16, 185, 129, 0.35);
    color: #059669;
}

.list-group-item .btn-outline-success:hover {
    background: #ecfdf5;
    border-color: #059669;
}

/* Nút xóa */
.list-group-item .btn-danger {
    background-color: #fee2e2;
    border-color: transparent;
    color: #b91c1c;
}

.list-group-item .btn-danger:hover {
    background-color: #fecaca;
}

/* Icon chấm tròn unread nhỏ gọn */
.list-group-item .bi-circle-fill {
    color: var(--notif-accent) !important;
    margin-right: 0.25rem;
}

/* Empty state */
#no-notifications-msg {
    font-size: 0.9rem;
    color: var(--notif-muted);
}
/* ---------- RESPONSIVE CHO MOBILE ---------- */
@media (max-width: 767.98px) {
    /* Header: trái = tiêu đề, phải = cụm nút */
    .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: row;
        align-items: center !important;
        flex-wrap: nowrap;
        gap: 0.5rem;
    }

    .d-flex.justify-content-between.align-items-center.mb-4 h2 {
        flex: 1 1 auto;
        min-width: 0;
        font-size: 1.05rem;
    }

    .d-flex.justify-content-between.align-items-center.mb-4 > .d-flex.gap-2 {
        flex: 0 0 auto;
        width: auto;
        margin-left: auto;
        justify-content: flex-end;
        flex-wrap: nowrap;
    }

    .btn-action {
        flex: 0 0 auto;
        font-size: 0.75rem;
        padding-inline: 0.45rem;
        padding-block: 0.3rem;
    }

    .card {
        border-radius: 10px;
    }

    .card-body {
        padding: 0.9rem 0.8rem;
    }

    /* --- QUAN TRỌNG: giữ layout 2 cột cho card thông báo --- */
    .list-group-item .d-flex.w-100.justify-content-between.align-items-start {
        flex-direction: row;          /* KHÔNG cho column nữa */
        align-items: flex-start;
        gap: 0.5rem;
    }

    .list-group-item .d-flex.gap-2.ms-3.flex-wrap {
        margin-left: 0.5rem !important;
        width: auto;                  /* không full width */
        justify-content: flex-end;
        align-items: flex-start;
    }

    .list-group-item {
        padding: 0.7rem 0.8rem;
    }

    .list-group-item h6 {
        font-size: 0.9rem;
    }

    .list-group-item p {
        font-size: 0.82rem;
    }

    .toast-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        border-radius: 12px;
    }
}

/* Extra nhỏ (<= 480px) – chỉ tinh chỉnh nhẹ kích thước nút */
@media (max-width: 480px) {
    .btn-action {
        flex: 0 0 auto;
        font-size: 0.7rem;
        padding-inline: 0.4rem;
        padding-block: 0.25rem;
    }

    .list-group-item .d-flex.gap-2.ms-3.flex-wrap {
        justify-content: flex-start;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- ===== TASK HEADER ===== -->
<div class="task-header-container">
    {% include 'components/task_header.html' %}
</div>
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h2>
        <i class="bi bi-bell"></i> Thông báo
        <span class="badge bg-primary ms-2" id="total-count">{{ notifications|length }}</span>
        <span class="badge bg-danger ms-1" id="unread-badge">
            {{ notifications|selectattr('read', 'equalto', False)|list|length }}
        </span>
    </h2>

    <div class="d-flex gap-2">
        <!-- Nút làm mới -->
        <button type="button" class="btn btn-sm btn-info btn-action" onclick="window.location.reload()" title="Tải lại trang để xem thông báo mới">
            <i class="bi bi-arrow-clockwise"></i>
        </button>

        <!-- Đánh dấu tất cả đã đọc -->
        <button type="button" class="btn btn-sm btn-secondary btn-action" id="mark-all-read-btn">
            <i class="bi bi-check-all"></i>Đã đọc tất cả
        </button>

        <!-- Xóa dropdown -->
        <div class="dropdown">
            <button class="btn btn-sm btn-danger dropdown-toggle btn-action" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-trash"></i>Xóa
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <button class="dropdown-item" id="delete-read-btn">
                        <i class="bi bi-check-circle"></i> Xóa đã đọc
                    </button>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <button class="dropdown-item text-danger" id="delete-all-btn">
                        <i class="bi bi-trash-fill"></i> Xóa tất cả
                    </button>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-body">
        {% if notifications %}
        <div class="list-group" id="notifications-list">
            {% for notif in notifications %}
            <div class="list-group-item {% if not notif.read %}list-group-item-primary{% endif %}"
                 data-notif-id="{{ notif.id }}"
                 data-read="{{ notif.read|lower }}"
                 {% if notif.link %}data-link="{{ notif.link }}"{% endif %}>
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            {% if not notif.read %}
                            <i class="bi bi-circle-fill text-primary" style="font-size: 0.5rem;"></i>
                            {% endif %}
                            {{ notif.title }}
                        </h6>
                        <p class="mb-1">{{ notif.body }}</p>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> {{ notif.created_at | vn_datetime }}
                        </small>
                    </div>

                    <div class="d-flex gap-2 ms-3 flex-wrap">
                        <!-- Nút đánh dấu đã đọc (chỉ hiện khi chưa đọc) -->
                        {% if not notif.read %}
                        <button type="button"
                                class="btn btn-sm btn-outline-success mark-read-btn"
                                data-notif-id="{{ notif.id }}"
                                title="Đánh dấu đã đọc">
                            <i class="bi bi-check"></i>
                        </button>
                        {% endif %}

                        <!-- Nút xóa -->
                        <button type="button"
                                class="btn btn-sm btn-danger delete-btn"
                                data-notif-id="{{ notif.id }}"
                                title="Xóa">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-muted mb-0" id="no-notifications-msg">
            <i class="bi bi-bell-slash" style="font-size: 3rem; opacity: 0.3;"></i><br>
            Bạn không có thông báo nào.
        </p>
        {% endif %}
    </div>
</div>

<script>
(function() {
    'use strict';

    const CSRF_TOKEN = '{{ csrf_token() }}';

    // Toast notification helper
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast-notification alert alert-${type} alert-dismissible fade show`;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Update badge counts
    function updateCounts(unreadCount, totalCount = null) {
        const unreadBadge = document.getElementById('unread-badge');
        const totalBadge = document.getElementById('total-count');

        if (unreadBadge) {
            unreadBadge.textContent = `${unreadCount}`;
            unreadBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
        }

        if (totalCount !== null && totalBadge) {
            totalBadge.textContent = `${totalCount}`;
        }

        // Cập nhật badge ở topbar và sidebar
        const topbarBadge = document.getElementById('notif-count');
        const sidebarBadge = document.getElementById('sidebar-notif-count');

        if (topbarBadge) {
            if (unreadCount > 0) {
                topbarBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                topbarBadge.style.display = 'inline-block';
            } else {
                topbarBadge.style.display = 'none';
            }
        }

        if (sidebarBadge) {
            if (unreadCount > 0) {
                sidebarBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                sidebarBadge.style.display = 'inline-block';
            } else {
                sidebarBadge.style.display = 'none';
            }
        }
    }

    // Check if any notifications left
    function checkEmptyState() {
        const list = document.getElementById('notifications-list');
        const items = list ? list.querySelectorAll('[data-notif-id]') : [];

        if (items.length === 0) {
            if (list) list.remove();

            const cardBody = document.querySelector('.card-body');
            if (!document.getElementById('no-notifications-msg')) {
                cardBody.innerHTML = `
                    <p class="text-center text-muted mb-0" id="no-notifications-msg">
                        <i class="bi bi-bell-slash" style="font-size: 3rem; opacity: 0.3;"></i><br>
                        Bạn không có thông báo nào.
                    </p>
                `;
            }
        }
    }

    // Mark single notification as read
    document.addEventListener('click', async function(e) {
        const btn = e.target.closest('.mark-read-btn');
        if (!btn) return;

        const notifId = btn.getAttribute('data-notif-id');
        const notifItem = document.querySelector(`[data-notif-id="${notifId}"]`);

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

        try {
            const response = await fetch(`/notifications/${notifId}/mark-read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `csrf_token=${CSRF_TOKEN}`
            });

            const data = await response.json();

            if (data.success) {
                notifItem.classList.remove('list-group-item-primary');
                notifItem.setAttribute('data-read', 'true');

                const dot = notifItem.querySelector('.bi-circle-fill');
                if (dot) dot.remove();

                btn.remove();

                updateCounts(data.unread_count);

                showToast('Đã đánh dấu đã đọc', 'success');
            } else {
                throw new Error(data.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Không thể đánh dấu đã đọc', 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check"></i>';
        }
    });

    // Delete single notification
    document.addEventListener('click', async function(e) {
        const btn = e.target.closest('.delete-btn');
        if (!btn) return;

        if (!confirm('Bạn có chắc muốn xóa thông báo này?')) return;

        const notifId = btn.getAttribute('data-notif-id');
        const notifItem = document.querySelector(`[data-notif-id="${notifId}"]`);

        btn.disabled = true;

        try {
            const response = await fetch(`/notifications/${notifId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `csrf_token=${CSRF_TOKEN}`
            });

            const data = await response.json();

            if (data.success) {
                notifItem.classList.add('notification-removing');
                setTimeout(() => {
                    notifItem.remove();
                    updateCounts(data.unread_count, data.total_count);
                    checkEmptyState();
                    showToast('Đã xóa thông báo', 'success');
                }, 300);
            } else {
                throw new Error(data.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Không thể xóa thông báo', 'danger');
            btn.disabled = false;
        }
    });

    // Mark all as read
    document.getElementById('mark-all-read-btn')?.addEventListener('click', async function() {
        const unreadItems = document.querySelectorAll('[data-read="false"]');
        if (unreadItems.length === 0) {
            showToast('Không có thông báo chưa đọc', 'info');
            return;
        }

        this.disabled = true;
        const originalHtml = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

        try {
            const response = await fetch('/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `csrf_token=${CSRF_TOKEN}`
            });

            const data = await response.json();

            if (data.success) {
                unreadItems.forEach(item => {
                    item.classList.remove('list-group-item-primary');
                    item.setAttribute('data-read', 'true');

                    const dot = item.querySelector('.bi-circle-fill');
                    if (dot) dot.remove();

                    const markBtn = item.querySelector('.mark-read-btn');
                    if (markBtn) markBtn.remove();
                });

                updateCounts(0);
                showToast(`Đã đánh dấu ${unreadItems.length} thông báo đã đọc`, 'success');
            } else {
                throw new Error(data.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Không thể đánh dấu tất cả đã đọc', 'danger');
        } finally {
            this.disabled = false;
            this.innerHTML = originalHtml;
        }
    });

    // Delete read notifications
    document.getElementById('delete-read-btn')?.addEventListener('click', async function() {
        const readItems = document.querySelectorAll('[data-read="true"]');
        if (readItems.length === 0) {
            showToast('Không có thông báo đã đọc để xóa', 'info');
            return;
        }

        if (!confirm(`Xóa ${readItems.length} thông báo đã đọc?`)) return;

        try {
            const response = await fetch('/notifications/delete-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `csrf_token=${CSRF_TOKEN}&type=read`
            });

            const data = await response.json();

            if (data.success) {
                readItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('notification-removing');
                        setTimeout(() => {
                            item.remove();
                            if (index === readItems.length - 1) {
                                updateCounts(data.unread_count, data.total_count);
                                checkEmptyState();
                                showToast(`Đã xóa ${data.deleted_count} thông báo`, 'success');
                            }
                        }, 300);
                    }, index * 50);
                });
            } else {
                throw new Error(data.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Không thể xóa thông báo', 'danger');
        }
    });

    // Delete all notifications
    document.getElementById('delete-all-btn')?.addEventListener('click', async function() {
        const allItems = document.querySelectorAll('[data-notif-id]');
        if (allItems.length === 0) return;

        if (!confirm(`Xóa tất cả ${allItems.length} thông báo?`)) return;

        try {
            const response = await fetch('/notifications/delete-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `csrf_token=${CSRF_TOKEN}&type=all`
            });

            const data = await response.json();

            if (data.success) {
                allItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('notification-removing');
                        setTimeout(() => {
                            item.remove();
                            if (index === allItems.length - 1) {
                                updateCounts(0, 0);
                                checkEmptyState();
                                showToast(`Đã xóa ${data.deleted_count} thông báo`, 'success');
                            }
                        }, 300);
                    }, index * 50);
                });
            } else {
                throw new Error(data.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Không thể xóa thông báo', 'danger');
        }
    });

    // Initialize badge visibility
    const unreadCount = document.querySelectorAll('[data-read="false"]').length;
    updateCounts(unreadCount);

})();
    // Click vào cả item để mở link
document.addEventListener("click", function (e) {
    const item = e.target.closest(".list-group-item");
    if (!item) return;

    // Nếu click trúng nút (đọc, xóa) thì không mở link
    if (e.target.closest("button")) return;

    const link = item.getAttribute("data-link");
    if (link) {
        window.location.href = link;
    }
});
</script>
{% endblock %}