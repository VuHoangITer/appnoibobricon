{% extends "base.html" %}

{% block title %}{{ priority_icon }} {{ priority_type }}{% endblock %}
{% block page_title %}{{ priority_icon }} {{ priority_type }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --ed-bg: #f5f7fb;
    --ed-card-bg: #ffffff;
    --ed-border: #e1e5ee;
    --ed-muted: #6c757d;
    --ed-text: #1f2933;
    --ed-primary: #0d6efd;
    --ed-primary-soft: #e7f1ff;
    --ed-success: #198754;
    --ed-success-soft: #e8f5e9;
    --ed-danger: #dc3545;
    --ed-danger-soft: #ffebee;
    --ed-info-soft: #e3f2fd;
    --ed-radius-lg: 12px;
    --ed-radius-md: 8px;
    --ed-radius-pill: 999px;
}

/* Priority Header – giống layout hình PC & dùng chung cho mobile */
.priority-header {
    background: #ffffff;
    border-radius: var(--ed-radius-lg);
    border: 1px solid var(--ed-border);
    padding: 12px 18px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
}

/* Cột trái: trạng thái chính */
.priority-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    white-space: nowrap;
}

.priority-status-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

/* HOÀN THÀNH – xanh lá */
.priority-status-box.status-box-done {
    border: 2px solid #22c55e;
    background: rgba(34, 197, 94, 0.08);
    color: #22c55e;
}

/* KHẨN CẤP – đỏ */
.priority-status-box.status-box-urgent {
    border: 2px solid #dc3545;
    background: rgba(220, 53, 69, 0.08);
    color: #dc3545;
}

/* QUAN TRỌNG – vàng */
.priority-status-box.status-box-important {
    border: 2px solid #eab308; /* hoặc #ffc107 */
    background: rgba(234, 179, 8, 0.08);
    color: #eab308;
}

/* LẶP LẠI – xanh dương */
.priority-status-box.status-box-recurring {
    border: 2px solid #0d6efd;
    background: rgba(13, 110, 253, 0.08);
    color: #0d6efd;
}

.priority-status-text {
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
}

/* Hoàn thành – xanh lá */
.priority-status-text.status-done {
    color: #22c55e;
}

/* Khẩn cấp – đỏ */
.priority-status-text.status-urgent {
    color: #dc3545;
}

/* Quan trọng – vàng */
.priority-status-text.status-important {
    color: #eab308; /* hoặc #ffc107 nếu anh thích vàng tươi hơn */
}

/* Lặp lại – xanh dương */
.priority-status-text.status-recurring {
    color: #0d6efd;
}

/* Cột giữa: icon Tốt / Chưa tốt */
.priority-header-center {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

/* Reset kiểu button */
.rating-icon {
    border: none;
    padding: 0;
    background: transparent;
    cursor: pointer;
}

/* Hình tròn gradient */
.rating-icon-circle {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.rating-icon-circle i {
    font-size: 1.2rem;
    color: #ffffff;
}

.rating-icon-circle.good {
    background: radial-gradient(circle at 30% 20%, #bbffd1, #22c55e);
}

.rating-icon-circle.bad {
    background: radial-gradient(circle at 30% 20%, #ffd0d0, #f97373);
}

.rating-icon-circle.active {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
}

/* Cột phải: ĐÚNG HẠN / QUÁ HẠN */
.priority-header-right {
    flex: 1 1 auto;
    display: flex;
    justify-content: flex-end;
    min-width: 0;
}

.priority-stats {
    display: flex;
    align-items: flex-end;
    gap: 40px;
}

.priority-stat-item {
    text-align: center;
    cursor: pointer;
}

.priority-stat-label-top {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    margin-bottom: 4px;
}

.priority-stat-label-top.on-time {
    color: #16a34a;
}

.priority-stat-label-top.overdue {
    color: #ef4444;
}

.priority-stat-number-big {
    font-size: 2.4rem;
    font-weight: 800;
    line-height: 1;
    color: #22c55e;
}

.priority-stat-number-big.overdue {
    color: #dc2626;
}

.priority-stat-item.active .priority-stat-number-big {
    transform: scale(1.05);
    text-shadow: 0 0 16px rgba(37, 99, 235, 0.25);
}

/* ====== Responsive: MOBILE - LAYOUT DỌC ====== */
@media (max-width: 768px) {
    .priority-header {
        padding: 12px 14px;
        gap: 12px;
        /* Chuyển sang layout dọc */
        flex-direction: column;
        align-items: stretch;
    }

    /* Dòng 1: HOÀN THÀNH - Căn giữa */
    .priority-header-left {
        justify-content: center;
    }

    .priority-status-text {
        font-size: 1.9rem;
        letter-spacing: 0.06em;
    }

    .priority-status-box {
        width: 18px;
        height: 18px;
        font-size: 0.8rem;
    }

    /* Dòng 2: 2 icon rating - Căn giữa */
    .priority-header-center {
        justify-content: center;
        gap: 20px;
    }

    .rating-icon-circle {
        width: 32px;
        height: 32px;
    }

    .rating-icon-circle i {
        font-size: 1.1rem;
    }

    /* Dòng 3: Đúng hạn / Quá hạn - Căn giữa */
    .priority-header-right {
        justify-content: center;
    }

    .priority-stats {
        gap: 30px;
    }

    .priority-stat-number-big {
        font-size: 1.8rem;
    }

    .priority-stat-label-top {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
    }
}


/* Floating Create Task Button */
.create-task-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: var(--ed-primary);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 0;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
}

.create-task-btn i {
    font-size: 1.6rem;
    margin: 0;
    line-height: 1;
}

/* Task Cards Container */
.task-cards-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

/* Task Card */
.task-card {
    border: 1px solid var(--ed-border);
    border-radius: 24px;
    background: var(--ed-card-bg);
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
    overflow: hidden;
}

/* Task Card Header với View Detail Icon */
.task-card-header {
    padding: 12px 16px;
    font-weight: 600;
    font-size: 1rem;
    border-bottom: 1px solid var(--ed-border);
    text-align: center;
    color: #ffffff;
    position: relative;
}

/* Icon View Detail */
.view-detail-icon {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.view-detail-icon:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.view-detail-icon i {
    font-size: 0.95rem;
    color: #ffffff;
}

/* Responsive cho icon */
@media (max-width: 768px) {
    .view-detail-icon {
        width: 24px;
        height: 24px;
        right: 8px;
    }

    .view-detail-icon i {
        font-size: 0.85rem;
    }
}

.task-card-header.on-time {
    background: var(--ed-success);
}

.task-card-header.overdue {
    background: var(--ed-danger);
}

.task-card-header.completed {
    background: var(--ed-info-soft);
    color: #0d47a1;
}

.task-card-body {
    padding: 15px 16px;
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* Task Content Layout */
.task-card-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
}

.task-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.task-left-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.task-right-section {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

/* ===== TASK FLOW (AVATAR) ===== */
.task-flow {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Avatar container */
.task-user {
    display: flex;
    align-items: center;
    margin-left: 0;
}

.task-user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e9ecef;
    color: #495057;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
    flex-shrink: 0;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.task-user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.task-arrow {
    font-size: 1rem;
    color: var(--ed-muted);
    margin: 0 4px;
}

/* ===== DÃY AVATAR NGƯỜI LÀM ===== */
.task-assignees {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-width: 100%;
}

/* ===== RESPONSIVE MOBILE ===== */
@media (max-width: 768px) {
    .task-user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }

    .task-arrow {
        font-size: 0.9rem;
        margin: 0 2px;
    }

    .task-assignees {
        gap: 6px;
    }
}


/* Requirement Box */
.task-requirement {
    margin-top: 4px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: var(--ed-radius-md);
    font-size: 0.9rem;
    word-break: break-word;
    border: 1px dashed var(--ed-primary);
}

.task-requirement-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 6px;
    font-size: 0.85rem;
}

/* Countdown */
.task-countdown,
.task-countdown-static {
    text-align: center;
    padding: 8px 14px;
    background: #f9fafb;
    border: 1px solid #e2e8f0;
    border-radius: var(--ed-radius-pill);
    white-space: nowrap;
}

.countdown-timer {
    font-size: 1.05rem;
    font-weight: 600;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: #1f2933;
    letter-spacing: 0.4px;
}

.countdown-timer.overdue {
    color: var(--ed-danger);
}

.countdown-timer.on-time-done {
    color: var(--ed-success);
}

/* Rating Badge trong countdown static */
.task-rating-badge {
    display: inline-block;
    font-size: 1.2rem;
    margin-top: 0;
    border-radius: 0;
    background: transparent;
}

.task-rating-badge.good {
    color: var(--ed-success);
}

.task-rating-badge.bad {
    color: var(--ed-danger);
}

/* Task Actions */
.task-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: auto;
    padding-top: 15px;
    border-top: 1px solid var(--ed-border);
}

.task-btn {
    padding: 8px 20px;
    border-radius: var(--ed-radius-pill);
    border: 1px solid transparent;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    background: #ffffff;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.task-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.task-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.task-btn-start {
    border-color: var(--ed-primary);
    background: var(--ed-primary-soft);
    color: var(--ed-primary);
}

.task-btn-start:hover {
    background: var(--ed-primary);
    color: #ffffff;
}

.task-btn-complete {
    border-color: var(--ed-success);
    background: var(--ed-success);
    color: #ffffff;
}

.task-btn-discuss {
    border-color: #ffc700;
    background: #ffc700;
    color: var(--ed-text);
}

.task-btn-discuss:hover {
    background: #ffb700;
}

/* Rating Buttons cho DONE tasks */
.task-btn-rate-good {
    border-color: var(--ed-success);
    background: var(--ed-success);
    color: #ffffff;
}

.task-btn-rate-good:hover {
    background: #157347;
}

.task-btn-rate-bad {
    border-color: var(--ed-danger);
    background: var(--ed-danger);
    color: #ffffff;
}

.task-btn-rate-bad:hover {
    background: #bb2d3b;
}

/* Unread badge */
.unread-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--ed-danger);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    border: 2px solid white;
    line-height: 1.2;
}

/* Responsive */
@media (max-width: 1024px) {
    .task-cards-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .priority-header {
        padding: 16px;
    }

    .priority-badge {
        font-size: 1.3rem;
    }

    .priority-stats {
        gap: 12px;
    }

    .priority-stat-number {
        font-size: 1.5rem;
    }

    .task-cards-container {
        grid-template-columns: 1fr;
        gap: 14px;
    }

    .countdown-timer {
        font-size: 0.98rem;
    }

    .task-actions {
        flex-wrap: wrap;
    }

    .task-btn {
        flex: 1;
        min-width: 48%;
        justify-content: center;
    }

    .create-task-btn {
        bottom: 70px;
        right: 20px;
        width: 50px;
        height: 50px;
    }

    .create-task-btn i {
        font-size: 1.4rem;
    }
}
/* ====== PAGINATION STYLES ====== */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 30px;
    gap: 15px;
}

.pagination-info {
    color: #6c757d;
    font-size: 0.9rem;
}

.pagination {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 8px;
}

.page-item {
    display: inline-block;
}

.page-link {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    color: #495057;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    background: #ffffff;
}

.page-link:hover {
    background: #f8f9fa;
    border-color: #0d6efd;
    color: #0d6efd;
    transform: translateY(-1px);
}

.page-item.active .page-link {
    background: #0d6efd;
    border-color: #0d6efd;
    color: #ffffff;
    font-weight: 600;
}

.page-item.disabled .page-link {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* Responsive */
@media (max-width: 768px) {
    .pagination-container {
        flex-direction: column;
        gap: 10px;
    }

    .page-link {
        min-width: 36px;
        height: 36px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="task-header-container">
    {% include 'components/task_header.html' %}
</div>
<!-- Priority Header -->
<div class="priority-header">
    <!-- BÊN TRÁI: trạng thái chính -->
    <div class="priority-header-left">
        <div class="priority-status-box
            {% if status == 'DONE' %}
                status-box-done
            {% elif tag == 'urgent' %}
                status-box-urgent
            {% elif tag == 'important' %}
                status-box-important
            {% elif tag == 'recurring' %}
                status-box-recurring
            {% endif %}
        ">
            {% if status == 'DONE' %}
                <i class="bi bi-check-lg"></i>
            {% else %}
                {{ priority_icon }}
            {% endif %}
        </div>
        <div class="priority-status-text
            {% if status == 'DONE' %}
                status-done
            {% elif tag == 'urgent' %}
                status-urgent
            {% elif tag == 'important' %}
                status-important
            {% elif tag == 'recurring' %}
                status-recurring
            {% endif %}
        ">
            {{ priority_type }}
        </div>
    </div>

    <!-- GIỮA: Tốt / Chưa tốt (chỉ dùng khi DONE) -->
    {% if status == 'DONE' %}
    <div class="priority-header-center">
        <button class="rating-icon" type="button" data-filter="rated-good" onclick="toggleFilter('rated-good')">
            <div class="rating-icon-circle good">
                <i class="bi bi-check-lg"></i>
            </div>
        </button>

        <button class="rating-icon" type="button" data-filter="rated-bad" onclick="toggleFilter('rated-bad')">
            <div class="rating-icon-circle bad">
                <i class="bi bi-check-lg"></i>
            </div>
        </button>
    </div>
    {% endif %}

    <!-- BÊN PHẢI: Đúng hạn / Quá hạn -->
    <div class="priority-header-right">
        <div class="priority-stats">
            <div class="priority-stat-item" data-filter="on-time" onclick="toggleFilter('on-time')">
                <div class="priority-stat-label-top on-time">
                    {% if status == 'DONE' %}ĐÚNG HẠN{% else %}CÒN HẠN{% endif %}
                </div>
                <div class="priority-stat-number-big">{{ on_time_count }}</div>
            </div>

            <div class="priority-stat-item" data-filter="overdue" onclick="toggleFilter('overdue')">
                <div class="priority-stat-label-top overdue">QUÁ HẠN</div>
                <div class="priority-stat-number-big overdue">{{ overdue_count }}</div>
            </div>
        </div>
    </div>
</div>



<!-- Task Cards Grid -->
{% if tasks %}
<div class="task-cards-container">
    {% for task in tasks %}
    <div class="task-card"
         data-task-id="{{ task.id }}"
         data-status="{% if task.status == 'DONE' %}completed{% elif task | is_overdue %}overdue{% else %}on-time{% endif %}"
         data-rating="{{ task.performance_rating or 'none' }}">

        <!-- Header -->
        <div class="task-card-header
            {% if task.status == 'DONE' %}
                {% if task.completed_overdue %}overdue{% else %}on-time{% endif %}
            {% elif task | is_overdue %}overdue
            {% else %}on-time{% endif %}">
            {{ task.title }}

            <!-- View Detail Icon -->
            <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}"
               class="view-detail-icon"
               title="Xem chi tiết"
               onclick="event.stopPropagation();">
                <i class="bi bi-eye"></i>
            </a>
        </div>

        <!-- Body -->
        <div class="task-card-body">
            <div class="task-card-content">
                <!-- Hàng 1: Avatar → Avatar | Countdown/Rating -->
                <div class="task-top-row">
                    <div class="task-left-section">
                        <div class="task-flow">
                            <!-- Avatar người giao -->
                            <div class="task-user">
                                <div class="task-user-avatar">
                                    {% if task.creator.avatar %}
                                        <img src="{{ url_for('profile.get_avatar', filename=task.creator.avatar) }}" alt="{{ task.creator.full_name }}">
                                    {% else %}
                                        {{ task.creator.full_name[0].upper() }}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="task-arrow">→</div>

                            <!-- Avatar TẤT CẢ người làm - KHÔNG GIỚI HẠN -->
                            <div class="task-assignees">
                                {% if task._cached_assignments %}
                                    {% for assignment in task._cached_assignments %}
                                    <div class="task-user">
                                        <div class="task-user-avatar">
                                            {% if assignment.user.avatar %}
                                                <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}" alt="{{ assignment.user.full_name }}">
                                            {% else %}
                                                {{ assignment.user.full_name[0].upper() }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Countdown hoặc Rating -->
                    <div class="task-right-section">
                        {% if task.due_date %}
                            {% if task.status == 'DONE' %}
                                {% if task.performance_rating %}
                                <div class="task-countdown-static">
                                    <div class="task-rating-badge {{ task.performance_rating }}">
                                        {% if task.performance_rating == 'good' %}
                                            <i class="bi bi-hand-thumbs-up-fill"></i>
                                        {% elif task.performance_rating == 'bad' %}
                                            <i class="bi bi-hand-thumbs-down-fill"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="task-countdown" data-due-date="{{ task.vn_due_date.strftime('%Y-%m-%dT%H:%M:%S') }}+07:00">
                                    <div class="countdown-timer">--:--:--</div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Hàng 2: Yêu cầu -->
                <div class="task-requirement">
                    <div class="task-requirement-label">YÊU CẦU:</div>
                    <div style="white-space: pre-wrap;">{{ task.description or 'Không có mô tả' }}</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="task-actions">
                {% if task.status == 'PENDING' %}
                    <button class="task-btn task-btn-start" onclick="quickUpdateStatus({{ task.id }}, 'IN_PROGRESS')">
                        <i class="bi bi-play"></i>
                        <span>Nhận Việc</span>
                    </button>

                {% elif task.status == 'IN_PROGRESS' %}
                    <button class="task-btn task-btn-complete" onclick="quickUpdateStatus({{ task.id }}, 'DONE')">
                        <i class="bi bi-check-circle"></i>
                        <span>Hoàn thành</span>
                    </button>

                {% elif task.status == 'DONE' %}
                    {% if current_user.role in ['director', 'manager'] %}
                        <button class="task-btn task-btn-rate-good"
                                onclick="quickRateTask({{ task.id }}, 'good')"
                                {% if task.performance_rating == 'good' %}disabled{% endif %}>
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                        <button class="task-btn task-btn-rate-bad"
                                onclick="quickRateTask({{ task.id }}, 'bad')"
                                {% if task.performance_rating == 'bad' %}disabled{% endif %}>
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    {% endif %}
                {% endif %}

                <!-- Nút Trao đổi -->
                <button class="task-btn task-btn-discuss"
                        onclick="window.location.href='{{ url_for('tasks.task_discussion', task_id=task.id) }}'"
                        style="position: relative;">
                    <i class="bi bi-chat-dots"></i>
                    <span>Trao đổi</span>
                    {% if task.unread_comment_count > 0 %}
                    <span class="unread-badge">{{ task.unread_comment_count }}</span>
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ========== PAGINATION ========== -->
{% if pagination.pages > 1 %}
<div class="pagination-container">
    <div class="pagination-info">
        Trang {{ pagination.page }} / {{ pagination.pages }}
        ({{ pagination.total }} nhiệm vụ)
    </div>

    <ul class="pagination">
        <!-- Nút Trang đầu -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=1) }}">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>

        <!-- Nút Trang trước -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.prev_num) if pagination.has_prev else '#' }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>

        <!-- Các số trang -->
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('tasks.priority_detail',
                        assigned_user=request.args.get('assigned_user'),
                        tag=tag,
                        status=status,
                        page=page_num) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}

        <!-- Nút Trang sau -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.next_num) if pagination.has_next else '#' }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>

        <!-- Nút Trang cuối -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.pages) }}">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
    </ul>
</div>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <p class="text-muted mt-3">Không có nhiệm vụ nào.</p>
</div>
{% endif %}

<!-- Floating Create Task Button -->
<button class="create-task-btn"
        onclick="window.location.href='{{ url_for('tasks.create_task') }}'"
        title="Tạo công việc mới">
    <i class="bi bi-plus-lg"></i>
</button>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// COUNTDOWN TIMER
// ========================================
function startCountdowns() {
    const countdownElements = document.querySelectorAll('.task-countdown');

    countdownElements.forEach(element => {
        const dueDate = new Date(element.dataset.dueDate);
        const timerDisplay = element.querySelector('.countdown-timer');

        function updateCountdown() {
            const now = new Date();
            const diff = dueDate - now;

            // ===== XỬ LÝ KHI QUÁ HẠN: HIỂN THỊ THỜI GIAN ÂM =====
            if (diff <= 0) {
                const overdueDiff = Math.abs(diff); // Lấy giá trị tuyệt đối

                const days = Math.floor(overdueDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((overdueDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((overdueDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((overdueDiff % (1000 * 60)) / 1000);

                let timeString = '-'; // Thêm dấu trừ
                if (days > 0) {
                    timeString += `${days}d:${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
                } else {
                    timeString += `${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
                }

                timerDisplay.textContent = timeString;
                timerDisplay.classList.add('overdue');
                element.style.background = '#f8d7da';
                element.style.borderColor = '#f5c2c7';
                return;
            }

            // ===== XỬ LÝ KHI CÒN HẠN: HIỂN THỊ BÌNH THƯỜNG =====
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            let timeString = '';
            if (days > 0) {
                timeString = `${days}d:${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
            } else {
                timeString = `${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
            }

            timerDisplay.textContent = timeString;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
}

// ========================================
// FILTER TASKS
// ========================================
let currentFilter = null;

function toggleFilter(filterType) {
    const buttons = document.querySelectorAll('[data-filter]'); // gồm cả icon & số
    const cards = document.querySelectorAll('.task-card');

    if (currentFilter === filterType) {
        currentFilter = null;
        buttons.forEach(btn => btn.classList.remove('active'));
        cards.forEach(card => card.style.display = 'flex');
    } else {
        currentFilter = filterType;

        buttons.forEach(btn => {
            if (btn.dataset.filter === filterType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        cards.forEach(card => {
            const header = card.querySelector('.task-card-header');
            const cardRating = card.dataset.rating;
            let shouldShow = false;

            if (filterType === 'overdue') {
                shouldShow = header.classList.contains('overdue');
            } else if (filterType === 'on-time') {
                shouldShow = header.classList.contains('on-time');
            } else if (filterType === 'rated-good') {
                shouldShow = (cardRating === 'good');
            } else if (filterType === 'rated-bad') {
                shouldShow = (cardRating === 'bad');
            }

            card.style.display = shouldShow ? 'flex' : 'none';
        });
    }
}

// ========================================
// QUICK UPDATE STATUS
// ========================================
function quickUpdateStatus(taskId, newStatus) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

    fetch(`/tasks/${taskId}/quick-update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Lỗi: ' + (data.error || 'Không thể cập nhật'));
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

// ========================================
// QUICK RATE TASK
// ========================================
function quickRateTask(taskId, rating) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    fetch(`/tasks/${taskId}/quick-rate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ rating: rating })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload để cập nhật UI
            location.reload();
        } else {
            alert('Lỗi: ' + (data.error || 'Không thể đánh giá'));
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

// ========================================
// INIT
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    startCountdowns();
});
</script>
{% endblock %}