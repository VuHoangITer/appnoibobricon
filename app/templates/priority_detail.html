{% extends "base.html" %}

{% block title %}{{ priority_icon }} {{ priority_type }}{% endblock %}
{% block page_title %}{{ priority_icon }} {{ priority_type }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chi-tiet-uu-tien.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block content %}
<div class="task-header-container">
    {% include 'components/task_header.html' %}
</div>
{% if total_unread_messages > 0 %}
<div class="unread-summary" onclick="toggleUnreadFilter()" id="unreadSummary">
    <div class="unread-summary-icon">
        üí¨
    </div>
    <div class="unread-summary-text">
        <div class="unread-summary-title">TIN NH·∫ÆN CH∆ØA ƒê·ªåC</div>
        <div class="unread-summary-subtitle">
            {{ tasks_with_unread }} nhi·ªám v·ª• c√≥ tin nh·∫Øn m·ªõi
        </div>
    </div>
    <div class="unread-summary-badge">
        {{ total_unread_messages }}
    </div>
</div>
{% endif %}
<!-- Priority Header -->
<div class="priority-header">
    <!-- B√äN TR√ÅI: tr·∫°ng th√°i ch√≠nh -->
    <div class="priority-header-left">
        <div class="priority-status-text
            {% if status == 'DONE' %}
                status-done
            {% elif tag == 'urgent' %}
                status-urgent
            {% elif tag == 'important' %}
                status-important
            {% elif tag == 'recurring' %}
                status-recurring
            {% endif %}
        ">
            {{ priority_type }}
        </div>
    </div>

    <!-- GI·ªÆA: T·ªët / Ch∆∞a t·ªët (ch·ªâ d√πng khi DONE) -->
    {% if status == 'DONE' %}
    <div class="priority-header-center">
        <button class="rating-icon" type="button" data-filter="rated-good" onclick="toggleFilter('rated-good')">
            <div class="rating-icon-circle good">
                <i class="bi bi-check-lg"></i>
            </div>
        </button>

        <button class="rating-icon" type="button" data-filter="rated-bad" onclick="toggleFilter('rated-bad')">
            <div class="rating-icon-circle bad">
                <i class="bi bi-check-lg"></i>
            </div>
        </button>
    </div>
    {% endif %}

    <!-- B√äN PH·∫¢I: ƒê√∫ng h·∫°n / Qu√° h·∫°n -->
    <div class="priority-header-right">
        <div class="priority-stats">
            <div class="priority-stat-item" data-filter="on-time" onclick="toggleFilter('on-time')">
                <div class="priority-stat-label-top on-time">
                    {% if status == 'DONE' %}ƒê√öNG H·∫†N{% else %}C√íN H·∫†N{% endif %}
                </div>
                <div class="priority-stat-number-big">{{ on_time_count }}</div>
            </div>

            <div class="priority-stat-item" data-filter="overdue" onclick="toggleFilter('overdue')">
                <div class="priority-stat-label-top overdue">QU√Å H·∫†N</div>
                <div class="priority-stat-number-big overdue">{{ overdue_count }}</div>
            </div>
        </div>
    </div>
</div>



<!-- Task Cards Grid -->
{% if tasks %}
<div class="task-cards-container">
    {% for task in tasks %}
    <div class="task-card {% if task.unread_comment_count > 0 %}has-unread{% endif %}"
         data-task-id="{{ task.id }}"
         data-has-unread="{{ 'true' if task.unread_comment_count > 0 else 'false' }}"
         data-status="{% if task.status == 'DONE' %}completed{% elif task | is_overdue %}overdue{% else %}on-time{% endif %}"
         data-rating="{{ task.performance_rating or 'none' }}">

        <!-- Header -->
        <div class="task-card-header
            {% if task.status == 'DONE' %}
                {% if task.completed_overdue %}overdue{% else %}on-time{% endif %}
            {% elif task | is_overdue %}overdue
            {% else %}on-time{% endif %}">
            {{ task.title }}
            <!-- Checklist icon -->
            {% if task._checklist_progress and task._checklist_progress.total > 0 %}
            <div class="task-checklist-icon has-checklist"
                 title="C√≥ {{ task._checklist_progress.total }} checklist">
                <i class="bi bi-list-check"></i>
            </div>
            {% endif %}

            <!-- View Detail Icon -->
            <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}"
               class="view-detail-icon"
               title="Xem chi ti·∫øt"
               onclick="event.stopPropagation();">
                <i class="bi bi-eye"></i>
            </a>
        </div>

        <!-- Body -->
        <div class="task-card-body">
            <div class="task-card-content">
                <!-- H√†ng 1: Avatar ‚Üí Avatar | Countdown/Rating -->
                <div class="task-top-row">
                    <div class="task-left-section">
                        <div class="task-flow">
                            <!-- Avatar ng∆∞·ªùi giao -->
                            <div class="task-user">
                                <div class="task-user-avatar">
                                    {% if task.creator.avatar %}
                                        <img src="{{ url_for('profile.get_avatar', filename=task.creator.avatar) }}" alt="{{ task.creator.full_name }}">
                                    {% else %}
                                        {{ task.creator.full_name[0].upper() }}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="task-arrow">‚Üí</div>

                            <!-- Avatar T·∫§T C·∫¢ ng∆∞·ªùi l√†m - KH√îNG GI·ªöI H·∫†N -->
                            <div class="task-assignees">
                                {% if task._cached_assignments %}
                                    {% for assignment in task._cached_assignments %}
                                    <div class="task-user">
                                        <div class="task-user-avatar">
                                            {% if assignment.user.avatar %}
                                                <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}" alt="{{ assignment.user.full_name }}">
                                            {% else %}
                                                {{ assignment.user.full_name[0].upper() }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Countdown ho·∫∑c Rating -->
                    <div class="task-right-section">
                        {% if task.status == 'DONE' %}
                            <!-- Hi·ªÉn th·ªã rating n·∫øu ƒë√£ ƒë√°nh gi√° -->
                            {% if task.performance_rating %}
                            <div class="task-countdown-static">
                                <div class="task-rating-badge {{ task.performance_rating }}">
                                    {% if task.performance_rating == 'good' %}
                                         <i class="bi bi-check-circle-fill"></i>
                                    {% elif task.performance_rating == 'bad' %}
                                        <i class="bi bi-x-circle-fill"></i>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% elif task.due_date %}
                            <!-- Hi·ªÉn th·ªã countdown cho task ch∆∞a DONE -->
                            <div class="task-countdown" data-due-date="{{ task.vn_due_date.strftime('%Y-%m-%dT%H:%M:%S') }}+07:00">
                                <div class="countdown-timer">--:--:--</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- H√†ng 2: Checklist Progress (n·∫øu c√≥) -->
                {% if task._checklist_progress and task._checklist_progress.total > 0 %}
                <div class="task-checklist-progress" onclick="showChecklistModal({{ task.id }}, event)">
                    <div class="checklist-progress-header">
                        <span class="checklist-progress-text">
                            <i class="bi bi-check2-square"></i>
                            Checklist: {{ task._checklist_progress.approved }}/{{ task._checklist_progress.total }}

                            <!-- ‚úÖ TH√äM BADGE CH·ªú DUY·ªÜT - CH·ªà HI·ªÜN CHO MANAGER/DIRECTOR -->
                            {% if current_user.role in ['manager', 'director'] and task._checklist_progress.waiting > 0 %}
                            <span class="badge-waiting-approval">
                                <i class="bi bi-clock-fill"></i> {{ task._checklist_progress.waiting }}
                            </span>
                            {% endif %}
                        </span>
                        <span class="checklist-progress-percentage {% if task._checklist_progress.is_complete %}complete{% else %}incomplete{% endif %}">
                            {{ task._checklist_progress.percentage }}%
                        </span>
                    </div>
                    <div class="checklist-progress-bar-container">
                        <div class="checklist-progress-bar" style="width: {{ task._checklist_progress.percentage }}%"></div>
                    </div>
                </div>
                {% endif %}

                <!-- H√†ng 3: Y√™u c·∫ßu -->
                <div class="task-requirement">
                    <div class="task-requirement-label">Y√äU C·∫¶U:</div>
                    <div style="white-space: pre-wrap;">{{ task.description or 'Kh√¥ng c√≥ m√¥ t·∫£' }}</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="task-actions">
                {% if task.status == 'PENDING' %}
                    <button class="task-btn task-btn-start" onclick="quickUpdateStatus({{ task.id }}, 'IN_PROGRESS')">
                        <i class="bi bi-play"></i>
                        <span>Nh·∫≠n Vi·ªác</span>
                    </button>

                {% elif task.status == 'IN_PROGRESS' %}
                    <button class="task-btn task-btn-complete" onclick="quickUpdateStatus({{ task.id }}, 'DONE')">
                        <i class="bi bi-check-circle"></i>
                        <span>Ho√†n th√†nh</span>
                    </button>

                {% elif task.status == 'DONE' %}
                    {% if current_user.role in ['director', 'manager'] %}
                        <!-- Ch·ªâ hi·ªán n√∫t khi CH∆ØA ƒë√°nh gi√° -->
                        {% if not task.performance_rating %}
                        <button class="task-btn task-btn-evaluate"
                                onclick="showRatingModal({{ task.id }})">
                            <i class="bi bi-clipboard-check"></i>
                            <span>ƒê√°nh gi√°</span>
                        </button>
                        {% endif %}
                        <!-- ƒê√£ ƒë√°nh gi√° ‚Üí KH√îNG HI·ªÜN G√å -->
                    {% endif %}
                {% endif %}

                <!-- N√∫t Trao ƒë·ªïi -->
                <button class="task-btn task-btn-discuss"
                        onclick="window.location.href='{{ url_for('tasks.task_discussion', task_id=task.id) }}'"
                        style="position: relative;">
                    <i class="bi bi-chat-dots"></i>
                    <span>Trao ƒë·ªïi</span>
                    {% if task.unread_comment_count > 0 %}
                    <span class="unread-badge">{{ task.unread_comment_count }}</span>
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ========== PAGINATION ========== -->
{% if pagination.pages > 1 %}
<div class="pagination-container">
    <div class="pagination-info">
        Trang {{ pagination.page }} / {{ pagination.pages }}
        ({{ pagination.total }} nhi·ªám v·ª•)
    </div>

    <ul class="pagination">
        <!-- N√∫t Trang ƒë·∫ßu -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=1) }}">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>

        <!-- N√∫t Trang tr∆∞·ªõc -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.prev_num) if pagination.has_prev else '#' }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>

        <!-- C√°c s·ªë trang -->
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('tasks.priority_detail',
                        assigned_user=request.args.get('assigned_user'),
                        tag=tag,
                        status=status,
                        page=page_num) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}

        <!-- N√∫t Trang sau -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.next_num) if pagination.has_next else '#' }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>

        <!-- N√∫t Trang cu·ªëi -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('tasks.priority_detail',
                assigned_user=request.args.get('assigned_user'),
                tag=tag,
                status=status,
                page=pagination.pages) }}">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
    </ul>
</div>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <p class="text-muted mt-3">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o.</p>
</div>
{% endif %}

<!-- Floating Create Task Button -->
<button class="create-task-btn"
        onclick="window.location.href='{{ url_for('tasks.create_task') }}'"
        title="T·∫°o c√¥ng vi·ªác m·ªõi">
    <i class="bi bi-plus-lg"></i>
</button>
<!-- ===== MODAL ƒê√ÅNH GI√Å ===== -->
<div class="rating-modal" id="ratingModal">
    <div class="rating-modal-content">
        <div class="rating-modal-header">
            <h3>ƒê√°nh gi√° nhi·ªám v·ª•</h3>
            <button onclick="closeRatingModal()" class="modal-close-btn">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <div class="rating-modal-body">
            <p class="rating-modal-question">Nh√¢n vi√™n ho√†n th√†nh nhi·ªám v·ª• nh∆∞ th·∫ø n√†o?</p>

            <div class="rating-options">
                <button class="rating-option good" onclick="selectRating('good')">
                    <div class="rating-option-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="rating-option-text">T·ªët</div>
                </button>

                <button class="rating-option bad" onclick="selectRating('bad')">
                    <div class="rating-option-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <div class="rating-option-text">Ch∆∞a t·ªët</div>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ===== CHECKLIST MODAL ===== -->
<div class="checklist-modal" id="checklistModal">
    <div class="checklist-modal-content">
        <div class="checklist-modal-header">
            <h3 class="checklist-modal-title">
                <i class="bi bi-list-check"></i>
                Checklist nhi·ªám v·ª•
            </h3>
            <button onclick="closeChecklistModal()" class="modal-close-btn">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <div class="checklist-modal-body" id="checklistModalBody">
            <!-- Checklist items s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chi-tiet-uu-tien.js') }}?v={{ config.VERSION }}"></script>
{% endblock %}