{% extends "base.html" %}

{% block title %}{{ priority_icon }} {{ priority_type }}{% endblock %}
{% block page_title %}{{ priority_icon }} {{ priority_type }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --ed-bg: #f5f7fb;
    --ed-card-bg: #ffffff;
    --ed-border: #e1e5ee;
    --ed-muted: #6c757d;
    --ed-text: #1f2933;
    --ed-primary: #0d6efd;
    --ed-primary-soft: #e7f1ff;
    --ed-success: #198754;
    --ed-success-soft: #e8f5e9;
    --ed-danger: #dc3545;
    --ed-danger-soft: #ffebee;
    --ed-info-soft: #e3f2fd;
    --ed-radius-lg: 12px;
    --ed-radius-md: 8px;
    --ed-radius-pill: 999px;
}

/* --------------------------------------------
   Section 1: Priority Header
   -------------------------------------------- */

.priority-header {
    background: var(--ed-card-bg);
    border: 1px solid var(--ed-border);
    padding: 20px 24px;
    border-radius: var(--ed-radius-lg);
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
}

.priority-badge {
    font-size: 1.5rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 15px;
    color: var(--ed-text);
}

/* M√†u theo t·ª´ng lo·∫°i priority */
.priority-badge.urgent {
    color: #dc3545;
}

.priority-badge.important {
    color: #ffc107;
}

.priority-badge.recurring {
    color: #0dcaf0;
}

.priority-badge.done {
    color: #198754;
}

.priority-stats {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
}

.priority-stat-item {
    text-align: center;
    padding: 10px 22px;
    background: #f8f9fb;
    border-radius: var(--ed-radius-pill);
    border: 1px solid var(--ed-border);
    cursor: pointer;
}

/* M√†u n·ªÅn cho C√íN H·∫†N v√† QU√Å H·∫†N */
.priority-stat-item[data-filter="on-time"] {
    background: var(--ed-success);
    border-color: var(--ed-success);
}

.priority-stat-item[data-filter="overdue"] {
    background: var(--ed-danger);
    border-color: var(--ed-danger);
}

.priority-stat-item[data-filter="on-time"] .priority-stat-number {
    color: var(--ed-bg);
}

.priority-stat-item[data-filter="overdue"] .priority-stat-number {
    color: var(--ed-bg);
}

.priority-stat-item.active {
    background: var(--ed-primary);
    border-color: var(--ed-primary);
}

.priority-stat-item.active .priority-stat-number,
.priority-stat-item.active .priority-stat-label {
    color: #ffffff;
}

.priority-stat-number {
    font-size: 1.8rem;
    font-weight: 700;
    display: block;
    color: var(--ed-text);
}

.priority-stat-label {
    font-size: 0.85rem;
    color: var(--ed-bg);
    margin-top: 4px;
    font-weight: 500;
}

/* --------------------------------------------
   Floating "Create Task" Button
   -------------------------------------------- */

.create-task-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 54px;
    height: 54px;
    border-radius: 50%;
    background: var(--ed-primary);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 0;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
}

.create-task-btn i {
    font-size: 1.6rem;
    margin: 0;
    line-height: 1;
}

@media (max-width: 768px) {
    .create-task-btn {
        bottom: 70px;
        right: 20px;
        width: 50px;
        height: 50px;
    }

    .create-task-btn i {
        font-size: 1.4rem;
    }
}

/* --------------------------------------------
   Section 2: Task Cards Container
   -------------------------------------------- */

.task-cards-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

/* --------------------------------------------
   Task Card ‚Äì Enterprise Style
   -------------------------------------------- */

.task-card {
    border: 1px solid var(--ed-border);
    border-radius: 24px;
    background: var(--ed-card-bg);
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
    overflow: hidden;
}

.task-card-header {
    padding: 12px 16px;
    font-weight: 600;
    font-size: 1rem;
    border-bottom: 1px solid var(--ed-border);
    text-align: center;
}

/* Header theo tr·∫°ng th√°i */
.task-card-header.on-time {
    background: var(--ed-success);
    color: #155724;
}

.task-card-header.overdue {
    background: var(--ed-danger);
    color: #842029;
}

.task-card-header.completed {
    background: var(--ed-info-soft);
    color: #0d47a1;
}

.task-card-body {
    padding: 15px 16px;
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* --------------------------------------------
   Layout n·ªôi dung tr√™n card
   -------------------------------------------- */

.task-card-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 15px;
}

.task-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.task-left-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.task-right-section {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

/* Ng∆∞·ªùi giao ‚Üí Ng∆∞·ªùi l√†m (layout ngang, ch·ªâ avatar) */
.task-flow {
    display: flex;
    align-items: center;
    gap: 8px;
}

.task-user {
    display: flex;
    align-items: center;
}

/* Avatar d·∫°ng enterprise */
.task-user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e9ecef;
    color: #495057;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.8rem;
    flex-shrink: 0;
}

.task-user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.task-user-info {
    display: none;
}

.task-arrow {
    font-size: 1rem;
    color: var(--ed-mute);
    margin: 0 4px;
}

/* --------------------------------------------
   Requirement Box
   -------------------------------------------- */

.task-requirement {
    margin-top: 4px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: var(--ed-radius-md);
    font-size: 0.9rem;
    word-break: break-word;

    /* khung n√©t ƒë·ª©t quanh √¥ Y√äU C·∫¶U */
    border: 1px dashed var(--ed-primary);
}

.task-requirement-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 6px;
    font-size: 0.85rem;
}

/* --------------------------------------------
   Countdown
   -------------------------------------------- */

.task-countdown,
.task-countdown-static {
    text-align: center;
    padding: 8px 14px;
    background: #f9fafb;
    border: 1px solid #e2e8f0;
    border-radius: var(--ed-radius-pill);
    white-space: nowrap;
}

.countdown-label {
    display: none;
}

.countdown-timer {
    font-size: 1.05rem;
    font-weight: 600;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: #1f2933;
    letter-spacing: 0.4px;
}

.countdown-timer.overdue {
    color: var(--ed-danger);
}

.countdown-timer.on-time-done {
    color: var(--ed-success);
}

/* --------------------------------------------
   Task Actions & Buttons
   -------------------------------------------- */

.task-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: auto;
    padding-top: 15px;
    border-top: 1px solid var(--ed-border);
}

.task-btn {
    padding: 8px 20px;
    border-radius: var(--ed-radius-pill);
    border: 1px solid transparent;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    background: #ffffff;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.task-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* N√∫t theo tr·∫°ng th√°i */

.task-btn-start {
    border-color: var(--ed-primary);
    background: var(--ed-primary-soft);
    color: var(--ed-primary);
}

.task-btn-start:hover {
    background: var(--ed-primary);
    color: #ffffff;
}

.task-btn-complete {
    border-color: var(--ed-success);
    background: var(--ed-success);
    color: var(--ed-success);
}

.task-btn-complete:hover {
    background: var(--ed-success);
    color: #ffffff;
}

.task-btn-discuss {
    border-color: var(--ed-bg);
    background: #ffc700;
    color: var(--ed-text);
}

.task-btn-discuss:hover {
    background: #ffc700;
    color: #ffffff;
}

/* --------------------------------------------
   Responsive
   -------------------------------------------- */

@media (max-width: 1024px) {
    .task-cards-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .priority-header {
        padding: 16px;
    }

    .priority-badge {
        font-size: 1.3rem;
    }

    .priority-stats {
        gap: 12px;
    }

    .priority-stat-number {
        font-size: 1.5rem;
    }

    .task-cards-container {
        grid-template-columns: 1fr;
        gap: 14px;
    }

    .countdown-timer {
        font-size: 0.98rem;
    }

    .task-actions {
        flex-direction: row;
        justify-content: space-between;
    }

    .task-btn {
        width: 48%;
        justify-content: center;
    }
}

/* --------------------------------------------
   Unread badge ‚Äì r√µ r√†ng nh∆∞ng g·ªçn
   -------------------------------------------- */

.unread-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--ed-danger);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    border: 2px solid white;
    line-height: 1.2;
}
.task-card-header.on-time,
.task-card-header.overdue,
.task-card-header.completed {
    color: #ffffff;
}
</style>
{% endblock %}

{% block content %}
<!-- Section 1: Priority Header -->
<div class="priority-header">
    <!-- TI√äU ƒê·ªÄ LO·∫†I ∆ØU TI√äN -->
    <div class="priority-badge
        {% if tag == 'urgent' %}urgent
        {% elif tag == 'important' %}important
        {% elif tag == 'recurring' %}recurring
        {% elif status == 'DONE' %}done{% endif %}">
        {{ priority_icon }} {{ priority_type }}
    </div>

    <div class="priority-stats">
        {% if status != 'DONE' %}
        <div class="priority-stat-item" data-filter="on-time" onclick="toggleFilter('on-time')">
            <span class="priority-stat-number">{{ on_time_count }}</span>
            <div class="priority-stat-label">C√íN H·∫†N</div>
        </div>
        <div class="priority-stat-item" data-filter="overdue" onclick="toggleFilter('overdue')">
            <span class="priority-stat-number">{{ overdue_count }}</span>
            <div class="priority-stat-label">QU√Å H·∫†N</div>
        </div>
        {% else %}
        <div class="priority-stat-item">
            <span class="priority-stat-number">{{ tasks|length }}</span>
            <div class="priority-stat-label">T·ªîNG S·ªê</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Section 2: Task Cards Grid -->
{% if tasks %}
<div class="task-cards-container">
    {% for task in tasks %}
    <div class="task-card" data-task-id="{{ task.id }}">
        <!-- Header -->
        <div class="task-card-header
            {% if task.status == 'DONE' %}completed
            {% elif task | is_overdue %}overdue
            {% else %}on-time{% endif %}">
            {{ task.title }}
        </div>

        <!-- Body -->
        <div class="task-card-body">
            <!-- Content -->
            <div class="task-card-content">
                <!-- H√†ng 1: Avatar ‚Üí Avatar | Countdown -->
                <div class="task-top-row">
                    <div class="task-left-section">
                        <!-- Ng∆∞·ªùi giao ‚Üí Ng∆∞·ªùi l√†m (ch·ªâ avatar) -->
                        <div class="task-flow">
                            <!-- Avatar ng∆∞·ªùi giao -->
                            <div class="task-user">
                                <div class="task-user-avatar">
                                    {% if task.creator.avatar %}
                                        <img src="{{ url_for('profile.get_avatar', filename=task.creator.avatar) }}" alt="{{ task.creator.full_name }}">
                                    {% else %}
                                        {{ task.creator.full_name[0].upper() }}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="task-arrow">‚Üí</div>

                            <!-- Avatar ng∆∞·ªùi l√†m -->
                            <div class="task-user">
                                <div class="task-user-avatar">
                                    {% if user.avatar %}
                                        <img src="{{ url_for('profile.get_avatar', filename=user.avatar) }}" alt="{{ user.full_name }}">
                                    {% else %}
                                        {{ user.full_name[0].upper() }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Countdown -->
                    <div class="task-right-section">
                        {% if task.due_date %}
                            {% if task.status == 'DONE' %}
                                <!-- Task ho√†n th√†nh: Hi·ªán QU√Å H·∫†N ho·∫∑c ƒê√öNG H·∫†N (kh√¥ng ƒë·∫øm) -->
                                <div class="task-countdown-static">
                                    {% if task.completed_overdue %}
                                        <div class="countdown-timer overdue">QU√Å H·∫†N</div>
                                    {% else %}
                                        <div class="countdown-timer on-time-done">ƒê√öNG H·∫†N</div>
                                    {% endif %}
                                    {% if task.performance_rating %}
                                    <div class="task-rating mt-2 text-center">
                                        <span class="badge
                                            {% if task.performance_rating == 'good' %}bg-success
                                            {% else %}bg-danger{% endif %}">
                                            {% if task.performance_rating == 'good' %}üëç
                                            {% else %}üëé{% endif %}
                                        </span>
                                    </div>
                                {% else %}
                                    <div class="task-rating mt-2 text-center">
                                        <span class="badge bg-secondary">Ch∆∞a ƒë√°nh gi√°</span>
                                    </div>
                                {% endif %}
                                </div>
                            {% else %}
                                <!-- Task ch∆∞a ho√†n th√†nh: ƒê·∫øm ng∆∞·ª£c -->
                                <div class="task-countdown" data-due-date="{{ task.vn_due_date.strftime('%Y-%m-%dT%H:%M:%S') }}+07:00">
                                    <div class="countdown-timer">--:--:--</div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- H√†ng 2: Y√™u c·∫ßu full width -->
                <div class="task-requirement">
                    <div class="task-requirement-label">Y√äU C·∫¶U:</div>
                    <div>{{ task.description or 'Kh√¥ng c√≥ m√¥ t·∫£' }}</div>
                </div>
            </div>

            <!-- N√∫t h√†nh ƒë·ªông (d∆∞·ªõi c√πng) -->
            <div class="task-actions">
                {% if task.status == 'PENDING' %}
                    <button class="task-btn task-btn-start" onclick="quickUpdateStatus({{ task.id }}, 'IN_PROGRESS')">
                        <i class="bi bi-play"></i>
                        <span>Nh·∫≠n Vi·ªác</span>
                    </button>
                {% elif task.status == 'IN_PROGRESS' %}
                    <button class="task-btn task-btn-complete" onclick="quickUpdateStatus({{ task.id }}, 'DONE')">
                        <i class="bi bi-check-circle"></i>
                        <span>Ho√†n th√†nh</span>
                    </button>
                {% endif %}

                <!-- N√∫t Trao ƒë·ªïi - lu√¥n hi·ªÉn th·ªã -->
                <button class="task-btn task-btn-discuss" onclick="window.location.href='{{ url_for('tasks.task_detail', task_id=task.id) }}'" style="position: relative;">
                    <i class="bi bi-chat-dots"></i>
                    <span>Trao ƒë·ªïi</span>
                    {% if task.unread_comment_count > 0 %}
                    <span class="unread-badge">{{ task.unread_comment_count }}</span>
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <p class="text-muted mt-3">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o.</p>
</div>
{% endif %}

<!-- Floating Create Task Button -->
<button class="create-task-btn"
        onclick="window.location.href='{{ url_for('tasks.create_task') }}'"
        title="T·∫°o c√¥ng vi·ªác m·ªõi">
    <i class="bi bi-plus-lg"></i>
</button>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// COUNTDOWN TIMER
// ========================================
function startCountdowns() {
    const countdownElements = document.querySelectorAll('.task-countdown');

    countdownElements.forEach(element => {
        const dueDate = new Date(element.dataset.dueDate);
        const timerDisplay = element.querySelector('.countdown-timer');

        function updateCountdown() {
            const now = new Date();
            const diff = dueDate - now;

            if (diff <= 0) {
                timerDisplay.textContent = 'QU√Å H·∫†N';
                timerDisplay.classList.add('overdue');
                element.style.background = '#f8d7da';
                element.style.borderColor = '#f5c2c7';
                return;
            }

            // T√≠nh to√°n ng√†y, gi·ªù, ph√∫t, gi√¢y
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // Format hi·ªÉn th·ªã
            let timeString = '';

            if (days > 0) {
                timeString = `${days}d:${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
            } else {
                timeString = `${String(hours).padStart(2, '0')}h:${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
            }

            timerDisplay.textContent = timeString;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
}

// ========================================
// FILTER TASKS
// ========================================
let currentFilter = null;

function toggleFilter(filterType) {
    const buttons = document.querySelectorAll('.priority-stat-item[data-filter]');
    const cards = document.querySelectorAll('.task-card');

    if (currentFilter === filterType) {
        currentFilter = null;
        buttons.forEach(btn => btn.classList.remove('active'));
        cards.forEach(card => card.style.display = 'flex');
    } else {
        currentFilter = filterType;

        buttons.forEach(btn => {
            if (btn.dataset.filter === filterType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        cards.forEach(card => {
            const header = card.querySelector('.task-card-header');

            if (filterType === 'overdue') {
                if (header.classList.contains('overdue')) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            } else if (filterType === 'on-time') {
                if (header.classList.contains('on-time')) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            }
        });
    }
}

// ========================================
// QUICK UPDATE STATUS
// ========================================
function quickUpdateStatus(taskId, newStatus) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ƒêang x·ª≠ l√Ω...';

    fetch(`/tasks/${taskId}/quick-update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

// ========================================
// INIT
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    startCountdowns();
});
</script>
{% endblock %}