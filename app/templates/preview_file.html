{% extends "base.html" %}

{% block title %}Xem tr∆∞·ªõc: {{ file.original_filename }}{% endblock %}
{% block page_title %}Xem tr∆∞·ªõc File{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px 0 32px;
        min-height: 0;
    }

    .file-header {
        background: #ffffff;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: none;
    }

    .file-name {
        font-size: 1.05rem;
        font-weight: 600;
        word-break: break-word;
        overflow-wrap: anywhere;
        white-space: normal;
        line-height: 1.4;
        margin-bottom: 0.35rem;
        padding-right: 12px;
        color: #111827;
    }

    .file-name i {
        font-size: 1.15rem;
        margin-right: 8px;
        vertical-align: -1px;
    }

    .file-header .text-muted small {
        font-size: 0.85rem;
    }

    .file-header .btn-primary {
        border-radius: 999px;
        padding: 8px 20px;
        font-size: 0.95rem;
        font-weight: 500;
        box-shadow: none;
    }

    .preview-content {
        background: #ffffff;
        border-radius: 12px;
        padding: 32px 20px;
        border: 1px solid #e5e7eb;
        box-shadow: none;
        text-align: center;
    }

    .big-icon {
        font-size: 72px;
        margin-bottom: 16px;
        opacity: 0.9;
    }

    .big-icon.bi-file-word { color: #2563eb; }
    .big-icon.bi-file-excel { color: #16a34a; }
    .big-icon.bi-file-earmark { color: #6b7280; }

    .preview-content h3 {
        font-size: 1.15rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #111827;
    }

    .preview-content .lead {
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
    }

    .preview-content .text-secondary {
        font-size: 0.9rem;
        color: #6b7280 !important;
    }

    .btn-success {
        border-radius: 999px;
        padding: 9px 26px;
        font-size: 0.95rem;
        font-weight: 500;
        box-shadow: none;
    }

    .btn-open-app {
        background: #0d9488;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        padding: 9px 26px;
        font-weight: 500;
        color: white;
    }

    .btn-open-app:hover {
        background: #0f766e;
        color: white;
    }

    .viewer-tabs {
        margin-bottom: 16px;
    }

    .viewer-tabs .btn-group {
        display: inline-flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .viewer-tabs .btn {
        border-radius: 999px;
        padding: 8px 20px;
        font-size: 0.9rem;
    }

    .viewer-tabs .btn.active {
        background-color: #0d9488;
        border-color: #0d9488;
        color: white;
    }

    .viewer-loading {
        padding: 40px;
        text-align: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .preview-container {
            padding: 16px 0 24px;
        }

        .file-header {
            padding: 14px 14px;
        }

        .file-name {
            font-size: 1rem;
        }

        .preview-content {
            padding: 24px 14px;
        }

        .big-icon {
            font-size: 60px;
        }

        .file-header .text-end {
            text-align: left !important;
            margin-top: 10px;
        }

        .viewer-tabs .btn {
            font-size: 0.85rem;
            padding: 6px 16px;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="preview-container">
    <!-- Header -->
    <div class="file-header">
        <div class="row align-items-start">
            <div class="col-md-8">
                <h4 class="file-name">
                    <i class="bi {% if file_type == 'word' %}bi-file-word{% elif file_type == 'excel' %}bi-file-excel{% else %}bi-file-earmark-text{% endif %}"></i>
                    {{ file.original_filename }}
                </h4>
                <div class="text-muted"><small>
                    <i class="bi bi-person"></i> {{ file.uploader.full_name }} |
                    <i class="bi bi-calendar"></i> {{ file.uploaded_at | vn_datetime }} |
                    <i class="bi bi-hdd"></i> {{ (file.file_size / 1024 / 1024) | round(2) }} MB
                </small></div>
                {% if file.description %}
                <p class="mt-2 mb-0"><strong>M√¥ t·∫£:</strong> {{ file.description }}</p>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('files.download_file', file_id=file.id) }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-download"></i> T·∫£i v·ªÅ
                </a>
            </div>
        </div>
    </div>

    <!-- N·ªôi dung xem tr∆∞·ªõc -->
    <div class="preview-content">
        {% if file_type == 'pdf' %}
            <!-- PDF xem tr·ª±c ti·∫øp -->
            <iframe src="{{ url_for('files.view_file', file_id=file.id) }}"
                    style="width:100%; height:800px; border:none;"></iframe>

        {% elif file_type == 'image' %}
            <!-- H√¨nh ·∫£nh xem tr·ª±c ti·∫øp -->
            <img src="{{ url_for('files.view_file', file_id=file.id) }}"
                 class="img-fluid rounded"
                 alt="{{ file.original_filename }}">

        {% elif file_type in ['word', 'excel'] %}
            <!-- Word/Excel - Tab ch·ªçn c√°ch xem -->
            <div class="viewer-tabs">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="showGoogleViewer()">
                        <i class="bi bi-eye"></i> Xem online
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showMicrosoftViewer()">
                        <i class="bi bi-microsoft"></i> Microsoft Viewer
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showDownloadOption()">
                        <i class="bi bi-download"></i> T·∫£i v·ªÅ
                    </button>
                </div>
            </div>

            <!-- Google Docs Viewer -->
            <div id="googleViewer">
                <div class="viewer-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-3 text-muted">ƒêang t·∫£i tr√¨nh xem...</p>
                </div>
                <iframe
                    src="https://docs.google.com/viewer?url={{ file_url | urlencode }}&embedded=true"
                    style="width:100%; height:800px; border:none; display:none;"
                    frameborder="0"
                    onload="this.style.display='block'; this.previousElementSibling.style.display='none';">
                </iframe>
                <p class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i>
                    N·∫øu kh√¥ng xem ƒë∆∞·ª£c, h√£y th·ª≠ Microsoft Viewer ho·∫∑c t·∫£i v·ªÅ
                </p>
            </div>

            <!-- Microsoft Office Online Viewer -->
            <div id="microsoftViewer" style="display: none;">
                <div class="viewer-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-3 text-muted">ƒêang t·∫£i tr√¨nh xem...</p>
                </div>
                <iframe
                    src="https://view.officeapps.live.com/op/view.aspx?src={{ file_url | urlencode }}"
                    style="width:100%; height:800px; border:none; display:none;"
                    frameborder="0"
                    onload="this.style.display='block'; this.previousElementSibling.style.display='none';">
                </iframe>
                <p class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i>
                    N·∫øu kh√¥ng xem ƒë∆∞·ª£c, h√£y th·ª≠ Google Viewer ho·∫∑c t·∫£i v·ªÅ
                </p>
            </div>

            <!-- Download Option -->
            <div id="downloadOption" style="display: none;">
                <i class="bi big-icon {% if file_type == 'word' %}bi-file-word{% elif file_type == 'excel' %}bi-file-excel{% endif %}"></i>
                <h3>
                    {% if file_type == 'word' %}üìÑ T√†i li·ªáu Microsoft Word
                    {% elif file_type == 'excel' %}üìä B·∫£ng t√≠nh Microsoft Excel
                    {% endif %}
                </h3>
                <p class="text-muted lead" style="word-break: break-word; overflow-wrap: anywhere; max-width: 100%;">
                    {{ file.original_filename }}
                </p>

                <!-- N√∫t t·∫£i v·ªÅ -->
                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                   class="btn btn-success btn-lg px-5 mb-3">
                    <i class="bi bi-download"></i> T·∫£i xu·ªëng ({{ (file.file_size / 1024 / 1024)|round(2) }} MB)
                </a>

                <!-- N√∫t m·ªü tr·ª±c ti·∫øp b·∫±ng app ‚Äì ch·ªâ hi·ªán tr√™n mobile -->
                {% if request.user_agent.platform in ['android', 'iphone', 'ipad'] or 'mobile' in request.user_agent.string|lower %}
                <div class="mt-4">
                    <p class="text-muted small mb-2">Ho·∫∑c</p>
                    <a href="{{ url_for('files.view_file', file_id=file.id) }}"
                       class="btn btn-open-app btn-lg px-5"
                       target="_blank">
                        <i class="bi bi-box-arrow-up-right"></i> M·ªü ngay b·∫±ng Word/Excel
                    </a>
                    <p class="text-muted small mt-3">
                        <i class="bi bi-phone"></i> N·∫øu ƒë√£ c√†i Microsoft Word/Excel ‚Üí file s·∫Ω m·ªü ngay trong ·ª©ng d·ª•ng
                    </p>
                </div>
                {% endif %}

                <div class="alert alert-info mt-4" style="max-width: 500px; margin: 20px auto;">
                    <i class="bi bi-lightbulb"></i> <strong>M·∫πo:</strong><br>
                    N·∫øu mu·ªën xem online m√† kh√¥ng t·∫£i v·ªÅ, h√£y ch·ªçn tab "Xem online" ho·∫∑c "Microsoft Viewer" ·ªü tr√™n
                </div>
            </div>

        {% else %}
            <!-- File kh√°c kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc -->
            <div>
                <i class="bi big-icon bi-file-earmark"></i>
                <h3>File ƒë√≠nh k√®m</h3>
                <p class="text-muted lead" style="word-break: break-word; overflow-wrap: anywhere;">
                    {{ file.original_filename }}
                </p>
                <p class="text-secondary">Lo·∫°i file n√†y kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc.</p>

                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                   class="btn btn-success btn-lg px-5">
                    <i class="bi bi-download"></i> T·∫£i xu·ªëng
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% if file_type in ['word', 'excel'] %}
<script>
function showGoogleViewer() {
    // ·∫®n t·∫•t c·∫£
    document.getElementById('googleViewer').style.display = 'block';
    document.getElementById('microsoftViewer').style.display = 'none';
    document.getElementById('downloadOption').style.display = 'none';

    // Update active button
    updateActiveButton(0);
}

function showMicrosoftViewer() {
    // ·∫®n t·∫•t c·∫£
    document.getElementById('googleViewer').style.display = 'none';
    document.getElementById('microsoftViewer').style.display = 'block';
    document.getElementById('downloadOption').style.display = 'none';

    // Update active button
    updateActiveButton(1);
}

function showDownloadOption() {
    // ·∫®n t·∫•t c·∫£
    document.getElementById('googleViewer').style.display = 'none';
    document.getElementById('microsoftViewer').style.display = 'none';
    document.getElementById('downloadOption').style.display = 'block';

    // Update active button
    updateActiveButton(2);
}

function updateActiveButton(index) {
    const buttons = document.querySelectorAll('.viewer-tabs .btn');
    buttons.forEach((btn, i) => {
        if (i === index) {
            btn.classList.remove('btn-outline-primary', 'btn-outline-secondary');
            btn.classList.add('btn-primary', 'active');
        } else {
            btn.classList.remove('btn-primary', 'active');
            if (i === 0) {
                btn.classList.add('btn-outline-primary');
            } else {
                btn.classList.add('btn-outline-secondary');
            }
        }
    });
}
</script>
{% endif %}
{% endblock %}