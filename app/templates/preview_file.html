{% extends "base.html" %}

{% block title %}Xem tr∆∞·ªõc: {{ file.original_filename }}{% endblock %}
{% block page_title %}Xem tr∆∞·ªõc File{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px 0 32px;
        min-height: 0;
    }

    .file-header {
        background: #ffffff;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: none;
    }

    .file-name {
        font-size: 1.05rem;
        font-weight: 600;
        word-break: break-word;
        overflow-wrap: anywhere;
        white-space: normal;
        line-height: 1.4;
        margin-bottom: 0.35rem;
        padding-right: 12px;
        color: #111827;
    }

    .file-name i {
        font-size: 1.15rem;
        margin-right: 8px;
        vertical-align: -1px;
    }

    .file-header .text-muted small {
        font-size: 0.85rem;
    }

    .file-header .btn-primary {
        border-radius: 999px;
        padding: 8px 20px;
        font-size: 0.95rem;
        font-weight: 500;
        box-shadow: none;
    }

    /* Style cho m√¥ t·∫£ */
    .file-description {
        margin-top: 12px;
        margin-bottom: 0;
        padding: 10px 12px;
        background: #f9fafb;
        border-radius: 6px;
        border-left: 3px solid #0d9488;
    }

    .file-description strong {
        color: #111827;
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
    }

    .file-description-text {
        color: #4b5563;
        word-break: break-word;
        overflow-wrap: anywhere;
        white-space: pre-wrap;
        line-height: 1.5;
        max-height: 120px;
        overflow-y: auto;
    }

    /* Scrollbar cho m√¥ t·∫£ d√†i */
    .file-description-text::-webkit-scrollbar {
        width: 6px;
    }

    .file-description-text::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .file-description-text::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }

    .file-description-text::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }

    .preview-content {
        background: #ffffff;
        border-radius: 12px;
        padding: 32px 20px;
        border: 1px solid #e5e7eb;
        box-shadow: none;
        text-align: center;
    }

    .big-icon {
        font-size: 72px;
        margin-bottom: 16px;
        opacity: 0.9;
    }

    .big-icon.bi-file-word { color: #2563eb; }
    .big-icon.bi-file-excel { color: #16a34a; }
    .big-icon.bi-file-earmark { color: #6b7280; }

    .preview-content h3 {
        font-size: 1.15rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #111827;
    }

    .preview-content .lead {
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
    }

    .preview-content .text-secondary {
        font-size: 0.9rem;
        color: #6b7280 !important;
    }

    .btn-success {
        border-radius: 999px;
        padding: 9px 26px;
        font-size: 0.95rem;
        font-weight: 500;
        box-shadow: none;
    }

    .btn-open-app {
        background: #0d9488;
        border-radius: 999px;
        border: none;
        font-size: 0.95rem;
        padding: 9px 26px;
        font-weight: 500;
        color: white;
    }

    .btn-open-app:hover {
        background: #0f766e;
        color: white;
    }

    .viewer-tabs {
        margin-bottom: 16px;
    }

    .viewer-tabs .btn-group {
        display: inline-flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .viewer-tabs .btn {
        border-radius: 999px;
        padding: 8px 20px;
        font-size: 0.9rem;
    }

    .viewer-tabs .btn.active {
        background-color: #0d9488;
        border-color: #0d9488;
        color: white;
    }

    .viewer-loading {
        padding: 40px;
        text-align: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .viewer-error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        color: #991b1b;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .preview-container {
            padding: 16px 0 24px;
        }

        .file-header {
            padding: 14px 14px;
        }

        .file-name {
            font-size: 1rem;
        }

        .file-description {
            margin-top: 10px;
            padding: 8px 10px;
        }

        .file-description-text {
            font-size: 0.9rem;
            max-height: 100px;
        }

        .preview-content {
            padding: 24px 14px;
        }

        .big-icon {
            font-size: 60px;
        }

        .file-header .text-end {
            text-align: left !important;
            margin-top: 10px;
        }

        .viewer-tabs .btn {
            font-size: 0.85rem;
            padding: 6px 16px;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="preview-container">
    <!-- Header -->
    <div class="file-header">
        <div class="row align-items-start">
            <div class="col-md-8">
                <h4 class="file-name">
                    <i class="bi {% if file_type == 'word' %}bi-file-word{% elif file_type == 'excel' %}bi-file-excel{% else %}bi-file-earmark-text{% endif %}"></i>
                    {{ file.original_filename }}
                </h4>
                <div class="text-muted"><small>
                    <i class="bi bi-person"></i> {{ file.uploader.full_name }} |
                    <i class="bi bi-calendar"></i> {{ file.uploaded_at | vn_datetime }} |
                    <i class="bi bi-hdd"></i> {{ (file.file_size / 1024 / 1024) | round(2) }} MB
                </small></div>
                {% if file.description %}
                    <div class="file-description">
                        <strong>M√¥ t·∫£:</strong>
                        <div class="file-description-text">{{ file.description }}</div>
                    </div>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('files.download_file', file_id=file.id) }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-download"></i> T·∫£i v·ªÅ
                </a>
            </div>
        </div>
    </div>

    <!-- N·ªôi dung xem tr∆∞·ªõc -->
    <div class="preview-content">
        {% if file_type == 'pdf' %}
            <!-- PDF xem tr·ª±c ti·∫øp -->
            <iframe src="{{ private_url }}"
                    id="pdfViewer"
                    style="width:100%; height:800px; border:none;"
                    onerror="showPdfError()"></iframe>

            <div id="pdfError" style="display:none;">
                <div class="viewer-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    Kh√¥ng th·ªÉ hi·ªÉn th·ªã PDF trong tr√¨nh duy·ªát n√†y.
                </div>
                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                   class="btn btn-success btn-lg">
                    <i class="bi bi-download"></i> T·∫£i v·ªÅ ƒë·ªÉ xem
                </a>
            </div>

        {% elif file_type == 'image' %}
            <!-- H√¨nh ·∫£nh xem tr·ª±c ti·∫øp -->
            <img src="{{ private_url }}"
                 class="img-fluid rounded"
                 alt="{{ file.original_filename }}"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Ctext x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27%3EKh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh%3C/text%3E%3C/svg%3E'">

        {% elif file_type in ['word', 'excel'] %}
            <!-- Word/Excel - Microsoft Viewer ∆∞u ti√™n -->
            <div class="viewer-tabs">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="showMicrosoftViewer()">
                        <i class="bi bi-microsoft"></i> Xem online
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="showDownloadOption()">
                        <i class="bi bi-download"></i> T·∫£i v·ªÅ
                    </button>
                </div>
            </div>

            <!-- Microsoft Office Online Viewer (M·∫∂C ƒê·ªäNH) -->
            <div id="microsoftViewer">
                <div class="viewer-loading" id="msLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-3 text-muted">ƒêang t·∫£i Microsoft Office Viewer...</p>
                    <p class="text-muted small">C√≥ th·ªÉ m·∫•t 5-10 gi√¢y</p>
                </div>

                <div id="msError" class="viewer-error" style="display:none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Kh√¥ng th·ªÉ t·∫£i file</strong><br>
                    <small>
                        Nguy√™n nh√¢n c√≥ th·ªÉ: file qu√° l·ªõn (&gt;10MB), ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£, ho·∫∑c l·ªói m·∫°ng.<br>
                        Vui l√≤ng t·∫£i file v·ªÅ ƒë·ªÉ xem.
                    </small>
                </div>

                <iframe
                    id="msFrame"
                    style="width:100%; height:800px; border:none; display:none;"
                    frameborder="0">
                </iframe>
            </div>

            <!-- Download Option -->
            <div id="downloadOption" style="display: none;">
                <i class="bi big-icon {% if file_type == 'word' %}bi-file-word{% elif file_type == 'excel' %}bi-file-excel{% endif %}"></i>
                <h3>
                    {% if file_type == 'word' %}üìÑ T√†i li·ªáu Microsoft Word
                    {% elif file_type == 'excel' %}üìä B·∫£ng t√≠nh Microsoft Excel
                    {% endif %}
                </h3>
                <p class="text-muted lead" style="word-break: break-word; overflow-wrap: anywhere; max-width: 100%;">
                    {{ file.original_filename }}
                </p>

                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                   class="btn btn-success btn-lg px-5 mb-3">
                    <i class="bi bi-download"></i> T·∫£i xu·ªëng ({{ (file.file_size / 1024 / 1024)|round(2) }} MB)
                </a>

                <div class="alert alert-info mt-4" style="max-width: 500px; margin: 20px auto;">
                    <i class="bi bi-lightbulb"></i> <strong>M·∫πo:</strong><br>
                    Mu·ªën xem online kh√¥ng c·∫ßn t·∫£i v·ªÅ? Ch·ªçn tab "Xem online" ·ªü tr√™n
                </div>
            </div>

        {% else %}
            <!-- File kh√°c -->
            <div>
                <i class="bi big-icon bi-file-earmark"></i>
                <h3>File ƒë√≠nh k√®m</h3>
                <p class="text-muted lead" style="word-break: break-word; overflow-wrap: anywhere;">
                    {{ file.original_filename }}
                </p>
                <p class="text-secondary">Lo·∫°i file n√†y kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc.</p>

                <a href="{{ url_for('files.download_file', file_id=file.id) }}"
                   class="btn btn-success btn-lg px-5">
                    <i class="bi bi-download"></i> T·∫£i xu·ªëng
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% if file_type in ['word', 'excel'] %}
<script>
let msFrameLoaded = false;

// Timeout ƒë·ªÉ hi·ªÉn th·ªã l·ªói n·∫øu iframe kh√¥ng load
const VIEWER_TIMEOUT = 20000; // 20 gi√¢y

function showMicrosoftViewer() {
    document.getElementById('microsoftViewer').style.display = 'block';
    document.getElementById('downloadOption').style.display = 'none';
    updateActiveButton(0);

    if (!msFrameLoaded) {
        loadMicrosoftViewer();
    }
}

function showDownloadOption() {
    document.getElementById('microsoftViewer').style.display = 'none';
    document.getElementById('downloadOption').style.display = 'block';
    updateActiveButton(1);
}

function loadMicrosoftViewer() {
    const frame = document.getElementById('msFrame');
    const loading = document.getElementById('msLoading');
    const error = document.getElementById('msError');

    // Set src for Microsoft Viewer
    frame.src = "https://view.officeapps.live.com/op/view.aspx?src={{ file_url | urlencode }}";

    let timeout = setTimeout(() => {
        if (!msFrameLoaded) {
            loading.style.display = 'none';
            error.style.display = 'block';
            frame.style.display = 'none';
        }
    }, VIEWER_TIMEOUT);

    // Th√™m check ƒë·ªãnh k·ª≥ ƒë·ªÉ ph√°t hi·ªán khi iframe load xong
    let checkInterval = setInterval(() => {
        try {
            // N·∫øu iframe c√≥ content ho·∫∑c kh√¥ng c√≤n loading
            if (frame.contentDocument || frame.contentWindow) {
                clearTimeout(timeout);
                clearInterval(checkInterval);
                msFrameLoaded = true;
                loading.style.display = 'none';
                frame.style.display = 'block';
                error.style.display = 'none';
            }
        } catch (e) {
            // Cross-origin: iframe ƒë√£ load nh∆∞ng kh√¥ng access ƒë∆∞·ª£c
            // ƒê√¢y l√† d·∫•u hi·ªáu t·ªët - nghƒ©a l√† viewer ƒë√£ load
            clearTimeout(timeout);
            clearInterval(checkInterval);
            msFrameLoaded = true;
            loading.style.display = 'none';
            frame.style.display = 'block';
            error.style.display = 'none';
        }
    }, 1000);

    frame.onload = function() {
        clearTimeout(timeout);
        clearInterval(checkInterval);
        msFrameLoaded = true;
        loading.style.display = 'none';
        frame.style.display = 'block';
        error.style.display = 'none';
    };

    frame.onerror = function() {
        clearTimeout(timeout);
        clearInterval(checkInterval);
        loading.style.display = 'none';
        error.style.display = 'block';
        frame.style.display = 'none';
    };
}

function updateActiveButton(index) {
    const buttons = document.querySelectorAll('.viewer-tabs .btn');
    buttons.forEach((btn, i) => {
        if (i === index) {
            btn.classList.remove('btn-outline-primary', 'btn-outline-secondary');
            btn.classList.add('btn-primary', 'active');
        } else {
            btn.classList.remove('btn-primary', 'active');
            if (i === 0) {
                btn.classList.add('btn-outline-primary');
            } else {
                btn.classList.add('btn-outline-secondary');
            }
        }
    });
}

function showPdfError() {
    document.getElementById('pdfViewer').style.display = 'none';
    document.getElementById('pdfError').style.display = 'block';
}

// Auto-load Microsoft Viewer khi trang load
window.addEventListener('load', function() {
    {% if file_type in ['word', 'excel'] %}
    loadMicrosoftViewer();
    {% endif %}
});
</script>
{% endif %}
{% endblock %}