{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Fix card header responsive */
.card-header h5 {
    font-size: 1.1rem;
    margin: 0;
    line-height: 1.4;
    word-break: keep-all;
    overflow-wrap: break-word;
}

.card-header h5 i {
    flex-shrink: 0;
    margin-right: 8px;
}

/* Mobile: giảm font-size cho header */
@media (max-width: 576px) {
    .card-header h5 {
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .card-header h5 i {
        font-size: 1rem;
        margin-right: 4px;
    }
}

/* Đảm bảo table responsive không overflow */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Stats cards responsive */
@media (max-width: 768px) {
    .card-title {
        font-size: 0.9rem;
    }

    .card-body h2 {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar-range"></i> Từ ngày:</label>
                <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="bi bi-calendar-range"></i> Đến ngày:</label>
                <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
            </div>
            {% if current_user.role in ['director', 'manager'] %}
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-person"></i> Người được giao nhiệm vụ:</label>
                <select class="form-select" name="assigned_user">
                    <option value="">-- Tất cả --</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {% if assigned_user == user.id|string %}selected{% endif %}>
                        {{ user.full_name }} ({{ user.role | role_vn }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel"></i> Lọc
                </button>
                <a href="{{ url_for('tasks.dashboard') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Xóa
                </a>
            </div>
        </form>
    </div>
</div>

{% if current_user.role in ['director', 'manager'] %}
<!-- Director/Manager Dashboard -->
<div class="row mb-4">
    <div class="col-md-3 col-6 mb-3 mb-md-0">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Tổng Nhiệm Vụ</h5>
                <h2>{{ total_tasks }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3 mb-md-0">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">Chờ xử lý</h5>
                <h2>{{ pending }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Đang thực hiện</h5>
                <h2>{{ in_progress }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Hoàn thành</h5>
                <h2>{{ done }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Tasks cá nhân của Director/Manager -->
{% if my_personal_tasks %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-person-check-fill"></i> Nhiệm vụ của bạn
                    <span class="badge bg-light text-primary ms-2">{{ my_personal_tasks|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for task in my_personal_tasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}">
                                <strong>{{ task.title }}</strong>
                            </a>
                            {% if task | is_overdue %}
                            <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                            {% endif %}
                            <br>
                            <small class="text-muted">
                                {% if task.due_date %}
                                <i class="bi bi-calendar-event"></i> Hạn: {{ task.due_date | vn_datetime('%d/%m/%Y %H:%M') }}
                                {% endif %}
                            </small>
                        </div>
                        <span class="badge bg-{{ task.status | status_badge }}">
                            {{ task.status | status_vn }}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- NHIỆM VỤ QUÁ HẠN - CHỈ HIỂN THỊ NẾU CÓ -->
{% if overdue_tasks %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> Nhiệm vụ quá hạn
                    <span class="badge bg-light text-danger ms-2">{{ overdue_tasks|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nhiệm Vụ</th>
                                <th>Tạo Bởi</th>
                                <th>Hạn Chót</th>
                                <th>Trạng Thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in overdue_tasks %}
                            <tr class="table-danger">
                                <td data-label="Nhiệm Vụ">
                                    <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}" class="text-danger fw-bold">
                                        {{ task.title }}
                                    </a>
                                    <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-people-fill"></i> Người làm:
                                        {% if task.assignments.count() > 0 %}
                                            {% set accepted_list = [] %}
                                            {% set pending_list = [] %}
                                            {% for assignment in task.assignments %}
                                                {% if assignment.accepted %}
                                                    {% set _ = accepted_list.append(assignment.user.full_name) %}
                                                {% else %}
                                                    {% set _ = pending_list.append(assignment.user.full_name + ' (chưa xác nhận)') %}
                                                {% endif %}
                                            {% endfor %}
                                            {{ (accepted_list + pending_list)|join(', ') }}
                                        {% else %}
                                            <span class="text-warning">Chưa gán</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td data-label="Tạo Bởi">
                                    <small>{{ task.creator.full_name }}</small>
                                </td>
                                <td data-label="Hạn Chót">
                                    <span class="badge bg-danger">
                                        {{ task.due_date | vn_datetime('%d/%m %H:%M') }}
                                    </span>
                                </td>
                                <td data-label="Trạng Thái">
                                    <span class="badge bg-{{ task.status | status_badge }}">
                                        {{ task.status | status_vn }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="bi bi-calendar-event"></i>
                    <span>Tất cả nhiệm vụ sắp đến hạn</span>
                </h5>
            </div>
            <div class="card-body">
                {% if upcoming %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nhiệm Vụ</th>
                                <th>Tạo Bởi</th>
                                <th>Hạn Chót</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in upcoming %}
                            <tr>
                                <td data-label="Nhiệm Vụ">
                                    <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}">
                                        {{ task.title }}
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-people-fill"></i> Người làm:
                                        {% if task.assignments.count() > 0 %}
                                            {% set accepted_list = [] %}
                                            {% set pending_list = [] %}
                                            {% for assignment in task.assignments %}
                                                {% if assignment.accepted %}
                                                    {% set _ = accepted_list.append(assignment.user.full_name) %}
                                                {% else %}
                                                    {% set _ = pending_list.append(assignment.user.full_name + ' (chưa xác nhận)') %}
                                                {% endif %}
                                            {% endfor %}
                                            {{ (accepted_list + pending_list)|join(', ') }}
                                        {% else %}
                                            <span class="text-warning">Chưa gán</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td data-label="Tạo Bởi">
                                    <small>{{ task.creator.full_name }}</small>
                                </td>
                                <td data-label="Hạn Chót">
                                    <span class="badge bg-warning">
                                        {{ task.due_date | vn_datetime('%d/%m %H:%M') }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">Không có task nào sắp đến hạn.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="bi bi-clock-history"></i>
                    <span>Hoạt động gần đây</span>
                </h5>
            </div>
            <div class="card-body">
                {% if recent_tasks %}
                <div class="list-group list-group-flush">
                    {% for task in recent_tasks %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div class="flex-grow-1">
                               Nhiệm vụ:
                                <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}" class="fw-bold">
                                   {{ task.title }}
                                </a>
                                {% if task | is_overdue %}
                                <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                                {% endif %}
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> Tạo bởi: {{ task.creator.full_name }}
                                    {% if task.assignments.count() > 0 %}
                                    <br>
                                    <i class="bi bi-people-fill"></i> Giao cho:
                                    {% set assigned_names = [] %}
                                    {% set pending_names = [] %}

                                    {% for assignment in task.assignments %}
                                        {% if assignment.accepted %}
                                            {% set _ = assigned_names.append(assignment.user.full_name) %}
                                        {% else %}
                                            {% set _ = pending_names.append(assignment.user.full_name) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if assigned_names %}
                                        {{ assigned_names|join(', ') }}
                                    {% elif pending_names %}
                                        <span class="text-danger">
                                            Đang chờ xác nhận của {{ pending_names|join(', ') }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Chưa có người được giao</span>
                                    {% endif %}

                                    {% endif %}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ task.status | status_badge }}">
                                    {{ task.status | status_vn }}
                                </span>
                                <br>
                                <small class="text-muted">
                                    {{ task.updated_at | vn_datetime('%d/%m vào lúc %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">Chưa có hoạt động nào.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Accountant/HR Dashboard -->
<div class="row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-list-check"></i> Nhiệm vụ của tôi</h5>
            </div>
            <div class="card-body">
                {% if my_tasks %}
                <ul class="list-group">
                    {% for task in my_tasks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}">{{ task.title }}</a>
                            {% if task | is_overdue %}
                            <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                            {% endif %}
                            <br>
                            <small class="text-muted">
                                {% if task.due_date %}
                                <i class="bi bi-calendar-event"></i> Hạn: {{ task.due_date | vn_datetime('%d/%m/%Y %H:%M') }}
                                {% endif %}
                            </small>
                        </div>
                        <span class="badge bg-{{ task.status | status_badge }}">
                            {{ task.status | status_vn }}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Bạn chưa có task nào.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="bi bi-inbox"></i> Tasks chờ chấp nhận</h5>
            </div>
            <div class="card-body">
                {% if pending_assignments %}
                <ul class="list-group">
                    {% for assignment in pending_assignments %}
                    <li class="list-group-item">
                        <a href="{{ url_for('tasks.task_detail', task_id=assignment.task_id) }}">
                            {{ assignment.task.title }}
                        </a>
                        <br>
                        <small class="text-muted">Gán bởi: {{ assignment.assigner.full_name }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Không có task nào chờ chấp nhận.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- NHIỆM VỤ QUÁ HẠN cho HR/Accountant -->
{% if overdue_tasks %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> Nhiệm vụ của bạn đã quá hạn
                    <span class="badge bg-light text-danger ms-2">{{ overdue_tasks|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Người gán</th>
                                <th>Hạn</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in overdue_tasks %}
                            <tr class="table-danger">
                                <td data-label="Task">
                                    <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}" class="text-danger fw-bold">
                                        {{ task.title }}
                                    </a>
                                    <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                                </td>
                                <td data-label="Người gán">
                                    <small>{{ task.creator.full_name }}</small>
                                </td>
                                <td data-label="Hạn">
                                    <span class="badge bg-danger">
                                        {{ task.due_date | vn_datetime('%d/%m %H:%M') }}
                                    </span>
                                </td>
                                <td data-label="Trạng thái">
                                    <span class="badge bg-{{ task.status | status_badge }}">
                                        {{ task.status | status_vn }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tasks sắp đến hạn cho HR/Accountant -->
{% if upcoming %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-event"></i> Tasks của bạn sắp đến hạn (7 ngày)
                    <span class="badge bg-dark ms-2">{{ upcoming|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Người gán</th>
                                <th>Hạn</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in upcoming %}
                            <tr>
                                <td data-label="Task">
                                    <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}">
                                        <strong>{{ task.title }}</strong>
                                    </a>
                                </td>
                                <td data-label="Người gán">
                                    <small>{{ task.creator.full_name }}</small>
                                </td>
                                <td data-label="Hạn">
                                    <span class="badge bg-warning">
                                        {{ task.due_date | vn_datetime('%d/%m %H:%M') }}
                                    </span>
                                </td>
                                <td data-label="Trạng thái">
                                    <span class="badge bg-{{ task.status | status_badge }}">
                                        {{ task.status | status_vn }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-journal-text"></i> Ghi chú gần đây</h5>
            </div>
            <div class="card-body">
                {% if recent_notes %}
                <ul class="list-group">
                    {% for note in recent_notes %}
                    <li class="list-group-item">
                        <a href="{{ url_for('notes.edit_note', note_id=note.id) }}">{{ note.title }}</a>
                        <br>
                        <small class="text-muted">{{ note.updated_at | vn_datetime }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Bạn chưa có ghi chú nào.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}