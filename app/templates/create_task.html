{% extends "base.html" %}

{% block title %}T·∫°o task m·ªõi{% endblock %}
{% block page_title %}T·∫°o C√¥ng vi·ªác M·ªõi{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-plus-circle"></i> Nhi·ªám v·ª• m·ªõi</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="mb-3">
                <label for="title" class="form-label">Ti√™u ƒë·ªÅ *</label>
                <div style="position: relative;">
                    <input type="text" class="form-control" id="title" name="title" required maxlength="35" style="padding-right: 50px;">
                    <small class="text-muted" style="position: absolute; right: 10px; top: 35%; transform: translateY(-50%); pointer-events: none; font-size: 0.8rem; font-weight: 200;">
                        <span id="char_count">35</span>
                    </small>
                </div>
            </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="due_date" class="form-label">H·∫°n ho√†n th√†nh (Ng√†y v√† gi·ªù)</label>
                        <input type="datetime-local" class="form-control" id="due_date" name="due_date">
                        <small class="text-muted">Ch·ªçn c·∫£ ng√†y v√† gi·ªù h·∫°n ho√†n th√†nh</small>
                    </div>

                    <!-- Tags - Hi·ªán cho T·∫§T C·∫¢ user khi t·ª± giao cho m√¨nh -->
                    <div class="mb-3" id="tags_section" style="display: none;">
                        <label class="form-label">
                            <i class="bi bi-tags"></i> Ph√¢n Lo·∫°i Nhi·ªám V·ª•
                        </label>
                        <div class="border rounded p-3 bg-light">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="is_urgent" id="is_urgent">
                                <label class="form-check-label" for="is_urgent">
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i> KH·∫®N C·∫§P
                                    </span>
                                    <small class="text-muted ms-2">Nhi·ªám v·ª• c·∫ßn x·ª≠ l√Ω ngay</small>
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="is_important" id="is_important">
                                <label class="form-check-label" for="is_important">
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-star-fill"></i> QUAN TR·ªåNG
                                    </span>
                                    <small class="text-muted ms-2">Nhi·ªám v·ª• n·∫±m trong k·∫ø ho·∫°ch</small>
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_recurring" id="is_recurring">
                                <label class="form-check-label" for="is_recurring">
                                    <span class="badge bg-info text-dark">
                                        <i class="bi bi-arrow-repeat"></i> L·∫∂P L·∫†I
                                    </span>
                                    <small class="text-muted ms-2">Nhi·ªám v·ª• ƒë·ªãnh k·ª≥, l·∫∑p l·∫°i</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Recurrence - CH·ªà cho Director/Manager -->
                    {% if current_user.can_assign_tasks() %}
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-arrow-clockwise"></i> T·ª± ƒë·ªông l·∫∑p l·∫°i
                        </label>
                        <div class="border rounded p-3 bg-light">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="recurrence_enabled" id="recurrence_enabled">
                                <label class="form-check-label" for="recurrence_enabled">
                                    <strong>B·∫≠t t·ª± ƒë·ªông giao l·∫°i nhi·ªám v·ª•</strong>
                                </label>
                            </div>

                            <!-- OPTIONS CH·ªà HI·ªÜN KHI B·∫¨T -->
                            <div id="recurrence_options" style="display: none;">

                                <!-- CH·ªåN LO·∫†I: INTERVAL hay WEEKLY -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Ch·ªçn ki·ªÉu l·∫∑p l·∫°i:</label>

                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="recurrence_type" id="type_interval" value="interval" checked>
                                        <label class="form-check-label" for="type_interval">
                                            üìÖ Chu k·ª≥ c·ªë ƒë·ªãnh (7/14/30 ng√†y)
                                        </label>
                                    </div>

                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="recurrence_type" id="type_weekly" value="weekly">
                                        <label class="form-check-label" for="type_weekly">
                                            üìÜ L·∫∑p theo ng√†y trong tu·∫ßn
                                        </label>
                                    </div>
                                </div>

                                <!-- INTERVAL OPTIONS (c≈©) -->
                                <div id="interval_options" class="mb-3">
                                    <label class="form-label small">Chu k·ª≥ l·∫∑p l·∫°i:</label>
                                    <select class="form-select form-select-sm" name="recurrence_interval_days" id="recurrence_interval_days">
                                        <option value="7" selected>H√†ng tu·∫ßn (7 ng√†y)</option>
                                        <option value="14">2 tu·∫ßn (14 ng√†y)</option>
                                        <option value="30">H√†ng th√°ng (30 ng√†y)</option>
                                    </select>
                                    <div class="alert alert-info small mt-2 mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        Khi b·∫≠t, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o nhi·ªám v·ª• m·ªõi theo chu k·ª≥ ƒë√£ ch·ªçn.
                                    </div>
                                </div>

                                <!-- WEEKLY OPTIONS  -->
                                <div id="weekly_options" style="display: none;">

                                    <!-- Ch·ªçn c√°c ng√†y -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Ch·ªçn c√°c ng√†y trong tu·∫ßn:</label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="0" id="day_mon">
                                                <label class="form-check-label" for="day_mon">Th·ª© 2</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="1" id="day_tue">
                                                <label class="form-check-label" for="day_tue">Th·ª© 3</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="2" id="day_wed">
                                                <label class="form-check-label" for="day_wed">Th·ª© 4</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="3" id="day_thu">
                                                <label class="form-check-label" for="day_thu">Th·ª© 5</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="4" id="day_fri">
                                                <label class="form-check-label" for="day_fri">Th·ª© 6</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="5" id="day_sat">
                                                <label class="form-check-label" for="day_sat">Th·ª© 7</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="recurrence_weekdays[]" value="6" id="day_sun">
                                                <label class="form-check-label" for="day_sun">Ch·ªß nh·∫≠t</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ch·ªçn gi·ªù -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">‚è∞ Th·ªùi gian t·∫°o nhi·ªám v·ª•:</label>
                                        <input type="time" class="form-control form-control-sm" name="recurrence_time" id="recurrence_time" value="09:00">
                                        <small class="text-muted">Nhi·ªám v·ª• s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o v√†o gi·ªù n√†y (khuy√™n ch·ªçn gi·ªù tr√≤n)</small>
                                    </div>

                                    <!-- Th·ªùi h·∫°n ho√†n th√†nh -->
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">üìÖ H·∫°n ho√†n th√†nh sau:</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" name="recurrence_duration_days" id="recurrence_duration_days" value="2" min="1" max="30">
                                            <span class="input-group-text">ng√†y</span>
                                        </div>
                                        <small class="text-muted">Nhi·ªám v·ª• ph·∫£i ho√†n th√†nh trong bao nhi√™u ng√†y</small>
                                    </div>

                                    <!-- Preview -->
                                    <div class="alert alert-info small mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        <span id="weekly_preview">
                                            Nhi·ªám v·ª• s·∫Ω t·ª± ƒë·ªông t·∫°o v√†o c√°c ng√†y ƒë√£ ch·ªçn l√∫c 09:00, h·∫°n ho√†n th√†nh sau 2 ng√†y.
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- ASSIGNMENT OPTIONS -->
                    <div class="mb-3">
                        <label class="form-label">Giao cho</label>

                        <!-- Option 1: Self -->
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="assign_type" id="assign_self" value="self" checked>
                            <label class="form-check-label" for="assign_self">
                                T·ª± Giao cho m√¨nh
                            </label>
                        </div>

                        {% if current_user.can_assign_tasks() %}
                        <!-- Option 2: Single User -->
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="assign_type" id="assign_user" value="user">
                            <label class="form-check-label" for="assign_user">
                                Giao cho 1 ng∆∞·ªùi c·ª• th·ªÉ
                            </label>
                        </div>
                        <select class="form-select mt-2" id="assign_to_user" name="assign_to_user" disabled>
                            <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name }} ({{ user.role | role_vn }})</option>
                            {% endfor %}
                        </select>

                        <div class="form-check mt-3">
                            <input class="form-check-input" type="radio" name="assign_type" id="assign_multiple" value="multiple">
                            <label class="form-check-label" for="assign_multiple">
                                <strong>Giao cho nhi·ªÅu ng∆∞·ªùi t√πy ch·ªçn</strong>
                            </label>
                        </div>
                        <div id="assign_multiple_container" class="mt-2 border rounded p-3 bg-light" style="display: none; max-height: 300px; overflow-y: auto;">
                            {% for user in users %}
                            <div class="form-check">
                                <input class="form-check-input user-checkbox" type="checkbox"
                                       name="assign_to_multiple[]"
                                       value="{{ user.id }}"
                                       id="user_{{ user.id }}"
                                       disabled>
                                <label class="form-check-label" for="user_{{ user.id }}">
                                    <strong>{{ user.full_name }}</strong>
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Option 4: Group -->
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="radio" name="assign_type" id="assign_group" value="group">
                            <label class="form-check-label" for="assign_group">
                                Giao cho c·∫£ nh√≥m
                            </label>
                        </div>
                        <select class="form-select mt-2" id="assign_to_group" name="assign_to_group" disabled>
                            <option value="">-- Ch·ªçn nh√≥m --</option>
                            <option value="manager">Tr∆∞·ªüng ph√≤ng</option>
                            <option value="accountant">K·∫ø to√°n</option>
                            <option value="hr">Nh√¢n vi√™n</option>
                        </select>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> T·∫°o nhi·ªám v·ª•
                        </button>
                        <a href="{{ url_for('tasks.list_tasks') }}" class="btn btn-secondary">H·ªßy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal c·∫£nh b√°o m√¥ t·∫£ qu√° d√†i -->
<div class="modal fade" id="descriptionWarningModal" tabindex="-1" aria-labelledby="descriptionWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="descriptionWarningModalLabel">
                    <i class="bi bi-exclamation-triangle-fill"></i> C·∫£nh b√°o: M√¥ t·∫£ qu√° d√†i
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2"><strong>M√¥ t·∫£ c·ªßa b·∫°n ƒë√£ v∆∞·ª£t qu√° 80 t·ª´!</strong></p>
                <p class="mb-2">S·ªë t·ª´ hi·ªán t·∫°i: <span id="currentWordCount" class="text-danger fw-bold">0</span> t·ª´</p>
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-info-circle"></i>
                    <strong>L∆∞u √Ω:</strong> S·∫øp S·∫º kh√¥ng duy·ªát n·∫øu b·∫°n vi·∫øt m√¥ t·∫£ qu√° d√†i.
                    H√£y c·ªë g·∫Øng di·ªÖn ƒë·∫°t ng·∫Øn g·ªçn, s√∫c t√≠ch v√† ƒëi th·∫≥ng v√†o v·∫•n ƒë·ªÅ.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-pencil"></i> Ch·ªânh s·ª≠a l·∫°i
                </button>
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal" id="continueAnyway">
                    <i class="bi bi-check-circle"></i> Ti·∫øp t·ª•c t·∫°o
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% if current_user.can_assign_tasks() %}
    // =====  RECURRENCE TOGGLE =====
    const recurrenceEnabled = document.getElementById('recurrence_enabled');
    const recurrenceOptions = document.getElementById('recurrence_options');
    const typeInterval = document.getElementById('type_interval');
    const typeWeekly = document.getElementById('type_weekly');
    const intervalOptions = document.getElementById('interval_options');
    const weeklyOptions = document.getElementById('weekly_options');

    // B·∫≠t/t·∫Øt options
    recurrenceEnabled.addEventListener('change', function() {
        recurrenceOptions.style.display = this.checked ? 'block' : 'none';
    });

    // Chuy·ªÉn ƒë·ªïi gi·ªØa interval v√† weekly
    function toggleRecurrenceType() {
        if (typeInterval.checked) {
            intervalOptions.style.display = 'block';
            weeklyOptions.style.display = 'none';
        } else if (typeWeekly.checked) {
            intervalOptions.style.display = 'none';
            weeklyOptions.style.display = 'block';
        }
    }

    typeInterval.addEventListener('change', toggleRecurrenceType);
    typeWeekly.addEventListener('change', toggleRecurrenceType);

    // =====  PREVIEW WEEKLY RECURRENCE =====
    const weekdayCheckboxes = document.querySelectorAll('input[name="recurrence_weekdays[]"]');
    const recurrenceTime = document.getElementById('recurrence_time');
    const recurrenceDuration = document.getElementById('recurrence_duration_days');
    const weeklyPreview = document.getElementById('weekly_preview');

    function updateWeeklyPreview() {
        const selectedDays = Array.from(weekdayCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => {
                const labels = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß nh·∫≠t'];
                return labels[parseInt(cb.value)];
            });

        const time = recurrenceTime.value || '09:00';
        const duration = recurrenceDuration.value || '2';

        if (selectedDays.length === 0) {
            weeklyPreview.textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ng√†y trong tu·∫ßn.';
            weeklyPreview.parentElement.className = 'alert alert-warning small mb-0';
        } else {
            weeklyPreview.textContent = `Task s·∫Ω t·ª± ƒë·ªông t·∫°o v√†o ${selectedDays.join(', ')} l√∫c ${time}, h·∫°n ho√†n th√†nh sau ${duration} ng√†y.`;
            weeklyPreview.parentElement.className = 'alert alert-info small mb-0';
        }
    }

    weekdayCheckboxes.forEach(cb => cb.addEventListener('change', updateWeeklyPreview));
    recurrenceTime.addEventListener('change', updateWeeklyPreview);
    recurrenceDuration.addEventListener('input', updateWeeklyPreview);
    {% endif %}

    // Character counter for title
    const titleInput = document.getElementById('title');
    const charCount = document.getElementById('char_count');

    titleInput.addEventListener('input', function() {
        const remaining = 35 - this.value.length;
        charCount.textContent = remaining;
        charCount.style.color = remaining < 20 ? 'red' : '';
    });

    // ===== WORD COUNTER CHO M√î T·∫¢ (CH·ªà √ÅP D·ª§NG CHO NON-DIRECTOR) =====
    {% if current_user.role != 'director' %}
    const descriptionTextarea = document.getElementById('description');
    let wordCountWarningShown = false;
    let allowSubmitWithLongDescription = false; // FLAG ƒê·ªÇ B·ªé QUA VALIDATION

    // H√†m ƒë·∫øm t·ª´ (t√°ch theo kho·∫£ng tr·∫Øng v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a)
    function countWords(text) {
        text = text.trim();
        if (text === '') return 0;
        return text.split(/\s+/).length;
    }

    // Ki·ªÉm tra khi ng∆∞·ªùi d√πng nh·∫≠p
    descriptionTextarea.addEventListener('input', function() {
        const wordCount = countWords(this.value);

        // N·∫øu v∆∞·ª£t 80 t·ª´ v√† ch∆∞a hi·ªán c·∫£nh b√°o
        if (wordCount > 80 && !wordCountWarningShown) {
            document.getElementById('currentWordCount').textContent = wordCount;
            const modal = new bootstrap.Modal(document.getElementById('descriptionWarningModal'));
            modal.show();
            wordCountWarningShown = true;
        }

        // Reset c·ªù n·∫øu ng∆∞·ªùi d√πng gi·∫£m xu·ªëng d∆∞·ªõi 80 t·ª´
        if (wordCount <= 80) {
            wordCountWarningShown = false;
            allowSubmitWithLongDescription = false; // Reset flag khi ƒë√£ s·ª≠a
        }
    });

    // ===== KI·ªÇM TRA L·∫†I KHI SUBMIT FORM =====
    document.querySelector('form').addEventListener('submit', function(e) {
        const wordCount = countWords(descriptionTextarea.value);

        // N·∫øu v∆∞·ª£t 80 t·ª´ V√Ä ch∆∞a ƒë∆∞·ª£c ph√©p submit
        if (wordCount > 80 && !allowSubmitWithLongDescription) {
            e.preventDefault(); // Ch·∫∑n submit
            document.getElementById('currentWordCount').textContent = wordCount;
            const modal = new bootstrap.Modal(document.getElementById('descriptionWarningModal'));
            modal.show();

            // N·∫øu ng∆∞·ªùi d√πng ch·ªçn "Ti·∫øp t·ª•c t·∫°o", cho ph√©p submit
            document.getElementById('continueAnyway').onclick = function() {
                allowSubmitWithLongDescription = true; // ƒê·∫∑t flag = true
                document.querySelector('form').submit(); // Submit l·∫°i
            };
        }
        // N·∫øu ƒë√£ ƒë∆∞·ª£c ph√©p ho·∫∑c <= 80 t·ª´ ‚Üí submit b√¨nh th∆∞·ªùng
    });
    {% endif %}

    // Assignment type toggle
    document.querySelectorAll('input[name="assign_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Disable t·∫•t c·∫£
            document.getElementById('assign_to_user').disabled = true;
            document.getElementById('assign_to_group').disabled = true;
            document.getElementById('assign_multiple_container').style.display = 'none';
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.disabled = true);

            // ===== HI·ªÜN/·∫®N PH·∫¶N TAGS =====
            const tagsSection = document.getElementById('tags_section');

            if (this.value === 'self') {
                // T·ª± giao cho m√¨nh ‚Üí HI·ªÜN tags cho T·∫§T C·∫¢ user
                tagsSection.style.display = 'block';
            } else {
                // Giao cho ng∆∞·ªùi kh√°c ‚Üí CH·ªà hi·ªán tags cho Director/Manager
                {% if current_user.can_assign_tasks() %}
                tagsSection.style.display = 'block';
                {% else %}
                tagsSection.style.display = 'none';
                {% endif %}
            }

            // Enable theo l·ª±a ch·ªçn
            if (this.value === 'user') {
                document.getElementById('assign_to_user').disabled = false;
            } else if (this.value === 'group') {
                document.getElementById('assign_to_group').disabled = false;
            } else if (this.value === 'multiple') {
                document.getElementById('assign_multiple_container').style.display = 'block';
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.disabled = false);
            }
        });
    });

    // ===== TRIGGER L·∫¶N ƒê·∫¶U KHI LOAD TRANG =====
    // M·∫∑c ƒë·ªãnh "self" ƒë∆∞·ª£c ch·ªçn ‚Üí hi·ªán tags
    document.getElementById('tags_section').style.display = 'block';
</script>
{% endblock %}