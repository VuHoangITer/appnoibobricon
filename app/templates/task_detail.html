{% extends "base.html" %}

{% block title %}Chi ti·∫øt Task{% endblock %}
{% block page_title %}Chi ti·∫øt C√¥ng vi·ªác{% endblock %}

{% block extra_css %}
<style>
:root {
    --ed-bg: #f5f7fb;
    --ed-card-bg: #ffffff;
    --ed-border: #e1e5ee;
    --ed-muted: #6c757d;
    --ed-text: #1f2933;
    --ed-primary: #0d6efd;
    --ed-primary-soft: #e7f1ff;
    --ed-danger-soft: #ffebee;
    --ed-radius-lg: 16px;
    --ed-radius-md: 10px;
    --ed-radius-pill: 999px;
}

/* N·ªÅn trang ki·ªÉu enterprise */
body {
    background: var(--ed-bg);
}

/* Card chung ‚Äì m·ªÅm, t·ªëi gi·∫£n h∆°n */
.card {
    border-radius: var(--ed-radius-lg);
    border: 1px solid var(--ed-border);
    background-color: var(--ed-card-bg);
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.05);
}

.card + .card {
    margin-top: 0.75rem;
}

/* Header card */
.card-header {
    border-bottom: 1px solid var(--ed-border);
    background: #4ba5ff;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

.card-header h4,
.card-header h5,
.card-header h6 {
    font-size: 0.98rem;
    font-weight: 600;
    color: var(--ed-text);
}

/* Badge tr·∫°ng th√°i nh·ªè g·ªçn h∆°n */
.badge {
    border-radius: var(--ed-radius-pill);
    font-weight: 500;
}

/* ====== OVERRIDE M√ÄU XANH L√Å ‚Üí XANH D∆Ø∆†NG SOFT ====== */

/* Header d√πng bg-success (B√°o c√°o ho√†n th√†nh, ƒê√°nh gi√°...) ‚Üí header xanh d∆∞∆°ng nh·∫°t */
.card-header.bg-success {
    background-color: var(--ed-primary-soft) !important;
    color: var(--ed-primary) !important;
    border-bottom-color: transparent;
}

/* Badge success (ƒê√£ nh·∫≠n, T·ªët, Ho√†n th√†nh ƒë√∫ng h·∫°n...) ‚Üí soft blue */
.badge.bg-success {
    background-color: #198754 !important;
    color: #ffffff !important;
}

.text-success {
    color: #198754 !important;
}

/* N√∫t success (ch·∫•p nh·∫≠n, ƒë√°nh gi√° t·ªët...) ‚Üí xanh d∆∞∆°ng */
.btn-success {
    background-color: #198754 !important;
    border-color: #198754 !important;
    color: #ffffff !important;
}

.btn-success:hover,
.btn-success:focus {
    background-color: #0b5ed7 !important;
    border-color: #0b5ed7 !important;
    color: #ffffff !important;
}

/* (Gi·ªØ warning/v√†ng nguy√™n, ch·ªâ b·ªè vi·ªÅn d∆∞·ªõi) */
.card-header.bg-warning {
    border-bottom-color: transparent;
}

/* Avatar ng∆∞·ªùi giao / ƒë∆∞·ª£c giao / ng∆∞·ªùi ho√†n th√†nh / comment */
.assignment-avatar,
.completer-avatar,
.comment-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    background: #e9edf7;
    color: #4b5563;
    font-weight: 600;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #d0d7e2;
}

.assignment-avatar {
    width: 45px;
    height: 45px;
    font-size: 0.95rem;
}

.completer-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.assignment-avatar img,
.completer-avatar img,
.comment-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Khu v·ª±c comments */
.comments-section {
    max-height: 500px;
    overflow-y: auto;
    padding: 14px;
    background: #f9fafb;
    border-radius: var(--ed-radius-md);
    border: 1px solid var(--ed-border);
}

.comment-item {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e7eb;
}

.comment-item:last-child {
    margin-bottom: 0;
    border-bottom: none;
}

.comment-content {
    flex: 1;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.comment-author {
    font-weight: 600;
    color: var(--ed-text);
    font-size: 0.9rem;
}

.comment-time {
    font-size: 0.75rem;
    color: var(--ed-muted);
}

.comment-text {
    color: #4b5563;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 0.88rem;
}

.comment-actions .btn {
    border-radius: var(--ed-radius-pill);
}

/* Form comment */
#commentForm textarea {
    resize: none;
    border-radius: var(--ed-radius-md);
}

#commentForm .btn {
    border-radius: var(--ed-radius-pill);
}

#filePreview {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Alert */
.alert {
    border-radius: var(--ed-radius-md);
}

/* Th·∫ª ƒë√°nh d·∫•u (KH·∫®N C·∫§P / QUAN TR·ªåNG / L·∫∂P L·∫†I) */
.mb-3 .badge.bg-danger,
.mb-3 .badge.bg-warning,
.mb-3 .badge.bg-info {
    font-size: 0.78rem;
    padding: 5px 10px;
}

/* Th·∫ª tr·∫°ng th√°i h·∫°n ho√†n th√†nh */
.badge.bg-danger,
.badge.bg-secondary {
    font-size: 0.78rem;
    padding: 4px 10px;
}

/* N√∫t nh·ªè */
.btn-sm.rounded-circle {
    border-radius: 50% !important;
}

/* Responsive nh·∫π cho 2 c·ªôt cu·ªëi (attachments + comments) */
@media (max-width: 768px) {
    .comments-section {
        max-height: 350px;
    }

    .comment-input-wrapper {
        flex-direction: row;
    }
}
    /* Comment attachment styles */
.comment-attachment {
    margin-top: 8px;
}

.attachment-image-preview img {
    border-radius: var(--ed-radius-md);
    transition: transform 0.2s ease;
}

.attachment-image-preview img:hover {
    transform: scale(1.02);
}

.attachment-info .btn {
    border-radius: var(--ed-radius-pill);
    font-size: 0.85rem;
}

#filePreview {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}


{% block content %}
<div class="row">
    <!-- ===== C·ªòT TR√ÅI: TH√îNG TIN CH√çNH ===== -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-card-text"></i> {{ task.title }}
                    {% if task | is_overdue and task.status != 'DONE' %}
                    <span class="badge bg-danger ms-2">QU√Å H·∫†N</span>
                    {% endif %}
                    {% if task.status == 'DONE' and task.completed_overdue %}
                    <span class="badge bg-danger text-dark ms-1">
                        <i class="bi bi-exclamation-triangle-fill"></i>Qu√° h·∫°n
                    </span>
                    {% endif %}
                </h4>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-{{ task.status | status_badge }}" style="font-size: 0.9rem;">
                        {{ task.status | status_vn }}
                    </span>
                    {% if task.creator_id == current_user.id or current_user.role in ['director', 'manager'] %}
                    <form method="POST" action="{{ url_for('tasks.delete_task', task_id=task.id) }}"
                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nhi·ªám v·ª• n√†y?');" class="mb-0">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm rounded-circle"
                                style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                title="X√≥a nhi·ªám v·ª•">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if task.requires_approval %}
                <div class="alert {% if task.approved == None %}alert-warning{% elif task.approved %}alert-success{% else %}alert-danger{% endif %} mb-3">
                    <div class="d-flex align-items-center">
                        <!-- ===== TR·∫†NG TH√ÅI: ƒêANG CH·ªú DUY·ªÜT ===== -->
                        {% if task.approved == None %}
                            <i class="bi bi-hourglass-split fs-4 me-3"></i>
                            <div class="flex-grow-1">
                                <strong>Ch·ªù ph√™ duy·ªát</strong>
                            </div>
                            <!-- N√öT PH√ä DUY·ªÜT - CH·ªà HI·ªÜN CHO NG∆Ø·ªúI C√ì QUY·ªÄN -->
                            {% if current_user.role in ['manager', 'director'] %}
                                {% if current_user.role == 'director' or (current_user.role == 'manager' and task.creator.role == 'hr') %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="approveSelfTask({{ task.id }})">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectSelfTask({{ task.id }})">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                                {% endif %}
                            {% endif %}

                        {% elif task.approved %}
                            <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
                            <div>
                                <p class="mb-0 small">
                                    B·ªüi <strong>{{ task.approver.full_name }}</strong>
                                    l√∫c {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-muted">Ghi ch√∫: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>

                        <!-- ===== TR·∫†NG TH√ÅI: ƒê√É T·ª™ CH·ªêI ===== -->
                        {% else %}
                            <i class="bi bi-x-circle-fill fs-4 me-3 text-danger"></i>
                            <div>
                                <p class="mb-0 small">
                                    B·ªüi <strong>{{ task.approver.full_name }}</strong>
                                    l√∫c {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-danger">L√Ω do: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Th·∫ª ƒë√°nh d·∫•u -->
                <div class="mb-3">
                    <h6><i class="bi bi-tags-fill"></i> Th·∫ª ƒë√°nh d·∫•u:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if task.is_urgent %}
                        <span class="badge bg-danger" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-exclamation-triangle-fill"></i> KH·∫®N C·∫§P
                        </span>
                        {% endif %}
                        {% if task.is_important %}
                        <span class="badge bg-warning text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-star-fill"></i> QUAN TR·ªåNG
                        </span>
                        {% endif %}
                        {% if task.is_recurring %}
                        <span class="badge bg-info text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-arrow-repeat"></i> L·∫∂P L·∫†I
                        </span>
                        {% endif %}
                        {% if not task.is_urgent and not task.is_important and not task.is_recurring %}
                        <span class="text-muted"><i>Ch∆∞a c√≥ th·∫ª</i></span>
                        {% endif %}
                    </div>

                    {% if current_user.role in ['director', 'manager'] %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#updateTagsForm">
                            <i class="bi bi-pencil"></i> C·∫≠p nh·∫≠t th·∫ª
                        </button>
                        <div class="collapse mt-2" id="updateTagsForm">
                            <div class="card card-body bg-light">
                                <form method="POST" action="{{ url_for('tasks.update_tags', task_id=task.id) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_urgent" id="edit_is_urgent" {% if task.is_urgent %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_urgent">
                                            <span class="badge bg-danger">KH·∫®N C·∫§P</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_important" id="edit_is_important" {% if task.is_important %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_important">
                                            <span class="badge bg-warning text-dark">QUAN TR·ªåNG</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="is_recurring" id="edit_is_recurring" {% if task.is_recurring %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_recurring">
                                            <span class="badge bg-info text-dark">L·∫∂P L·∫†I</span>
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="bi bi-check-circle"></i> L∆∞u
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <hr>

                <!-- M√¥ t·∫£ -->
                <div class="mb-3">
                    <h6><i class="bi bi-file-text"></i> M√¥ t·∫£:</h6>
                    <p class="mb-0">{{ task.description or 'Kh√¥ng c√≥ m√¥ t·∫£' }}</p>
                </div>

                <hr>

                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="row">
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Ng∆∞·ªùi t·∫°o:</strong></p>
                        <p class="mb-0">{{ task.creator.full_name }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Ng√†y t·∫°o:</strong></p>
                        <p class="mb-0">{{ task.created_at | vn_datetime }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>H·∫°n ho√†n th√†nh:</strong></p>
                        {% if task.due_date %}
                        <span class="badge bg-{{ 'danger' if (task | is_overdue and task.status != 'DONE') else 'secondary' }}">
                            {{ task.due_date | vn_datetime('%H:%M - %d/%m/%Y') }}
                        </span>
                        {% else %}
                        <span class="text-muted">Ch∆∞a c√≥</span>
                        {% endif %}
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>C·∫≠p nh·∫≠t cu·ªëi:</strong></p>
                        <p class="mb-0">{{ task.updated_at | vn_datetime }}</p>
                    </div>
                </div>

                <!-- Th√¥ng tin Recurring -->
                {% if task.recurrence_enabled %}
                <hr>
                <div class="border-start border-primary border-3 ps-3 mb-3">
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-arrow-repeat"></i> T·ª± ƒë·ªông l·∫∑p l·∫°i
                    </h6>
                    <small class="text-muted">
                        <strong>Chu k·ª≥:</strong>
                        {% if task.recurrence_interval_days == 7 %}H√†ng tu·∫ßn
                        {% elif task.recurrence_interval_days == 14 %}2 tu·∫ßn
                        {% elif task.recurrence_interval_days == 30 %}H√†ng th√°ng
                        {% else %}{{ task.recurrence_interval_days }} ng√†y{% endif %}
                        {% if task.last_recurrence_date %}
                        <br><strong>L·∫ßn t·∫°o ti·∫øp theo:</strong> {{ task.last_recurrence_date | add_days(task.recurrence_interval_days) | vn_datetime }}
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <!-- Task con -->
                {% if task.parent_task_id %}
                <div class="border-start border-success border-3 ps-3 mb-3">
                    <small class="text-muted">
                        <i class="bi bi-link-45deg"></i> Nhi·ªám v·ª• l·∫∑p l·∫°i t·ª´
                        <a href="{{ url_for('tasks.task_detail', task_id=task.parent_task_id) }}">
                            #{{ task.parent_task_id }}
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- FORM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI -->
        {% if (user_assignment and user_assignment.accepted or task.creator_id == current_user.id or current_user.role in ['director', 'manager'])
              and (not task.requires_approval or task.approved == True or current_user.role in ['director', 'manager']) %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> C·∫≠p nh·∫≠t tr·∫°ng th√°i</h5>
            </div>
            <div class="card-body">
                <!-- Accept/Reject -->
                {% if user_assignment and not user_assignment.accepted and user_assignment.assigned_group %}
                <div class="alert alert-info">
                    <p class="mb-2"><strong>Nhi·ªám v·ª• ƒë∆∞·ª£c giao cho nh√≥m {{ user_assignment.assigned_group | role_vn }}</strong></p>
                    <p class="mb-3">B·∫°n c·∫ßn ch·∫•p nh·∫≠n ƒë·ªÉ hi·ªÉn th·ªã trong danh s√°ch c·ªßa m√¨nh.</p>
                    <form method="POST" action="{{ url_for('tasks.accept_task', task_id=task.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-circle"></i> Ch·∫•p nh·∫≠n
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.reject_task', task_id=task.id) }}" style="display: inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-x-circle"></i> T·ª´ ch·ªëi
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- C·∫£nh b√°o qu√° h·∫°n -->
                {% if (task | is_overdue) and task.status != 'DONE' %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Nhi·ªám v·ª• ƒë√£ qu√° h·∫°n!</strong> Ho√†n th√†nh s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n l√† "Qu√° h·∫°n".
                </div>
                {% endif %}

                <!-- Form -->
                <form method="POST" action="{{ url_for('tasks.update_status', task_id=task.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="status" class="form-label"><strong>Tr·∫°ng th√°i:</strong></label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="status" name="status" onchange="handleStatusChange()">
                                <option value="PENDING" {% if task.status == 'PENDING' %}selected{% endif %}>Ch∆∞a L√†m</option>
                                <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>ƒêang l√†m</option>
                                <option value="DONE" {% if task.status == 'DONE' %}selected{% endif %}>Ho√†n th√†nh</option>
                                <option value="CANCELLED" {% if task.status == 'CANCELLED' %}selected{% endif %}>ƒê√£ h·ªßy</option>
                            </select>
                            <button type="submit" class="btn btn-primary" style="min-width: 120px;">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3" id="completionNoteDiv" style="display: none;">
                        <label for="completion_note" class="form-label">
                            <strong><i class="bi bi-chat-left-text"></i> N·ªôi dung b√°o c√°o:</strong>
                        </label>
                        <textarea class="form-control" id="completion_note" name="completion_note" rows="3"
                                  placeholder="Nh·∫≠p b√°o c√°o..."></textarea>
                    </div>
                </form>

                <script>
                function handleStatusChange() {
                    const statusSelect = document.getElementById('status');
                    const completionNoteDiv = document.getElementById('completionNoteDiv');
                    const currentStatus = '{{ task.status }}';
                    if (statusSelect.value === 'DONE' && currentStatus !== 'DONE') {
                        completionNoteDiv.style.display = 'block';
                    } else {
                        completionNoteDiv.style.display = 'none';
                    }
                }
                document.addEventListener('DOMContentLoaded', handleStatusChange);
                </script>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ===== C·ªòT PH·∫¢I: NG∆Ø·ªúI ƒê∆Ø·ª¢C GIAO + CARDS PH·ª§ ===== -->
    <div class="col-md-4">
        <!-- Ng∆∞·ªùi ƒë∆∞·ª£c giao -->
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Ng∆∞·ªùi ƒë∆∞·ª£c giao</h6>
            </div>
            <div class="card-body">
                {% if assignments %}
                <ul class="list-group list-group-flush">
                    {% for assignment in assignments %}
                    <li class="list-group-item px-0">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="assignment-avatar">
                                {% if assignment.user.avatar %}
                                <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}" alt="">
                                {% else %}
                                {{ assignment.user.full_name[0].upper() }}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <strong class="d-block">{{ assignment.user.full_name }}</strong>
                                <small class="text-muted">{{ assignment.user.role | role_vn }}</small>
                            </div>
                            <div>
                                {% if assignment.accepted %}
                                <span class="badge bg-success">ƒê√£ nh·∫≠n</span>
                                {% else %}
                                <span class="badge bg-warning">Ch·ªù</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if assignment.assigned_group %}
                        <small class="text-muted">Nh√≥m: {{ assignment.assigned_group | role_vn }}</small>
                        {% endif %}
                        {% if assignment.accepted and assignment.accepted_at %}
                        <small class="text-muted d-block">{{ assignment.accepted_at | vn_datetime }}</small>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Ch∆∞a c√≥ ng∆∞·ªùi ƒë∆∞·ª£c g√°n</p>
                {% endif %}
            </div>
        </div>

        <!-- B√°o c√°o ho√†n th√†nh -->
        {% if task.status == 'DONE' %}
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-clipboard-check-fill"></i> B√°o c√°o ho√†n th√†nh</h6>
            </div>
            <div class="card-body">
                {% set reports = task.completion_reports.all() %}
                {% if reports %}
                {% set completion_report = reports[0] %}
                <div class="d-flex align-items-center gap-2 mb-3">
                    <div class="completer-avatar">
                        {% if completion_report.completer.avatar %}
                        <img src="{{ url_for('profile.get_avatar', filename=completion_report.completer.avatar) }}" alt="">
                        {% else %}
                        {{ completion_report.completer.full_name[0].upper() }}
                        {% endif %}
                    </div>
                    <div>
                        <strong class="d-block">{{ completion_report.completer.full_name }}</strong>
                        <small class="text-muted">{{ completion_report.completed_at | vn_datetime }}</small>
                    </div>
                </div>
                {% if completion_report.completion_time %}
                <p class="mb-2 small">
                    <strong>Th·ªùi gian:</strong>
                    {% set days = (completion_report.completion_time // 1440) %}
                    {% set hours = ((completion_report.completion_time % 1440) // 60) %}
                    {% set minutes = (completion_report.completion_time % 60) %}
                    {% if days > 0 %}{{ days }}ng√†y {% endif %}
                    {% if hours > 0 %}{{ hours }}gi·ªù {% endif %}{{ minutes }}ph√∫t
                </p>
                {% endif %}
                {% if completion_report.completion_note %}
                <p class="mb-0 small" style="white-space: pre-wrap;">{{ completion_report.completion_note }}</p>
                {% endif %}
                {% else %}
                <p class="text-muted small mb-0">Ho√†n th√†nh tr∆∞·ªõc khi c√≥ h·ªá th·ªëng b√°o c√°o</p>
                {% endif %}
            </div>
        </div>

        <!-- ƒê√°nh gi√° hi·ªáu su·∫•t -->
        <div class="card mb-3">
            <div class="card-header {% if task.performance_rating == 'good' %}bg-success{% elif task.performance_rating == 'bad' %}bg-danger{% else %}bg-secondary{% endif %} text-white">
                <h6 class="mb-0"><i class="bi bi-star-fill"></i> ƒê√°nh gi√°</h6>
            </div>
            <div class="card-body text-center">
                {% if task.performance_rating %}
                <div class="mb-3">
                    {% if task.performance_rating == 'good' %}
                    <i class="bi bi-hand-thumbs-up-fill text-success" style="font-size: 2.5rem;"></i>
                    {% else %}
                    <i class="bi bi-hand-thumbs-down-fill text-danger" style="font-size: 2.5rem;"></i>
                    {% endif %}
                </div>
                <small class="text-muted">{{ task.rated_at | vn_datetime }} - {{ task.rater.full_name }}</small>
                {% if current_user.role in ['director', 'manager'] %}
                <hr>
                <div class="d-flex gap-2 mt-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% endif %}
                {% else %}
                {% if current_user.role in ['director', 'manager'] %}
                <p class="text-muted small mb-3">H√£y ƒë√°nh gi√° hi·ªáu su·∫•t:</p>
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% else %}
                <p class="text-muted small mb-0">
                    <i class="bi bi-hourglass-split"></i> Ch·ªù ƒë√°nh gi√°
                </p>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ===== FULL WIDTH: TRAO ƒê·ªîI (B·ªé PH·∫¶N FILE ƒê√çNH K√àM) ===== -->
<div class="row mt-3">
    <!-- Trao ƒë·ªïi - FULL WIDTH -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Trao ƒë·ªïi</h6>
            </div>
            <div class="card-body">
                <div class="comments-section" id="commentsList">
                    {% for comment in sorted_comments %}
                    <div class="comment-item" data-id="{{ comment.id }}">
                        <div class="comment-avatar">
                            {% if comment.user.avatar %}
                            <img src="{{ url_for('profile.get_avatar', filename=comment.user.avatar) }}" alt="">
                            {% else %}
                            {{ comment.user.full_name[0].upper() }}
                            {% endif %}
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <div>
                                    <span class="comment-author">{{ comment.user.full_name }}</span>
                                    <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">{{ comment.user.role | role_vn }}</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="comment-time">{{ comment.created_at | vn_datetime }}</span>
                                    {% if comment.user_id == current_user.id or current_user.role == 'director' %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment({{ comment.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="comment-text">{{ comment.content }}</div>

                            <!--  HI·ªÇN TH·ªä FILE ƒê√çNH K√àM N·∫æU C√ì -->
                            {% if comment.has_attachment %}
                            <div class="comment-attachment mt-2">
                                {% if comment.attachment_file_type == 'image' %}
                                <!-- Preview ·∫£nh -->
                                <div class="attachment-image-preview">
                                    <img src="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id) }}"
                                         alt="{{ comment.attachment_original_filename }}"
                                         class="img-thumbnail"
                                         style="max-width: 300px; max-height: 300px; cursor: pointer;"
                                         onclick="window.open(this.src, '_blank')">
                                </div>
                                {% endif %}

                                <!-- Link download cho t·∫•t c·∫£ file -->
                                <div class="attachment-info mt-2">
                                    <a href="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id) }}"
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-{% if comment.attachment_file_type == 'image' %}image{% elif comment.attachment_file_type == 'pdf' %}file-pdf{% else %}file-earmark{% endif %}"></i>
                                        {{ comment.attachment_original_filename }}
                                        <small class="text-muted">({{ (comment.attachment_file_size / 1024) | round(1) }} KB)</small>
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center" id="noComments">Ch∆∞a c√≥ b√¨nh lu·∫≠n</p>
                    {% endfor %}
                </div>

                {% if user_assignment and user_assignment.accepted or task.creator_id == current_user.id or current_user.role in ['director', 'manager'] %}
                <form id="commentForm" enctype="multipart/form-data" class="mt-3">
                    <textarea class="form-control mb-2" id="commentInput" name="content" rows="2" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>

                    <!-- File attachment input + preview -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <label for="commentFileInput" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-paperclip"></i> ƒê√≠nh k√®m file
                            </label>
                            <input type="file" id="commentFileInput" name="file" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                        </div>

                        <button type="submit" class="btn btn-primary" id="btnAddComment">
                            <i class="bi bi-send"></i> G·ª≠i
                        </button>
                    </div>

                    <!-- Preview area -->
                    <div id="filePreview" class="mt-2" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center justify-content-between p-2 mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-file-earmark"></i>
                                <span id="filePreviewName"></span>
                                <small class="text-muted" id="filePreviewSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFileInput()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <!-- Image preview -->
                        <img id="imagePreview" style="max-width: 200px; max-height: 200px; display: none;" class="img-thumbnail">
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const TASK_ID = {{ task.id }};
const CONFIG = {
    TASK_ID: {{ task.id }},
    CURRENT_USER_ID: {{ current_user.id }},
    CURRENT_USER_ROLE: '{{ current_user.role }}',
    CSRF_TOKEN: '{{ csrf_token() }}'
};

const ROLE_MAP = {
    'director': 'Gi√°m ƒë·ªëc',
    'manager': 'Tr∆∞·ªüng ph√≤ng',
    'accountant': 'K·∫ø to√°n',
    'hr': 'Nh√¢n s·ª±'
};

let lastTimestamp = 0;
let knownCommentIds = new Set();
let isFirstPoll = true;

// DOM elements
const commentsList = document.getElementById('commentsList');
const commentInput = document.getElementById('commentInput');
const btnAddComment = document.getElementById('btnAddComment');

// Initialize known comment IDs
document.querySelectorAll('.comment-item[data-id]').forEach(el => {
    const id = parseInt(el.getAttribute('data-id'));
    knownCommentIds.add(id);
});

// ============================================
// FILE PREVIEW FOR COMMENT
// ============================================
const commentFileInput = document.getElementById('commentFileInput');
const filePreview = document.getElementById('filePreview');
const filePreviewName = document.getElementById('filePreviewName');
const filePreviewSize = document.getElementById('filePreviewSize');
const imagePreview = document.getElementById('imagePreview');

if (commentFileInput) {
    commentFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // Validate file
            if (!validateFile(file)) {
                clearFileInput();
                return;
            }

            // Show preview
            filePreviewName.textContent = file.name;
            filePreviewSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
            filePreview.style.display = 'block';

            // Show image preview if it's an image
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        }
    });
}

function validateFile(file) {
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
                         'application/pdf', 'application/msword',
                         'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                         'application/vnd.ms-excel',
                         'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                         'text/plain'];

    if (!allowedTypes.includes(file.type)) {
        showToast('Lo·∫°i file kh√¥ng ƒë∆∞·ª£c ph√©p', 'danger');
        return false;
    }

    if (file.size > 10 * 1024 * 1024) { // 10MB
        showToast('File qu√° l·ªõn (t·ªëi ƒëa 10MB)', 'danger');
        return false;
    }

    return true;
}

function clearFileInput() {
    if (commentFileInput) {
        commentFileInput.value = '';
        filePreview.style.display = 'none';
        imagePreview.style.display = 'none';
    }
}

// ============================================
// COMMENTS REAL-TIME
// ============================================
function startRealtimeComments() {
    console.log('üöÄ Starting real-time comments for task', TASK_ID);

    if (typeof window.sseManager === 'undefined') {
        console.warn('‚ö†Ô∏è SSE Manager not loaded, using polling fallback');
        startPollingFallback();
        return;
    }

    window.sseManager.connect(
        'task-comments',
        `/sse/tasks/${TASK_ID}/comments?last_timestamp=${lastTimestamp}`,
        {
            onOpen: () => {
                console.log('‚úÖ SSE Task Comments connected');
            },
            onError: (error, attempts) => {
                console.error('‚ùå SSE Task Comments error:', error, 'attempts:', attempts);
            },
            events: {
                'new_comments': (data) => {
                    console.log('[SSE] New comments:', data);
                    handleNewComments(data);
                },
                'comments_sync': (data) => {
                    console.log('[SSE] Comments sync:', data);
                    handleCommentsSync(data);
                },
                'heartbeat': () => {
                    console.log('üíì SSE comments heartbeat');
                }
            }
        },
        {
            url: `/tasks/${TASK_ID}/comments?_t=${Date.now()}`,
            interval: 3000,
            onData: (data) => {
                console.log('[POLLING] Fallback data:', data);
                if (data.success && data.comments && data.comments.length > 0) {
                    handleNewComments(data);
                }
            }
        }
    );
}

function startPollingFallback() {
    console.log('üîÑ Starting polling fallback (3s interval)');
    pollComments();
    setInterval(pollComments, 3000);
}

async function pollComments() {
    try {
        const response = await fetch(`/tasks/${TASK_ID}/comments?_t=${Date.now()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();

        if (data.success) {
            if (isFirstPoll && data.comments && data.comments.length > 0) {
                let maxTimestamp = lastTimestamp;
                data.comments.forEach(c => {
                    if (c.created_at_timestamp) {
                        maxTimestamp = Math.max(maxTimestamp, c.created_at_timestamp);
                    }
                });
                lastTimestamp = maxTimestamp;
                isFirstPoll = false;
                return;
            }

            isFirstPoll = false;

            const newComments = data.comments.filter(c =>
                !knownCommentIds.has(c.id) && c.created_at_timestamp > lastTimestamp
            );

            if (newComments.length > 0) {
                handleNewComments({ comments: newComments, total: data.total });
            }

            const serverIds = new Set(data.comments.map(c => c.id));
            handleCommentsSync({ existing_ids: Array.from(serverIds), total_count: data.total });
        }
    } catch (error) {
        console.error('[POLLING] Error:', error);
    }
}

function handleNewComments(data) {
    console.log('[HANDLER] Processing', data.comments.length, 'new comments');

    data.comments.forEach(comment => {
        if (!knownCommentIds.has(comment.id)) {
            console.log('[HANDLER] Adding new comment ID:', comment.id);
            addCommentToList(comment);
            knownCommentIds.add(comment.id);

            if (comment.created_at_timestamp) {
                lastTimestamp = Math.max(lastTimestamp, comment.created_at_timestamp);
            }
        }
    });
}

function handleCommentsSync(data) {
    const existingIds = new Set(data.existing_ids);

    knownCommentIds.forEach(id => {
        if (!existingIds.has(id)) {
            console.log('[HANDLER] Comment deleted:', id);
            const element = document.querySelector(`.comment-item[data-id="${id}"]`);
            if (element) {
                element.style.transition = 'opacity 0.3s';
                element.style.opacity = '0';

                setTimeout(() => {
                    element.remove();
                    knownCommentIds.delete(id);
                }, 300);
            } else {
                knownCommentIds.delete(id);
            }
        }
    });
}

function addComment() {
    const content = commentInput.value.trim();

    if (!content) {
        showToast('Vui l√≤ng nh·∫≠p n·ªôi dung', 'warning');
        return;
    }

    btnAddComment.disabled = true;
    btnAddComment.innerHTML = '<i class="bi bi-hourglass-split"></i>';

    // ‚úÖ THAY ƒê·ªîI: D√πng FormData thay v√¨ JSON
    const formData = new FormData();
    formData.append('content', content);
    formData.append('csrf_token', CONFIG.CSRF_TOKEN);

    // ‚úÖ TH√äM: Add file if selected
    if (commentFileInput && commentFileInput.files.length > 0) {
        formData.append('file', commentFileInput.files[0]);
    }

    fetch(`/tasks/${TASK_ID}/comments`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        },
        body: formData  // ‚úÖ THAY ƒê·ªîI: formData thay v√¨ JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            commentInput.value = '';
            clearFileInput();  // ‚úÖ TH√äM: Clear file input

            addCommentToList(data.comment);
            knownCommentIds.add(data.comment.id);

            if (data.comment.created_at_timestamp) {
                lastTimestamp = Math.max(lastTimestamp, data.comment.created_at_timestamp);
            }

            showToast('ƒê√£ g·ª≠i b√¨nh lu·∫≠n', 'success');
        } else {
            showToast(data.error || 'L·ªói g·ª≠i b√¨nh lu·∫≠n', 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        showToast('C√≥ l·ªói x·∫£y ra', 'danger');
    })
    .finally(() => {
        btnAddComment.disabled = false;
        btnAddComment.innerHTML = '<i class="bi bi-send"></i>';
    });
}

function addCommentToList(comment) {
    if (document.querySelector(`.comment-item[data-id="${comment.id}"]`)) {
        return;
    }

    const noComments = document.getElementById('noComments');
    if (noComments) noComments.remove();

    const item = document.createElement('div');
    item.className = 'comment-item';
    item.dataset.id = comment.id;
    item.style.opacity = '0';

    const avatarHTML = comment.user.avatar
        ? `<img src="/profile/avatar/${comment.user.avatar}" alt="">`
        : comment.user.avatar_letter;

    const deleteBtn = comment.can_delete
        ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id})">
               <i class="bi bi-trash"></i>
           </button>`
        : '';

    // ‚úÖ TH√äM: Build attachment HTML
    let attachmentHTML = '';
    if (comment.has_attachment && comment.attachment) {
        const att = comment.attachment;

        // Image preview
        if (att.file_type === 'image') {
            attachmentHTML += `
                <div class="comment-attachment mt-2">
                    <div class="attachment-image-preview">
                        <img src="${att.download_url}"
                             alt="${escapeHtml(att.filename)}"
                             class="img-thumbnail"
                             style="max-width: 300px; max-height: 300px; cursor: pointer;"
                             onclick="window.open(this.src, '_blank')">
                    </div>
            `;
        } else {
            attachmentHTML += `<div class="comment-attachment mt-2">`;
        }

        // Download link
        const icon = att.file_type === 'image' ? 'image' :
                    att.file_type === 'pdf' ? 'file-pdf' : 'file-earmark';

        attachmentHTML += `
                    <div class="attachment-info mt-2">
                        <a href="${att.download_url}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="bi bi-${icon}"></i>
                            ${escapeHtml(att.filename)}
                            <small class="text-muted">(${(att.file_size / 1024).toFixed(1)} KB)</small>
                        </a>
                    </div>
                </div>
        `;
    }

    item.innerHTML = `
        <div class="comment-avatar">${avatarHTML}</div>
        <div class="comment-content">
            <div class="comment-header">
                <div>
                    <span class="comment-author">${escapeHtml(comment.user.full_name)}</span>
                    <span class="badge bg-secondary ms-1" style="font-size: 0.7rem;">${ROLE_MAP[comment.user.role] || comment.user.role}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="comment-time">${comment.created_at_display}</span>
                    ${deleteBtn}
                </div>
            </div>
            <div class="comment-text">${escapeHtml(comment.content)}</div>
            ${attachmentHTML}
        </div>
    `;

    commentsList.appendChild(item);

    setTimeout(() => {
        item.style.transition = 'opacity 0.3s';
        item.style.opacity = '1';
    }, 10);

    const commentsSection = document.querySelector('.comments-section');
    if (commentsSection) {
        commentsSection.scrollTop = commentsSection.scrollHeight;
    }
}

function deleteComment(commentId) {
    if (!confirm('X√≥a b√¨nh lu·∫≠n n√†y?')) return;

    fetch(`/tasks/${TASK_ID}/comments/${commentId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`.comment-item[data-id="${commentId}"]`);
            if (item) {
                item.style.transition = 'opacity 0.3s';
                item.style.opacity = '0';

                setTimeout(() => {
                    item.remove();
                    knownCommentIds.delete(commentId);
                }, 300);
            }
            showToast('ƒê√£ x√≥a b√¨nh lu·∫≠n', 'success');
        } else {
            showToast(data.error || 'L·ªói x√≥a b√¨nh lu·∫≠n', 'danger');
        }
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================
window.addEventListener('beforeunload', () => {
    console.log('üö™ Task detail unloading - disconnecting SSE');
    if (window.sseManager) {
        window.sseManager.disconnect('task-comments');
    }
});

window.addEventListener('pagehide', () => {
    console.log('üö™ Task detail hiding - disconnecting SSE');
    if (window.sseManager) {
        window.sseManager.disconnect('task-comments');
    }
});

// ============================================
// TASK APPROVAL FUNCTIONS
// ============================================

function approveSelfTask(taskId) {
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n
    if (!confirm('X√°c nh·∫≠n ph√™ duy·ªát c√¥ng vi·ªác n√†y?')) {
        return;
    }

    // G·ª≠i request (KH√îNG C√ì BODY)
    fetch(`/tasks/${taskId}/approve-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
        // ‚ùå B·ªé: body: JSON.stringify({ note: ... })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ƒê√£ ph√™ duy·ªát c√¥ng vi·ªác', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚ùå ' + (data.error || 'L·ªói ph√™ duy·ªát'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('‚ùå C√≥ l·ªói x·∫£y ra', 'danger');
    });
}

function rejectSelfTask(taskId) {
    // Hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n v·ªõi c·∫£nh b√°o
    if (!confirm('X√°c nh·∫≠n t·ª´ ch·ªëi c√¥ng vi·ªác n√†y?\n\n‚ö†Ô∏è C√¥ng vi·ªác s·∫Ω b·ªã H·ª¶Y v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) {
        return;
    }

    // G·ª≠i request (KH√îNG C√ì BODY)
    fetch(`/tasks/${taskId}/reject-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
        // ‚ùå B·ªé: body: JSON.stringify({ reason: ... })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ƒê√£ t·ª´ ch·ªëi c√¥ng vi·ªác', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚ùå ' + (data.error || 'L·ªói t·ª´ ch·ªëi'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('‚ùå C√≥ l·ªói x·∫£y ra', 'danger');
    });
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Task Detail Page Loaded');

    startRealtimeComments();

    //  Handle Enter key
    if (commentInput) {
        commentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addComment();
            }
        });
    }

    //  Handle form submit
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addComment();
        });
    }
});
</script>
{% endblock %}