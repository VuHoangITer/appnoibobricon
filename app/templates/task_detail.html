{% extends "base.html" %}

{% block title %}Chi tiết Task{% endblock %}
{% block page_title %}Chi tiết Công việc{% endblock %}

{% block extra_css %}
<style>
:root {
    --ed-bg: #f5f7fb;
    --ed-card-bg: #ffffff;
    --ed-border: #e1e5ee;
    --ed-muted: #6c757d;
    --ed-text: #1f2933;
    --ed-primary: #0d6efd;
    --ed-primary-soft: #e7f1ff;
    --ed-danger-soft: #ffebee;
    --ed-radius-lg: 16px;
    --ed-radius-md: 10px;
    --ed-radius-pill: 999px;
}

/* Nền trang kiểu enterprise */
body {
    background: var(--ed-bg);
}

/* Card chung – mềm, tối giản hơn */
.card {
    border-radius: var(--ed-radius-lg);
    border: 1px solid var(--ed-border);
    background-color: var(--ed-card-bg);
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.05);
}

.card + .card {
    margin-top: 0.75rem;
}

/* Header card */
.card-header {
    border-bottom: 1px solid var(--ed-border);
    background: #4ba5ff;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

.card-header h4,
.card-header h5,
.card-header h6 {
    font-size: 0.98rem;
    font-weight: 600;
    color: var(--ed-text);
}

/* Badge trạng thái nhỏ gọn hơn */
.badge {
    border-radius: var(--ed-radius-pill);
    font-weight: 500;
}

/* ====== OVERRIDE MÀU XANH LÁ → XANH DƯƠNG SOFT ====== */

/* Header dùng bg-success (Báo cáo hoàn thành, Đánh giá...) → header xanh dương nhạt */
.card-header.bg-success {
    background-color: var(--ed-primary-soft) !important;
    color: var(--ed-primary) !important;
    border-bottom-color: transparent;
}

/* Badge success (Đã nhận, Tốt, Hoàn thành đúng hạn...) → soft blue */
.badge.bg-success {
    background-color: #198754 !important;
    color: #ffffff !important;
}

.text-success {
    color: #198754 !important;
}

/* Nút success (chấp nhận, đánh giá tốt...) → xanh dương */
.btn-success {
    background-color: #198754 !important;
    border-color: #198754 !important;
    color: #ffffff !important;
}

.btn-success:hover,
.btn-success:focus {
    background-color: #0b5ed7 !important;
    border-color: #0b5ed7 !important;
    color: #ffffff !important;
}

/* (Giữ warning/vàng nguyên, chỉ bỏ viền dưới) */
.card-header.bg-warning {
    border-bottom-color: transparent;
}

/* Avatar người giao / được giao / người hoàn thành / comment */
.assignment-avatar,
.completer-avatar,
.comment-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    background: #e9edf7;
    color: #4b5563;
    font-weight: 600;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #d0d7e2;
}

.assignment-avatar {
    width: 45px;
    height: 45px;
    font-size: 0.95rem;
}

.completer-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.assignment-avatar img,
.completer-avatar img,
.comment-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Alert */
.alert {
    border-radius: var(--ed-radius-md);
}

/* Thẻ đánh dấu (KHẨN CẤP / QUAN TRỌNG / LẶP LẠI) */
.mb-3 .badge.bg-danger,
.mb-3 .badge.bg-warning,
.mb-3 .badge.bg-info {
    font-size: 0.78rem;
    padding: 5px 10px;
}

/* Thẻ trạng thái hạn hoàn thành */
.badge.bg-danger,
.badge.bg-secondary {
    font-size: 0.78rem;
    padding: 4px 10px;
}

/* Nút nhỏ */
.btn-sm.rounded-circle {
    border-radius: 50% !important;
}

/* Responsive nhẹ cho 2 cột cuối (attachments + comments) */
@media (max-width: 768px) {
    .comments-section {
        max-height: 350px;
    }

    .comment-input-wrapper {
        flex-direction: row;
    }
}
/* ============================================
   CHECKLIST SECTION
   ============================================ */

.checklist-section {
    margin-top: 1rem;
}

.checklist-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.checklist-header h6 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.checklist-progress-inline {
    display: flex;
    align-items: center;
    gap: 12px;
}

.checklist-progress-text-inline {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 600;
}

.checklist-progress-bar-inline {
    flex: 1;
    min-width: 120px;
    height: 8px;
    background: #e9ecef;
    border-radius: 999px;
    overflow: hidden;
}

.checklist-progress-fill-inline {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 999px;
    transition: width 0.3s ease;
}

/* Checklist Items List */
.checklist-items-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.checklist-item-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 12px 14px;
    transition: all 0.2s ease;
}

.checklist-item-card:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.checklist-item-card.approved {
    background: #e8f5e9;
    border-color: #22c55e;
}

.checklist-item-card.waiting {
    background: #fff8e1;
    border-color: #ffc107;
}

.checklist-item-card.rejected {
    background: #ffebee;
    border-color: #dc3545;
}

.checklist-item-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.checklist-checkbox-inline {
    width: 20px;
    height: 20px;
    border: 2px solid #cbd5e1;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
}

.checklist-item-card.approved .checklist-checkbox-inline {
    background: #22c55e;
    border-color: #22c55e;
    color: white;
}

.checklist-item-card.waiting .checklist-checkbox-inline {
    background: #ffc107;
    border-color: #ffc107;
    color: white;
}

.checklist-checkbox-inline i {
    font-size: 0.8rem;
}

.checklist-item-text {
    flex: 1;
}

.checklist-item-title-inline {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1f2933;
    margin-bottom: 4px;
}

.checklist-item-desc-inline {
    font-size: 0.85rem;
    color: #6c757d;
}

.checklist-item-status-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
    flex-shrink: 0;
}

.checklist-item-status-inline.pending {
    background: #e9ecef;
    color: #6c757d;
}

.checklist-item-status-inline.waiting {
    background: #fff8e1;
    color: #f59e0b;
}

.checklist-item-status-inline.approved {
    background: #e8f5e9;
    color: #22c55e;
}

.checklist-item-status-inline.rejected {
    background: #ffebee;
    color: #dc3545;
}

.checklist-item-rejection-inline {
    margin-top: 8px;
    padding: 8px 10px;
    background: white;
    border-left: 3px solid #dc3545;
    border-radius: 5px;
    font-size: 0.85rem;
    color: #dc3545;
}

.checklist-item-actions-inline {
    display: flex;
    gap: 6px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #e9ecef;
}

.checklist-action-btn-inline {
    padding: 5px 12px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
}

.checklist-action-btn-inline:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

.checklist-action-btn-inline.btn-complete {
    background: #0d6efd;
    color: white;
}

.checklist-action-btn-inline.btn-approve {
    background: #22c55e;
    color: white;
}

.checklist-action-btn-inline.btn-reject {
    background: #dc3545;
    color: white;
}

.checklist-action-btn-inline.btn-reset {
    background: #6c757d;
    color: white;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .checklist-item-row {
        flex-direction: column;
        gap: 8px;
    }

    .checklist-item-actions-inline {
        flex-wrap: wrap;
    }

    .checklist-action-btn-inline {
        flex: 1;
        min-width: 45%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- ===== TASK HEADER ===== -->
<div class="task-header-container">
    {% include 'components/task_header.html' %}
</div>
<div class="row">
    <!-- ===== CỘT TRÁI: THÔNG TIN CHÍNH ===== -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-card-text"></i> {{ task.title }}
                    {% if task | is_overdue and task.status != 'DONE' %}
                    <span class="badge bg-danger ms-2">QUÁ HẠN</span>
                    {% endif %}
                    {% if task.status == 'DONE' and task.completed_overdue %}
                    <span class="badge bg-danger text-dark ms-1">
                        <i class="bi bi-exclamation-triangle-fill"></i>Quá hạn
                    </span>
                    {% endif %}
                </h4>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-{{ task.status | status_badge }}" style="font-size: 0.9rem;">
                        {{ task.status | status_vn }}
                    </span>

                    <!-- ===== NÚT EDIT  ===== -->
                    {% set can_edit = false %}

                    {# Director: sửa được tất cả #}
                    {% if current_user.role == 'director' %}
                        {% set can_edit = true %}

                    {# Manager: sửa được nhiều loại task #}
                    {% elif current_user.role == 'manager' %}
                        {# 1. Task do HR tạo #}
                        {% if task.creator.role == 'hr' %}
                            {% set can_edit = true %}

                        {# 2. Task do chính Manager tạo #}
                        {% elif task.creator_id == current_user.id %}
                            {% set can_edit = true %}

                        {# 3. Task được giao cho HR (CHỈ HR, không bao gồm kế toán) - bất kể ai tạo #}
                        {% else %}
                            {% for assignment in task.assignments %}
                                {% if assignment.user.role == 'hr' %}
                                    {% set can_edit = true %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endif %}

                    {% if can_edit %}
                        <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}"
                           class="btn btn-warning btn-sm rounded-circle"
                           style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;"
                           title="Chỉnh sửa nhiệm vụ">
                            <i class="bi bi-pencil"></i>
                        </a>
                    {% endif %}

                    <!-- NÚT XÓA - GIỮ NGUYÊN LOGIC CŨ -->
                    {% if task.creator_id == current_user.id or current_user.role in ['director', 'manager'] %}
                    <form method="POST" action="{{ url_for('tasks.delete_task', task_id=task.id) }}"
                          onsubmit="return confirm('Bạn có chắc muốn xóa nhiệm vụ này?');" class="mb-0">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm rounded-circle"
                                style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                title="Xóa nhiệm vụ">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if task.requires_approval %}
                <div class="alert {% if task.approved == None %}alert-warning{% elif task.approved %}alert-success{% else %}alert-danger{% endif %} mb-3">
                    <div class="d-flex align-items-center">
                        <!-- ===== TRẠNG THÁI: ĐANG CHỜ DUYỆT ===== -->
                        {% if task.approved == None %}
                            <i class="bi bi-hourglass-split fs-4 me-3"></i>
                            <div class="flex-grow-1">
                                <strong>Chờ phê duyệt</strong>
                            </div>
                            <!-- NÚT PHÊ DUYỆT - CHỈ HIỆN CHO NGƯỜI CÓ QUYỀN -->
                            {% if current_user.role in ['manager', 'director'] %}
                                {% if current_user.role == 'director' or (current_user.role == 'manager' and task.creator.role == 'hr') %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="approveSelfTask({{ task.id }})">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectSelfTask({{ task.id }})">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                                {% endif %}
                            {% endif %}

                        {% elif task.approved %}
                            <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
                            <div>
                                <p class="mb-0 small">
                                    Bởi <strong>{{ task.approver.full_name }}</strong>
                                    lúc {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-muted">Ghi chú: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>

                        <!-- ===== TRẠNG THÁI: ĐÃ TỪ CHỐI ===== -->
                        {% else %}
                            <i class="bi bi-x-circle-fill fs-4 me-3 text-danger"></i>
                            <div>
                                <p class="mb-0 small">
                                    Bởi <strong>{{ task.approver.full_name }}</strong>
                                    lúc {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-danger">Lý do: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Thẻ đánh dấu -->
                <div class="mb-3">
                    <h6><i class="bi bi-tags-fill"></i> Thẻ đánh dấu:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if task.is_urgent %}
                        <span class="badge bg-danger" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-exclamation-triangle-fill"></i> KHẨN CẤP
                        </span>
                        {% endif %}
                        {% if task.is_important %}
                        <span class="badge bg-warning text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-star-fill"></i> QUAN TRỌNG
                        </span>
                        {% endif %}
                        {% if task.is_recurring %}
                        <span class="badge bg-info text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-arrow-repeat"></i> LẶP LẠI
                        </span>
                        {% endif %}
                        {% if not task.is_urgent and not task.is_important and not task.is_recurring %}
                        <span class="text-muted"><i>Chưa có thẻ</i></span>
                        {% endif %}
                    </div>

                    {% if current_user.role in ['director', 'manager'] %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#updateTagsForm">
                            <i class="bi bi-pencil"></i> Cập nhật thẻ
                        </button>
                        <div class="collapse mt-2" id="updateTagsForm">
                            <div class="card card-body bg-light">
                                <form method="POST" action="{{ url_for('tasks.update_tags', task_id=task.id) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_urgent" id="edit_is_urgent" {% if task.is_urgent %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_urgent">
                                            <span class="badge bg-danger">KHẨN CẤP</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_important" id="edit_is_important" {% if task.is_important %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_important">
                                            <span class="badge bg-warning text-dark">QUAN TRỌNG</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="is_recurring" id="edit_is_recurring" {% if task.is_recurring %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_recurring">
                                            <span class="badge bg-info text-dark">LẶP LẠI</span>
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="bi bi-check-circle"></i> Lưu
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <hr>

                <!-- Mô tả -->
                <div class="mb-3">
                    <h6><i class="bi bi-file-text"></i> Mô tả:</h6>
                    <p class="mb-0" style="white-space: pre-wrap;">{{ task.description or 'Không có mô tả' }}</p>
                </div>

                <hr>

                <!-- ===== CHECKLIST SECTION ===== -->
                {% if task.checklists %}
                <div class="checklist-section">
                    <div class="checklist-header">
                        <h6><i class="bi bi-list-check"></i> Checklist ({{ task.checklists|length }})</h6>
                        <div class="checklist-progress-inline">
                            <span class="checklist-progress-text-inline">
                                {{ task.get_checklist_progress().approved }}/{{ task.get_checklist_progress().total }}
                            </span>
                            <div class="checklist-progress-bar-inline">
                                <div class="checklist-progress-fill-inline"
                                     style="width: {{ task.get_checklist_progress().percentage }}%"></div>
                            </div>
                            <span class="checklist-progress-text-inline"
                                  style="color: {% if task.get_checklist_progress().is_complete %}#22c55e{% else %}#f59e0b{% endif %}">
                                {{ task.get_checklist_progress().percentage }}%
                            </span>
                        </div>
                    </div>

                    <div class="checklist-items-list">
                        {% for item in task.checklists %}
                        <div class="checklist-item-card {{ item.status.lower() }}" data-checklist-id="{{ item.id }}">
                            <div class="checklist-item-row">
                                <div class="checklist-checkbox-inline">
                                    {% if item.status == 'APPROVED' %}
                                        <i class="bi bi-check-lg"></i>
                                    {% elif item.status == 'WAITING_APPROVAL' %}
                                        <i class="bi bi-hourglass-split"></i>
                                    {% endif %}
                                </div>

                                <div class="checklist-item-text">
                                    <div class="checklist-item-title-inline">{{ item.title }}</div>
                                    {% if item.description %}
                                    <div class="checklist-item-desc-inline">{{ item.description }}</div>
                                    {% endif %}
                                </div>

                                <div class="checklist-item-status-inline {{ item.status.lower() }}">
                                    {% if item.status == 'APPROVED' %}
                                        <i class="bi bi-check-circle-fill"></i> Đã duyệt
                                    {% elif item.status == 'WAITING_APPROVAL' %}
                                        <i class="bi bi-clock-fill"></i> Chờ duyệt
                                    {% elif item.status == 'REJECTED' %}
                                        <i class="bi bi-x-circle-fill"></i> Từ chối
                                    {% else %}
                                        <i class="bi bi-circle"></i> Chưa làm
                                    {% endif %}
                                </div>
                            </div>

                            {% if item.status == 'REJECTED' and item.rejection_reason %}
                            <div class="checklist-item-rejection-inline">
                                <strong>Lý do từ chối:</strong> {{ item.rejection_reason }}
                            </div>
                            {% endif %}

                            <!-- Action buttons -->
                            {% if item.status == 'PENDING' and task.is_assigned_to(current_user.id) %}
                            <div class="checklist-item-actions-inline">
                                <button class="checklist-action-btn-inline btn-complete"
                                        onclick="completeChecklistItemInline({{ task.id }}, {{ item.id }})">
                                    <i class="bi bi-check-lg"></i> Hoàn thành
                                </button>
                            </div>
                            {% elif item.status == 'WAITING_APPROVAL' and current_user.role in ['manager', 'director'] %}
                            <div class="checklist-item-actions-inline">
                                <button class="checklist-action-btn-inline btn-approve"
                                        onclick="approveChecklistItemInline({{ task.id }}, {{ item.id }}, 'approve')">
                                    <i class="bi bi-check-lg"></i> Duyệt
                                </button>
                                <button class="checklist-action-btn-inline btn-reject"
                                        onclick="rejectChecklistItemInline({{ task.id }}, {{ item.id }})">
                                    <i class="bi bi-x-lg"></i> Từ chối
                                </button>
                            </div>
                            {% elif item.status == 'REJECTED' and task.is_assigned_to(current_user.id) %}
                            <div class="checklist-item-actions-inline">
                                <button class="checklist-action-btn-inline btn-reset"
                                        onclick="resetChecklistItemInline({{ task.id }}, {{ item.id }})">
                                    <i class="bi bi-arrow-counterclockwise"></i> Làm lại
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <hr>
                {% endif %}

                <!-- Thông tin cơ bản -->
                <div class="row">
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Người tạo:</strong></p>
                        <p class="mb-0">{{ task.creator.full_name }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Ngày tạo:</strong></p>
                        <p class="mb-0">{{ task.created_at | vn_datetime }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Hạn hoàn thành:</strong></p>
                        {% if task.due_date %}
                        <span class="badge bg-{{ 'danger' if (task | is_overdue and task.status != 'DONE') else 'secondary' }}">
                            {{ task.due_date | vn_datetime('%H:%M - %d/%m/%Y') }}
                        </span>
                        {% else %}
                        <span class="text-muted">Chưa có</span>
                        {% endif %}
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Cập nhật cuối:</strong></p>
                        <p class="mb-0">{{ task.updated_at | vn_datetime }}</p>
                    </div>
                </div>

                <!-- Thông tin Recurring -->
                {% if task.recurrence_enabled %}
                <hr>
                <div class="border-start border-primary border-3 ps-3 mb-3">
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-arrow-repeat"></i> Tự động lặp lại
                    </h6>
                    <small class="text-muted">
                        {% if task.recurrence_type == 'weekly' %}
                            {# ===== ✅ WEEKLY MODE ===== #}
                            <strong>Loại:</strong> Theo các ngày trong tuần
                            <br>
                            <strong>Các ngày:</strong>
                            {% set weekday_names = {
                                '0': 'Chủ nhật',
                                '1': 'Thứ 2',
                                '2': 'Thứ 3',
                                '3': 'Thứ 4',
                                '4': 'Thứ 5',
                                '5': 'Thứ 6',
                                '6': 'Thứ 7'
                            } %}
                            {% if task.recurrence_weekdays %}
                                {% set weekdays = task.recurrence_weekdays.split(',') %}
                                {% for day in weekdays %}
                                    <span class="badge bg-info text-dark me-1">{{ weekday_names[day] }}</span>
                                {% endfor %}
                            {% endif %}
                        {% else %}
                            {# ===== INTERVAL MODE (CŨ) ===== #}
                            <strong>Chu kỳ:</strong>
                            {% if task.recurrence_interval_days == 7 %}Hàng tuần
                            {% elif task.recurrence_interval_days == 14 %}2 tuần
                            {% elif task.recurrence_interval_days == 30 %}Hàng tháng
                            {% else %}{{ task.recurrence_interval_days }} ngày{% endif %}
                            {% if task.last_recurrence_date %}
                            <br><strong>Lần tạo tiếp theo:</strong>
                            {{ task.last_recurrence_date | add_days(task.recurrence_interval_days) | vn_datetime }}
                            {% endif %}
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <!-- Task con -->
                {% if task.parent_task_id %}
                <div class="border-start border-success border-3 ps-3 mb-3">
                    <small class="text-muted">
                        <i class="bi bi-link-45deg"></i> Nhiệm vụ lặp lại từ
                        <a href="{{ url_for('tasks.task_detail', task_id=task.parent_task_id) }}">
                            #{{ task.parent_task_id }}
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- FORM CẬP NHẬT TRẠNG THÁI -->
        {% if (user_assignment and user_assignment.accepted or task.creator_id == current_user.id or current_user.role in ['director', 'manager'])
              and (not task.requires_approval or task.approved == True or current_user.role in ['director', 'manager']) %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Cập nhật trạng thái</h5>
            </div>
            <div class="card-body">
                <!-- Accept/Reject -->
                {% if user_assignment and not user_assignment.accepted and user_assignment.assigned_group %}
                <div class="alert alert-info">
                    <p class="mb-2"><strong>Nhiệm vụ được giao cho nhóm {{ user_assignment.assigned_group | role_vn }}</strong></p>
                    <p class="mb-3">Bạn cần chấp nhận để hiển thị trong danh sách của mình.</p>
                    <form method="POST" action="{{ url_for('tasks.accept_task', task_id=task.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-circle"></i> Chấp nhận
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.reject_task', task_id=task.id) }}" style="display: inline;" onsubmit="return confirm('Bạn có chắc muốn từ chối?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-x-circle"></i> Từ chối
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- Cảnh báo quá hạn -->
                {% if (task | is_overdue) and task.status != 'DONE' %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Nhiệm vụ đã quá hạn!</strong> Hoàn thành sẽ được ghi nhận là "Quá hạn".
                </div>
                {% endif %}

                <!-- Form -->
                <form method="POST" action="{{ url_for('tasks.update_status', task_id=task.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="status" class="form-label"><strong>Trạng thái:</strong></label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="status" name="status" onchange="handleStatusChange()">
                                <option value="PENDING" {% if task.status == 'PENDING' %}selected{% endif %}>Chưa Làm</option>
                                <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>Đang làm</option>
                                <option value="DONE" {% if task.status == 'DONE' %}selected{% endif %}>Hoàn thành</option>
                                <option value="CANCELLED" {% if task.status == 'CANCELLED' %}selected{% endif %}>Đã hủy</option>
                            </select>
                            <button type="submit" class="btn btn-primary" style="min-width: 120px;">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3" id="completionNoteDiv" style="display: none;">
                        <label for="completion_note" class="form-label">
                            <strong><i class="bi bi-chat-left-text"></i> Nội dung báo cáo:</strong>
                        </label>
                        <textarea class="form-control" id="completion_note" name="completion_note" rows="3"
                                  placeholder="Nhập báo cáo..."></textarea>
                    </div>
                </form>

                <script>
                function handleStatusChange() {
                    const statusSelect = document.getElementById('status');
                    const completionNoteDiv = document.getElementById('completionNoteDiv');
                    const submitBtn = statusSelect.closest('form').querySelector('button[type="submit"]');
                    const currentStatus = '{{ task.status }}';

                    if (statusSelect.value === 'DONE' && currentStatus !== 'DONE') {
                        completionNoteDiv.style.display = 'block';

                        // ✅ KIỂM TRA CHECKLIST
                        {% if task.checklists %}
                        const checklistProgress = {{ task.get_checklist_progress() | tojson }};
                        if (!checklistProgress.is_complete) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
                            submitBtn.classList.remove('btn-primary');
                            submitBtn.classList.add('btn-secondary');

                            showToast(`❌ Chưa hoàn thành checklist! (${checklistProgress.approved}/${checklistProgress.total} đã duyệt)`, 'warning');
                            return;
                        }
                        {% endif %}

                        // Nếu checklist OK hoặc không có checklist
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i>';
                        submitBtn.classList.remove('btn-secondary');
                        submitBtn.classList.add('btn-primary');
                    } else {
                        completionNoteDiv.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i>';
                        submitBtn.classList.remove('btn-secondary');
                        submitBtn.classList.add('btn-primary');
                    }
                }

                // Thêm validation khi submit form
                document.addEventListener('DOMContentLoaded', function() {
                    handleStatusChange();

                    const statusForm = document.querySelector('form[action="{{ url_for("tasks.update_status", task_id=task.id) }}"]');
                    if (statusForm) {
                        statusForm.addEventListener('submit', function(e) {
                            const statusSelect = document.getElementById('status');
                            const currentStatus = '{{ task.status }}';

                            if (statusSelect.value === 'DONE' && currentStatus !== 'DONE') {
                                {% if task.checklists %}
                                const checklistProgress = {{ task.get_checklist_progress() | tojson }};
                                if (!checklistProgress.is_complete) {
                                    e.preventDefault();
                                    showToast(`❌ Không thể hoàn thành! Vẫn còn ${checklistProgress.total - checklistProgress.approved}/${checklistProgress.total} checklist chưa được duyệt`, 'danger');
                                    return false;
                                }
                                {% endif %}
                            }
                        });
                    }
                });
                </script>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ===== CỘT PHẢI: NGƯỜI ĐƯỢC GIAO + CARDS PHỤ ===== -->
    <div class="col-md-4">
        <!-- Người được giao -->
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Người được giao</h6>
            </div>
            <div class="card-body">
                {% if assignments %}
                <ul class="list-group list-group-flush">
                    {% for assignment in assignments %}
                    <li class="list-group-item px-0">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="assignment-avatar">
                                {% if assignment.user.avatar %}
                                <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}" alt="">
                                {% else %}
                                {{ assignment.user.full_name[0].upper() }}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <strong class="d-block">{{ assignment.user.full_name }}</strong>
                                <small class="text-muted">{{ assignment.user.role | role_vn }}</small>
                            </div>
                            <div>
                                {% if assignment.accepted %}
                                <span class="badge bg-success">Đã nhận</span>
                                {% else %}
                                <span class="badge bg-warning">Chờ</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if assignment.assigned_group %}
                        <small class="text-muted">Nhóm: {{ assignment.assigned_group | role_vn }}</small>
                        {% endif %}
                        {% if assignment.accepted and assignment.accepted_at %}
                        <small class="text-muted d-block">{{ assignment.accepted_at | vn_datetime }}</small>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Chưa có người được gán</p>
                {% endif %}
            </div>
        </div>

        <!-- Báo cáo hoàn thành -->
        {% if task.status == 'DONE' %}
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-clipboard-check-fill"></i> Báo cáo hoàn thành</h6>
            </div>
            <div class="card-body">
                {% set reports = task.completion_reports.all() %}
                {% if reports %}
                {% set completion_report = reports[0] %}
                <div class="d-flex align-items-center gap-2 mb-3">
                    <div class="completer-avatar">
                        {% if completion_report.completer.avatar %}
                        <img src="{{ url_for('profile.get_avatar', filename=completion_report.completer.avatar) }}" alt="">
                        {% else %}
                        {{ completion_report.completer.full_name[0].upper() }}
                        {% endif %}
                    </div>
                    <div>
                        <strong class="d-block">{{ completion_report.completer.full_name }}</strong>
                        <small class="text-muted">{{ completion_report.completed_at | vn_datetime }}</small>
                    </div>
                </div>
                {% if completion_report.completion_time %}
                <p class="mb-2 small">
                    <strong>Thời gian làm việc:</strong>
                    {% set days = (completion_report.completion_time // 1440) %}
                    {% set hours = ((completion_report.completion_time % 1440) // 60) %}
                    {% set minutes = (completion_report.completion_time % 60) %}
                    {% if days > 0 %}{{ days }}ngày {% endif %}
                    {% if hours > 0 %}{{ hours }}giờ {% endif %}{{ minutes }}phút
                </p>
                {% endif %}
                {% if completion_report.completion_note %}
                <p class="mb-0 small" style="white-space: pre-wrap;">{{ completion_report.completion_note }}</p>
                {% endif %}
                {% else %}
                <p class="text-muted small mb-0">Hoàn thành trước khi có hệ thống báo cáo</p>
                {% endif %}
            </div>
        </div>

        <!-- Đánh giá hiệu suất -->
        <div class="card mb-3">
            <div class="card-header {% if task.performance_rating == 'good' %}bg-success{% elif task.performance_rating == 'bad' %}bg-danger{% else %}bg-secondary{% endif %} text-white">
                <h6 class="mb-0"><i class="bi bi-star-fill"></i> Đánh giá</h6>
            </div>
            <div class="card-body text-center">
                {% if task.performance_rating %}
                <div class="mb-3">
                    {% if task.performance_rating == 'good' %}
                    <i class="bi bi-hand-thumbs-up-fill text-success" style="font-size: 2.5rem;"></i>
                    {% else %}
                    <i class="bi bi-hand-thumbs-down-fill text-danger" style="font-size: 2.5rem;"></i>
                    {% endif %}
                </div>
                <small class="text-muted">{{ task.rated_at | vn_datetime }} - {{ task.rater.full_name }}</small>
                {% if current_user.role in ['director', 'manager'] %}
                <hr>
                <div class="d-flex gap-2 mt-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% endif %}
                {% else %}
                {% if current_user.role in ['director', 'manager'] %}
                <p class="text-muted small mb-3">Hãy đánh giá hiệu suất:</p>
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% else %}
                <p class="text-muted small mb-0">
                    <i class="bi bi-hourglass-split"></i> Chờ đánh giá
                </p>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- ===== FULL WIDTH: NÚT MỞ TRANG THẢO LUẬN ===== -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Trao đổi</h6>
            </div>
            <div class="card-body text-center py-5">
                <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                <p class="mt-3 mb-3 text-muted">Nhấn vào nút bên dưới để xem và tham gia thảo luận</p>
                <a href="{{ url_for('tasks.task_discussion', task_id=task.id) }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-chat-dots"></i> Mở trang thảo luận
                    {% if task.unread_comment_count > 0 %}
                    <span class="badge bg-danger ms-2">{{ task.unread_comment_count }}</span>
                    {% endif %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    TASK_ID: {{ task.id }},
    CURRENT_USER_ID: {{ current_user.id }},
    CURRENT_USER_ROLE: '{{ current_user.role }}',
    CSRF_TOKEN: '{{ csrf_token() }}'
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ============================================
// TASK APPROVAL FUNCTIONS
// ============================================
function approveSelfTask(taskId) {
    if (!confirm('Xác nhận phê duyệt công việc này?')) {
        return;
    }

    fetch(`/tasks/${taskId}/approve-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã phê duyệt công việc', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('❌ ' + (data.error || 'Lỗi phê duyệt'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('❌ Có lỗi xảy ra', 'danger');
    });
}

function rejectSelfTask(taskId) {
    if (!confirm('Xác nhận từ chối công việc này?\n\n⚠️ Công việc sẽ bị HỦY và không thể khôi phục!')) {
        return;
    }

    fetch(`/tasks/${taskId}/reject-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã từ chối công việc', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('❌ ' + (data.error || 'Lỗi từ chối'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('❌ Có lỗi xảy ra', 'danger');
    });
}

// ============================================
// CHECKLIST FUNCTIONS (INLINE - TASK DETAIL)
// ============================================

function completeChecklistItemInline(taskId, checklistId) {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

    fetch(`/tasks/${taskId}/checklist/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        },
        body: JSON.stringify({ checklist_id: checklistId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã gửi yêu cầu duyệt', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('❌ ' + (data.error || 'Không thể xử lý'), 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Hoàn thành';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Có lỗi xảy ra', 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Hoàn thành';
    });
}

function approveChecklistItemInline(taskId, checklistId, action) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

    fetch(`/tasks/${taskId}/checklist/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        },
        body: JSON.stringify({
            checklist_id: checklistId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã duyệt checklist', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('❌ ' + (data.error || 'Không thể xử lý'), 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Có lỗi xảy ra', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

function rejectChecklistItemInline(taskId, checklistId) {
    const reason = prompt('Nhập lý do từ chối (tùy chọn):');

    if (reason === null) return;

    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

    fetch(`/tasks/${taskId}/checklist/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        },
        body: JSON.stringify({
            checklist_id: checklistId,
            action: 'reject',
            rejection_reason: reason || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã từ chối checklist', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('❌ ' + (data.error || 'Không thể xử lý'), 'danger');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Có lỗi xảy ra', 'danger');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

function resetChecklistItemInline(taskId, checklistId) {
    if (!confirm('Bạn muốn làm lại checklist này?')) return;

    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang xử lý...';

    fetch(`/tasks/${taskId}/checklist/reset`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        },
        body: JSON.stringify({ checklist_id: checklistId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Đã reset checklist', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast('❌ ' + (data.error || 'Không thể xử lý'), 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Làm lại';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ Có lỗi xảy ra', 'danger');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Làm lại';
    });
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('📄 Task Detail Page Loaded');
});
</script>
{% endblock %}