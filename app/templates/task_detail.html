{% extends "base.html" %}

{% block title %}Chi ti·∫øt Task{% endblock %}
{% block page_title %}Chi ti·∫øt C√¥ng vi·ªác{% endblock %}

{% block extra_css %}
<style>
:root {
    --ed-bg: #f5f7fb;
    --ed-card-bg: #ffffff;
    --ed-border: #e1e5ee;
    --ed-muted: #6c757d;
    --ed-text: #1f2933;
    --ed-primary: #0d6efd;
    --ed-primary-soft: #e7f1ff;
    --ed-danger-soft: #ffebee;
    --ed-radius-lg: 16px;
    --ed-radius-md: 10px;
    --ed-radius-pill: 999px;
}

/* N·ªÅn trang ki·ªÉu enterprise */
body {
    background: var(--ed-bg);
}

/* Card chung ‚Äì m·ªÅm, t·ªëi gi·∫£n h∆°n */
.card {
    border-radius: var(--ed-radius-lg);
    border: 1px solid var(--ed-border);
    background-color: var(--ed-card-bg);
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.05);
}

.card + .card {
    margin-top: 0.75rem;
}

/* Header card */
.card-header {
    border-bottom: 1px solid var(--ed-border);
    background: #4ba5ff;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

.card-header h4,
.card-header h5,
.card-header h6 {
    font-size: 0.98rem;
    font-weight: 600;
    color: var(--ed-text);
}

/* Badge tr·∫°ng th√°i nh·ªè g·ªçn h∆°n */
.badge {
    border-radius: var(--ed-radius-pill);
    font-weight: 500;
}

/* ====== OVERRIDE M√ÄU XANH L√Å ‚Üí XANH D∆Ø∆†NG SOFT ====== */

/* Header d√πng bg-success (B√°o c√°o ho√†n th√†nh, ƒê√°nh gi√°...) ‚Üí header xanh d∆∞∆°ng nh·∫°t */
.card-header.bg-success {
    background-color: var(--ed-primary-soft) !important;
    color: var(--ed-primary) !important;
    border-bottom-color: transparent;
}

/* Badge success (ƒê√£ nh·∫≠n, T·ªët, Ho√†n th√†nh ƒë√∫ng h·∫°n...) ‚Üí soft blue */
.badge.bg-success {
    background-color: #198754 !important;
    color: #ffffff !important;
}

.text-success {
    color: #198754 !important;
}

/* N√∫t success (ch·∫•p nh·∫≠n, ƒë√°nh gi√° t·ªët...) ‚Üí xanh d∆∞∆°ng */
.btn-success {
    background-color: #198754 !important;
    border-color: #198754 !important;
    color: #ffffff !important;
}

.btn-success:hover,
.btn-success:focus {
    background-color: #0b5ed7 !important;
    border-color: #0b5ed7 !important;
    color: #ffffff !important;
}

/* (Gi·ªØ warning/v√†ng nguy√™n, ch·ªâ b·ªè vi·ªÅn d∆∞·ªõi) */
.card-header.bg-warning {
    border-bottom-color: transparent;
}

/* Avatar ng∆∞·ªùi giao / ƒë∆∞·ª£c giao / ng∆∞·ªùi ho√†n th√†nh / comment */
.assignment-avatar,
.completer-avatar,
.comment-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    background: #e9edf7;
    color: #4b5563;
    font-weight: 600;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #d0d7e2;
}

.assignment-avatar {
    width: 45px;
    height: 45px;
    font-size: 0.95rem;
}

.completer-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    font-size: 0.9rem;
}

.assignment-avatar img,
.completer-avatar img,
.comment-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Alert */
.alert {
    border-radius: var(--ed-radius-md);
}

/* Th·∫ª ƒë√°nh d·∫•u (KH·∫®N C·∫§P / QUAN TR·ªåNG / L·∫∂P L·∫†I) */
.mb-3 .badge.bg-danger,
.mb-3 .badge.bg-warning,
.mb-3 .badge.bg-info {
    font-size: 0.78rem;
    padding: 5px 10px;
}

/* Th·∫ª tr·∫°ng th√°i h·∫°n ho√†n th√†nh */
.badge.bg-danger,
.badge.bg-secondary {
    font-size: 0.78rem;
    padding: 4px 10px;
}

/* N√∫t nh·ªè */
.btn-sm.rounded-circle {
    border-radius: 50% !important;
}

/* Responsive nh·∫π cho 2 c·ªôt cu·ªëi (attachments + comments) */
@media (max-width: 768px) {
    .comments-section {
        max-height: 350px;
    }

    .comment-input-wrapper {
        flex-direction: row;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- ===== TASK HEADER ===== -->
<div class="task-header-container">
    {% include 'components/task_header.html' %}
</div>
<div class="row">
    <!-- ===== C·ªòT TR√ÅI: TH√îNG TIN CH√çNH ===== -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-card-text"></i> {{ task.title }}
                    {% if task | is_overdue and task.status != 'DONE' %}
                    <span class="badge bg-danger ms-2">QU√Å H·∫†N</span>
                    {% endif %}
                    {% if task.status == 'DONE' and task.completed_overdue %}
                    <span class="badge bg-danger text-dark ms-1">
                        <i class="bi bi-exclamation-triangle-fill"></i>Qu√° h·∫°n
                    </span>
                    {% endif %}
                </h4>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-{{ task.status | status_badge }}" style="font-size: 0.9rem;">
                        {{ task.status | status_vn }}
                    </span>

                    <!-- ===== N√öT EDIT  ===== -->
                    {% set can_edit = false %}

                    {# Director: s·ª≠a ƒë∆∞·ª£c t·∫•t c·∫£ #}
                    {% if current_user.role == 'director' %}
                        {% set can_edit = true %}

                    {# Manager: s·ª≠a ƒë∆∞·ª£c nhi·ªÅu lo·∫°i task #}
                    {% elif current_user.role == 'manager' %}
                        {# 1. Task do HR t·∫°o #}
                        {% if task.creator.role == 'hr' %}
                            {% set can_edit = true %}

                        {# 2. Task do ch√≠nh Manager t·∫°o #}
                        {% elif task.creator_id == current_user.id %}
                            {% set can_edit = true %}

                        {# 3. Task ƒë∆∞·ª£c giao cho HR (CH·ªà HR, kh√¥ng bao g·ªìm k·∫ø to√°n) - b·∫•t k·ªÉ ai t·∫°o #}
                        {% else %}
                            {% for assignment in task.assignments %}
                                {% if assignment.user.role == 'hr' %}
                                    {% set can_edit = true %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endif %}

                    {% if can_edit %}
                        <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}"
                           class="btn btn-warning btn-sm rounded-circle"
                           style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;"
                           title="Ch·ªânh s·ª≠a nhi·ªám v·ª•">
                            <i class="bi bi-pencil"></i>
                        </a>
                    {% endif %}

                    <!-- N√öT X√ìA - GI·ªÆ NGUY√äN LOGIC C≈® -->
                    {% if task.creator_id == current_user.id or current_user.role in ['director', 'manager'] %}
                    <form method="POST" action="{{ url_for('tasks.delete_task', task_id=task.id) }}"
                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nhi·ªám v·ª• n√†y?');" class="mb-0">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm rounded-circle"
                                style="width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center;"
                                title="X√≥a nhi·ªám v·ª•">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if task.requires_approval %}
                <div class="alert {% if task.approved == None %}alert-warning{% elif task.approved %}alert-success{% else %}alert-danger{% endif %} mb-3">
                    <div class="d-flex align-items-center">
                        <!-- ===== TR·∫†NG TH√ÅI: ƒêANG CH·ªú DUY·ªÜT ===== -->
                        {% if task.approved == None %}
                            <i class="bi bi-hourglass-split fs-4 me-3"></i>
                            <div class="flex-grow-1">
                                <strong>Ch·ªù ph√™ duy·ªát</strong>
                            </div>
                            <!-- N√öT PH√ä DUY·ªÜT - CH·ªà HI·ªÜN CHO NG∆Ø·ªúI C√ì QUY·ªÄN -->
                            {% if current_user.role in ['manager', 'director'] %}
                                {% if current_user.role == 'director' or (current_user.role == 'manager' and task.creator.role == 'hr') %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="approveSelfTask({{ task.id }})">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectSelfTask({{ task.id }})">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                                {% endif %}
                            {% endif %}

                        {% elif task.approved %}
                            <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
                            <div>
                                <p class="mb-0 small">
                                    B·ªüi <strong>{{ task.approver.full_name }}</strong>
                                    l√∫c {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-muted">Ghi ch√∫: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>

                        <!-- ===== TR·∫†NG TH√ÅI: ƒê√É T·ª™ CH·ªêI ===== -->
                        {% else %}
                            <i class="bi bi-x-circle-fill fs-4 me-3 text-danger"></i>
                            <div>
                                <p class="mb-0 small">
                                    B·ªüi <strong>{{ task.approver.full_name }}</strong>
                                    l√∫c {{ task.approved_at | vn_datetime }}
                                    {% if task.approval_note %}
                                    <br><em class="text-danger">L√Ω do: {{ task.approval_note }}</em>
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Th·∫ª ƒë√°nh d·∫•u -->
                <div class="mb-3">
                    <h6><i class="bi bi-tags-fill"></i> Th·∫ª ƒë√°nh d·∫•u:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if task.is_urgent %}
                        <span class="badge bg-danger" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-exclamation-triangle-fill"></i> KH·∫®N C·∫§P
                        </span>
                        {% endif %}
                        {% if task.is_important %}
                        <span class="badge bg-warning text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-star-fill"></i> QUAN TR·ªåNG
                        </span>
                        {% endif %}
                        {% if task.is_recurring %}
                        <span class="badge bg-info text-dark" style="font-size: 0.95rem; padding: 6px 10px;">
                            <i class="bi bi-arrow-repeat"></i> L·∫∂P L·∫†I
                        </span>
                        {% endif %}
                        {% if not task.is_urgent and not task.is_important and not task.is_recurring %}
                        <span class="text-muted"><i>Ch∆∞a c√≥ th·∫ª</i></span>
                        {% endif %}
                    </div>

                    {% if current_user.role in ['director', 'manager'] %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#updateTagsForm">
                            <i class="bi bi-pencil"></i> C·∫≠p nh·∫≠t th·∫ª
                        </button>
                        <div class="collapse mt-2" id="updateTagsForm">
                            <div class="card card-body bg-light">
                                <form method="POST" action="{{ url_for('tasks.update_tags', task_id=task.id) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_urgent" id="edit_is_urgent" {% if task.is_urgent %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_urgent">
                                            <span class="badge bg-danger">KH·∫®N C·∫§P</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="is_important" id="edit_is_important" {% if task.is_important %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_important">
                                            <span class="badge bg-warning text-dark">QUAN TR·ªåNG</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" name="is_recurring" id="edit_is_recurring" {% if task.is_recurring %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_recurring">
                                            <span class="badge bg-info text-dark">L·∫∂P L·∫†I</span>
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="bi bi-check-circle"></i> L∆∞u
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <hr>

                <!-- M√¥ t·∫£ -->
                <div class="mb-3">
                    <h6><i class="bi bi-file-text"></i> M√¥ t·∫£:</h6>
                    <p class="mb-0" style="white-space: pre-wrap;">{{ task.description or 'Kh√¥ng c√≥ m√¥ t·∫£' }}</p>
                </div>

                <hr>

                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="row">
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Ng∆∞·ªùi t·∫°o:</strong></p>
                        <p class="mb-0">{{ task.creator.full_name }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>Ng√†y t·∫°o:</strong></p>
                        <p class="mb-0">{{ task.created_at | vn_datetime }}</p>
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>H·∫°n ho√†n th√†nh:</strong></p>
                        {% if task.due_date %}
                        <span class="badge bg-{{ 'danger' if (task | is_overdue and task.status != 'DONE') else 'secondary' }}">
                            {{ task.due_date | vn_datetime('%H:%M - %d/%m/%Y') }}
                        </span>
                        {% else %}
                        <span class="text-muted">Ch∆∞a c√≥</span>
                        {% endif %}
                    </div>
                    <div class="col-6 mb-2">
                        <p class="mb-1"><strong>C·∫≠p nh·∫≠t cu·ªëi:</strong></p>
                        <p class="mb-0">{{ task.updated_at | vn_datetime }}</p>
                    </div>
                </div>

                <!-- Th√¥ng tin Recurring -->
                {% if task.recurrence_enabled %}
                <hr>
                <div class="border-start border-primary border-3 ps-3 mb-3">
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-arrow-repeat"></i> T·ª± ƒë·ªông l·∫∑p l·∫°i
                    </h6>
                    <small class="text-muted">
                        <strong>Chu k·ª≥:</strong>
                        {% if task.recurrence_interval_days == 7 %}H√†ng tu·∫ßn
                        {% elif task.recurrence_interval_days == 14 %}2 tu·∫ßn
                        {% elif task.recurrence_interval_days == 30 %}H√†ng th√°ng
                        {% else %}{{ task.recurrence_interval_days }} ng√†y{% endif %}
                        {% if task.last_recurrence_date %}
                        <br><strong>L·∫ßn t·∫°o ti·∫øp theo:</strong> {{ task.last_recurrence_date | add_days(task.recurrence_interval_days) | vn_datetime }}
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <!-- Task con -->
                {% if task.parent_task_id %}
                <div class="border-start border-success border-3 ps-3 mb-3">
                    <small class="text-muted">
                        <i class="bi bi-link-45deg"></i> Nhi·ªám v·ª• l·∫∑p l·∫°i t·ª´
                        <a href="{{ url_for('tasks.task_detail', task_id=task.parent_task_id) }}">
                            #{{ task.parent_task_id }}
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- FORM C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI -->
        {% if (user_assignment and user_assignment.accepted or task.creator_id == current_user.id or current_user.role in ['director', 'manager'])
              and (not task.requires_approval or task.approved == True or current_user.role in ['director', 'manager']) %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> C·∫≠p nh·∫≠t tr·∫°ng th√°i</h5>
            </div>
            <div class="card-body">
                <!-- Accept/Reject -->
                {% if user_assignment and not user_assignment.accepted and user_assignment.assigned_group %}
                <div class="alert alert-info">
                    <p class="mb-2"><strong>Nhi·ªám v·ª• ƒë∆∞·ª£c giao cho nh√≥m {{ user_assignment.assigned_group | role_vn }}</strong></p>
                    <p class="mb-3">B·∫°n c·∫ßn ch·∫•p nh·∫≠n ƒë·ªÉ hi·ªÉn th·ªã trong danh s√°ch c·ªßa m√¨nh.</p>
                    <form method="POST" action="{{ url_for('tasks.accept_task', task_id=task.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check-circle"></i> Ch·∫•p nh·∫≠n
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.reject_task', task_id=task.id) }}" style="display: inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-x-circle"></i> T·ª´ ch·ªëi
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- C·∫£nh b√°o qu√° h·∫°n -->
                {% if (task | is_overdue) and task.status != 'DONE' %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Nhi·ªám v·ª• ƒë√£ qu√° h·∫°n!</strong> Ho√†n th√†nh s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n l√† "Qu√° h·∫°n".
                </div>
                {% endif %}

                <!-- Form -->
                <form method="POST" action="{{ url_for('tasks.update_status', task_id=task.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="status" class="form-label"><strong>Tr·∫°ng th√°i:</strong></label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="status" name="status" onchange="handleStatusChange()">
                                <option value="PENDING" {% if task.status == 'PENDING' %}selected{% endif %}>Ch∆∞a L√†m</option>
                                <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>ƒêang l√†m</option>
                                <option value="DONE" {% if task.status == 'DONE' %}selected{% endif %}>Ho√†n th√†nh</option>
                                <option value="CANCELLED" {% if task.status == 'CANCELLED' %}selected{% endif %}>ƒê√£ h·ªßy</option>
                            </select>
                            <button type="submit" class="btn btn-primary" style="min-width: 120px;">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3" id="completionNoteDiv" style="display: none;">
                        <label for="completion_note" class="form-label">
                            <strong><i class="bi bi-chat-left-text"></i> N·ªôi dung b√°o c√°o:</strong>
                        </label>
                        <textarea class="form-control" id="completion_note" name="completion_note" rows="3"
                                  placeholder="Nh·∫≠p b√°o c√°o..."></textarea>
                    </div>
                </form>

                <script>
                function handleStatusChange() {
                    const statusSelect = document.getElementById('status');
                    const completionNoteDiv = document.getElementById('completionNoteDiv');
                    const currentStatus = '{{ task.status }}';
                    if (statusSelect.value === 'DONE' && currentStatus !== 'DONE') {
                        completionNoteDiv.style.display = 'block';
                    } else {
                        completionNoteDiv.style.display = 'none';
                    }
                }
                document.addEventListener('DOMContentLoaded', handleStatusChange);
                </script>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ===== C·ªòT PH·∫¢I: NG∆Ø·ªúI ƒê∆Ø·ª¢C GIAO + CARDS PH·ª§ ===== -->
    <div class="col-md-4">
        <!-- Ng∆∞·ªùi ƒë∆∞·ª£c giao -->
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Ng∆∞·ªùi ƒë∆∞·ª£c giao</h6>
            </div>
            <div class="card-body">
                {% if assignments %}
                <ul class="list-group list-group-flush">
                    {% for assignment in assignments %}
                    <li class="list-group-item px-0">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <div class="assignment-avatar">
                                {% if assignment.user.avatar %}
                                <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}" alt="">
                                {% else %}
                                {{ assignment.user.full_name[0].upper() }}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <strong class="d-block">{{ assignment.user.full_name }}</strong>
                                <small class="text-muted">{{ assignment.user.role | role_vn }}</small>
                            </div>
                            <div>
                                {% if assignment.accepted %}
                                <span class="badge bg-success">ƒê√£ nh·∫≠n</span>
                                {% else %}
                                <span class="badge bg-warning">Ch·ªù</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if assignment.assigned_group %}
                        <small class="text-muted">Nh√≥m: {{ assignment.assigned_group | role_vn }}</small>
                        {% endif %}
                        {% if assignment.accepted and assignment.accepted_at %}
                        <small class="text-muted d-block">{{ assignment.accepted_at | vn_datetime }}</small>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted mb-0">Ch∆∞a c√≥ ng∆∞·ªùi ƒë∆∞·ª£c g√°n</p>
                {% endif %}
            </div>
        </div>

        <!-- B√°o c√°o ho√†n th√†nh -->
        {% if task.status == 'DONE' %}
        <div class="card mb-3 {% if current_user.role in ['hr', 'accountant'] %}d-none d-md-block{% endif %}">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-clipboard-check-fill"></i> B√°o c√°o ho√†n th√†nh</h6>
            </div>
            <div class="card-body">
                {% set reports = task.completion_reports.all() %}
                {% if reports %}
                {% set completion_report = reports[0] %}
                <div class="d-flex align-items-center gap-2 mb-3">
                    <div class="completer-avatar">
                        {% if completion_report.completer.avatar %}
                        <img src="{{ url_for('profile.get_avatar', filename=completion_report.completer.avatar) }}" alt="">
                        {% else %}
                        {{ completion_report.completer.full_name[0].upper() }}
                        {% endif %}
                    </div>
                    <div>
                        <strong class="d-block">{{ completion_report.completer.full_name }}</strong>
                        <small class="text-muted">{{ completion_report.completed_at | vn_datetime }}</small>
                    </div>
                </div>
                {% if completion_report.completion_time %}
                <p class="mb-2 small">
                    <strong>Th·ªùi gian l√†m vi·ªác:</strong>
                    {% set days = (completion_report.completion_time // 1440) %}
                    {% set hours = ((completion_report.completion_time % 1440) // 60) %}
                    {% set minutes = (completion_report.completion_time % 60) %}
                    {% if days > 0 %}{{ days }}ng√†y {% endif %}
                    {% if hours > 0 %}{{ hours }}gi·ªù {% endif %}{{ minutes }}ph√∫t
                </p>
                {% endif %}
                {% if completion_report.completion_note %}
                <p class="mb-0 small" style="white-space: pre-wrap;">{{ completion_report.completion_note }}</p>
                {% endif %}
                {% else %}
                <p class="text-muted small mb-0">Ho√†n th√†nh tr∆∞·ªõc khi c√≥ h·ªá th·ªëng b√°o c√°o</p>
                {% endif %}
            </div>
        </div>

        <!-- ƒê√°nh gi√° hi·ªáu su·∫•t -->
        <div class="card mb-3">
            <div class="card-header {% if task.performance_rating == 'good' %}bg-success{% elif task.performance_rating == 'bad' %}bg-danger{% else %}bg-secondary{% endif %} text-white">
                <h6 class="mb-0"><i class="bi bi-star-fill"></i> ƒê√°nh gi√°</h6>
            </div>
            <div class="card-body text-center">
                {% if task.performance_rating %}
                <div class="mb-3">
                    {% if task.performance_rating == 'good' %}
                    <i class="bi bi-hand-thumbs-up-fill text-success" style="font-size: 2.5rem;"></i>
                    {% else %}
                    <i class="bi bi-hand-thumbs-down-fill text-danger" style="font-size: 2.5rem;"></i>
                    {% endif %}
                </div>
                <small class="text-muted">{{ task.rated_at | vn_datetime }} - {{ task.rater.full_name }}</small>
                {% if current_user.role in ['director', 'manager'] %}
                <hr>
                <div class="d-flex gap-2 mt-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% endif %}
                {% else %}
                {% if current_user.role in ['director', 'manager'] %}
                <p class="text-muted small mb-3">H√£y ƒë√°nh gi√° hi·ªáu su·∫•t:</p>
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="good"/>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('tasks.rate_task', task_id=task.id) }}" class="flex-fill">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="rating" value="bad"/>
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-hand-thumbs-down-fill"></i>
                        </button>
                    </form>
                </div>
                {% else %}
                <p class="text-muted small mb-0">
                    <i class="bi bi-hourglass-split"></i> Ch·ªù ƒë√°nh gi√°
                </p>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- ===== FULL WIDTH: N√öT M·ªû TRANG TH·∫¢O LU·∫¨N ===== -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Trao ƒë·ªïi</h6>
            </div>
            <div class="card-body text-center py-5">
                <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                <p class="mt-3 mb-3 text-muted">Nh·∫•n v√†o n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem v√† tham gia th·∫£o lu·∫≠n</p>
                <a href="{{ url_for('tasks.task_discussion', task_id=task.id) }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-chat-dots"></i> M·ªü trang th·∫£o lu·∫≠n
                    {% if task.unread_comment_count > 0 %}
                    <span class="badge bg-danger ms-2">{{ task.unread_comment_count }}</span>
                    {% endif %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    TASK_ID: {{ task.id }},
    CURRENT_USER_ID: {{ current_user.id }},
    CURRENT_USER_ROLE: '{{ current_user.role }}',
    CSRF_TOKEN: '{{ csrf_token() }}'
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ============================================
// TASK APPROVAL FUNCTIONS
// ============================================
function approveSelfTask(taskId) {
    if (!confirm('X√°c nh·∫≠n ph√™ duy·ªát c√¥ng vi·ªác n√†y?')) {
        return;
    }

    fetch(`/tasks/${taskId}/approve-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ƒê√£ ph√™ duy·ªát c√¥ng vi·ªác', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚ùå ' + (data.error || 'L·ªói ph√™ duy·ªát'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('‚ùå C√≥ l·ªói x·∫£y ra', 'danger');
    });
}

function rejectSelfTask(taskId) {
    if (!confirm('X√°c nh·∫≠n t·ª´ ch·ªëi c√¥ng vi·ªác n√†y?\n\n‚ö†Ô∏è C√¥ng vi·ªác s·∫Ω b·ªã H·ª¶Y v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) {
        return;
    }

    fetch(`/tasks/${taskId}/reject-self-task`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CONFIG.CSRF_TOKEN
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ƒê√£ t·ª´ ch·ªëi c√¥ng vi·ªác', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('‚ùå ' + (data.error || 'L·ªói t·ª´ ch·ªëi'), 'danger');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showToast('‚ùå C√≥ l·ªói x·∫£y ra', 'danger');
    });
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ Task Detail Page Loaded');
});
</script>
{% endblock %}