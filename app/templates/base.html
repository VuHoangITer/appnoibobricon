<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}H·ªá th·ªëng qu·∫£n l√Ω c√¥ng vi·ªác{% endblock %}</title>

    <style>
    /* ·∫®n main content khi ch∆∞a load xong */
    body:not(.page-loaded) .main-content,
    body:not(.page-loaded) .hub-main-container {
        opacity: 0;
    }

    /* Loading spinner */
    body:not(.page-loaded)::before {
        content: '';
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: globalSpin 0.8s linear infinite;
        z-index: 9999;
    }

    @keyframes globalSpin {
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Fade in khi loaded */
    body.page-loaded .main-content,
    body.page-loaded .hub-main-container {
        opacity: 1;
        animation: globalFadeIn 0.3s ease;
    }

    @keyframes globalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">

    <!-- Preload Logo Image -->
    <link rel="preload" href="{{ url_for('static', filename='images/logo.png') }}" as="image">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRICON Workflow">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ config.VERSION }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notification-settings.css') }}?v={{ config.VERSION }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/seasonal-effects.css') }}?v={{ config.VERSION }}">

    <style>
        html {
            scroll-behavior: smooth;
        }

        .main-wrapper {
            margin-left: 0 !important;
            transition: none !important;
        }

        /* TOP NAVBAR LOGO */
        .navbar-logo {
            height: 45px;
            width: auto;
            object-fit: contain;
            transition: transform 0.3s ease;
            margin-right: 15px;
            cursor: pointer;
        }

        .navbar-logo:hover {
            transform: scale(1.05);
        }

        .navbar-logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            padding: 0;
            margin-right: 8px;
        }

        /* USER AVATAR DROPDOWN */
        .user-avatar-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0dcaf0;
            color: white;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: 12px;
        }

        .user-avatar-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 240px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: hidden;
        }

        .user-avatar-btn.active + .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            padding: 20px;
            background: #0dcaf0;
            color: white;
            text-align: center;
        }

        .user-dropdown-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            margin: 0 auto 12px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .user-dropdown-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-dropdown-role {
            font-size: 13px;
            opacity: 0.9;
        }

        .user-dropdown-body {
            padding: 8px 0;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }

        .user-dropdown-item:hover {
            background: #f8f9fa;
        }

        .user-dropdown-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
            color: #667eea;
        }

        .user-dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #e9ecef;
            margin-top: 4px;
        }

        .user-dropdown-item.logout i {
            color: #dc3545;
        }

        /* MODULE MENU BUTTON */
        .module-menu-btn {
            position: relative;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #000000;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
            display: none;
        }

        .module-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar-logo {
                height: 38px;
            }

            .user-dropdown {
                right: -10px;
            }

            .module-menu-btn {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .navbar-logo {
                height: 32px;
            }

            .module-menu-btn {
                font-size: 1.2rem;
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div id="seasonalEffects"></div>

    {% if current_user.is_authenticated %}
    <div class="main-wrapper" id="mainWrapper">
        <!-- TOP NAVBAR -->
        <nav class="top-navbar">
            <div class="navbar-left">
                <a href="{{ url_for('hub.workflow_hub') }}" class="navbar-logo-link" title="V·ªÅ Trang Ch·ªß">
                    <img src="{{ url_for('static', filename='images/logo.png') }}"
                         alt="BRICON Logo"
                         class="navbar-logo">
                </a>
            </div>
            <div class="navbar-right">
                <button class="module-menu-btn" id="moduleMenuBtn" style="display: none;">
                    <i class="bi bi-list"></i>
                </button>
                <button class="notification-btn" onclick="window.location.href='{{ url_for('notifications.list_notifications') }}'">
                    <i class="bi bi-bell-fill"></i>
                    <span class="notification-badge" id="notif-count" style="display: none;"></span>
                </button>

                <div style="position: relative;">
                    <button class="user-avatar-btn" id="userAvatarBtn" onclick="toggleUserDropdown()">
                        {% if current_user.avatar %}
                            <img src="{{ url_for('profile.get_avatar', filename=current_user.avatar) }}"
                                 alt="Avatar"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        {% else %}
                            {{ current_user.full_name[0].upper() }}
                        {% endif %}
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-avatar">
                                {% if current_user.avatar %}
                                    <img src="{{ url_for('profile.get_avatar', filename=current_user.avatar) }}"
                                         alt="Avatar"
                                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                    {{ current_user.full_name[0].upper() }}
                                {% endif %}
                            </div>
                            <div class="user-dropdown-name">{{ current_user.full_name }}</div>
                            <div class="user-dropdown-role">{{ current_user.role | role_vn }}</div>
                        </div>
                        <div class="user-dropdown-body">
                            {% if current_user.role == 'director' %}
                            <a href="{{ url_for('seasonal_effects.settings') }}" class="user-dropdown-item">
                                <i class="bi bi-snow"></i>
                                <span>Hi·ªáu ·ª©ng theo m√πa</span>
                            </a>
                            {% endif %}
                            <a href="{{ url_for('profile.settings') }}" class="user-dropdown-item">
                                <i class="bi bi-gear"></i>
                                <span>C√†i ƒë·∫∑t t√†i kho·∫£n</span>
                            </a>
                            <a href="{{ url_for('auth.logout') }}" class="user-dropdown-item logout">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <!-- END TOP NAVBAR -->

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-container" id="flashContainer">
                    {% for category, message in messages %}
                    <div class="flash-message {{ category }}" data-duration="5000">
                        <div class="flash-icon">
                            <i class="bi bi-{% if category == 'success' %}check-circle-fill{% elif category == 'danger' %}exclamation-triangle-fill{% elif category == 'warning' %}exclamation-circle-fill{% else %}info-circle-fill{% endif %}"></i>
                        </div>
                        <div class="flash-content">
                            <strong>{% if category == 'success' %}Th√†nh c√¥ng{% elif category == 'danger' %}L·ªói{% elif category == 'warning' %}C·∫£nh b√°o{% else %}Th√¥ng b√°o{% endif %}</strong>
                            <p>{{ message }}</p>
                        </div>
                        <button class="flash-close" onclick="closeFlash(this)">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="flash-progress"></div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>
    {% else %}
    {% block login_content %}{% endblock %}
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ========== CACHE BUSTER ========== -->
    <script>
        // ‚úÖ CACHE BUSTER - OPTIMIZED VERSION
        (function() {
            const VERSION = '{{ config.VERSION }}';
            const STORED_VERSION = localStorage.getItem('app_version');

            // Ch·ªâ reload khi version thay ƒë·ªïi
            if (STORED_VERSION && STORED_VERSION !== VERSION) {
                console.log('üîÑ New version detected! Clearing cache...');

                // Clear cache
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }

                // Update version
                localStorage.setItem('app_version', VERSION);

                // Hard reload
                window.location.reload(true);
            } else if (!STORED_VERSION) {
                // First time visit
                localStorage.setItem('app_version', VERSION);
            }
        })();
    </script>
    <!-- ================================== -->

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ ServiceWorker registered successfully');
                    })
                    .catch(function(err) {
                        console.log('‚ùå ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>

    <!-- SSE Manager - Load cho t·∫•t c·∫£ authenticated users -->
    {% if current_user.is_authenticated %}
    <script src="{{ url_for('static', filename='js/sse-manager.js') }}?v={{ config.VERSION }}"></script>
    <script>
    // ==========================================
    // SSE CLEANUP ON NAVIGATION
    // ==========================================
    (function() {
        let isNavigating = false;

        // Disconnect khi click link
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a[href]');
            if (link && !link.href.startsWith('#') && !link.target) {
                isNavigating = true;
                if (window.sseManager) {
                    console.log('üö™ Link clicked - disconnecting SSE');
                    window.sseManager.disconnectAll();
                }
            }
        });

        // Disconnect khi submit form
        document.addEventListener('submit', function(e) {
            isNavigating = true;
            if (window.sseManager) {
                console.log('üö™ Form submit - disconnecting SSE');
                window.sseManager.disconnectAll();
            }
        });

        // Disconnect khi unload
        window.addEventListener('beforeunload', function() {
            if (window.sseManager && !isNavigating) {
                console.log('üö™ Page unload - disconnecting SSE');
                window.sseManager.disconnectAll();
            }
        });

        // Disconnect khi pagehide (mobile Safari)
        window.addEventListener('pagehide', function() {
            if (window.sseManager) {
                console.log('üö™ Page hide - disconnecting SSE');
                window.sseManager.disconnectAll();
            }
        });
    })();
    </script>
    {% endif %}

    <!-- Notification Sound & Manager -->
    {% if current_user.is_authenticated %}
    <script src="{{ url_for('static', filename='js/notification-sound.js') }}?v={{ config.VERSION }}"></script>
    <script src="{{ url_for('static', filename='js/notification-manager.js') }}?v={{ config.VERSION }}"></script>
    {% endif %}

    <script>
        // ==========================================
        // USER DROPDOWN TOGGLE
        // ==========================================
        function toggleUserDropdown() {
            const btn = document.getElementById('userAvatarBtn');
            if (!btn) return;

            btn.classList.toggle('active');

            if (btn.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUserDropdownOutside);
                }, 0);
            } else {
                document.removeEventListener('click', closeUserDropdownOutside);
            }
        }

        function closeUserDropdownOutside(e) {
            const btn = document.getElementById('userAvatarBtn');
            const dropdown = document.getElementById('userDropdown');

            if (!btn || !dropdown) return;

            if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
                btn.classList.remove('active');
                document.removeEventListener('click', closeUserDropdownOutside);
            }
        }

        // NOTIFICATION COUNT UPDATE
        {% if current_user.is_authenticated %}
        function updateNotifCount() {
            fetch('{{ url_for("notifications.unread_count") }}')
                .then(res => res.json())
                .then(data => {
                    const badge = document.getElementById('notif-count');
                    if (!badge) return;

                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(err => console.error(' Error fetching notifications:', err));
        }
        {% endif %}

        // ==========================================
        // SCROLL POSITION PERSISTENCE
        // ==========================================
        {% if current_user.is_authenticated %}
        (function() {
            const CONTENT_SCROLL_KEY = 'main_content_scroll_position';

            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                // Restore scroll position
                const savedContentScroll = sessionStorage.getItem(CONTENT_SCROLL_KEY);
                if (savedContentScroll) {
                    setTimeout(function() {
                        window.scrollTo(0, parseInt(savedContentScroll));
                    }, 50);
                }

                // Save scroll position
                let contentScrollTimeout;
                window.addEventListener('scroll', function() {
                    clearTimeout(contentScrollTimeout);
                    contentScrollTimeout = setTimeout(function() {
                        sessionStorage.setItem(CONTENT_SCROLL_KEY, window.scrollY);
                    }, 100);
                });
            }

            // Save scroll position before navigation
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a[href]');
                if (link && !link.getAttribute('href').startsWith('#')) {
                    sessionStorage.setItem(CONTENT_SCROLL_KEY, window.scrollY);
                }
            });
        })();
        {% endif %}

        {% if current_user.is_authenticated %}
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîî Loading notification count...');

                setTimeout(function() {
                    if (typeof updateNotifCount === 'function') {
                        updateNotifCount();
                    }
                }, 200);
            });
        })();
        {% endif %}

        // ==========================================
        // FLASH MESSAGES AUTO DISMISS
        // ==========================================
        function closeFlash(btn) {
            const flashMsg = btn.closest('.flash-message');
            flashMsg.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(() => {
                flashMsg.remove();

                // X√≥a container n·∫øu kh√¥ng c√≤n flash n√†o
                const container = document.getElementById('flashContainer');
                if (container && container.children.length === 0) {
                    container.remove();
                }
            }, 300);
        }

        // Auto dismiss all flash messages after duration
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');

            flashMessages.forEach(function(flash) {
                const duration = parseInt(flash.dataset.duration) || 5000;

                setTimeout(function() {
                    if (flash.parentElement) {
                        closeFlash(flash.querySelector('.flash-close'));
                    }
                }, duration);
            });
        });
    </script>
    <!-- L·ªói th√¨ x√≥a -->
    <!-- MOBILE BOTTOM NAVIGATION -->
    {% if current_user.is_authenticated %}
    <nav class="mobile-bottom-nav">
        <!-- 1. HOME -->
        <a href="{{ url_for('hub.workflow_hub') }}"
           class="bottom-nav-item"
           title="Trang Ch·ªß">
            <i class="bi bi-house-door-fill"></i>
        </a>

        <!-- 2. MODULE MENU -->
        <button class="bottom-nav-item"
                id="mobileModuleMenuBtn"
                title="Menu Module">
            <i class="bi bi-list"></i>
        </button>

        <!-- 3. T·∫†O NHI·ªÜM V·ª§ - N√öT M·ªöI -->
        <a href="{{ url_for('tasks.create_task') }}"
           class="bottom-nav-item bottom-nav-create"
           title="T·∫°o Nhi·ªám V·ª•">
            <div class="create-task-circle">
                <i class="bi bi-plus-circle"></i>
            </div>
        </a>

        <!-- 4. TH√îNG B√ÅO -->
        <a href="{{ url_for('notifications.list_notifications') }}"
           class="bottom-nav-item"
           title="Th√¥ng B√°o">
            <i class="bi bi-bell-fill"></i>
            <span class="bottom-nav-badge"
                  id="mobile-notif-count"
                  style="display: none;"></span>
        </a>

        <!-- 5. T√ÄI KHO·∫¢N -->
        <button class="bottom-nav-item"
                id="mobileUserBtn"
                title="T√†i Kho·∫£n">
            <div class="bottom-nav-avatar">
                {% if current_user.avatar %}
                    <img src="{{ url_for('profile.get_avatar', filename=current_user.avatar) }}"
                         alt="Avatar">
                {% else %}
                    {{ current_user.full_name[0].upper() }}
                {% endif %}
            </div>
        </button>
    </nav>

    <!-- MOBILE USER DROPDOWN -->
    <div class="mobile-dropdown-overlay" id="mobileDropdownOverlay"></div>
    <div class="mobile-user-dropdown" id="mobileUserDropdown">
        <div class="user-dropdown-header">
            <div class="user-dropdown-avatar">
                {% if current_user.avatar %}
                    <img src="{{ url_for('profile.get_avatar', filename=current_user.avatar) }}"
                         alt="Avatar"
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                {% else %}
                    {{ current_user.full_name[0].upper() }}
                {% endif %}
            </div>
            <div class="user-dropdown-name">{{ current_user.full_name }}</div>
            <div class="user-dropdown-role">{{ current_user.role | role_vn }}</div>
        </div>
        <div class="user-dropdown-body">
            {% if current_user.role == 'director' %}
            <a href="{{ url_for('seasonal_effects.settings') }}" class="user-dropdown-item">
                <i class="bi bi-snow"></i>
                <span>Hi·ªáu ·ª©ng theo m√πa</span>
            </a>
            {% endif %}
            <button class="user-dropdown-item notification-settings-btn" onclick="if(window.notificationManager) window.notificationManager.openSettings()">
                <i class="bi bi-volume-up-fill"></i>
                <span>C√†i ƒë·∫∑t th√¥ng b√°o</span>
            </button>
            <a href="{{ url_for('profile.settings') }}" class="user-dropdown-item">
                <i class="bi bi-gear"></i>
                <span>C√†i ƒë·∫∑t t√†i kho·∫£n</span>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="user-dropdown-item logout">
                <i class="bi bi-box-arrow-right"></i>
                <span>ƒêƒÉng xu·∫•t</span>
            </a>
        </div>
    </div>

    <script>
    // ==========================================
    // ‚úÖ MOBILE BOTTOM NAV - FINAL VERSION
    // ==========================================
    (function() {
        'use strict';

        if (window.mobileBottomNavInitialized) {
            console.log('‚ö†Ô∏è Mobile bottom nav already initialized');
            return;
        }
        window.mobileBottomNavInitialized = true;

        console.log('üì± Initializing mobile bottom nav...');

        // ==========================================
        // 1. MOBILE USER DROPDOWN
        // ==========================================
        const mobileUserBtn = document.getElementById('mobileUserBtn');
        const mobileUserDropdown = document.getElementById('mobileUserDropdown');
        const mobileDropdownOverlay = document.getElementById('mobileDropdownOverlay');

        if (mobileUserBtn && mobileUserDropdown && mobileDropdownOverlay) {
            mobileUserBtn.addEventListener('click', function() {
                mobileUserDropdown.classList.toggle('active');
                mobileDropdownOverlay.classList.toggle('active');
            });

            mobileDropdownOverlay.addEventListener('click', function() {
                mobileUserDropdown.classList.remove('active');
                mobileDropdownOverlay.classList.remove('active');
            });
        }

        // ==========================================
        // 2. MOBILE MODULE MENU BUTTON
        // ==========================================
        const mobileModuleMenuBtn = document.getElementById('mobileModuleMenuBtn');
        if (mobileModuleMenuBtn) {
            mobileModuleMenuBtn.addEventListener('click', function() {
                const activeModule = document.querySelector('.module-container.active');
                if (activeModule) {
                    const moduleName = activeModule.id.replace('module-', '');
                    if (typeof toggleSidebar === 'function') {
                        toggleSidebar(moduleName);
                    }
                } else {
                    console.log('üìç Currently at hub, no sidebar to toggle');
                }
            });
        }

        // ==========================================
        // 3. SYNC MOBILE NOTIFICATION BADGE
        // ==========================================
        function syncMobileNotificationBadge() {
            const desktopBadge = document.getElementById('notif-count');
            const mobileBadge = document.getElementById('mobile-notif-count');

            if (!desktopBadge || !mobileBadge) {
                console.log('‚ö†Ô∏è Badge elements not found');
                return;
            }

            const count = desktopBadge.textContent.trim();
            const isVisible = desktopBadge.style.display !== 'none';

            console.log('üîî Desktop badge:', { count, isVisible, display: desktopBadge.style.display });

            if (isVisible && count && count !== '0') {
                mobileBadge.textContent = count;
                mobileBadge.style.display = 'inline-block';
                console.log('‚úÖ Mobile badge updated:', count);
            } else {
                mobileBadge.style.display = 'none';
                console.log('‚ùå Mobile badge hidden');
            }
        }

        // ==========================================
        // 4. HOOK INTO updateNotifCount
        // ==========================================
        const originalUpdateNotifCount = window.updateNotifCount;

        window.updateNotifCount = function() {
            console.log('üéØ updateNotifCount called');

            if (originalUpdateNotifCount) {
                originalUpdateNotifCount();
            }

            // Sync sau khi desktop badge ƒë√£ update
            setTimeout(function() {
                syncMobileNotificationBadge();
            }, 100);
        };

        // ==========================================
        // 5. HIGHLIGHT ACTIVE PAGE
        // ==========================================
        function highlightActivePage() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.mobile-bottom-nav .bottom-nav-item');

            navItems.forEach(function(item) {
                const href = item.getAttribute('href');
                if (href && currentPath === href) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ==========================================
        // 6. INITIALIZATION & SYNC
        // ==========================================

        // Initial sync
        console.log('üîÑ Initial sync...');
        highlightActivePage();

        // Wait for DOM to be fully ready
        setTimeout(function() {
            syncMobileNotificationBadge();
        }, 300);

        // Sync again after 1 second (ensure desktop badge loaded)
        setTimeout(function() {
            console.log('üîÑ Second sync (1s delay)...');
            syncMobileNotificationBadge();
        }, 1000);

        // Sync when tab becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è Tab visible - syncing badges');
                setTimeout(syncMobileNotificationBadge, 200);
            }
        });

        // Expose globally for debugging
        window.syncMobileNotificationBadge = syncMobileNotificationBadge;

        console.log('‚úÖ Mobile bottom nav initialized');

    })();
    </script>
    {% endif %}
    {% block scripts %}{% endblock %}
    {% if current_user.is_authenticated %}
        <!-- Seasonal Effects -->
        <script src="{{ url_for('static', filename='js/santa-effect.js') }}?v={{ config.VERSION }}"></script>
        <script src="{{ url_for('static', filename='js/seasonal-effects.js') }}?v={{ config.VERSION }}"></script>
        <script>
            // Auto-init seasonal effects
            if (window.SeasonalEffects) {
                SeasonalEffects.init();
            }
        </script>
    {% endif %}
    <script>
        (function() {
            // Mark page as loaded khi DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    requestAnimationFrame(function() {
                        document.body.classList.add('page-loaded');
                    });
                });
            } else {
                // N·∫øu ƒë√£ load r·ªìi (cache)
                requestAnimationFrame(function() {
                    document.body.classList.add('page-loaded');
                });
            }

            // Fallback: force loaded sau 800ms
            setTimeout(function() {
                if (!document.body.classList.contains('page-loaded')) {
                    document.body.classList.add('page-loaded');
                }
            }, 800);
        })();
    </script>
</body>
</html>