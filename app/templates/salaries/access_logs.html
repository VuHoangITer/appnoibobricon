{% extends "base.html" %}

{% block title %}Lịch Sử Truy Cập - {{ salary.employee_name }}{% endblock %}
{% block page_title %}Lịch Sử Truy Cập Link Chia Sẻ{% endblock %}

{% block extra_css %}
<style>
.access-log-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.access-log-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

.access-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.access-time {
    font-size: 0.9rem;
    color: #6c757d;
}

.access-ip {
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    font-weight: 600;
    color: #0d6efd;
}

.device-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.device-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.device-item i {
    font-size: 1.5rem;
}

.device-item .info {
    flex: 1;
}

.device-item .label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.device-item .value {
    font-size: 0.95rem;
    font-weight: 600;
    color: #212529;
}

.location-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    font-size: 0.85rem;
}

.stats-summary {
    background: #86b7fe;
    color: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    opacity: 0.9;
}

.link-info-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.no-access {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.no-access i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}
</style>
{% endblock %}

{% block content %}
<!-- Stats Summary -->
<div class="stats-summary">
    <h4 class="mb-0">
        <i class="bi bi-graph-up"></i> Tổng Quan Truy Cập
    </h4>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value">{{ access_logs|length }}</div>
            <div class="stat-label">Lượt Truy Cập</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ share_link.view_count }}</div>
            <div class="stat-label">Đếm Chính Thức</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% if share_link.max_views %}
                    {{ share_link.max_views - share_link.view_count }}
                {% else %}
                    ∞
                {% endif %}
            </div>
            <div class="stat-label">Còn Lại</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% set unique_ips = access_logs|map(attribute='ip_address')|unique|list|length %}
                {{ unique_ips }}
            </div>
            <div class="stat-label">IP Khác Nhau</div>
        </div>
    </div>
</div>

<!-- Link Info -->
<div class="link-info-card">
    <div class="row align-items-center">
        <div class="col-md-8">
            <strong><i class="bi bi-link-45deg"></i> Link:</strong>
            <code>{{ request.host_url }}salaries/shared/{{ share_link.token }}</code>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('salaries.manage_share_links', salary_id=salary.id) }}" 
               class="btn btn-sm btn-primary">
                <i class="bi bi-arrow-left"></i> Quay Lại
            </a>
        </div>
    </div>
</div>

<!-- Access Logs -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> Lịch Sử Truy Cập Chi Tiết
            <span class="badge bg-primary ms-2">{{ access_logs|length }} lượt</span>
        </h5>
    </div>
    <div class="card-body">
        {% if access_logs %}
            {% for log in access_logs %}
            <div class="access-log-card">
                <div class="access-header">
                    <div>
                        <div class="access-ip">
                            <i class="bi bi-globe"></i> {{ log.ip_address }}
                        </div>
                        {% if log.country or log.city %}
                        <div class="mt-2">
                            <span class="location-badge">
                                <i class="bi bi-geo-alt-fill"></i>
                                {% if log.city %}{{ log.city }}{% endif %}
                                {% if log.city and log.country %}, {% endif %}
                                {% if log.country %}{{ log.country }}{% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <div class="access-time">
                            <i class="bi bi-clock"></i>
                            {{ log.accessed_at|vn_datetime }}
                        </div>
                    </div>
                </div>
                
                <div class="device-info">
                    <!-- Browser -->
                    <div class="device-item">
                        <i class="bi bi-browser-chrome text-primary"></i>
                        <div class="info">
                            <div class="label">Trình Duyệt</div>
                            <div class="value">
                                {{ log.browser }}
                                {% if log.browser_version %}
                                    <small class="text-muted">{{ log.browser_version }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Operating System -->
                    <div class="device-item">
                        <i class="bi {{ log.get_os_icon() }} text-success"></i>
                        <div class="info">
                            <div class="label">Hệ Điều Hành</div>
                            <div class="value">{{ log.os or 'Unknown' }}</div>
                        </div>
                    </div>
                    
                    <!-- Device Type -->
                    <div class="device-item">
                        <i class="bi {{ log.get_device_icon() }} text-info"></i>
                        <div class="info">
                            <div class="label">Thiết Bị</div>
                            <div class="value">
                                {% if log.device_brand %}
                                    {{ log.device_brand }}
                                {% endif %}
                                {{ log.device_type|capitalize }}
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if log.user_agent %}
                <details class="mt-3">
                    <summary class="text-muted" style="cursor: pointer; font-size: 0.85rem;">
                        <i class="bi bi-info-circle"></i> Chi tiết User Agent
                    </summary>
                    <pre class="mt-2 p-2 bg-light rounded" style="font-size: 0.75rem; white-space: pre-wrap; word-wrap: break-word;">{{ log.user_agent }}</pre>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="no-access">
                <i class="bi bi-inbox"></i>
                <h5>Chưa Có Lượt Truy Cập Nào</h5>
                <p class="text-muted">Link này chưa được ai truy cập.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Export Button -->
{% if access_logs %}
<div class="text-center mt-4">
    <button class="btn btn-outline-primary" onclick="exportToCSV()">
        <i class="bi bi-download"></i> Xuất CSV
    </button>
</div>

<script>
function exportToCSV() {
    const logs = [
        ['Thời Gian', 'IP Address', 'Trình Duyệt', 'Phiên Bản', 'Hệ Điều Hành', 'Thiết Bị', 'Thương Hiệu', 'Vị Trí']
    ];
    
    {% for log in access_logs %}
    logs.push([
        '{{ log.accessed_at|vn_datetime }}',
        '{{ log.ip_address }}',
        '{{ log.browser or "" }}',
        '{{ log.browser_version or "" }}',
        '{{ log.os or "" }}',
        '{{ log.device_type or "" }}',
        '{{ log.device_brand or "" }}',
        '{% if log.city %}{{ log.city }}{% endif %}{% if log.city and log.country %}, {% endif %}{% if log.country %}{{ log.country }}{% endif %}'
    ]);
    {% endfor %}
    
    const csvContent = logs.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'access_logs_{{ share_link.token[:8] }}_{{ now.strftime("%Y%m%d") }}.csv';
    link.click();
}
</script>
{% endif %}

{% endblock %}