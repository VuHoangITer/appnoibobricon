{% extends "base.html" %}

{% block title %}Tạo bảng lương{% endblock %}
{% block page_title %}Tạo Bảng Lương{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Tạo bảng lương mới</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="salaryForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" id="employee_id" name="employee_id">

                    <!-- Thông tin nhân viên -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Nhân Viên *</label>
                            <select class="form-select" id="employee_select">
                                <option value="">-- Chọn nhân viên hoặc nhập tên mới --</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}"
                                        data-name="{{ emp.full_name }}"
                                        data-grade-id="{{ emp.salary_grade_id or '' }}">
                                    {{ emp.full_name }}
                                    {% if emp.salary_grade %}({{ emp.salary_grade.name }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Chọn nhân viên có sẵn để tự động điền lương</small>
                        </div>

                        <div class="col-md-6">
                            <label for="employee_name" class="form-label">Hoặc Nhập Tên Mới</label>
                            <input type="text" class="form-control" id="employee_name" name="employee_name"
                                   placeholder="Nhập họ và tên nhân viên mới">
                        </div>
                    </div>

                    <!-- Cấp bậc lương -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cấp Bậc Lương (Tự động điền)</label>
                            <select class="form-select" id="salary_grade_select">
                                <option value="">-- Không chọn --</option>
                                {% for grade in salary_grades %}
                                <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Chọn để tự động điền lương cơ bản + năng lực</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Tháng/Năm *</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select" id="month_select" name="month_select" required>
                                        <option value="">Chọn tháng</option>
                                        {% for m in range(1, 13) %}
                                        <option value="{{ m }}">Tháng {{ m }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="year_select" name="year_select" required>
                                        <option value="">Chọn năm</option>
                                    </select>
                                </div>
                            </div>
                            <input type="hidden" id="month" name="month">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="work_days_in_month" class="form-label">
                                Quy định số Công/tháng *
                                <i class="bi bi-info-circle" title="Tự động điền theo tháng"></i>
                            </label>
                            <input type="number" class="form-control calc-input" id="work_days_in_month"
                                   name="work_days_in_month" step="0.5" required readonly>
                            <small class="text-muted">Tự động điền khi chọn tháng/năm</small>
                        </div>
                        <div class="col-md-6">
                            <label for="actual_work_days" class="form-label">Số công của tháng *</label>
                            <input type="number" class="form-control calc-input" id="actual_work_days"
                                   name="actual_work_days" step="0.5" required>
                            <small class="text-muted">Số ngày thực tế đi làm</small>
                        </div>
                    </div>

                    <!-- Lương cơ bản -->
                    <h5 class="mb-3"><i class="bi bi-wallet2"></i> Lương cơ bản</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="basic_salary" class="form-label">Lương cơ bản/tháng (₫) *</label>
                            <input type="number" class="form-control calc-input" id="basic_salary"
                                   name="basic_salary" step="1" required>
                        </div>
                        <div class="col-md-6">
                            <label for="responsibility_salary" class="form-label">Lương trách nhiệm/tháng (₫)</label>
                            <input type="number" class="form-control calc-input" id="responsibility_salary"
                                   name="responsibility_salary" step="1" value="0">
                        </div>
                    </div>

                    <!-- Lương năng lực -->
                    <h5 class="mb-3"><i class="bi bi-award"></i> Lương năng lực</h5>
                    <div id="capacity-container" class="mb-4">
                        <div class="capacity-item row mb-2">
                            <div class="col-md-7">
                                <input type="text" class="form-control" name="capacity_content[]" placeholder="Nội dung">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control calc-input capacity-amount"
                                       name="capacity_amount[]" placeholder="Số tiền" step="1" value="0">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-danger btn-sm remove-capacity">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success btn-sm mb-4" id="add-capacity">
                        <i class="bi bi-plus-circle"></i> Thêm lương năng lực
                    </button>

                    <!-- Các khoản khấu trừ -->
                    <h5 class="mb-3"><i class="bi bi-dash-circle"></i> Các khoản khấu trừ</h5>
                    <div id="deduction-container" class="mb-4">
                        <div class="deduction-item row mb-2">
                            <div class="col-md-7">
                                <input type="text" class="form-control" name="deduction_content[]" placeholder="Nội dung">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control calc-input deduction-amount"
                                       name="deduction_amount[]" placeholder="Số tiền" step="1" value="0">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-danger btn-sm remove-deduction">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success btn-sm mb-4" id="add-deduction">
                        <i class="bi bi-plus-circle"></i> Thêm khoản khấu trừ
                    </button>

                    <hr>

                    <!-- Kết quả tính toán -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="mb-3"><i class="bi bi-calculator"></i> Kết quả tính toán</h5>

                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <strong>Lương cơ bản/ngày:</strong>
                                    <span id="display_basic_per_day" class="float-end">0 ₫</span>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong>Lương trách nhiệm/ngày:</strong>
                                    <span id="display_resp_per_day" class="float-end">0 ₫</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <strong class="text-primary">Lương chính:</strong>
                                    <span id="display_main_salary" class="float-end text-primary fw-bold">0 ₫</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <strong>Tổng lương năng lực:</strong>
                                    <span id="display_capacity_bonus" class="float-end">0 ₫</span>
                                </div>
                            </div>

                            <hr>

                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <strong class="text-info" style="font-size: 1.1rem;">Tổng thu nhập:</strong>
                                    <span id="display_total_income" class="float-end text-info fw-bold" style="font-size: 1.1rem;">0 ₫</span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-2">
                                    <strong class="text-danger">Tổng khấu trừ:</strong>
                                    <span id="display_total_deduction" class="float-end text-danger fw-bold">0 ₫</span>
                                </div>
                            </div>

                            <hr style="border-width: 2px;">

                            <div class="row">
                                <div class="col-md-12">
                                    <strong class="text-success" style="font-size: 1.3rem;">
                                        <i class="bi bi-cash-coin"></i> Lương thực lĩnh:
                                    </strong>
                                    <span id="display_net_salary" class="float-end text-success fw-bold" style="font-size: 1.3rem;">0 ₫</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Tạo bảng lương
                        </button>
                        <a href="{{ url_for('salaries.list_salaries') }}" class="btn btn-secondary btn-lg">Hủy</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Populate year dropdown
const yearSelect = document.getElementById('year_select');
const currentYear = new Date().getFullYear();
for (let year = currentYear - 5; year <= currentYear + 5; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = 'Năm ' + year;
    if (year === currentYear) {
        option.selected = true;
    }
    yearSelect.appendChild(option);
}

// Set current month
const currentMonth = new Date().getMonth() + 1;
document.getElementById('month_select').value = currentMonth;

// Update month hidden field
function updateMonthField() {
    const month = document.getElementById('month_select').value;
    const year = document.getElementById('year_select').value;
    if (month && year) {
        const monthStr = month.padStart(2, '0');
        document.getElementById('month').value = `${monthStr}-${year}`;

        // Auto-fetch work days
        fetchWorkDays(parseInt(month), parseInt(year));
    }
}

document.getElementById('month_select').addEventListener('change', updateMonthField);
document.getElementById('year_select').addEventListener('change', updateMonthField);
updateMonthField();

// Fetch work days from server
async function fetchWorkDays(month, year) {
    try {
        const response = await fetch(`/work-days/api/work-days?month=${month}&year=${year}`);
        const data = await response.json();
        document.getElementById('work_days_in_month').value = data.work_days;
        calculate();
    } catch (error) {
        console.error('Error fetching work days:', error);
    }
}

// Employee select handler
document.getElementById('employee_select').addEventListener('change', async function() {
    const selectedOption = this.options[this.selectedIndex];
    const employeeId = this.value;

    if (!employeeId) {
        document.getElementById('employee_id').value = '';
        document.getElementById('employee_name').value = '';
        document.getElementById('salary_grade_select').value = '';
        return;
    }

    const employeeName = selectedOption.dataset.name;
    const gradeId = selectedOption.dataset.gradeId;

    document.getElementById('employee_id').value = employeeId;
    document.getElementById('employee_name').value = employeeName;
    document.getElementById('employee_name').readOnly = true;

    if (gradeId) {
        document.getElementById('salary_grade_select').value = gradeId;
        // Trigger auto-fill
        await loadSalaryGrade(gradeId);
    }
});

// When typing manual name, clear employee_id
document.getElementById('employee_name').addEventListener('input', function() {
    if (document.getElementById('employee_select').value) {
        document.getElementById('employee_select').value = '';
        document.getElementById('employee_id').value = '';
        this.readOnly = false;
    }
});

// Salary grade auto-fill
document.getElementById('salary_grade_select').addEventListener('change', async function() {
    const gradeId = this.value;
    if (gradeId) {
        await loadSalaryGrade(gradeId);
    }
});

async function loadSalaryGrade(gradeId) {
    try {
        const response = await fetch(`/salary-grades/api/grade/${gradeId}`);
        const data = await response.json();

        // Fill basic salaries
        document.getElementById('basic_salary').value = data.basic_salary;
        document.getElementById('responsibility_salary').value = data.responsibility_salary;

        // Fill capacity bonuses
        const container = document.getElementById('capacity-container');
        container.innerHTML = '';

        const bonuses = data.capacity_bonuses || [];
        if (bonuses.length === 0) {
            bonuses.push({content: '', amount: 0});
        }

        bonuses.forEach(bonus => {
            const row = createCapacityRow(bonus.content, bonus.amount);
            container.appendChild(row);
        });

        attachCalculateEvent();
        calculate();

    } catch (error) {
        console.error('Error loading salary grade:', error);
    }
}

function createCapacityRow(content = '', amount = 0) {
    const div = document.createElement('div');
    div.className = 'capacity-item row mb-2';
    div.innerHTML = `
        <div class="col-md-7">
            <input type="text" class="form-control" name="capacity_content[]"
                   value="${content}" placeholder="Nội dung">
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control calc-input capacity-amount"
                   name="capacity_amount[]" value="${amount}" placeholder="Số tiền" step="1">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm remove-capacity">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    return div;
}

// Add/remove capacity rows
document.getElementById('add-capacity').addEventListener('click', function() {
    const container = document.getElementById('capacity-container');
    container.appendChild(createCapacityRow());
    attachCalculateEvent();
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-capacity')) {
        const item = e.target.closest('.capacity-item');
        if (document.querySelectorAll('.capacity-item').length > 1) {
            item.remove();
            calculate();
        }
    }
});

// Add/remove deduction rows
document.getElementById('add-deduction').addEventListener('click', function() {
    const container = document.getElementById('deduction-container');
    const newRow = document.createElement('div');
    newRow.className = 'deduction-item row mb-2';
    newRow.innerHTML = `
        <div class="col-md-7">
            <input type="text" class="form-control" name="deduction_content[]" placeholder="Nội dung">
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control calc-input deduction-amount"
                   name="deduction_amount[]" placeholder="Số tiền" step="1" value="0">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm remove-deduction">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
    attachCalculateEvent();
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-deduction')) {
        const item = e.target.closest('.deduction-item');
        if (document.querySelectorAll('.deduction-item').length > 1) {
            item.remove();
            calculate();
        }
    }
});

// Calculate function
function calculate() {
    const workDays = parseFloat(document.getElementById('work_days_in_month').value) || 0;
    const actualDays = parseFloat(document.getElementById('actual_work_days').value) || 0;
    const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
    const respSalary = parseFloat(document.getElementById('responsibility_salary').value) || 0;

    const basicPerDay = workDays > 0 ? basicSalary / workDays : 0;
    document.getElementById('display_basic_per_day').textContent = formatMoney(basicPerDay);

    const respPerDay = workDays > 0 ? respSalary / workDays : 0;
    document.getElementById('display_resp_per_day').textContent = formatMoney(respPerDay);

    const mainSalary = (basicPerDay + respPerDay) * actualDays;
    document.getElementById('display_main_salary').textContent = formatMoney(mainSalary);

    let totalCapacity = 0;
    document.querySelectorAll('.capacity-amount').forEach(input => {
        totalCapacity += parseFloat(input.value) || 0;
    });
    document.getElementById('display_capacity_bonus').textContent = formatMoney(totalCapacity);

    const totalIncome = mainSalary + totalCapacity;
    document.getElementById('display_total_income').textContent = formatMoney(totalIncome);

    let totalDeduction = 0;
    document.querySelectorAll('.deduction-amount').forEach(input => {
        totalDeduction += parseFloat(input.value) || 0;
    });
    document.getElementById('display_total_deduction').textContent = formatMoney(totalDeduction);

    const netSalary = totalIncome - totalDeduction;
    document.getElementById('display_net_salary').textContent = formatMoney(netSalary);
}

function formatMoney(amount) {
    return new Intl.NumberFormat('vi-VN').format(Math.round(amount)) + ' ₫';
}

function attachCalculateEvent() {
    document.querySelectorAll('.calc-input').forEach(input => {
        input.removeEventListener('input', calculate);
        input.addEventListener('input', calculate);
    });
}

attachCalculateEvent();
calculate();
</script>
{% endblock %}