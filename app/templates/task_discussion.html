{% extends "base.html" %}

{% block title %}Thảo luận{% endblock %}
{% block page_title %}{ task.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/thao-luan.css') }}?v={{ config.VERSION }} }}">
{% endblock %}

{% block content %}
<!-- ===== TASK HEADER ===== -->
<div class="discussion-container">
    <div class="task-header-container">
        {% include 'components/task_header.html' %}
    </div>

    <!-- Task Info - Compact với Header màu -->
    <div class="task-card">
        <div class="task-card-header
            {% if task.status == 'DONE' %}
                {% if task.completed_overdue %}overdue{% else %}on-time{% endif %}
            {% elif task | is_overdue %}overdue
            {% else %}on-time{% endif %}">
            {{ task.title }}
        </div>

        <div class="task-card-body">
            <div class="task-card-row">
                <div class="task-flow-compact">
                    <!-- Avatar người giao -->
                    <div class="task-avatar-compact">
                        {% if task.creator.avatar %}
                            <img src="{{ url_for('profile.get_avatar', filename=task.creator.avatar) }}"
                                 alt="{{ task.creator.full_name }}">
                        {% else %}
                            {{ task.creator.full_name[0].upper() }}
                        {% endif %}
                    </div>

                    <div class="task-arrow-compact">→</div>

                    <!-- DÃY AVATAR NGƯỜI LÀM -->
                    <div class="task-assignees-compact">
                        {% if assignments %}
                            {% for assignment in assignments %}
                            <div class="task-avatar-compact">
                                {% if assignment.user.avatar %}
                                    <img src="{{ url_for('profile.get_avatar', filename=assignment.user.avatar) }}"
                                         alt="{{ assignment.user.full_name }}">
                                {% else %}
                                    {{ assignment.user.full_name[0].upper() }}
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div>
                    {% if task.status == 'DONE' and task.performance_rating %}
                        <div class="task-rating-display">
                            {% if task.performance_rating == 'good' %}
                                <div class="rating-icon-display good">
                                    <i class="bi bi-hand-thumbs-up-fill"></i>
                                </div>
                            {% elif task.performance_rating == 'bad' %}
                                <div class="rating-icon-display bad">
                                    <i class="bi bi-hand-thumbs-down-fill"></i>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="task-requirement-compact">
                <div class="task-requirement-label">YÊU CẦU:</div>
                <div style="white-space: pre-wrap;">{{ task.description or 'Không có mô tả' }}</div>
            </div>
        </div>
    </div>

    <!-- Comments Container -->
    <div class="comments-container">
        <!-- Header -->
        <div class="comments-header">
            {% if priority_text %}
                <span class="task-priority-badge {{ priority_class }}">
                    <span>{{ priority_icon }}</span>
                    <span>{{ priority_text }}</span>
                </span>
            {% endif %}
            <span class="comments-count" id="commentsCount">
                {{ sorted_comments | length }} tin nhắn
            </span>
        </div>

        <!-- Body -->
        <div class="comments-body" id="commentsList"
         ondrop="handleDrop(event)"
         ondragover="handleDragOver(event)"
         ondragleave="handleDragLeave(event)">
        <div class="drop-zone-indicator" id="dropZoneIndicator">
            <i class="bi bi-cloud-arrow-up"></i>
            <p>Thả file vào đây để gửi</p>
        </div>
            {% for comment in sorted_comments %}
           <div class="comment-item {% if comment.user_id == current_user.id %}mine{% else %}other{% endif %}" data-id="{{ comment.id }}">
                <div class="comment-avatar">
                    {% if comment.user.avatar %}
                    <img src="{{ url_for('profile.get_avatar', filename=comment.user.avatar) }}" alt="">
                    {% else %}
                    {{ comment.user.full_name[0].upper() }}
                    {% endif %}
                </div>
                <div class="comment-content">
                    <!-- ✅ NÚT MENU 3 CHẤM (CHỈ DIRECTOR) -->
                    {% if current_user.role == 'director' %}
                    <button class="comment-menu-btn" onclick="toggleCommentMenu({{ comment.id }}, event)">
                        <i class="bi bi-three-dots"></i>
                    </button>

                    <!-- Dropdown menu -->
                    <div class="comment-dropdown" id="commentMenu{{ comment.id }}">
                        <button class="comment-dropdown-item delete" onclick="deleteComment({{ comment.id }})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endif %}

                    <div class="comment-header">
                        <div>
                            <span class="comment-author">{{ comment.user.full_name }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="comment-time">{{ comment.created_at | vn_datetime }}</span>
                        </div>
                    </div>
                    <div class="comment-text" onclick="toggleCommentTime({{ comment.id }})">{{ comment.content }}</div>

                    <!-- Attachment -->
                    {% if comment.has_attachment %}
                    <div class="comment-attachment">
                        {% set attachments = comment.get_attachments_list() %}

                        {% if attachments %}
                            {% set images = attachments | selectattr('file_type', 'equalto', 'image') | list %}
                            {% set other_files = attachments | rejectattr('file_type', 'equalto', 'image') | list %}

                            {% if images %}
                            <div class="attachment-images-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                {% for att in images %}
                                <div class="attachment-image-preview">
                                    <img src="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id, attachment_id=att.id) }}"
                                         alt="{{ att.original_filename }}"
                                         class="img-thumbnail"
                                         style="width: 100%; max-height: 200px; object-fit: cover; cursor: pointer; border-radius: 8px;"
                                         onclick="openLightbox(this.src, '{{ att.original_filename }}', {{ att.file_size }})">
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if other_files %}
                                {% for att in other_files %}
                                <div class="attachment-info mt-2">
                                    {% if att.file_type in ['document', 'spreadsheet'] %}
                                        <!-- ===== WORD/EXCEL: CÓ PREVIEW - CHUYỂN TRANG ===== -->
                                        <a href="{{ url_for('tasks.preview_comment_attachment', task_id=task.id, comment_id=comment.id, attachment_id=att.id) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            {{ att.original_filename }}
                                        </a>
                                        <small class="text-muted">({{ (att.file_size / 1024) | round(1) }} KB)</small>
                                    {% else %}
                                        <!-- ===== FILE KHÁC: DOWNLOAD TRỰC TIẾP ===== -->
                                        <a href="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id, attachment_id=att.id) }}"
                                           class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="bi bi-{% if att.file_type == 'pdf' %}file-pdf{% else %}file-earmark{% endif %}"></i>
                                            {{ att.original_filename }}
                                        </a>
                                        <small class="text-muted">({{ (att.file_size / 1024) | round(1) }} KB)</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% endif %}
                        {% else %}
                            {% if comment.attachment_file_type == 'image' %}
                            <div class="attachment-image-preview">
                                <img src="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id, attachment_id=0) }}"
                                     alt="{{ comment.attachment_original_filename }}"
                                     class="img-thumbnail"
                                     style="max-width: 400px; max-height: 400px; cursor: pointer;"
                                     onclick="openLightbox(this.src, '{{ att.original_filename }}', {{ att.file_size }})">
                            </div>
                            {% endif %}
                            <div class="attachment-info mt-2">
                                <a href="{{ url_for('tasks.download_comment_attachment', task_id=task.id, comment_id=comment.id, attachment_id=0) }}"
                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="bi bi-{% if comment.attachment_file_type == 'image' %}image{% elif comment.attachment_file_type == 'pdf' %}file-pdf{% else %}file-earmark{% endif %}"></i>
                                    {{ comment.attachment_original_filename }}
                                    <small class="text-muted">({{ (comment.attachment_file_size / 1024) | round(1) }} KB)</small>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="empty-comments" id="noComments">
                <i class="bi bi-chat-dots"></i>
                <p>Chưa có tin nhắn nào. Hãy bắt đầu cuộc thảo luận!</p>
            </div>
            {% endfor %}
        </div>

        <!-- ✅ FOOTER - MESSENGER STYLE INPUT -->
        {% if user_assignment and user_assignment.accepted or task.creator_id == current_user.id or current_user.role in ['director', 'manager'] %}
        <div class="comments-footer">
            <form id="commentForm" enctype="multipart/form-data">
                <!-- 1️⃣ TEXTAREA + NÚT BÊN TRONG (Trên cùng) -->
                <div class="input-wrapper">
                    <textarea class="form-control"
                              id="commentInput"
                              name="content"
                              rows="1"
                              placeholder="Nhập tin nhắn..."></textarea>

                    <!-- Nút bên trong textarea -->
                    <div class="input-actions-inside">
                        <!-- Đính kèm -->
                        <label for="commentFileInput" class="btn-attach-icon" title="Đính kèm file">
                            <i class="bi bi-paperclip"></i>
                        </label>
                        <input type="file" id="commentFileInput" name="file" style="display: none;"
                               accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" multiple>

                        <!-- Gửi -->
                        <button type="submit" class="btn-send-icon" id="btnAddComment" title="Gửi">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>

                <!-- 2️⃣ FILE PREVIEW (Dưới textarea - như Messenger) -->
                <div id="filePreview" style="display: none;">
                    <div class="alert alert-info d-flex align-items-center justify-content-between p-2 mb-0 mt-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-file-earmark"></i>
                            <span id="filePreviewName"></span>
                            <small class="text-muted" id="filePreviewSize"></small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFileInput()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>

                    <!-- Grid cho nhiều ảnh -->
                    <div id="multipleImagePreview" style="display: none;"></div>

                    <!-- Single image preview -->
                    <img id="imagePreview" style="max-width: 200px; max-height: 200px; display: none;" class="img-thumbnail mt-2">
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Image Lightbox -->
<div class="lightbox-overlay" id="imageLightbox">
    <div class="lightbox-content">
        <img class="lightbox-image" id="lightboxImage">
        <div class="lightbox-info" id="lightboxInfo"></div>
        <button class="lightbox-download" id="lightboxDownload">
            <i class="bi bi-download"></i>
            <span>Tải về</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CONFIG PHẢI Ở TRONG TEMPLATE (vì có Jinja2 variables) -->
<script>
window.CONFIG = {
    TASK_ID: {{ task.id }},
    CURRENT_USER_ID: {{ current_user.id }},
    CURRENT_USER_ROLE: '{{ current_user.role }}',
    CSRF_TOKEN: '{{ csrf_token() }}'
};
</script>

<!-- ✅ LOAD FILE JS SAU KHI ĐÃ CÓ CONFIG -->
<script src="{{ url_for('static', filename='js/thao-luan.js') }}?v={{ config.VERSION }} }}"></script>
{% endblock %}