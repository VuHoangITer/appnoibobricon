{% extends "base.html" %}

{% block title %}Quy Tr√¨nh C√¥ng Vi·ªác - NO THING{% endblock %}

{% block page_title %}Quy Tr√¨nh C√¥ng Vi·ªác{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/hub-style.css') }}">
{% endblock %}
{% block content %}
<div class="hub-main-container">
    <!-- MAIN HUB - 4 ICONS -->
    <div id="main-hub" class="hub-icon-grid">
        <!-- Icon 1: C√¥ng Vi·ªác -->
        <div class="hub-icon-card" onclick="showModule('tasks')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-briefcase-fill"></i>
            </div>
            <span class="hub-icon-label">C√¥ng Vi·ªác</span>
        </div>

        <!-- Icon 2: L∆∞∆°ng -->
        {% if current_user.role in ['director', 'accountant'] %}
        <div class="hub-icon-card" onclick="showModule('salary')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="bi bi-cash-coin"></i>
            </div>
            <span class="hub-icon-label">L∆∞∆°ng</span>
            <span class="hub-icon-badge" id="salary-badge" {% if not (pending_penalties > 0 or pending_advances > 0) %}style="display: none;"{% endif %}>
                {{ pending_penalties + pending_advances }}
            </span>
        </div>
        {% endif %}

        <!-- Icon 3: Th√¥ng Tin -->
        <div class="hub-icon-card" onclick="showModule('info')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="bi bi-megaphone-fill"></i>
            </div>
            <span class="hub-icon-label">Th√¥ng Tin</span>
            <span class="hub-icon-badge" id="info-badge" {% if not (unconfirmed_news > 0 or unread_notifications > 0) %}style="display: none;"{% endif %}>
                {{ unconfirmed_news + unread_notifications }}
            </span>
        </div>

        <!-- Icon 4: T√†i Kho·∫£n -->
        {% if current_user.role == 'director' %}
        <div class="hub-icon-card" onclick="showModule('account')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="bi bi-person-circle"></i>
            </div>
            <span class="hub-icon-label">T√†i Kho·∫£n</span>
        </div>
        {% endif %}
    </div>

    <!-- MODULE 1: C√îNG VI·ªÜC -->
    <div id="module-tasks" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('tasks')"></div>

        <div class="module-sidebar" id="sidebar-tasks">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-briefcase-fill" style="color: #667eea;"></i>
                    <span>C√¥ng Vi·ªác</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('tasks.create_task') }}" class="sidebar-menu-item">
                    <i class="bi bi-plus-circle-fill" style="color: #004989;"></i>
                    <span>T·∫°o C√¥ng Vi·ªác</span>
                </a>
                <a href="{{ url_for('tasks.dashboard') }}" class="sidebar-menu-item">
                    <i class="bi bi-speedometer2" style="color: #667eea;"></i>
                    <span>Th·ªëng K√™</span>
                </a>
                <a href="{{ url_for('tasks.kanban') }}" class="sidebar-menu-item">
                    <i class="bi bi-kanban" style="color: #f093fb;"></i>
                    <span>T√≥m T·∫Øt CV</span>
                </a>
                {% if current_user.role in ['director', 'manager'] %}
                <a href="{{ url_for('tasks.pending_approvals') }}" class="sidebar-menu-item" data-badge-id="tasks_need_approval">
                    <i class="bi bi-hourglass-split" style="color: #ff9800;"></i>
                    <span>Ch·ªù Ph√™ Duy·ªát</span>
                    {% if tasks_need_approval > 0 %}
                    <span class="badge bg-warning text-dark">{{ tasks_need_approval }}</span>
                    {% endif %}
                </a>
                {% endif %}
                {% if current_user.role in ['director', 'manager'] %}
                <a href="{{ url_for('performance.performance_review') }}" class="sidebar-menu-item">
                    <i class="bi bi-graph-up-arrow" style="color: #30cfd0;"></i>
                    <span>Hi·ªáu Su·∫•t NV</span>
                </a>
                <a href="{{ url_for('performance.unrated_tasks') }}" class="sidebar-menu-item" data-badge-id="my_tasks_need_rating">
                    <i class="bi bi-star-fill" style="color: #ffd700;"></i>
                    <span>CV Ch∆∞a ƒê√°nh Gi√°</span>
                    {% if my_tasks_need_rating > 0 %}
                    <span class="badge bg-danger">{{ my_tasks_need_rating }}</span>
                    {% endif %}
                </a>
                {% endif %}
            </div>
        </div>

        <div class="module-content">
            <div class="performance-header">
                <div class="performance-logo">
                        <img src="{{ url_for('static', filename='images/logo-bri.png') }}" alt="BRICON Logo">
                </div>
                <div class="performance-right">
                    <h5 class="performance-title">TO DO BRICON</h5>

                <div class="filter-bar">
                    <button class="filter-date-btn" onclick="openFilterModal()">
                        <i class="bi bi-calendar-range"></i>
                        <span class="d-none d-sm-inline">L·ªçc</span>
                        <span class="filter-indicator" id="filterIndicator" style="display: none;">
                            <i class="bi bi-check-circle-fill"></i>
                        </span>
                    </button>

                    <!-- Top & Bottom Users -->
                    <div class="top-bottom-users" id="topBottomUsers">
                        {% if initial_top_bottom %}
                            {% if initial_top_bottom.top_user %}
                            <div class="top-user" title="L√†m nhi·ªÅu nh·∫•t: {{ initial_top_bottom.top_user.full_name }}">
                                <img src="{% if initial_top_bottom.top_user.avatar %}/profile/avatar/{{ initial_top_bottom.top_user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ initial_top_bottom.top_user.full_name|urlencode }}&background=00ff89&color=000&size=128{% endif %}"
                                     alt="{{ initial_top_bottom.top_user.full_name }}"
                                     class="user-badge-avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name={{ initial_top_bottom.top_user.full_name|urlencode }}&background=00ff89&color=000&size=128'">
                                <span class="user-badge-name">{{ initial_top_bottom.top_user.full_name }}</span>
                            </div>
                            {% endif %}

                            {% if initial_top_bottom.bottom_user %}
                            <div class="bottom-user" title="C·∫ßn c·ªë g·∫Øng th√™m: {{ initial_top_bottom.bottom_user.full_name }}">
                                <img src="{% if initial_top_bottom.bottom_user.avatar %}/profile/avatar/{{ initial_top_bottom.bottom_user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ initial_top_bottom.bottom_user.full_name|urlencode }}&background=dc3545&color=fff&size=128{% endif %}"
                                     alt="{{ initial_top_bottom.bottom_user.full_name }}"
                                     class="user-badge-avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name={{ initial_top_bottom.bottom_user.full_name|urlencode }}&background=dc3545&color=fff&size=128'">
                                <span class="user-badge-name">{{ initial_top_bottom.bottom_user.full_name }}</span>
                            </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted" style="margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                        {% endif %}
                    </div>
                </div>
                </div>
            </div>

            <!-- PERFORMANCE SECTION + TABLE -->
            <div class="performance-section">
                <div class="performance-table-container">
                    <table class="performance-table">
                       <thead>
                        <tr>
                            <th style="width: 80px; text-align: center;">
                                <i class="bi bi-person-circle"></i>
                            </th>
                            <th>Nh√¢n Vi√™n</th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">üî• Kh·∫©n C·∫•p</span>
                                <span class="d-md-none">üî•</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">‚≠ê Quan Tr·ªçng</span>
                                <span class="d-md-none">‚≠ê</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">üîÅ L·∫∑p L·∫°i</span>
                                <span class="d-md-none">üîÅ</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">‚úÖ Ho√†n Th√†nh</span>
                                <span class="d-md-none">‚úÖ</span>
                            </th>
                        </tr>
                    </thead>
                        <tbody id="performanceTableBody">
                            {% if initial_performance %}
                                {% for user in initial_performance %}
                                <tr data-user-id="{{ user.user_id }}">
                                    <td>
                                        <img src="{% if user.avatar %}/profile/avatar/{{ user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128{% endif %}"
                                             alt="{{ user.full_name }}"
                                             class="user-avatar-cell"
                                             onerror="this.src='https://ui-avatars.com/api/?name={{ user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128'">
                                    </td>
                                    <td class="user-name-cell">{{ user.full_name }}</td>
                                    <td class="count-cell urgent" data-type="urgent">
                                        {% if user.urgent_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='urgent') }}"
                                           class="task-count-link">{{ user.urgent_count }}</a>
                                        {% else %}
                                        {{ user.urgent_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell important" data-type="important">
                                        {% if user.important_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='important') }}"
                                           class="task-count-link">{{ user.important_count }}</a>
                                        {% else %}
                                        {{ user.important_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell recurring" data-type="recurring">
                                        {% if user.recurring_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='recurring') }}"
                                           class="task-count-link">{{ user.recurring_count }}</a>
                                        {% else %}
                                        {{ user.recurring_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell done" data-type="done">
                                        {% if user.done_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, status='DONE') }}"
                                           class="task-count-link">{{ user.done_count }}</a>
                                        {% else %}
                                        {{ user.done_count }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                                        <p class="text-muted mt-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE 2: L∆Ø∆†NG -->
    {% if current_user.role in ['director', 'accountant'] %}
    <div id="module-salary" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('salary')"></div>

        <div class="module-sidebar" id="sidebar-salary">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-cash-coin" style="color: #f093fb;"></i>
                    <span>L∆∞∆°ng</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('salaries.list_salaries') }}" class="sidebar-menu-item">
                    <i class="bi bi-wallet2" style="color: #a8edea;"></i>
                    <span>Qu·∫£n L√Ω L∆∞∆°ng</span>
                </a>
                <a href="{{ url_for('employees.list_employees') }}" class="sidebar-menu-item">
                    <i class="bi bi-people-fill" style="color: #ffecd2;"></i>
                    <span>Nh√¢n Vi√™n</span>
                </a>
                <a href="{{ url_for('work_days.list_configs') }}" class="sidebar-menu-item">
                    <i class="bi bi-calendar-week" style="color: #ff9a9e;"></i>
                    <span>S·ªë C√¥ng/Th√°ng</span>
                </a>
                {% if current_user.role == 'director' %}
                <a href="{{ url_for('salary_grades.list_grades') }}" class="sidebar-menu-item">
                    <i class="bi bi-award-fill" style="color: #ffd89b;"></i>
                    <span>C·∫•p B·∫≠c L∆∞∆°ng</span>
                </a>
                {% endif %}
                <a href="{{ url_for('penalties.list_penalties') }}" class="sidebar-menu-item" data-badge-id="penalties">
                    <i class="bi bi-exclamation-triangle-fill" style="color: #f43b47;"></i>
                    <span>Bi√™n B·∫£n Ph·∫°t</span>
                    {% if pending_penalties > 0 %}
                    <span class="badge bg-danger">{{ pending_penalties }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('advances.list_advances') }}" class="sidebar-menu-item" data-badge-id="advances">
                    <i class="bi bi-cash-stack" style="color: #ffc3a0;"></i>
                    <span>T·∫°m ·ª®ng</span>
                    {% if pending_advances > 0 %}
                    <span class="badge bg-warning">{{ pending_advances }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-cash-coin"></i> Qu·∫£n L√Ω L∆∞∆°ng & T√†i Ch√≠nh
            </h5>

            <div class="stats-grid">
                <div class="stat-card stat-info">
                    <div class="stat-icon"><i class="bi bi-wallet2"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_salaries }}</h3>
                        <p>B·∫£ng L∆∞∆°ng</p>
                    </div>
                </div>

                <div class="stat-card stat-primary">
                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_employees }}</h3>
                        <p>Nh√¢n Vi√™n</p>
                    </div>
                </div>

                <div class="stat-card stat-danger">
                    <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_penalties }}</h3>
                        <p>Ph·∫°t Ch∆∞a Tr·ª´</p>
                    </div>
                </div>

                <div class="stat-card stat-warning">
                    <div class="stat-icon"><i class="bi bi-cash-stack"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_advances }}</h3>
                        <p>T·∫°m ·ª®ng Ch∆∞a Tr·ª´</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- MODULE 3: TH√îNG TIN -->
    <div id="module-info" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('info')"></div>

        <div class="module-sidebar" id="sidebar-info">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-megaphone-fill" style="color: #4facfe;"></i>
                    <span>Th√¥ng Tin</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('news.list_news') }}" class="sidebar-menu-item" data-badge-id="unconfirmed_news">
                    <i class="bi bi-newspaper" style="color: #09203f;"></i>
                    <span>Th√¥ng B√°o NB</span>
                    {% if unconfirmed_news > 0 %}
                    <span class="badge bg-danger">{{ unconfirmed_news }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('files.list_files') }}" class="sidebar-menu-item">
                    <i class="bi bi-folder2-open" style="color: #ebbba7;"></i>
                    <span>Th∆∞ Vi·ªán File</span>
                </a>
                <a href="{{ url_for('notes.list_notes') }}" class="sidebar-menu-item">
                    <i class="bi bi-journal-text" style="color: #c471f5;"></i>
                    <span>Ghi Ch√∫</span>
                </a>
                <a href="{{ url_for('notifications.list_notifications') }}" class="sidebar-menu-item" data-badge-id="unread_notifications">
                    <i class="bi bi-bell" style="color: #f83600;"></i>
                    <span>Nh·∫Øc Nh·ªü</span>
                    {% if unread_notifications > 0 %}
                    <span class="badge bg-danger">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-megaphone-fill"></i> Th√¥ng Tin & T√†i Li·ªáu
            </h5>

            <div class="stats-grid">
                <a href="{{ url_for('news.list_news') }}" class="stat-card stat-info" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-newspaper"></i></div>
                    <div class="stat-content">
                        <h3>{{ unconfirmed_news }}</h3>
                        <p>TB Ch∆∞a X√°c Nh·∫≠n</p>
                    </div>
                </a>

                <a href="{{ url_for('notifications.list_notifications') }}" class="stat-card stat-warning" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-bell"></i></div>
                    <div class="stat-content">
                        <h3>{{ unread_notifications }}</h3>
                        <p>Nh·∫Øc Nh·ªü Ch∆∞a ƒê·ªçc</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- MODULE 4: T√ÄI KHO·∫¢N -->
    {% if current_user.role == 'director' %}
    <div id="module-account" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('account')"></div>

        <div class="module-sidebar" id="sidebar-account">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-person-circle" style="color: #fa709a;"></i>
                    <span>T√†i Kho·∫£n</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('auth.users') }}" class="sidebar-menu-item">
                    <i class="bi bi-people" style="color: #89f7fe;"></i>
                    <span>Qu·∫£n L√Ω TK</span>
                </a>
                <a href="{{ url_for('auth.register') }}" class="sidebar-menu-item">
                    <i class="bi bi-person-plus-fill" style="color: #fddb92;"></i>
                    <span>T·∫°o T√†i Kho·∫£n</span>
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-person-circle"></i> Qu·∫£n Tr·ªã T√†i Kho·∫£n
            </h5>

            <div class="stats-grid">
                <a href="{{ url_for('auth.users') }}" class="stat-card stat-primary" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-people"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_users }}</h3>
                        <p>T·ªïng T√†i Kho·∫£n</p>
                    </div>
                </a>

                <a href="{{ url_for('auth.users') }}" class="stat-card stat-done" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                    <div class="stat-content">
                        <h3>{{ active_users }}</h3>
                        <p>ƒêang Ho·∫°t ƒê·ªông</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Filter Ng√†y -->
<div class="modal fade" id="filterDateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-range text-primary"></i>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-event text-success"></i> T·ª´ Ng√†y:
                    </label>
                    <input type="date" class="form-control form-control-lg" id="modalDateFrom">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-check text-danger"></i> ƒê·∫øn Ng√†y:
                    </label>
                    <input type="date" class="form-control form-control-lg" id="modalDateTo">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetFilter()">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
                <button type="button" class="btn btn-primary" onclick="applyFilter()">
                    <i class="bi bi-funnel-fill"></i> L·ªçc
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// MODULE NAVIGATION
// ========================================
function showModule(moduleName) {
    document.getElementById('main-hub').style.display = 'none';

    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    const module = document.getElementById('module-' + moduleName);
    if (module) {
        module.classList.add('active');
    }

    updateModuleMenuButton();

    setTimeout(() => {
        enableBackdropClick();
    }, 100);

    if (moduleName === 'tasks') {
        setTimeout(() => {
            console.log('üìä Entering Tasks module - refreshing performance');
            refreshPerformanceNow();
            loadTopBottomUsers();
        }, 500);
    }
}

function backToHub() {
    closeSidebarOnMobile();

    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    document.getElementById('main-hub').style.display = 'grid';

    updateModuleMenuButton();
    disableBackdropClick();
}

// ========================================
// MOBILE SIDEBAR TOGGLE
// ========================================
function toggleSidebar(moduleName) {
    const sidebar = document.getElementById('sidebar-' + moduleName);

    if (sidebar) {
        sidebar.classList.toggle('active');
        const module = document.getElementById('module-' + moduleName);
        const overlay = module.querySelector('.sidebar-overlay');
        if (overlay) {
            overlay.classList.toggle('active');
        }
    }
}

function closeSidebarOnMobile() {
    document.querySelectorAll('.module-sidebar').forEach(s => {
        s.classList.remove('active');
    });
    document.querySelectorAll('.sidebar-overlay').forEach(o => {
        o.classList.remove('active');
    });
}

// ========================================
// MODULE MENU BUTTON TOGGLE
// ========================================
function updateModuleMenuButton() {
    const menuBtn = document.getElementById('moduleMenuBtn');
    const isInModule = document.querySelector('.module-container.active');

    if (menuBtn) {
        if (isInModule && window.innerWidth <= 992) {
            menuBtn.style.display = 'block';
        } else {
            menuBtn.style.display = 'none';
        }
    }
}

// ========================================
// CLICK BACKDROP TO GO BACK TO HUB
// ========================================
let backdropClickEnabled = false;

function enableBackdropClick() {
    if (backdropClickEnabled) return;
    backdropClickEnabled = true;

    document.addEventListener('click', handleBackdropClick);
}

function disableBackdropClick() {
    backdropClickEnabled = false;
    document.removeEventListener('click', handleBackdropClick);
}

function handleBackdropClick(e) {
    const activeModule = document.querySelector('.module-container.active');
    if (!activeModule) {
        disableBackdropClick();
        return;
    }

    const moduleContent = activeModule.querySelector('.module-content');
    const moduleSidebar = activeModule.querySelector('.module-sidebar');

    if (e.target.closest('.hub-icon-card')) return;
    if (e.target.closest('.top-navbar')) return;
    if (e.target.closest('.modal')) return;
    if (e.target.classList.contains('modal')) return;
    if (document.querySelector('.modal.show')) return;
    if (e.target.classList.contains('modal-backdrop')) return;

    if (window.innerWidth > 992) {
        if (!moduleContent.contains(e.target) && !moduleSidebar.contains(e.target)) {
            backToHub();
        }
    } else {
        const overlay = activeModule.querySelector('.sidebar-overlay');
        if (overlay && e.target === overlay) {
            closeSidebarOnMobile();
        }
    }
}

// ========================================
// REAL-TIME UPDATES: SSE + FALLBACK POLLING
// ========================================
let sseStatsConnected = false;

function startRealtimeUpdates() {
    console.log('üöÄ Starting real-time stats updates...');

    if (typeof window.sseManager === 'undefined') {
        console.warn('‚ö†Ô∏è SSE Manager not loaded, using polling');
        startPollingFallback();
        startSmartPerformancePolling();
        return;
    }

    window.sseManager.connect(
        'dashboard-stats',
        '/sse/dashboard-stats',
        {
            onOpen: () => {
                console.log('‚úÖ SSE Dashboard Stats connected');
                sseStatsConnected = true;
            },
            onError: (error, attempts) => {
                console.error('‚ùå SSE Stats error:', error, 'attempts:', attempts);
                sseStatsConnected = false;
            },
            events: {
                'stats_update': (data) => {
                    console.log('üìä SSE stats update:', data);
                    updateUIWithStats(data);
                },
                'heartbeat': (data) => {
                    console.log('üíì SSE stats heartbeat');
                },
                'error': (data) => {
                    console.error('‚ùå SSE stats error event:', data);
                },
                'close': (data) => {
                    console.log('üîå SSE stats closed by server');
                }
            }
        },
        {
            url: '/hub/api/realtime-stats',
            interval: 30000,
            onData: (data) => {
                console.log('üìä Polling stats:', data);
                updateUIWithStats(data);
            }
        }
    );

    startSmartPerformancePolling();
}

function startPollingFallback() {
    console.log('üîÑ Starting polling fallback for stats (30s interval)');
    setInterval(updateRealtimeData, 30000);
}

function stopRealtimeUpdates() {
    if (window.sseManager) {
        window.sseManager.disconnect('dashboard-stats');
    }

    stopSmartPerformancePolling();
}

function updateRealtimeData() {
    fetch('/hub/api/realtime-stats')
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            console.log('üìä Real-time update:', data);
            updateUIWithStats(data);
        })
        .catch(err => {
            console.error('‚ùå Real-time update error:', err);
        });
}

function updateUIWithStats(data) {
    if (typeof updateNotifCount === 'function') {
        updateNotifCount();
    }

    const infoBadge = document.getElementById('info-badge');
    if (infoBadge) {
        if (data.info_badge > 0) {
            infoBadge.textContent = data.info_badge;
            infoBadge.style.display = 'inline-block';
        } else {
            infoBadge.style.display = 'none';
        }
    }

    const salaryBadge = document.getElementById('salary-badge');
    if (salaryBadge && data.salary_badge !== undefined) {
        if (data.salary_badge > 0) {
            salaryBadge.textContent = data.salary_badge;
            salaryBadge.style.display = 'inline-block';
        } else {
            salaryBadge.style.display = 'none';
        }
    }

    updateInfoModuleStats(data);
    updateSalaryModuleStats(data);
    updateTasksModuleBadges(data);

    if (data.my_overdue > 0) {
        console.warn(`‚ö†Ô∏è B·∫°n c√≥ ${data.my_overdue} c√¥ng vi·ªác qu√° h·∫°n!`);
    }
}

function updateInfoModuleStats(data) {
    const infoModule = document.getElementById('module-info');
    if (infoModule) {
        const unconfirmedCard = infoModule.querySelector('.stat-info h3');
        if (unconfirmedCard) unconfirmedCard.textContent = data.unconfirmed_news;

        const unreadCard = infoModule.querySelector('.stat-warning h3');
        if (unreadCard) unreadCard.textContent = data.unread_notifications;

        updateSidebarBadge(infoModule, 'unconfirmed_news', data.unconfirmed_news);
        updateSidebarBadge(infoModule, 'unread_notifications', data.unread_notifications);
    }
}

function updateSalaryModuleStats(data) {
    const salaryModule = document.getElementById('module-salary');
    if (salaryModule) {
        const penaltyCard = salaryModule.querySelector('.stat-danger h3');
        if (penaltyCard) penaltyCard.textContent = data.pending_penalties;

        const advanceCard = salaryModule.querySelector('.stat-warning h3');
        if (advanceCard) advanceCard.textContent = data.pending_advances;

        updateSidebarBadge(salaryModule, 'penalties', data.pending_penalties);
        updateSidebarBadge(salaryModule, 'advances', data.pending_advances);
    }
}

function updateTasksModuleBadges(data) {
    const tasksModule = document.getElementById('module-tasks');
    if (tasksModule) {
        // C·∫≠p nh·∫≠t badge "Ch·ªù Ph√™ Duy·ªát"
        if (data.tasks_need_approval !== undefined) {
            updateSidebarBadge(tasksModule, 'tasks_need_approval', data.tasks_need_approval);
        }

        // C·∫≠p nh·∫≠t badge "CV Ch∆∞a ƒê√°nh Gi√°"
        if (data.my_tasks_need_rating !== undefined) {
            updateSidebarBadge(tasksModule, 'my_tasks_need_rating', data.my_tasks_need_rating);
        }
    }
}


function updateSidebarBadge(module, badgeType, count) {
    const sidebar = module.querySelector('.module-sidebar');
    if (!sidebar) {
        console.warn('[Badge] Sidebar not found for module:', module.id);
        return;
    }

    const targetLink = sidebar.querySelector(`a[data-badge-id="${badgeType}"]`);

    if (!targetLink) {
        console.warn(`[Badge] Link not found for badge type: ${badgeType}`);
        return;
    }

    let badge = targetLink.querySelector('.badge');

    if (count > 0) {
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge bg-danger';
            targetLink.appendChild(badge);
            console.log(`[Badge] Created badge for ${badgeType}: ${count}`);
        } else {
            console.log(`[Badge] Updated badge for ${badgeType}: ${count}`);
        }
        badge.textContent = count;
        badge.style.display = 'inline-block';
    } else {
        if (badge) {
            badge.remove();
            console.log(`[Badge] Removed badge for ${badgeType}`);
        }
    }
}

// ========================================
// SMART PERFORMANCE POLLING
// ========================================
let performancePollingInterval = null;
let lastPerformanceUpdate = 0;
const PERFORMANCE_POLL_INTERVAL = 60000;
let animationTimeouts = {};

function startSmartPerformancePolling() {
    console.log('üîÑ Starting smart performance polling (60s interval)');

    stopSmartPerformancePolling();

    performancePollingInterval = setInterval(() => {
        const activeModule = document.querySelector('.module-container.active');
        const isTaskModule = activeModule && activeModule.id === 'module-tasks';

        const now = Date.now();
        const timeSinceLastUpdate = now - lastPerformanceUpdate;
        const shouldPoll = isTaskModule &&
                          !document.hidden &&
                          timeSinceLastUpdate >= PERFORMANCE_POLL_INTERVAL;

        if (shouldPoll) {
            console.log(`üîÑ Smart polling: Refreshing performance data (${Math.round(timeSinceLastUpdate/1000)}s since last update)`);
            loadPerformance();
            loadTopBottomUsers();
            lastPerformanceUpdate = now;
        } else {
            if (!isTaskModule) {
                console.log('‚è∏Ô∏è Skipping poll: Not in Tasks module');
            } else if (document.hidden) {
                console.log('‚è∏Ô∏è Skipping poll: Tab hidden');
            } else {
                console.log(`‚è∏Ô∏è Skipping poll: Too soon (${Math.round(timeSinceLastUpdate/1000)}s < 60s)`);
            }
        }
    }, PERFORMANCE_POLL_INTERVAL);
}

function stopSmartPerformancePolling() {
    if (performancePollingInterval) {
        console.log('üõë Stopping performance polling');
        clearInterval(performancePollingInterval);
        performancePollingInterval = null;
    }
}

function refreshPerformanceNow() {
    console.log('‚úÖ Manual refresh: Updating performance immediately');
    loadPerformance();
    loadTopBottomUsers();
    lastPerformanceUpdate = Date.now();
}

// ========================================
// AUTO CENTER ICONS
// ========================================
function autoCenterIcons() {
    const iconGrid = document.getElementById('main-hub');
    const iconCount = iconGrid.querySelectorAll('.hub-icon-card').length;

    if (iconCount === 2) {
        iconGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        iconGrid.style.maxWidth = '550px';
    } else if (iconCount === 3) {
        iconGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
        iconGrid.style.maxWidth = '750px';
    } else if (iconCount === 1) {
        iconGrid.style.gridTemplateColumns = '1fr';
        iconGrid.style.maxWidth = '250px';
    }
}

// ========================================
// PERFORMANCE TABLE - LOAD DATA
// ========================================
let performanceLoadTimeout = null;

function loadPerformance() {
    if (performanceLoadTimeout) {
        clearTimeout(performanceLoadTimeout);
    }

    performanceLoadTimeout = setTimeout(() => {
        const params = new URLSearchParams();
        if (currentFilterFrom) params.append('date_from', currentFilterFrom);
        if (currentFilterTo) params.append('date_to', currentFilterTo);

        const url = '/hub/api/team-performance?' + params.toString();

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateTableRows(data.data);
                } else {
                    console.error('Error loading performance:', data.error);
                    document.getElementById('performanceTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                                <p class="text-danger mt-3">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(err => {
                console.error('Error fetching performance:', err);
                document.getElementById('performanceTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                            <p class="text-danger mt-3">L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</p>
                        </td>
                    </tr>
                `;
            });
    }, 100);
}

// ========================================
// TOP & BOTTOM USERS - LOAD SEPARATELY
// ========================================
function loadTopBottomUsers() {
    const params = new URLSearchParams();
    if (currentFilterFrom) params.append('date_from', currentFilterFrom);
    if (currentFilterTo) params.append('date_to', currentFilterTo);

    const url = '/hub/api/top-bottom-users?' + params.toString();

    fetch(url)
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                renderTopBottomUsers(response.data);
            } else {
                console.error('Error loading top/bottom users:', response.error);
            }
        })
        .catch(err => {
            console.error('Error fetching top/bottom users:', err);
        });
}

// ========================================
// FUNCTION 1: UPDATE TABLE ROWS (CH·ªà UPDATE THAY ƒê·ªîI)
// ========================================
function updateTableRows(newData) {
    const tbody = document.getElementById('performanceTableBody');

    if (!newData || newData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="text-muted mt-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                </td>
            </tr>
        `;
        return;
    }

    const existingRows = {};
    tbody.querySelectorAll('tr[data-user-id]').forEach(row => {
        const userId = row.getAttribute('data-user-id');
        existingRows[userId] = row;
    });

    const seenUsers = new Set();

    newData.forEach((user, index) => {
        seenUsers.add(user.user_id.toString());
        const existingRow = existingRows[user.user_id];

        if (existingRow) {
            updateCellIfChanged(existingRow, 'urgent', user.urgent_count, user.user_id);
            updateCellIfChanged(existingRow, 'important', user.important_count, user.user_id);
            updateCellIfChanged(existingRow, 'recurring', user.recurring_count, user.user_id);
            updateCellIfChanged(existingRow, 'done', user.done_count, user.user_id);

            const currentIndex = Array.from(tbody.children).indexOf(existingRow);
            if (currentIndex !== index) {
                tbody.insertBefore(existingRow, tbody.children[index]);
            }
        } else {
            const newRow = createTableRow(user);
            if (tbody.children[index]) {
                tbody.insertBefore(newRow, tbody.children[index]);
            } else {
                tbody.appendChild(newRow);
            }
        }
    });

    Object.keys(existingRows).forEach(userId => {
        if (!seenUsers.has(userId)) {
            existingRows[userId].remove();
        }
    });
}

// ========================================
// FUNCTION 2: UPDATE M·ªòT CELL N·∫æU C√ì THAY ƒê·ªîI
// ========================================
function updateCellIfChanged(row, type, newCount, userId) {
    const cell = row.querySelector(`td[data-type="${type}"]`);
    if (!cell) return;

    const link = cell.querySelector('a.task-count-link');
    const currentCount = link ? parseInt(link.textContent) : parseInt(cell.textContent);

    if (currentCount !== newCount) {
        const cellKey = `${userId}-${type}`;

        if (animationTimeouts[cellKey]) {
            clearTimeout(animationTimeouts[cellKey]);
            cell.classList.remove('cell-updating', 'cell-updated');
        }

        cell.classList.add('cell-updating');

        animationTimeouts[cellKey] = setTimeout(() => {
            const filterParams = new URLSearchParams();
            if (currentFilterFrom) filterParams.append('date_from', currentFilterFrom);
            if (currentFilterTo) filterParams.append('date_to', currentFilterTo);

            const baseUrl = '/tasks/priority-detail';

            if (type === 'done') {
                filterParams.append('assigned_user', userId);
                filterParams.append('status', 'DONE');
            } else {
                filterParams.append('assigned_user', userId);
                filterParams.append('tag', type);
            }

            const url = baseUrl + '?' + filterParams.toString();

            if (newCount > 0) {
                cell.innerHTML = `<a href="${url}" class="task-count-link">${newCount}</a>`;
            } else {
                cell.textContent = newCount;
            }

            cell.classList.remove('cell-updating');
            cell.classList.add('cell-updated');

            setTimeout(() => {
                cell.classList.remove('cell-updated');
                delete animationTimeouts[cellKey];
            }, 1000);

        }, 300);
    }
}

// ========================================
// FUNCTION 3: T·∫†O ROW M·ªöI CHO USER M·ªöI
// ========================================
function createTableRow(user) {
    const row = document.createElement('tr');
    row.setAttribute('data-user-id', user.user_id);

    const avatarUrl = user.avatar
        ? `/profile/avatar/${user.avatar}`
        : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128`;

    const filterParams = new URLSearchParams();
    if (currentFilterFrom) filterParams.append('date_from', currentFilterFrom);
    if (currentFilterTo) filterParams.append('date_to', currentFilterTo);

    const baseUrl = '/tasks/priority-detail';

    const urgentParams = new URLSearchParams(filterParams);
    urgentParams.append('assigned_user', user.user_id);
    urgentParams.append('tag', 'urgent');
    const urgentUrl = baseUrl + '?' + urgentParams.toString();

    const importantParams = new URLSearchParams(filterParams);
    importantParams.append('assigned_user', user.user_id);
    importantParams.append('tag', 'important');
    const importantUrl = baseUrl + '?' + importantParams.toString();

    const recurringParams = new URLSearchParams(filterParams);
    recurringParams.append('assigned_user', user.user_id);
    recurringParams.append('tag', 'recurring');
    const recurringUrl = baseUrl + '?' + recurringParams.toString();

    const doneParams = new URLSearchParams(filterParams);
    doneParams.append('assigned_user', user.user_id);
    doneParams.append('status', 'DONE');
    const doneUrl = baseUrl + '?' + doneParams.toString();

    row.innerHTML = `
        <td>
            <img src="${avatarUrl}"
                 alt="${user.full_name}"
                 class="user-avatar-cell"
                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128'">
        </td>
        <td class="user-name-cell">${user.full_name}</td>
        <td class="count-cell urgent" data-type="urgent">
            ${user.urgent_count > 0
                ? `<a href="${urgentUrl}" class="task-count-link">${user.urgent_count}</a>`
                : user.urgent_count}
        </td>
        <td class="count-cell important" data-type="important">
            ${user.important_count > 0
                ? `<a href="${importantUrl}" class="task-count-link">${user.important_count}</a>`
                : user.important_count}
        </td>
        <td class="count-cell recurring" data-type="recurring">
            ${user.recurring_count > 0
                ? `<a href="${recurringUrl}" class="task-count-link">${user.recurring_count}</a>`
                : user.recurring_count}
        </td>
        <td class="count-cell done" data-type="done">
            ${user.done_count > 0
                ? `<a href="${doneUrl}" class="task-count-link">${user.done_count}</a>`
                : user.done_count}
        </td>
    `;

    return row;
}

// ========================================
// RENDER TOP & BOTTOM USERS
// ========================================
function renderTopBottomUsers(data) {
    const container = document.getElementById('topBottomUsers');

    if (!data || (!data.top_user && !data.bottom_user)) {
        container.innerHTML = '<p class="text-muted" style="margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
    }

    let html = '';

    if (data.top_user) {
        const avatarUrl = data.top_user.avatar
            ? `/profile/avatar/${data.top_user.avatar}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(data.top_user.full_name)}&background=00ff89&color=000&size=128`;

        html += `
            <div class="top-user" title="L√†m nhi·ªÅu nh·∫•t: ${data.top_user.full_name}">
                <img src="${avatarUrl}"
                     alt="${data.top_user.full_name}"
                     class="user-badge-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data.top_user.full_name)}&background=00ff89&color=000&size=128'">
                <span class="user-badge-name">${data.top_user.full_name}</span>
            </div>
        `;
    }

    if (data.bottom_user) {
        const avatarUrl = data.bottom_user.avatar
            ? `/profile/avatar/${data.bottom_user.avatar}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(data.bottom_user.full_name)}&background=dc3545&color=fff&size=128`;

        html += `
            <div class="bottom-user" title="C·∫ßn c·ªë g·∫Øng th√™m: ${data.bottom_user.full_name}">
                <img src="${avatarUrl}"
                     alt="${data.bottom_user.full_name}"
                     class="user-badge-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data.bottom_user.full_name)}&background=dc3545&color=fff&size=128'">
                <span class="user-badge-name">${data.bottom_user.full_name}</span>
            </div>
        `;
    }

    container.innerHTML = html || '<p class="text-muted" style="margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
}

// ========================================
// FILTER MODAL FUNCTIONS
// ========================================
let filterModalInstance = null;
let currentFilterFrom = '';
let currentFilterTo = '';

function openFilterModal() {
    if (!filterModalInstance) {
        filterModalInstance = new bootstrap.Modal(document.getElementById('filterDateModal'));
    }

    document.getElementById('modalDateFrom').value = currentFilterFrom;
    document.getElementById('modalDateTo').value = currentFilterTo;

    filterModalInstance.show();
}

function applyFilter() {
    currentFilterFrom = document.getElementById('modalDateFrom').value;
    currentFilterTo = document.getElementById('modalDateTo').value;

    filterModalInstance.hide();

    const indicator = document.getElementById('filterIndicator');
    if (currentFilterFrom || currentFilterTo) {
        indicator.style.display = 'inline-flex';

        let filterText = '';
        if (currentFilterFrom && currentFilterTo) {
            filterText = `${formatDate(currentFilterFrom)} - ${formatDate(currentFilterTo)}`;
        } else if (currentFilterFrom) {
            filterText = `T·ª´ ${formatDate(currentFilterFrom)}`;
        } else if (currentFilterTo) {
            filterText = `ƒê·∫øn ${formatDate(currentFilterTo)}`;
        }
        indicator.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${filterText}`;
    } else {
        indicator.style.display = 'none';
    }

    loadPerformance();
    loadTopBottomUsers();
}

function resetFilter() {
    currentFilterFrom = '';
    currentFilterTo = '';
    document.getElementById('modalDateFrom').value = '';
    document.getElementById('modalDateTo').value = '';

    document.getElementById('filterIndicator').style.display = 'none';

    filterModalInstance.hide();

    loadPerformance();
    loadTopBottomUsers();
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `${day}/${month}`;
}

// ========================================
// EVENT LISTENERS
// ========================================
document.getElementById('moduleMenuBtn')?.addEventListener('click', function() {
    const activeModule = document.querySelector('.module-container.active');
    if (activeModule) {
        const moduleName = activeModule.id.replace('module-', '');
        toggleSidebar(moduleName);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth <= 992) {
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                closeSidebarOnMobile();
            });
        });
    }
});

window.addEventListener('resize', updateModuleMenuButton);

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const activeModule = document.querySelector('.module-container.active');
        if (activeModule) {
            backToHub();
        }
    }
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('üì¥ Tab hidden - connections remain open');
    } else {
        console.log('üì≥ Tab visible - checking connections');
        if (window.sseManager) {
            for (const [name, conn] of window.sseManager.connections) {
                if (conn.eventSource.readyState === EventSource.CLOSED) {
                    console.log(`üîÑ Reconnecting ${name}`);
                    window.sseManager.connect(name, conn.url, conn.callbacks, conn.fallbackConfig);
                }
            }
        }
    }
});

window.addEventListener('beforeunload', function() {
    console.log('üö™ Page unloading - disconnecting all SSE');
    if (window.sseManager) {
        window.sseManager.disconnectAll();
    }
    stopSmartPerformancePolling();
});

window.addEventListener('pagehide', function() {
    console.log('üö™ Page hiding - disconnecting all SSE');
    if (window.sseManager) {
        window.sseManager.disconnectAll();
    }
});

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    autoCenterIcons();
    updateModuleMenuButton();
    startRealtimeUpdates();

    console.log('üìä Bandwidth estimate for 50 users:');
    console.log('- SSE (dashboard-stats): ~6.5GB/month');
    console.log('- SSE (notifications): ~2GB/month');
    console.log('- Polling (performance): ~2GB/month');
    console.log('- Total: ~10.5GB/month');
    console.log('‚úÖ Optimized with smart polling!');
});
//==========9:56 27/11=================
    document.body.classList.add('has-module-sidebar');
</script>
{% endblock %}