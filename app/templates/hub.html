{% extends "base.html" %}

{% block title %}Quy Tr√¨nh C√¥ng Vi·ªác - NO THING{% endblock %}

{% block page_title %}Quy Tr√¨nh C√¥ng Vi·ªác{% endblock %}

{% block extra_css %}
<style>
body {
    background-image: url('{{ url_for('static', filename='images/hinh-nen.webp') }}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: scroll;
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

@supports (-webkit-touch-callout: none) {
    body {
        background: none;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        height: 100dvh;
        background-image: url('{{ url_for('static', filename='images/hinh-nen.webp') }}');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        z-index: -1;
    }
}

nav.top-navbar {
    background: transparent !important;
}

/* ============================================
   MAIN HUB LAYOUT
   ============================================ */
.hub-main-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 30px 20px;
}

/* ============================================
   4 ICON GRID - CENTER
   ============================================ */
.hub-icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 20px;
    max-width: 600px;
    margin: 0 auto;
    padding: 30px 20px;
}

.hub-icon-card {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px 10px;
    background: white;
    backdrop-filter: blur(8px);
    border: 1.5px solid rgba(255, 255, 255, 0.25);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    text-decoration: none;
    color: inherit;
}

.hub-icon-card:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    border-color: rgba(255, 255, 255, 0.4);
}

.hub-icon-card:active {
    transform: translateY(-1px) scale(0.98);
}

.hub-icon-wrapper {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.25s ease;
}

.hub-icon-card:hover .hub-icon-wrapper {
    transform: scale(1.08);
    box-shadow: 0 5px 16px rgba(0, 0, 0, 0.2);
}

.hub-icon-wrapper i {
    font-size: 1.8rem;
    color: white;
}

.hub-icon-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: dark;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    line-height: 1.2;
}

.hub-icon-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #dc3545;
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    border: 2px solid white;
}

/* ============================================
   MODULE PAGE - SIDEBAR + CONTENT
   ============================================ */
.module-container {
    display: none;
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
}

.module-container.active {
    display: flex;
}

.module-sidebar {
    width: 280px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    margin-right: 20px;
    position: sticky;
    top: 80px;
    height: fit-content;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    backdrop-filter: blur(4px);
}

.sidebar-overlay.active {
    display: block;
}

@media (max-width: 992px) {
    .module-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        margin: 0;
        z-index: 1050;
        transition: left 0.3s ease;
        max-height: 100vh;
        border-radius: 0 16px 16px 0;
    }

    .module-sidebar.active {
        left: 0;
    }
    .module-content {
        width: 100%;
    }
}

.module-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.module-sidebar-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
}

.module-sidebar-title i {
    font-size: 1.5rem;
}

.back-to-hub-btn {
    background: transparent;
    border: none;
    color: #6c757d;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.back-to-hub-btn:hover {
    color: #0d6efd;
    transform: scale(1.1);
}

.sidebar-menu {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.sidebar-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
    text-decoration: none;
    color: #495057;
}

.sidebar-menu-item:hover {
    background: white;
    border-color: #0d6efd;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
    color: #0d6efd;
}

.sidebar-menu-item i {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.sidebar-menu-item span {
    font-size: 0.95rem;
    font-weight: 600;
}

.sidebar-menu-item .badge {
    margin-left: auto;
}

.module-content {
    flex: 1;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

/* ============================================
   STATS & NOTIFICATIONS
   ============================================ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-radius: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid;
    transition: all 0.3s ease;
    text-decoration: none;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: white;
}

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: #2c3e50;
}

.stat-content p {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0;
}

.stat-pending { border-left-color: #ffc107; }
.stat-pending .stat-icon { color: #ffc107; }
.stat-progress { border-left-color: #0dcaf0; }
.stat-progress .stat-icon { color: #0dcaf0; }
.stat-overdue { border-left-color: #dc3545; }
.stat-overdue .stat-icon { color: #dc3545; }
.stat-done { border-left-color: #198754; }
.stat-done .stat-icon { color: #198754; }
.stat-info { border-left-color: #0dcaf0; }
.stat-info .stat-icon { color: #0dcaf0; }
.stat-warning { border-left-color: #ffc107; }
.stat-warning .stat-icon { color: #ffc107; }
.stat-danger { border-left-color: #dc3545; }
.stat-danger .stat-icon { color: #dc3545; }
.stat-primary { border-left-color: #0d6efd; }
.stat-primary .stat-icon { color: #0d6efd; }

.notification-box {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding: 20px 25px;
    border-radius: 16px;
    border-left: 5px solid;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    margin-bottom: 30px;
}

.notification-icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 10px 0;
}

.notification-message {
    font-size: 1rem;
    line-height: 1.6;
    margin: 0 0 15px 0;
}

.notification-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    padding: 5px 12px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    backdrop-filter: blur(5px);
}

.notification-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    border-left-color: #dc3545;
    color: white;
}

.notification-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border-left-color: #ffc107;
    color: white;
}

.notification-success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    border-left-color: #198754;
    color: white;
}

.notification-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-left-color: #0dcaf0;
    color: white;
}

.notification-secondary {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-left-color: #6c757d;
    color: #2c3e50;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1200px) {
    .module-sidebar {
        width: 240px;
    }
}

@media (max-width: 992px) {
    .module-container {
        flex-direction: column;
    }

    .module-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        margin: 0;
        z-index: 1050;
        transition: left 0.3s ease;
        max-height: 100vh;
        border-radius: 0 16px 16px 0;
    }

    .module-sidebar.active {
        left: 0;
    }

    .floating-menu-btn {
        display: flex;
    }

    .module-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .hub-main-container {
        padding: 20px 10px;
    }

    .hub-icon-grid {
        gap: 15px;
        padding: 20px 10px;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    }

    .hub-icon-card {
        padding: 12px 8px;
        gap: 6px;
    }

    .hub-icon-wrapper {
        width: 55px;
        height: 55px;
    }

    .hub-icon-wrapper i {
        font-size: 1.6rem;
    }

    .hub-icon-label {
        font-size: 0.8rem;
    }

    .module-content {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .hub-icon-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 100%;
    }

    .hub-icon-wrapper {
        width: 50px;
        height: 50px;
    }

    .hub-icon-wrapper i {
        font-size: 1.5rem;
    }

    .hub-icon-label {
        font-size: 0.75rem;
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.module-container.active {
    animation: fadeIn 0.4s ease;
}

a:not(.btn):not(.nav-link):not(.sidebar-brand){
    text-decoration: none;
    color: #000000;
}

.notification-btn {
    color: #ffffff;
}

/* ============================================
   PERFORMANCE TABLE
   ============================================ */
.performance-section {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    margin-bottom: 30px;
}

.filter-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
    gap: 15px;
    flex-wrap: wrap;
}

.top-bottom-users {
    display: flex;
    gap: 20px;
    align-items: center;
}

.top-user, .bottom-user {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    border-radius: 12px;
    background: #f8f9fa;
    transition: all 0.3s;
}

.top-user {
    border: 2px solid #ffd700;
    background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
}

.bottom-user {
    border: 2px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
}

.user-badge-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.user-badge-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.user-badge-count {
    font-weight: 700;
    font-size: 1rem;
}

.top-user .user-badge-count {
    color: #ffa500;
}

.bottom-user .user-badge-count {
    color: #dc3545;
}

.performance-table-container {
    overflow-x: auto;
}

.performance-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.1rem;
}

.performance-table thead th {
    background: #f8f9fa;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

.performance-table tbody td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
    font-size: 1.6rem;
}

.performance-table tbody tr:hover {
    background: #f8f9fa;
}

.user-avatar-cell {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e0e0e0;
}

.user-name-cell {
    font-weight: 600;
    color: #2c3e50;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.count-cell {
    text-align: center;
    font-weight: 700;
    font-size: 1.1rem;
}

.count-cell.urgent { color: #dc3545; }
.count-cell.important { color: #ffa500; }
.count-cell.recurring { color: #0dcaf0; }
.count-cell.done { color: #198754; }

@media (max-width: 768px) {
    .performance-section {
        padding: 15px;
        border-radius: 12px;
    }

    .filter-bar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding-bottom: 12px;
        margin-bottom: 15px;
    }

    .filter-date-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
        border-radius: 10px;
        gap: 6px;
        flex-shrink: 0;
    }

    .filter-date-btn i {
        font-size: 1rem;
    }

    .filter-indicator {
        font-size: 0.7rem;
        padding: 2px 6px;
    }

    .top-bottom-users {
        gap: 6px;
        flex: 0;
        justify-content: flex-end;
    }

    .top-user, .bottom-user {
        padding: 4px 6px;
        gap: 4px;
        border-radius: 8px;
        flex-shrink: 0;
        min-width: auto;
    }

    .top-user i, .bottom-user i {
        font-size: 0.9rem;
    }

    .user-badge-avatar {
        width: 28px;
        height: 28px;
    }

    .user-badge-name,
    .user-badge-count {
        display: none;
    }

    .performance-table-container {
        overflow-x: visible;
    }

    .performance-table {
        font-size: 1rem;
    }

    .performance-table thead th {
        padding: 8px 4px;
        font-size: 1rem;
    }

    .performance-table thead th:nth-child(2) {
        display: none;
    }

    .performance-table tbody td {
        padding: 8px 4px;
        font-size: 1.5rem;
    }

    .performance-table tbody td:nth-child(2) {
        display: none;
    }

    .user-avatar-cell {
        width: 35px;
        height: 35px;
    }

    .user-name-cell {
        font-size: 1rem;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .count-cell {
        font-size: 0.95rem;
    }

    .performance-table thead th {
        font-size: 0.65rem;
    }
}

@media (max-width: 480px) {
    .performance-section {
        padding: 10px;
    }

    .filter-bar {
        gap: 10px;
    }

    .performance-table {
        font-size: 0.7rem;
    }

    .performance-table thead th {
        padding: 6px 2px;
        font-size: 1.1rem;
    }

    .performance-table tbody td {
        padding: 6px 2px;
    }

    .user-avatar-cell {
        width: 30px;
        height: 30px;
    }

    .user-name-cell {
        font-size: 0.75rem;
        max-width: 70px;
    }

    .count-cell {
        font-size: 0.8rem;
    }

    .top-user i, .bottom-user i {
        font-size: 1.1rem;
    }
}

@media (min-width: 769px) and (max-width: 992px) {
    .performance-table {
        font-size: 0.85rem;
    }

    .performance-table thead th,
    .performance-table tbody td {
        padding: 12px 8px;
    }

    .user-avatar-cell {
        width: 45px;
        height: 45px;
    }

    .count-cell {
        font-size: 1rem;
    }
}

.filter-date-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: darkblue;
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.filter-date-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.filter-date-btn:active {
    transform: translateY(0);
}

.filter-date-btn i {
    font-size: 1.2rem;
}

.filter-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(255, 255, 255, 0.2);
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 0.85rem;
}

.filter-indicator i {
    font-size: 1rem;
}

@media (max-width: 768px) {
    .filter-bar {
        gap: 8px;
        padding-bottom: 12px;
        margin-bottom: 15px;
    }

    .filter-date-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
        border-radius: 10px;
        gap: 6px;
        flex-shrink: 0;
    }

    .filter-date-btn i {
        font-size: 1rem;
    }

    .filter-date-btn span:first-of-type {
        display: none;
    }

    .filter-indicator {
        font-size: 0.7rem;
        padding: 2px 6px;
    }

    .top-bottom-users {
        gap: 8px;
        flex: 1;
        justify-content: flex-end;
    }

    .top-user, .bottom-user {
        padding: 6px 10px;
        gap: 6px;
        border-radius: 10px;
        flex-shrink: 0;
    }

    .top-user i, .bottom-user i {
        font-size: 1rem;
    }

    .user-badge-avatar {
        width: 32px;
        height: 32px;
    }

    .user-badge-name {
        font-size: 0.75rem;
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-badge-count {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }

    .filter-date-btn {
        width: 100%;
        justify-content: center;
    }

    .filter-date-btn span:first-of-type {
        display: inline;
    }

    .top-bottom-users {
        width: 100%;
        justify-content: space-between;
    }

    .top-user, .bottom-user {
        flex: 1;
        justify-content: center;
    }
}

#filterDateModal .form-control-lg {
    padding: 12px;
    font-size: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.3s;
}

#filterDateModal .form-control-lg:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#filterDateModal .modal-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
}

#filterDateModal .modal-title {
    font-weight: 700;
    color: #2c3e50;
}

#filterDateModal .modal-footer {
    border-top: 2px solid #dee2e6;
}

.task-count-link {
    color: inherit;
    text-decoration: none;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: inline-block;
}

.task-count-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
    text-decoration: underline;
}

.count-cell.urgent .task-count-link {
    color: #dc3545 !important;
}

.count-cell.urgent .task-count-link:hover {
    background: rgba(220, 53, 69, 0.2);
}

.count-cell.important .task-count-link {
    color: #ffa500 !important;
}

.count-cell.important .task-count-link:hover {
    background: rgba(255, 193, 7, 0.2);
}

.count-cell.recurring .task-count-link {
    color: #0dcaf0 !important;
}

.count-cell.recurring .task-count-link:hover {
    background: rgba(13, 202, 240, 0.2);
}

.count-cell.done .task-count-link {
    color: #198754 !important;
}

.count-cell.done .task-count-link:hover {
    background: rgba(25, 135, 84, 0.2);
}

.count-cell.urgent .task-count-link:visited {
    color: #dc3545 !important;
}

.count-cell.important .task-count-link:visited {
    color: #ffa500 !important;
}

.count-cell.recurring .task-count-link:visited {
    color: #0dcaf0 !important;
}

.count-cell.done .task-count-link:visited {
    color: #198754 !important;
}
/* Animation cho cell updates */
.cell-updating {
    background: rgba(255, 193, 7, 0.3) !important;
    transition: background 0.3s ease;
}

.cell-updated {
    background: rgba(25, 135, 84, 0.3) !important;
    animation: pulse 0.5s ease;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="hub-main-container">
    <!-- MAIN HUB - 4 ICONS -->
    <div id="main-hub" class="hub-icon-grid">
        <!-- Icon 1: C√¥ng Vi·ªác -->
        <div class="hub-icon-card" onclick="showModule('tasks')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-briefcase-fill"></i>
            </div>
            <span class="hub-icon-label">C√¥ng Vi·ªác</span>
        </div>

        <!-- Icon 2: L∆∞∆°ng -->
        {% if current_user.role in ['director', 'accountant'] %}
        <div class="hub-icon-card" onclick="showModule('salary')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="bi bi-cash-coin"></i>
            </div>
            <span class="hub-icon-label">L∆∞∆°ng</span>
            <span class="hub-icon-badge" id="salary-badge" {% if not (pending_penalties > 0 or pending_advances > 0) %}style="display: none;"{% endif %}>
                {{ pending_penalties + pending_advances }}
            </span>
        </div>
        {% endif %}

        <!-- Icon 3: Th√¥ng Tin -->
        <div class="hub-icon-card" onclick="showModule('info')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="bi bi-megaphone-fill"></i>
            </div>
            <span class="hub-icon-label">Th√¥ng Tin</span>
            <span class="hub-icon-badge" id="info-badge" {% if not (unconfirmed_news > 0 or unread_notifications > 0) %}style="display: none;"{% endif %}>
                {{ unconfirmed_news + unread_notifications }}
            </span>
        </div>

        <!-- Icon 4: T√†i Kho·∫£n -->
        {% if current_user.role == 'director' %}
        <div class="hub-icon-card" onclick="showModule('account')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="bi bi-person-circle"></i>
            </div>
            <span class="hub-icon-label">T√†i Kho·∫£n</span>
        </div>
        {% endif %}
    </div>

    <!-- MODULE 1: C√îNG VI·ªÜC -->
    <div id="module-tasks" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('tasks')"></div>

        <div class="module-sidebar" id="sidebar-tasks">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-briefcase-fill" style="color: #667eea;"></i>
                    <span>C√¥ng Vi·ªác</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('tasks.create_task') }}" class="sidebar-menu-item">
                    <i class="bi bi-plus-circle-fill" style="color: #004989;"></i>
                    <span>T·∫°o C√¥ng Vi·ªác</span>
                </a>
                <a href="{{ url_for('tasks.dashboard') }}" class="sidebar-menu-item">
                    <i class="bi bi-speedometer2" style="color: #667eea;"></i>
                    <span>Th·ªëng K√™</span>
                </a>
                <a href="{{ url_for('tasks.kanban') }}" class="sidebar-menu-item">
                    <i class="bi bi-kanban" style="color: #f093fb;"></i>
                    <span>T√≥m T·∫Øt CV</span>
                </a>
                {% if current_user.role in ['director', 'manager'] %}
                <a href="{{ url_for('performance.performance_review') }}" class="sidebar-menu-item">
                    <i class="bi bi-graph-up-arrow" style="color: #30cfd0;"></i>
                    <span>Hi·ªáu Su·∫•t NV</span>
                </a>
                <a href="{{ url_for('performance.unrated_tasks') }}" class="sidebar-menu-item" data-badge-id="my_tasks_need_rating">
                    <i class="bi bi-star-fill" style="color: #ffd700;"></i>
                    <span>CV Ch∆∞a ƒê√°nh Gi√°</span>
                    {% if my_tasks_need_rating > 0 %}
                    <span class="badge bg-danger">{{ my_tasks_need_rating }}</span>
                    {% endif %}
                </a>
                {% endif %}
            </div>
        </div>

        <div class="module-content">
            <h5 class="text-center" style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                T·ªîNG QUAN
            </h5>
            <div class="performance-section">
                <div class="filter-bar">
                    <button class="filter-date-btn" onclick="openFilterModal()">
                        <i class="bi bi-calendar-range"></i>
                        <span class="filter-indicator" id="filterIndicator" style="display: none;">
                            <i class="bi bi-check-circle-fill"></i>
                        </span>
                    </button>

                    <div class="top-bottom-users" id="topBottomUsers">
                        <!-- ‚úÖ SERVER-SIDE RENDER v·ªõi Jinja2 -->
                        {% if initial_performance %}
                            {% set top_user = initial_performance|selectattr('rank', 'equalto', 1)|first %}
                            {% set bottom_user = initial_performance|selectattr('rank', 'equalto', -1)|first %}

                            {% if top_user %}
                            <div class="top-user" title="L√†m nhi·ªÅu nh·∫•t">
                                <i class="bi bi-trophy-fill" style="color: #ffd700; font-size: 1.3rem;"></i>
                                <img src="{% if top_user.avatar %}/profile/avatar/{{ top_user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ top_user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128{% endif %}"
                                     alt="{{ top_user.full_name }}"
                                     class="user-badge-avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name={{ top_user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128'">
                                <span class="user-badge-name">{{ top_user.full_name }}</span>
                                <span class="user-badge-count">{{ top_user.done_count }} vi·ªác</span>
                            </div>
                            {% endif %}

                            {% if bottom_user %}
                            <div class="bottom-user" title="C·∫ßn c·ªë g·∫Øng th√™m">
                                <i class="bi bi-exclamation-circle-fill" style="color: #dc3545; font-size: 1.3rem;"></i>
                                <img src="{% if bottom_user.avatar %}/profile/avatar/{{ bottom_user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ bottom_user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128{% endif %}"
                                     alt="{{ bottom_user.full_name }}"
                                     class="user-badge-avatar"
                                     onerror="this.src='https://ui-avatars.com/api/?name={{ bottom_user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128'">
                                <span class="user-badge-name">{{ bottom_user.full_name }}</span>
                                <span class="user-badge-count">{{ bottom_user.done_count }} vi·ªác</span>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="performance-table-container">
                    <table class="performance-table">
                       <thead>
                        <tr>
                            <th style="width: 80px;">Avatar</th>
                            <th>T√™n NV</th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">üî¥ Kh·∫©n C·∫•p</span>
                                <span class="d-md-none">üî¥</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">‚≠ê Quan Tr·ªçng</span>
                                <span class="d-md-none">‚≠ê</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">üîÅ L·∫∑p L·∫°i</span>
                                <span class="d-md-none">üîÅ</span>
                            </th>
                            <th style="width: 100px; text-align: center;">
                                <span class="d-none d-md-inline">‚úÖ Ho√†n Th√†nh</span>
                                <span class="d-md-none">‚úÖ</span>
                            </th>
                        </tr>
                    </thead>
                        <tbody id="performanceTableBody">
                            <!-- ‚úÖ SERVER-SIDE RENDER v·ªõi Jinja2 -->
                            {% if initial_performance %}
                                {% for user in initial_performance %}
                                <tr data-user-id="{{ user.user_id }}">
                                    <td>
                                        <img src="{% if user.avatar %}/profile/avatar/{{ user.avatar }}{% else %}https://ui-avatars.com/api/?name={{ user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128{% endif %}"
                                             alt="{{ user.full_name }}"
                                             class="user-avatar-cell"
                                             onerror="this.src='https://ui-avatars.com/api/?name={{ user.full_name|urlencode }}&background=0dcaf0&color=fff&size=128'">
                                    </td>
                                    <td class="user-name-cell">{{ user.full_name }}</td>
                                    <td class="count-cell urgent" data-type="urgent">
                                        {% if user.urgent_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='urgent') }}"
                                           class="task-count-link">{{ user.urgent_count }}</a>
                                        {% else %}
                                        {{ user.urgent_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell important" data-type="important">
                                        {% if user.important_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='important') }}"
                                           class="task-count-link">{{ user.important_count }}</a>
                                        {% else %}
                                        {{ user.important_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell recurring" data-type="recurring">
                                        {% if user.recurring_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, tag='recurring') }}"
                                           class="task-count-link">{{ user.recurring_count }}</a>
                                        {% else %}
                                        {{ user.recurring_count }}
                                        {% endif %}
                                    </td>
                                    <td class="count-cell done" data-type="done">
                                        {% if user.done_count > 0 %}
                                        <a href="{{ url_for('tasks.priority_detail', assigned_user=user.user_id, status='DONE') }}"
                                           class="task-count-link">{{ user.done_count }}</a>
                                        {% else %}
                                        {{ user.done_count }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                                        <p class="text-muted mt-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE 2: L∆Ø∆†NG -->
    {% if current_user.role in ['director', 'accountant'] %}
    <div id="module-salary" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('salary')"></div>

        <div class="module-sidebar" id="sidebar-salary">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-cash-coin" style="color: #f093fb;"></i>
                    <span>L∆∞∆°ng</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('salaries.list_salaries') }}" class="sidebar-menu-item">
                    <i class="bi bi-wallet2" style="color: #a8edea;"></i>
                    <span>Qu·∫£n L√Ω L∆∞∆°ng</span>
                </a>
                <a href="{{ url_for('employees.list_employees') }}" class="sidebar-menu-item">
                    <i class="bi bi-people-fill" style="color: #ffecd2;"></i>
                    <span>Nh√¢n Vi√™n</span>
                </a>
                <a href="{{ url_for('work_days.list_configs') }}" class="sidebar-menu-item">
                    <i class="bi bi-calendar-week" style="color: #ff9a9e;"></i>
                    <span>S·ªë C√¥ng/Th√°ng</span>
                </a>
                {% if current_user.role == 'director' %}
                <a href="{{ url_for('salary_grades.list_grades') }}" class="sidebar-menu-item">
                    <i class="bi bi-award-fill" style="color: #ffd89b;"></i>
                    <span>C·∫•p B·∫≠c L∆∞∆°ng</span>
                </a>
                {% endif %}
                <a href="{{ url_for('penalties.list_penalties') }}" class="sidebar-menu-item" data-badge-id="penalties">
                    <i class="bi bi-exclamation-triangle-fill" style="color: #f43b47;"></i>
                    <span>Bi√™n B·∫£n Ph·∫°t</span>
                    {% if pending_penalties > 0 %}
                    <span class="badge bg-danger">{{ pending_penalties }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('advances.list_advances') }}" class="sidebar-menu-item" data-badge-id="advances">
                    <i class="bi bi-cash-stack" style="color: #ffc3a0;"></i>
                    <span>T·∫°m ·ª®ng</span>
                    {% if pending_advances > 0 %}
                    <span class="badge bg-warning">{{ pending_advances }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-cash-coin"></i> Qu·∫£n L√Ω L∆∞∆°ng & T√†i Ch√≠nh
            </h5>

            <div class="stats-grid">
                <div class="stat-card stat-info">
                    <div class="stat-icon"><i class="bi bi-wallet2"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_salaries }}</h3>
                        <p>B·∫£ng L∆∞∆°ng</p>
                    </div>
                </div>

                <div class="stat-card stat-primary">
                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_employees }}</h3>
                        <p>Nh√¢n Vi√™n</p>
                    </div>
                </div>

                <div class="stat-card stat-danger">
                    <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_penalties }}</h3>
                        <p>Ph·∫°t Ch∆∞a Tr·ª´</p>
                    </div>
                </div>

                <div class="stat-card stat-warning">
                    <div class="stat-icon"><i class="bi bi-cash-stack"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_advances }}</h3>
                        <p>T·∫°m ·ª®ng Ch∆∞a Tr·ª´</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- MODULE 3: TH√îNG TIN -->
    <div id="module-info" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('info')"></div>

        <div class="module-sidebar" id="sidebar-info">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-megaphone-fill" style="color: #4facfe;"></i>
                    <span>Th√¥ng Tin</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('news.list_news') }}" class="sidebar-menu-item" data-badge-id="unconfirmed_news">
                    <i class="bi bi-newspaper" style="color: #09203f;"></i>
                    <span>Th√¥ng B√°o NB</span>
                    {% if unconfirmed_news > 0 %}
                    <span class="badge bg-danger">{{ unconfirmed_news }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('files.list_files') }}" class="sidebar-menu-item">
                    <i class="bi bi-folder2-open" style="color: #ebbba7;"></i>
                    <span>Th∆∞ Vi·ªán File</span>
                </a>
                <a href="{{ url_for('notes.list_notes') }}" class="sidebar-menu-item">
                    <i class="bi bi-journal-text" style="color: #c471f5;"></i>
                    <span>Ghi Ch√∫</span>
                </a>
                <a href="{{ url_for('notifications.list_notifications') }}" class="sidebar-menu-item" data-badge-id="unread_notifications">
                    <i class="bi bi-bell" style="color: #f83600;"></i>
                    <span>Nh·∫Øc Nh·ªü</span>
                    {% if unread_notifications > 0 %}
                    <span class="badge bg-danger">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-megaphone-fill"></i> Th√¥ng Tin & T√†i Li·ªáu
            </h5>

            <div class="stats-grid">
                <a href="{{ url_for('news.list_news') }}" class="stat-card stat-info" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-newspaper"></i></div>
                    <div class="stat-content">
                        <h3>{{ unconfirmed_news }}</h3>
                        <p>TB Ch∆∞a X√°c Nh·∫≠n</p>
                    </div>
                </a>

                <a href="{{ url_for('notifications.list_notifications') }}" class="stat-card stat-warning" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-bell"></i></div>
                    <div class="stat-content">
                        <h3>{{ unread_notifications }}</h3>
                        <p>Nh·∫Øc Nh·ªü Ch∆∞a ƒê·ªçc</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- MODULE 4: T√ÄI KHO·∫¢N -->
    {% if current_user.role == 'director' %}
    <div id="module-account" class="module-container">
        <div class="sidebar-overlay" onclick="toggleSidebar('account')"></div>

        <div class="module-sidebar" id="sidebar-account">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-person-circle" style="color: #fa709a;"></i>
                    <span>T√†i Kho·∫£n</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="{{ url_for('auth.users') }}" class="sidebar-menu-item">
                    <i class="bi bi-people" style="color: #89f7fe;"></i>
                    <span>Qu·∫£n L√Ω TK</span>
                </a>
                <a href="{{ url_for('auth.register') }}" class="sidebar-menu-item">
                    <i class="bi bi-person-plus-fill" style="color: #fddb92;"></i>
                    <span>T·∫°o T√†i Kho·∫£n</span>
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-person-circle"></i> Qu·∫£n Tr·ªã T√†i Kho·∫£n
            </h5>

            <div class="stats-grid">
                <a href="{{ url_for('auth.users') }}" class="stat-card stat-primary" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-people"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_users }}</h3>
                        <p>T·ªïng T√†i Kho·∫£n</p>
                    </div>
                </a>

                <a href="{{ url_for('auth.users') }}" class="stat-card stat-done" style="cursor: pointer;">
                    <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                    <div class="stat-content">
                        <h3>{{ active_users }}</h3>
                        <p>ƒêang Ho·∫°t ƒê·ªông</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Filter Ng√†y -->
<div class="modal fade" id="filterDateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-range text-primary"></i>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-event text-success"></i> T·ª´ Ng√†y:
                    </label>
                    <input type="date" class="form-control form-control-lg" id="modalDateFrom">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-check text-danger"></i> ƒê·∫øn Ng√†y:
                    </label>
                    <input type="date" class="form-control form-control-lg" id="modalDateTo">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="resetFilter()">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
                <button type="button" class="btn btn-primary" onclick="applyFilter()">
                    <i class="bi bi-funnel-fill"></i> L·ªçc
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// MODULE NAVIGATION
// ========================================
function showModule(moduleName) {
    document.getElementById('main-hub').style.display = 'none';

    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    const module = document.getElementById('module-' + moduleName);
    if (module) {
        module.classList.add('active');
    }

    updateModuleMenuButton();

    setTimeout(() => {
        enableBackdropClick();
    }, 100);

    if (moduleName === 'tasks') {
        setTimeout(() => {
            console.log('üìä Entering Tasks module - refreshing performance');
            refreshPerformanceNow();
        }, 500);
    }
}

function backToHub() {
    closeSidebarOnMobile();

    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    document.getElementById('main-hub').style.display = 'grid';

    updateModuleMenuButton();
    disableBackdropClick();
}

// ========================================
// MOBILE SIDEBAR TOGGLE
// ========================================
function toggleSidebar(moduleName) {
    const sidebar = document.getElementById('sidebar-' + moduleName);

    if (sidebar) {
        sidebar.classList.toggle('active');
        const module = document.getElementById('module-' + moduleName);
        const overlay = module.querySelector('.sidebar-overlay');
        if (overlay) {
            overlay.classList.toggle('active');
        }
    }
}

function closeSidebarOnMobile() {
    document.querySelectorAll('.module-sidebar').forEach(s => {
        s.classList.remove('active');
    });
    document.querySelectorAll('.sidebar-overlay').forEach(o => {
        o.classList.remove('active');
    });
}

// ========================================
// MODULE MENU BUTTON TOGGLE
// ========================================
function updateModuleMenuButton() {
    const menuBtn = document.getElementById('moduleMenuBtn');
    const isInModule = document.querySelector('.module-container.active');

    if (menuBtn) {
        if (isInModule && window.innerWidth <= 992) {
            menuBtn.style.display = 'block';
        } else {
            menuBtn.style.display = 'none';
        }
    }
}

// ========================================
// CLICK BACKDROP TO GO BACK TO HUB
// ========================================
let backdropClickEnabled = false;

function enableBackdropClick() {
    if (backdropClickEnabled) return;
    backdropClickEnabled = true;

    document.addEventListener('click', handleBackdropClick);
}

function disableBackdropClick() {
    backdropClickEnabled = false;
    document.removeEventListener('click', handleBackdropClick);
}

function handleBackdropClick(e) {
    const activeModule = document.querySelector('.module-container.active');
    if (!activeModule) {
        disableBackdropClick();
        return;
    }

    const moduleContent = activeModule.querySelector('.module-content');
    const moduleSidebar = activeModule.querySelector('.module-sidebar');

    if (e.target.closest('.hub-icon-card')) return;
    if (e.target.closest('.top-navbar')) return;
    if (e.target.closest('.modal')) return;
    if (e.target.classList.contains('modal')) return;
    if (document.querySelector('.modal.show')) return;
    if (e.target.classList.contains('modal-backdrop')) return;

    if (window.innerWidth > 992) {
        if (!moduleContent.contains(e.target) && !moduleSidebar.contains(e.target)) {
            backToHub();
        }
    } else {
        const overlay = activeModule.querySelector('.sidebar-overlay');
        if (overlay && e.target === overlay) {
            closeSidebarOnMobile();
        }
    }
}

// ========================================
// REAL-TIME UPDATES: SSE + FALLBACK POLLING
// ========================================
let sseStatsConnected = false;

function startRealtimeUpdates() {
    console.log('üöÄ Starting real-time stats updates...');

    // ‚úÖ KH√îNG g·ªçi updateRealtimeData() ·ªü ƒë√¢y
    // SSE s·∫Ω t·ª± ƒë·ªông update khi connected

    if (typeof window.sseManager === 'undefined') {
        console.warn('‚ö†Ô∏è SSE Manager not loaded, using polling');
        startPollingFallback();
        startSmartPerformancePolling();
        return;
    }

    window.sseManager.connect(
        'dashboard-stats',
        '/sse/dashboard-stats',
        {
            onOpen: () => {
                console.log('‚úÖ SSE Dashboard Stats connected');
                sseStatsConnected = true;
            },
            onError: (error, attempts) => {
                console.error('‚ùå SSE Stats error:', error, 'attempts:', attempts);
                sseStatsConnected = false;
            },
            events: {
                'stats_update': (data) => {
                    console.log('üìä SSE stats update:', data);
                    updateUIWithStats(data);
                },
                'heartbeat': (data) => {
                    console.log('üíì SSE stats heartbeat');
                },
                'error': (data) => {
                    console.error('‚ùå SSE stats error event:', data);
                },
                'close': (data) => {
                    console.log('üîå SSE stats closed by server');
                }
            }
        },
        {
            url: '/hub/api/realtime-stats',
            interval: 30000,
            onData: (data) => {
                console.log('üìä Polling stats:', data);
                updateUIWithStats(data);
            }
        }
    );

    startSmartPerformancePolling();
}

function startPollingFallback() {
    console.log('üîÑ Starting polling fallback for stats (30s interval)');
    setInterval(updateRealtimeData, 30000);
}

function stopRealtimeUpdates() {
    if (window.sseManager) {
        window.sseManager.disconnect('dashboard-stats');
    }

    stopSmartPerformancePolling();
}

function updateRealtimeData() {
    fetch('/hub/api/realtime-stats')
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            console.log('üìä Real-time update:', data);
            updateUIWithStats(data);
        })
        .catch(err => {
            console.error('‚ùå Real-time update error:', err);
        });
}

function updateUIWithStats(data) {
    if (typeof updateNotifCount === 'function') {
        updateNotifCount();
    }

    const infoBadge = document.getElementById('info-badge');
    if (infoBadge) {
        if (data.info_badge > 0) {
            infoBadge.textContent = data.info_badge;
            infoBadge.style.display = 'inline-block';
        } else {
            infoBadge.style.display = 'none';
        }
    }

    const salaryBadge = document.getElementById('salary-badge');
    if (salaryBadge && data.salary_badge !== undefined) {
        if (data.salary_badge > 0) {
            salaryBadge.textContent = data.salary_badge;
            salaryBadge.style.display = 'inline-block';
        } else {
            salaryBadge.style.display = 'none';
        }
    }

    updateInfoModuleStats(data);
    updateSalaryModuleStats(data);

    if (data.my_overdue > 0) {
        console.warn(`‚ö†Ô∏è B·∫°n c√≥ ${data.my_overdue} c√¥ng vi·ªác qu√° h·∫°n!`);
    }
}

function updateInfoModuleStats(data) {
    const infoModule = document.getElementById('module-info');
    if (infoModule) {
        const unconfirmedCard = infoModule.querySelector('.stat-info h3');
        if (unconfirmedCard) unconfirmedCard.textContent = data.unconfirmed_news;

        const unreadCard = infoModule.querySelector('.stat-warning h3');
        if (unreadCard) unreadCard.textContent = data.unread_notifications;

        updateSidebarBadge(infoModule, 'unconfirmed_news', data.unconfirmed_news);
        updateSidebarBadge(infoModule, 'unread_notifications', data.unread_notifications);
    }
}

function updateSalaryModuleStats(data) {
    const salaryModule = document.getElementById('module-salary');
    if (salaryModule) {
        const penaltyCard = salaryModule.querySelector('.stat-danger h3');
        if (penaltyCard) penaltyCard.textContent = data.pending_penalties;

        const advanceCard = salaryModule.querySelector('.stat-warning h3');
        if (advanceCard) advanceCard.textContent = data.pending_advances;

        updateSidebarBadge(salaryModule, 'penalties', data.pending_penalties);
        updateSidebarBadge(salaryModule, 'advances', data.pending_advances);
    }
}

function updateSidebarBadge(module, badgeType, count) {
    const sidebar = module.querySelector('.module-sidebar');
    if (!sidebar) {
        console.warn('[Badge] Sidebar not found for module:', module.id);
        return;
    }

    const targetLink = sidebar.querySelector(`a[data-badge-id="${badgeType}"]`);

    if (!targetLink) {
        console.warn(`[Badge] Link not found for badge type: ${badgeType}`);
        return;
    }

    let badge = targetLink.querySelector('.badge');

    if (count > 0) {
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge bg-danger';
            targetLink.appendChild(badge);
            console.log(`[Badge] Created badge for ${badgeType}: ${count}`);
        } else {
            console.log(`[Badge] Updated badge for ${badgeType}: ${count}`);
        }
        badge.textContent = count;
        badge.style.display = 'inline-block';
    } else {
        if (badge) {
            badge.remove();
            console.log(`[Badge] Removed badge for ${badgeType}`);
        }
    }
}

// ========================================
// SMART PERFORMANCE POLLING
// ========================================
let performancePollingInterval = null;
let lastPerformanceUpdate = 0;
const PERFORMANCE_POLL_INTERVAL = 60000;
let animationTimeouts = {};

function startSmartPerformancePolling() {
    console.log('üîÑ Starting smart performance polling (60s interval)');

    // ‚úÖ KH√îNG load performance ·ªü ƒë√¢y
    // S·∫Ω ƒë∆∞·ª£c g·ªçi trong showModule('tasks')

    stopSmartPerformancePolling();

    performancePollingInterval = setInterval(() => {
        const activeModule = document.querySelector('.module-container.active');
        const isTaskModule = activeModule && activeModule.id === 'module-tasks';

        const now = Date.now();
        const timeSinceLastUpdate = now - lastPerformanceUpdate;
        const shouldPoll = isTaskModule &&
                          !document.hidden &&
                          timeSinceLastUpdate >= PERFORMANCE_POLL_INTERVAL;

        if (shouldPoll) {
            console.log(`üîÑ Smart polling: Refreshing performance data (${Math.round(timeSinceLastUpdate/1000)}s since last update)`);
            loadPerformance();
            lastPerformanceUpdate = now;
        } else {
            if (!isTaskModule) {
                console.log('‚è∏Ô∏è Skipping poll: Not in Tasks module');
            } else if (document.hidden) {
                console.log('‚è∏Ô∏è Skipping poll: Tab hidden');
            } else {
                console.log(`‚è∏Ô∏è Skipping poll: Too soon (${Math.round(timeSinceLastUpdate/1000)}s < 60s)`);
            }
        }
    }, PERFORMANCE_POLL_INTERVAL);
}

function stopSmartPerformancePolling() {
    if (performancePollingInterval) {
        console.log('üõë Stopping performance polling');
        clearInterval(performancePollingInterval);
        performancePollingInterval = null;
    }
}

function refreshPerformanceNow() {
    console.log('‚úÖ Manual refresh: Updating performance immediately');
    loadPerformance();
    lastPerformanceUpdate = Date.now();
}

// ========================================
// AUTO CENTER ICONS
// ========================================
function autoCenterIcons() {
    const iconGrid = document.getElementById('main-hub');
    const iconCount = iconGrid.querySelectorAll('.hub-icon-card').length;

    if (iconCount === 2) {
        iconGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        iconGrid.style.maxWidth = '550px';
    } else if (iconCount === 3) {
        iconGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
        iconGrid.style.maxWidth = '750px';
    } else if (iconCount === 1) {
        iconGrid.style.gridTemplateColumns = '1fr';
        iconGrid.style.maxWidth = '250px';
    }
}

// ========================================
// PERFORMANCE TABLE - LOAD DATA
// ========================================
let performanceLoadTimeout = null;

function loadPerformance() {
    //  Debounce - tr√°nh g·ªçi duplicate khi load trang
    if (performanceLoadTimeout) {
        clearTimeout(performanceLoadTimeout);
    }

    performanceLoadTimeout = setTimeout(() => {
        const params = new URLSearchParams();
        if (currentFilterFrom) params.append('date_from', currentFilterFrom);
        if (currentFilterTo) params.append('date_to', currentFilterTo);

        const url = '/hub/api/team-performance?' + params.toString();

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateTableRows(data.data);
                } else {
                    console.error('Error loading performance:', data.error);
                    document.getElementById('performanceTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                                <p class="text-danger mt-3">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(err => {
                console.error('Error fetching performance:', err);
                document.getElementById('performanceTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                            <p class="text-danger mt-3">L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</p>
                        </td>
                    </tr>
                `;
            });
    }, 100);
}

// ========================================
// FUNCTION 1: UPDATE TABLE ROWS (CH·ªà UPDATE THAY ƒê·ªîI)
// ========================================
function updateTableRows(newData) {
    const tbody = document.getElementById('performanceTableBody');

    if (!newData || newData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="text-muted mt-3">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                </td>
            </tr>
        `;
        return;
    }

    // Map existing rows by user_id
    const existingRows = {};
    tbody.querySelectorAll('tr[data-user-id]').forEach(row => {
        const userId = row.getAttribute('data-user-id');
        existingRows[userId] = row;
    });

    // Track which users we've seen
    const seenUsers = new Set();

    newData.forEach((user, index) => {
        seenUsers.add(user.user_id.toString());
        const existingRow = existingRows[user.user_id];

        if (existingRow) {
            // ‚úÖ UPDATE existing row - CH·ªà UPDATE CHANGED CELLS
            updateCellIfChanged(existingRow, 'urgent', user.urgent_count, user.user_id);
            updateCellIfChanged(existingRow, 'important', user.important_count, user.user_id);
            updateCellIfChanged(existingRow, 'recurring', user.recurring_count, user.user_id);
            updateCellIfChanged(existingRow, 'done', user.done_count, user.user_id);

            // Reorder if needed
            const currentIndex = Array.from(tbody.children).indexOf(existingRow);
            if (currentIndex !== index) {
                tbody.insertBefore(existingRow, tbody.children[index]);
            }
        } else {
            // ‚úÖ ADD new row
            const newRow = createTableRow(user);
            if (tbody.children[index]) {
                tbody.insertBefore(newRow, tbody.children[index]);
            } else {
                tbody.appendChild(newRow);
            }
        }
    });

    // ‚úÖ REMOVE rows that are no longer in data
    Object.keys(existingRows).forEach(userId => {
        if (!seenUsers.has(userId)) {
            existingRows[userId].remove();
        }
    });

    // Update top/bottom users
    renderTopBottomUsers(newData);
}

// ========================================
// FUNCTION 2: UPDATE M·ªòT CELL N√äU C√ì THAY ƒê·ªîI
// ========================================
function updateCellIfChanged(row, type, newCount, userId) {
    // T√¨m cell c·∫ßn update
    const cell = row.querySelector(`td[data-type="${type}"]`);
    if (!cell) return;

    // L·∫•y gi√° tr·ªã hi·ªán t·∫°i
    const link = cell.querySelector('a.task-count-link');
    const currentCount = link ? parseInt(link.textContent) : parseInt(cell.textContent);

    // CH·ªà update n·∫øu gi√° tr·ªã thay ƒë·ªïi
    if (currentCount !== newCount) {

        // T·∫°o key unique cho cell n√†y (VD: "5-urgent")
        const cellKey = `${userId}-${type}`;

        // ‚úÖ N·∫æU ƒêANG C√ì ANIMATION C≈® ‚Üí HU·ª∂ N√ì
        if (animationTimeouts[cellKey]) {
            clearTimeout(animationTimeouts[cellKey]);
            cell.classList.remove('cell-updating', 'cell-updated');
        }

        // B·∫Øt ƒë·∫ßu animation m·ªõi
        cell.classList.add('cell-updating');

        // L∆∞u timeout v√†o object
        animationTimeouts[cellKey] = setTimeout(() => {

            // Build URL cho link
            const filterParams = new URLSearchParams();
            if (currentFilterFrom) filterParams.append('date_from', currentFilterFrom);
            if (currentFilterTo) filterParams.append('date_to', currentFilterTo);

            const baseUrl = '/tasks/priority-detail';

            if (type === 'done') {
                filterParams.append('assigned_user', userId);
                filterParams.append('status', 'DONE');
            } else {
                filterParams.append('assigned_user', userId);
                filterParams.append('tag', type);
            }

            const url = baseUrl + '?' + filterParams.toString();

            // Update n·ªôi dung cell
            if (newCount > 0) {
                cell.innerHTML = `<a href="${url}" class="task-count-link">${newCount}</a>`;
            } else {
                cell.textContent = newCount;
            }

            // K·∫øt th√∫c animation
            cell.classList.remove('cell-updating');
            cell.classList.add('cell-updated');

            // Sau 1s th√¨ cleanup
            setTimeout(() => {
                cell.classList.remove('cell-updated');
                delete animationTimeouts[cellKey]; // Gi·∫£i ph√≥ng memory
            }, 1000);

        }, 300);
    }
}

// ========================================
// FUNCTION 3: T·∫†O ROW M·ªöI CHO USER M·ªöI
// ========================================
function createTableRow(user) {
    const row = document.createElement('tr');
    row.setAttribute('data-user-id', user.user_id);

    const avatarUrl = user.avatar
        ? `/profile/avatar/${user.avatar}`
        : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128`;

    const filterParams = new URLSearchParams();
    if (currentFilterFrom) filterParams.append('date_from', currentFilterFrom);
    if (currentFilterTo) filterParams.append('date_to', currentFilterTo);

    const baseUrl = '/tasks/priority-detail';

    // Build URLs cho t·ª´ng lo·∫°i
    const urgentParams = new URLSearchParams(filterParams);
    urgentParams.append('assigned_user', user.user_id);
    urgentParams.append('tag', 'urgent');
    const urgentUrl = baseUrl + '?' + urgentParams.toString();

    const importantParams = new URLSearchParams(filterParams);
    importantParams.append('assigned_user', user.user_id);
    importantParams.append('tag', 'important');
    const importantUrl = baseUrl + '?' + importantParams.toString();

    const recurringParams = new URLSearchParams(filterParams);
    recurringParams.append('assigned_user', user.user_id);
    recurringParams.append('tag', 'recurring');
    const recurringUrl = baseUrl + '?' + recurringParams.toString();

    const doneParams = new URLSearchParams(filterParams);
    doneParams.append('assigned_user', user.user_id);
    doneParams.append('status', 'DONE');
    const doneUrl = baseUrl + '?' + doneParams.toString();

    row.innerHTML = `
        <td>
            <img src="${avatarUrl}"
                 alt="${user.full_name}"
                 class="user-avatar-cell"
                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128'">
        </td>
        <td class="user-name-cell">${user.full_name}</td>
        <td class="count-cell urgent" data-type="urgent">
            ${user.urgent_count > 0
                ? `<a href="${urgentUrl}" class="task-count-link">${user.urgent_count}</a>`
                : user.urgent_count}
        </td>
        <td class="count-cell important" data-type="important">
            ${user.important_count > 0
                ? `<a href="${importantUrl}" class="task-count-link">${user.important_count}</a>`
                : user.important_count}
        </td>
        <td class="count-cell recurring" data-type="recurring">
            ${user.recurring_count > 0
                ? `<a href="${recurringUrl}" class="task-count-link">${user.recurring_count}</a>`
                : user.recurring_count}
        </td>
        <td class="count-cell done" data-type="done">
            ${user.done_count > 0
                ? `<a href="${doneUrl}" class="task-count-link">${user.done_count}</a>`
                : user.done_count}
        </td>
    `;

    return row;
}

function renderTopBottomUsers(data) {
    const container = document.getElementById('topBottomUsers');

    if (data.length === 0) {
        container.innerHTML = '<p class="text-muted" style="margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
    }

    let html = '';

    const topUser = data.find(u => u.rank === 1);
    if (topUser) {
        const avatarUrl = topUser.avatar
            ? `/profile/avatar/${topUser.avatar}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(topUser.full_name)}&background=0dcaf0&color=fff&size=128`;

        html += `
            <div class="top-user" title="L√†m nhi·ªÅu nh·∫•t">
                <i class="bi bi-trophy-fill" style="color: #ffd700; font-size: 1.3rem;"></i>
                <img src="${avatarUrl}"
                     alt="${topUser.full_name}"
                     class="user-badge-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(topUser.full_name)}&background=0dcaf0&color=fff&size=128'">
                <span class="user-badge-name">${topUser.full_name}</span>
                <span class="user-badge-count">${topUser.done_count} vi·ªác</span>
            </div>
        `;
    }

    const bottomUser = data.find(u => u.rank === -1);
    if (bottomUser) {
        const avatarUrl = bottomUser.avatar
            ? `/profile/avatar/${bottomUser.avatar}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(bottomUser.full_name)}&background=0dcaf0&color=fff&size=128`;

        html += `
            <div class="bottom-user" title="C·∫ßn c·ªë g·∫Øng th√™m">
                <i class="bi bi-exclamation-circle-fill" style="color: #dc3545; font-size: 1.3rem;"></i>
                <img src="${avatarUrl}"
                     alt="${bottomUser.full_name}"
                     class="user-badge-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(bottomUser.full_name)}&background=0dcaf0&color=fff&size=128'">
                <span class="user-badge-name">${bottomUser.full_name}</span>
                <span class="user-badge-count">${bottomUser.done_count} vi·ªác</span>
            </div>
        `;
    }

    if (data.length === 1 && data[0].rank === 0) {
        const user = data[0];
        const avatarUrl = user.avatar
            ? `/profile/avatar/${user.avatar}`
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128`;

        html = `
            <div class="top-user" title="Duy nh·∫•t">
                <i class="bi bi-person-circle" style="color: #0d6efd; font-size: 1.3rem;"></i>
                <img src="${avatarUrl}"
                     alt="${user.full_name}"
                     class="user-badge-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=0dcaf0&color=fff&size=128'">
                <span class="user-badge-name">${user.full_name}</span>
                <span class="user-badge-count">${user.done_count} vi·ªác</span>
            </div>
        `;
    }

    container.innerHTML = html || '<p class="text-muted" style="margin: 0;">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
}

// ========================================
// FILTER MODAL FUNCTIONS
// ========================================
let filterModalInstance = null;
let currentFilterFrom = '';
let currentFilterTo = '';

function openFilterModal() {
    if (!filterModalInstance) {
        filterModalInstance = new bootstrap.Modal(document.getElementById('filterDateModal'));
    }

    document.getElementById('modalDateFrom').value = currentFilterFrom;
    document.getElementById('modalDateTo').value = currentFilterTo;

    filterModalInstance.show();
}

function applyFilter() {
    currentFilterFrom = document.getElementById('modalDateFrom').value;
    currentFilterTo = document.getElementById('modalDateTo').value;

    filterModalInstance.hide();

    const indicator = document.getElementById('filterIndicator');
    if (currentFilterFrom || currentFilterTo) {
        indicator.style.display = 'inline-flex';

        let filterText = '';
        if (currentFilterFrom && currentFilterTo) {
            filterText = `${formatDate(currentFilterFrom)} - ${formatDate(currentFilterTo)}`;
        } else if (currentFilterFrom) {
            filterText = `T·ª´ ${formatDate(currentFilterFrom)}`;
        } else if (currentFilterTo) {
            filterText = `ƒê·∫øn ${formatDate(currentFilterTo)}`;
        }
        indicator.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${filterText}`;
    } else {
        indicator.style.display = 'none';
    }

    loadPerformance();
}

function resetFilter() {
    currentFilterFrom = '';
    currentFilterTo = '';
    document.getElementById('modalDateFrom').value = '';
    document.getElementById('modalDateTo').value = '';

    document.getElementById('filterIndicator').style.display = 'none';

    filterModalInstance.hide();

    loadPerformance();
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `${day}/${month}`;
}

// ========================================
// EVENT LISTENERS
// ========================================
document.getElementById('moduleMenuBtn')?.addEventListener('click', function() {
    const activeModule = document.querySelector('.module-container.active');
    if (activeModule) {
        const moduleName = activeModule.id.replace('module-', '');
        toggleSidebar(moduleName);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth <= 992) {
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                closeSidebarOnMobile();
            });
        });
    }
});

window.addEventListener('resize', updateModuleMenuButton);

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const activeModule = document.querySelector('.module-container.active');
        if (activeModule) {
            backToHub();
        }
    }
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('üì¥ Tab hidden - connections remain open');
    } else {
        console.log('üì≥ Tab visible - checking connections');
        if (window.sseManager) {
            for (const [name, conn] of window.sseManager.connections) {
                if (conn.eventSource.readyState === EventSource.CLOSED) {
                    console.log(`üîÑ Reconnecting ${name}`);
                    window.sseManager.connect(name, conn.url, conn.callbacks, conn.fallbackConfig);
                }
            }
        }
    }
});

window.addEventListener('beforeunload', function() {
    console.log('üö™ Page unloading - disconnecting all SSE');
    if (window.sseManager) {
        window.sseManager.disconnectAll();
    }
    stopSmartPerformancePolling();
});

window.addEventListener('pagehide', function() {
    console.log('üö™ Page hiding - disconnecting all SSE');
    if (window.sseManager) {
        window.sseManager.disconnectAll();
    }
});

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    autoCenterIcons();
    updateModuleMenuButton();
    startRealtimeUpdates();

    // ‚úÖ CH·ªà load performance khi v√†o module tasks
    // Kh√¥ng load ngay khi v√†o hub
    // S·∫Ω ƒë∆∞·ª£c g·ªçi trong showModule('tasks')

    console.log('üìä Bandwidth estimate for 50 users:');
    console.log('- SSE (dashboard-stats): ~6.5GB/month');
    console.log('- SSE (notifications): ~2GB/month');
    console.log('- Polling (performance): ~2GB/month');
    console.log('- Total: ~10.5GB/month');
    console.log('‚úÖ Optimized with smart polling!');
});
</script>
{% endblock %}