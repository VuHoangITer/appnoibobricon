{% extends "base.html" %}

{% block title %}Quy Trình Công Việc - NO THING{% endblock %}

{% block page_title %}Quy Trình Công Việc{% endblock %}

{% block extra_css %}
<style>
body {
    background: #e0e0e0;
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

nav.top-navbar {
    background: transparent !important;
}

/* ============================================
   MAIN HUB LAYOUT
   ============================================ */
.hub-main-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 30px 20px;
}

/* ============================================
   4 ICON GRID - CENTER
   ============================================ */
.hub-icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 20px;
    max-width: 600px;
    margin: 0 auto;
    padding: 30px 20px;
}

.hub-icon-card {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px 10px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px);
    border: 1.5px solid rgba(255, 255, 255, 0.25);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
}

.hub-icon-card:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    border-color: rgba(255, 255, 255, 0.4);
}

.hub-icon-card:active {
    transform: translateY(-1px) scale(0.98);
}

.hub-icon-wrapper {
    width: 60px;
    height: 60px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.25s ease;
}

.hub-icon-card:hover .hub-icon-wrapper {
    transform: scale(1.08);
    box-shadow: 0 5px 16px rgba(0, 0, 0, 0.2);
}

.hub-icon-wrapper i {
    font-size: 1.8rem;
    color: white;
}

.hub-icon-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: dark;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    line-height: 1.2;
}

.hub-icon-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #dc3545;
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    border: 2px solid white;
}
/* ============================================
   MODULE PAGE - SIDEBAR + CONTENT
   ============================================ */
.module-container {
    display: none; /* Hidden by default */
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
}

.module-container.active {
    display: flex;
}

.module-sidebar {
    width: 280px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    margin-right: 20px;
    position: sticky;
    top: 80px;
    height: fit-content;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

/* Sidebar Overlay - Mobile */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    backdrop-filter: blur(4px);
}

.sidebar-overlay.active {
    display: block;
}

/* Mobile Sidebar Drawer */
@media (max-width: 992px) {
    .module-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        margin: 0;
        z-index: 1050;
        transition: left 0.3s ease;
        max-height: 100vh;
        border-radius: 0 16px 16px 0;
    }

    .module-sidebar.active {
        left: 0;
    }
    .module-content {
        width: 100%;
    }
}

.module-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.module-sidebar-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
}

.module-sidebar-title i {
    font-size: 1.5rem;
}

.back-to-hub-btn {
    background: transparent;
    border: none;
    color: #6c757d;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.back-to-hub-btn:hover {
    color: #0d6efd;
    transform: scale(1.1);
}

.sidebar-menu {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.sidebar-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
    text-decoration: none;
    color: #495057;
}

.sidebar-menu-item:hover {
    background: white;
    border-color: #0d6efd;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
    color: #0d6efd;
}

.sidebar-menu-item i {
    font-size: 1.2rem;
    flex-shrink: 0;
}

.sidebar-menu-item span {
    font-size: 0.95rem;
    font-weight: 600;
}

.sidebar-menu-item .badge {
    margin-left: auto;
}

.module-content {
    flex: 1;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

/* ============================================
   STATS & NOTIFICATIONS (REUSE FROM OLD)
   ============================================ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-radius: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid;
    transition: all 0.3s ease;
    text-decoration: none;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: white;
}

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: #2c3e50;
}

.stat-content p {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0;
}

/* Stat Card Colors */
.stat-pending { border-left-color: #ffc107; }
.stat-pending .stat-icon { color: #ffc107; }
.stat-progress { border-left-color: #0dcaf0; }
.stat-progress .stat-icon { color: #0dcaf0; }
.stat-overdue { border-left-color: #dc3545; }
.stat-overdue .stat-icon { color: #dc3545; }
.stat-done { border-left-color: #198754; }
.stat-done .stat-icon { color: #198754; }
.stat-info { border-left-color: #0dcaf0; }
.stat-info .stat-icon { color: #0dcaf0; }
.stat-warning { border-left-color: #ffc107; }
.stat-warning .stat-icon { color: #ffc107; }
.stat-danger { border-left-color: #dc3545; }
.stat-danger .stat-icon { color: #dc3545; }
.stat-primary { border-left-color: #0d6efd; }
.stat-primary .stat-icon { color: #0d6efd; }

/* Notification Box */
.notification-box {
    display: flex;
    align-items: flex-start;
    gap: 20px;
    padding: 20px 25px;
    border-radius: 16px;
    border-left: 5px solid;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    margin-bottom: 30px;
}

.notification-icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 10px 0;
}

.notification-message {
    font-size: 1rem;
    line-height: 1.6;
    margin: 0 0 15px 0;
}

.notification-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    padding: 5px 12px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    backdrop-filter: blur(5px);
}

/* Notification Types */
.notification-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    border-left-color: #dc3545;
    color: white;
}

.notification-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border-left-color: #ffc107;
    color: white;
}

.notification-success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    border-left-color: #198754;
    color: white;
}

.notification-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border-left-color: #0dcaf0;
    color: white;
}

.notification-secondary {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-left-color: #6c757d;
    color: #2c3e50;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1200px) {
    .module-sidebar {
        width: 240px;
    }
}

@media (max-width: 992px) {
    .module-container {
        flex-direction: column;
    }

    .module-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        margin: 0;
        z-index: 1050;
        transition: left 0.3s ease;
        max-height: 100vh;
        border-radius: 0 16px 16px 0;
    }

    .module-sidebar.active {
        left: 0;
    }

    .floating-menu-btn {
        display: flex;
    }

    .module-content {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .hub-main-container {
        padding: 20px 10px;
    }

    .hub-icon-grid {
        gap: 15px;
        padding: 20px 10px;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    }

    .hub-icon-card {
        padding: 12px 8px;
        gap: 6px;
    }

    .hub-icon-wrapper {
        width: 55px;
        height: 55px;
    }

    .hub-icon-wrapper i {
        font-size: 1.6rem;
    }

    .hub-icon-label {
        font-size: 0.8rem;
    }

    .module-content {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .hub-icon-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 100%;
    }

    .hub-icon-wrapper {
        width: 50px;
        height: 50px;
    }

    .hub-icon-wrapper i {
        font-size: 1.5rem;
    }

    .hub-icon-label {
        font-size: 0.75rem;
    }
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.module-container.active {
    animation: fadeIn 0.4s ease;
}
a:not(.btn):not(.nav-link):not(.sidebar-brand){
    text-decoration: none;
    color: #000000;
}
.notification-btn {
    color: #ffffff;
}
#iframeDirectLink {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<div class="hub-main-container">
    <!-- ============================================
         MAIN HUB - 4 ICONS
         ============================================ -->
    <div id="main-hub" class="hub-icon-grid">
        <!-- Icon 1: Công Việc -->
        <div class="hub-icon-card" onclick="showModule('tasks')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-briefcase-fill"></i>
            </div>
            <span class="hub-icon-label">Công Việc</span>
            <span class="hub-icon-badge" id="work-badge" {% if not (my_work_badge > 0 or tasks_badge > 0) %}style="display: none;"{% endif %}>
                {{ my_work_badge + tasks_badge }}
            </span>
        </div>

        <!-- Icon 2: Lương (chỉ Director/Accountant) -->
        {% if current_user.role in ['director', 'accountant'] %}
        <div class="hub-icon-card" onclick="showModule('salary')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="bi bi-cash-coin"></i>
            </div>
            <span class="hub-icon-label">Lương</span>
            <span class="hub-icon-badge" id="salary-badge" {% if not (pending_penalties > 0 or pending_advances > 0) %}style="display: none;"{% endif %}>
                {{ pending_penalties + pending_advances }}
            </span>
        </div>
        {% endif %}

        <!-- Icon 3: Thông Tin -->
        <div class="hub-icon-card" onclick="showModule('info')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="bi bi-megaphone-fill"></i>
            </div>
            <span class="hub-icon-label">Thông Tin</span>
            <span class="hub-icon-badge" id="info-badge" {% if not (unconfirmed_news > 0 or unread_notifications > 0) %}style="display: none;"{% endif %}>
                {{ unconfirmed_news + unread_notifications }}
            </span>
        </div>

        <!-- Icon 4: Tài Khoản -->
        {% if current_user.role == 'director' %}
        <div class="hub-icon-card" onclick="showModule('account')">
            <div class="hub-icon-wrapper" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="bi bi-person-circle"></i>
            </div>
            <span class="hub-icon-label">Tài Khoản</span>
        </div>
        {% endif %}
    </div>

    <!-- ============================================
         MODULE 1: CÔNG VIỆC
         ============================================ -->
    <div id="module-tasks" class="module-container">
        <!-- Sidebar Overlay - Mobile Only -->
        <div class="sidebar-overlay" onclick="toggleSidebar('tasks')"></div>

        <div class="module-sidebar" id="sidebar-tasks">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-briefcase-fill" style="color: #667eea;"></i>
                    <span>Công Việc</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('tasks.dashboard') }}', 'Thống Kê')">
                    <i class="bi bi-speedometer2" style="color: #667eea;"></i>
                    <span>Thống Kê</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('tasks.kanban') }}', 'Tóm Tắt CV')">
                    <i class="bi bi-kanban" style="color: #f093fb;"></i>
                    <span>Tóm Tắt CV</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('workflow.workflow_diagram') }}', 'Luồng Giao Việc')">
                    <i class="bi bi-diagram-3-fill" style="color: #4facfe;"></i>
                    <span>Luồng Giao Việc</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('tasks.create_task') }}', 'Tạo Công Việc')">
                    <i class="bi bi-plus-circle-fill" style="color: #004989;"></i>
                    <span>Tạo Công Việc</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('tasks.list_tasks') }}', 'Danh Sách CV')">
                    <i class="bi bi-list-task" style="color: #43e97b;"></i>
                    <span>Danh Sách CV</span>
                </a>
                {% if current_user.role in ['director', 'manager'] %}
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('performance.performance_review') }}', 'Hiệu Suất NV')">
                    <i class="bi bi-graph-up-arrow" style="color: #30cfd0;"></i>
                    <span>Hiệu Suất NV</span>
                </a>
                <a href="#" class="sidebar-menu-item"
                   data-badge-id="my_tasks_need_rating"
                   onclick="openInModal('{{ url_for('performance.unrated_tasks') }}', 'CV Chưa Đánh Giá')">
                    <i class="bi bi-star-fill" style="color: #ffd700;"></i>
                    <span>CV Chưa Đánh Giá</span>
                    {% if my_tasks_need_rating > 0 %}
                    <span class="badge bg-danger">{{ my_tasks_need_rating }}</span>
                    {% endif %}
                </a>
                {% endif %}
            </div>
        </div>

        <div class="module-content">
            <!-- STATS CÁ NHÂN -->
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-person-circle"></i> Công Việc Cá Nhân
            </h5>
            <div class="stats-grid">
                <div class="stat-card stat-pending" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#myPendingModal">
                    <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                    <div class="stat-content">
                        <h3>{{ my_pending_tasks }}</h3>
                        <p>Chưa Làm</p>
                    </div>
                </div>

                <div class="stat-card stat-progress" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#myInProgressModal">
                    <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
                    <div class="stat-content">
                        <h3>{{ my_in_progress }}</h3>
                        <p>Đang Làm</p>
                    </div>
                </div>

                <div class="stat-card stat-warning" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#myDueSoonModal">
                    <div class="stat-icon"><i class="bi bi-alarm"></i></div>
                    <div class="stat-content">
                        <h3>{{ my_due_soon }}</h3>
                        <p>Sắp Đến Hạn</p>
                    </div>
                </div>

                <div class="stat-card stat-overdue" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#myOverdueModal">
                    <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <h3>{{ my_overdue }}</h3>
                        <p>Quá Hạn</p>
                    </div>
                </div>

                <div class="stat-card stat-done" style="cursor: pointer;" onclick="openInModal('{{ url_for('hub.my_completed_tasks') }}', 'Đã Hoàn Thành')">
                    <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                    <div class="stat-content">
                        <h3>{{ my_completed_recent }}</h3>
                        <p>Đã Hoàn Thành</p>
                    </div>
                </div>
            </div>
            <!-- THÔNG BÁO CÁ NHÂN -->
            {% if personal_notification %}
            <div class="notification-box notification-{{ personal_notification.type }}">
                <div class="notification-icon">
                    <i class="{{ personal_notification.icon }}"></i>
                </div>
                <div class="notification-content">
                    <h4 class="notification-title">{{ personal_notification.title }}</h4>
                    <p class="notification-message">{{ personal_notification.message|safe }}</p>
                    <div class="notification-stats">
                        {% if personal_notification.stats.completion_rate is defined %}
                        <span class="stat-item">
                            <i class="bi bi-check-circle"></i> Hoàn thành:
                            <strong>{{ "%.0f"|format(personal_notification.stats.completion_rate) }}%</strong>
                        </span>
                        {% endif %}
                        {% if personal_notification.stats.quality_rate is defined %}
                        <span class="stat-item">
                            <i class="bi bi-star"></i> Chất lượng:
                            <strong>{{ "%.0f"|format(personal_notification.stats.quality_rate) }}%</strong>
                        </span>
                        {% endif %}
                        {% if personal_notification.stats.overdue is defined and personal_notification.stats.overdue > 0 %}
                        <span class="stat-item">
                            <i class="bi bi-exclamation-triangle"></i> Quá hạn:
                            <strong class="text-danger">{{ personal_notification.stats.overdue }}</strong>
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- QUẢN LÝ (Director/Manager) -->
            {% if current_user.role in ['director', 'manager'] %}
            <hr style="margin: 40px 0; border-color: rgba(0,0,0,0.1);">

            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-building"></i> Quản Lý Công Việc
            </h5>
            <div class="stats-grid">
                <div class="stat-card stat-info" style="cursor: pointer;" onclick="openInModal('{{ url_for('tasks.tasks_by_status', status='ALL') }}', 'Tổng Công Việc')">
                    <div class="stat-icon"><i class="bi bi-list-check"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_tasks }}</h3>
                        <p>Tổng Công Việc</p>
                    </div>
                </div>

                <div class="stat-card stat-warning" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#teamPendingModal">
                    <div class="stat-icon"><i class="bi bi-hourglass-top"></i></div>
                    <div class="stat-content">
                        <h3>{{ team_pending }}</h3>
                        <p>Chưa Làm (Team)</p>
                    </div>
                </div>

                <div class="stat-card stat-danger" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#teamOverdueModal">
                    <div class="stat-icon"><i class="bi bi-exclamation-octagon"></i></div>
                    <div class="stat-content">
                        <h3>{{ team_overdue }}</h3>
                        <p>Quá Hạn (Team)</p>
                    </div>
                </div>

                <div class="stat-card stat-primary" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#needRatingModal">
                    <div class="stat-icon"><i class="bi bi-star"></i></div>
                    <div class="stat-content">
                        <h3>{{ tasks_need_rating }}</h3>
                        <p>Cần Đánh Giá</p>
                    </div>
                </div>
            </div>

            <!-- THÔNG BÁO CÔNG TY -->
            {% if current_user.role == 'director' and company_notification %}
            <div class="notification-box notification-{{ company_notification.type }}">
                <div class="notification-icon">
                    <i class="{{ company_notification.icon }}"></i>
                </div>
                <div class="notification-content">
                    <h4 class="notification-title">{{ company_notification.title }}</h4>
                    <p class="notification-message">{{ company_notification.message|safe }}</p>
                    <div class="notification-stats">
                        {% if company_notification.stats.completion_rate is defined %}
                        <span class="stat-item">
                            <i class="bi bi-check-circle"></i> Hoàn thành:
                            <strong>{{ "%.0f"|format(company_notification.stats.completion_rate) }}%</strong>
                        </span>
                        {% endif %}
                        {% if company_notification.stats.on_time_rate is defined %}
                        <span class="stat-item">
                            <i class="bi bi-alarm"></i> Đúng hạn:
                            <strong>{{ "%.0f"|format(company_notification.stats.on_time_rate) }}%</strong>
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- ============================================
         MODULE 2: LƯƠNG
         ============================================ -->
    {% if current_user.role in ['director', 'accountant'] %}
    <div id="module-salary" class="module-container">
        <!-- Sidebar Overlay - Mobile Only -->
        <div class="sidebar-overlay" onclick="toggleSidebar('salary')"></div>

        <div class="module-sidebar" id="sidebar-salary">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-cash-coin" style="color: #f093fb;"></i>
                    <span>Lương</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('salaries.list_salaries') }}', 'Quản Lý Lương')">
                    <i class="bi bi-wallet2" style="color: #a8edea;"></i>
                    <span>Quản Lý Lương</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('employees.list_employees') }}', 'Nhân Viên')">
                    <i class="bi bi-people-fill" style="color: #ffecd2;"></i>
                    <span>Nhân Viên</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('work_days.list_configs') }}', 'Số Công/Tháng')">
                    <i class="bi bi-calendar-week" style="color: #ff9a9e;"></i>
                    <span>Số Công/Tháng</span>
                </a>
                {% if current_user.role == 'director' %}
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('salary_grades.list_grades') }}', 'Cấp Bậc Lương')">
                    <i class="bi bi-award-fill" style="color: #ffd89b;"></i>
                    <span>Cấp Bậc Lương</span>
                </a>
                {% endif %}
                <a href="#" class="sidebar-menu-item"
                   data-badge-id="penalties"
                   onclick="openInModal('{{ url_for('penalties.list_penalties') }}', 'Biên Bản Phạt')">
                    <i class="bi bi-exclamation-triangle-fill" style="color: #f43b47;"></i>
                    <span>Biên Bản Phạt</span>
                    {% if pending_penalties > 0 %}
                    <span class="badge bg-danger">{{ pending_penalties }}</span>
                    {% endif %}
                </a>
                <a href="#" class="sidebar-menu-item"
                   data-badge-id="advances"
                   onclick="openInModal('{{ url_for('advances.list_advances') }}', 'Tạm Ứng')">
                    <i class="bi bi-cash-stack" style="color: #ffc3a0;"></i>
                    <span>Tạm Ứng</span>
                    {% if pending_advances > 0 %}
                    <span class="badge bg-warning">{{ pending_advances }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-cash-coin"></i> Quản Lý Lương & Tài Chính
            </h5>

            <div class="stats-grid">
                <div class="stat-card stat-info">
                    <div class="stat-icon"><i class="bi bi-wallet2"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_salaries }}</h3>
                        <p>Bảng Lương</p>
                    </div>
                </div>

                <div class="stat-card stat-primary">
                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_employees }}</h3>
                        <p>Nhân Viên</p>
                    </div>
                </div>

                <div class="stat-card stat-danger">
                    <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_penalties }}</h3>
                        <p>Phạt Chưa Trừ</p>
                    </div>
                </div>

                <div class="stat-card stat-warning">
                    <div class="stat-icon"><i class="bi bi-cash-stack"></i></div>
                    <div class="stat-content">
                        <h3>{{ pending_advances }}</h3>
                        <p>Tạm Ứng Chưa Trừ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ============================================
         MODULE 3: THÔNG TIN
         ============================================ -->
    <div id="module-info" class="module-container">
        <!-- Sidebar Overlay - Mobile Only -->
        <div class="sidebar-overlay" onclick="toggleSidebar('info')"></div>

        <div class="module-sidebar" id="sidebar-info">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-megaphone-fill" style="color: #4facfe;"></i>
                    <span>Thông Tin</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="#" class="sidebar-menu-item"
                   data-badge-id="unconfirmed_news"
                   onclick="openInModal('{{ url_for('news.list_news') }}', 'Thông Báo Nội Bộ')">
                    <i class="bi bi-newspaper" style="color: #09203f;"></i>
                    <span>Thông Báo NB</span>
                    {% if unconfirmed_news > 0 %}
                    <span class="badge bg-danger">{{ unconfirmed_news }}</span>
                    {% endif %}
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('files.list_files') }}', 'Thư Viện File')">
                    <i class="bi bi-folder2-open" style="color: #ebbba7;"></i>
                    <span>Thư Viện File</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('notes.list_notes') }}', 'Ghi Chú')">
                    <i class="bi bi-journal-text" style="color: #c471f5;"></i>
                    <span>Ghi Chú</span>
                </a>
                <a href="#" class="sidebar-menu-item"
                   data-badge-id="unread_notifications"
                   onclick="openInModal('{{ url_for('notifications.list_notifications') }}', 'Nhắc Nhở')">
                    <i class="bi bi-bell" style="color: #f83600;"></i>
                    <span>Nhắc Nhở</span>
                    {% if unread_notifications > 0 %}
                    <span class="badge bg-danger">{{ unread_notifications }}</span>
                    {% endif %}
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-megaphone-fill"></i> Thông Tin & Tài Liệu
            </h5>

            <div class="stats-grid">
                <div class="stat-card stat-info" style="cursor: pointer;" onclick="openInModal('{{ url_for('news.list_news') }}', 'Thông Báo NB')">
                    <div class="stat-icon"><i class="bi bi-newspaper"></i></div>
                    <div class="stat-content">
                        <h3>{{ unconfirmed_news }}</h3>
                        <p>TB Chưa Xác Nhận</p>
                    </div>
                </div>

                <div class="stat-card stat-warning" style="cursor: pointer;" onclick="openInModal('{{ url_for('notifications.list_notifications') }}', 'Nhắc Nhở')">
                    <div class="stat-icon"><i class="bi bi-bell"></i></div>
                    <div class="stat-content">
                        <h3>{{ unread_notifications }}</h3>
                        <p>Nhắc Nhở Chưa Đọc</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODULE 4: TÀI KHOẢN
         ============================================ -->
    {% if current_user.role == 'director' %}
    <div id="module-account" class="module-container">
        <!-- Sidebar Overlay - Mobile Only -->
        <div class="sidebar-overlay" onclick="toggleSidebar('account')"></div>

        <div class="module-sidebar" id="sidebar-account">
            <div class="module-sidebar-header">
                <div class="module-sidebar-title">
                    <i class="bi bi-person-circle" style="color: #fa709a;"></i>
                    <span>Tài Khoản</span>
                </div>
                <button class="back-to-hub-btn" onclick="backToHub()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('auth.users') }}', 'Quản Lý Tài Khoản')">
                    <i class="bi bi-people" style="color: #89f7fe;"></i>
                    <span>Quản Lý TK</span>
                </a>
                <a href="#" class="sidebar-menu-item" onclick="openInModal('{{ url_for('auth.register') }}', 'Tạo Tài Khoản')">
                    <i class="bi bi-person-plus-fill" style="color: #fddb92;"></i>
                    <span>Tạo Tài Khoản</span>
                </a>
            </div>
        </div>

        <div class="module-content">
            <h5 style="margin-bottom: 20px; color: #2c3e50; font-weight: 700;">
                <i class="bi bi-person-circle"></i> Quản Trị Tài Khoản
            </h5>

            <div class="stats-grid">
                <div class="stat-card stat-primary" style="cursor: pointer;" onclick="openInModal('{{ url_for('auth.users') }}', 'Quản Lý Tài Khoản')">
                    <div class="stat-icon"><i class="bi bi-people"></i></div>
                    <div class="stat-content">
                        <h3>{{ total_users }}</h3>
                        <p>Tổng Tài Khoản</p>
                    </div>
                </div>

                <div class="stat-card stat-done" style="cursor: pointer;" onclick="openInModal('{{ url_for('auth.users') }}', 'Tài Khoản Hoạt Động')">
                    <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                    <div class="stat-content">
                        <h3>{{ active_users }}</h3>
                        <p>Đang Hoạt Động</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- ============================================
     MODALS
     ============================================ -->

<!-- Modal: Công Việc CHƯA LÀM -->
<div class="modal fade" id="myPendingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                <h5 class="modal-title text-white">
                    <i class="bi bi-clock-history"></i> Công Việc Chưa Làm - <span>{{ my_pending_tasks }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="myPendingTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('hub.my_pending_tasks') }}" class="btn btn-warning">
                    <i class="bi bi-list-task"></i> Xem tất cả
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Công Việc ĐANG LÀM -->
<div class="modal fade" id="myInProgressModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);">
                <h5 class="modal-title text-white">
                    <i class="bi bi-hourglass-split"></i> Công Việc Đang Làm - <span>{{ my_in_progress }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="myInProgressTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('hub.my_in_progress_tasks') }}" class="btn btn-info text-white">
                    <i class="bi bi-list-task"></i> Xem tất cả
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Công Việc Sắp Đến Hạn -->
<div class="modal fade" id="myDueSoonModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-alarm"></i> Công Việc Sắp Đến Hạn (3 ngày tới) - <span>{{ my_due_soon }}</span>
                </h5>
                <button type="button" class="btn-close d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="myDueSoonTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Công Việc Quá Hạn Của Tôi -->
<div class="modal fade" id="myOverdueModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Công Việc Quá Hạn Của Tôi - <span>{{ my_overdue }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="myOverdueTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.role in ['director', 'manager'] %}
<!-- Modal: Công Việc CHƯA LÀM TEAM -->
<div class="modal fade" id="teamPendingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                <h5 class="modal-title text-white">
                    <i class="bi bi-hourglass-top"></i> Công Việc Chưa Làm (Team) - <span>{{ team_pending }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="teamPendingTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('tasks.tasks_by_status', status='PENDING') }}" class="btn btn-warning">
                    <i class="bi bi-list-task"></i> Xem tất cả
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Quá Hạn Team -->
<div class="modal fade" id="teamOverdueModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-octagon"></i> Công Việc Quá Hạn (Team) - <span>{{ team_overdue }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="overdueTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cần Đánh Giá -->
<div class="modal fade" id="needRatingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-star"></i> Công Việc Cần Đánh Giá - <span>{{ tasks_need_rating }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="unratedTasksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-3">Đang tải...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('performance.unrated_tasks') }}" class="btn btn-primary">
                     Đến trang đánh giá
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Universal Iframe -->
<div class="modal fade" id="iframeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="iframeModalTitle">
                    <i class="bi bi-window"></i> <span id="iframeModalTitleText">Đang tải...</span>
                </h5>
                <div class="d-flex gap-2 align-items-center">
                    <a href="#" id="iframeDirectLink" class="btn btn-light btn-sm rounded-circle" target="_blank" title="Mở trang mới">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    <button type="button" class="btn-close btn-close-white d-md-none" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body p-0" style="height: calc(100vh - 60px);">
                <iframe
                    id="contentIframe"
                    style="width: 100%; height: 100%; border: none;"
                    src=""
                ></iframe>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ========================================
// MODULE NAVIGATION
// ========================================
function showModule(moduleName) {
    // Hide main hub
    document.getElementById('main-hub').style.display = 'none';

    // Hide all modules
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    // Show selected module
    const module = document.getElementById('module-' + moduleName);
    if (module) {
        module.classList.add('active');
    }
}

function backToHub() {
    // Close sidebar if open on mobile
    closeSidebarOnMobile();

    // Hide all modules
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    // Show main hub
    document.getElementById('main-hub').style.display = 'grid';
}

// ========================================
// MOBILE SIDEBAR TOGGLE
// ========================================
function toggleSidebar(moduleName) {
    const sidebar = document.getElementById('sidebar-' + moduleName);
    const overlay = sidebar.nextElementSibling.previousElementSibling; // Get overlay

    if (sidebar) {
        sidebar.classList.toggle('active');
        // Find overlay in the same module
        const module = document.getElementById('module-' + moduleName);
        const overlay = module.querySelector('.sidebar-overlay');
        if (overlay) {
            overlay.classList.toggle('active');
        }
    }
}

function closeSidebarOnMobile() {
    // Close all sidebars
    document.querySelectorAll('.module-sidebar').forEach(s => {
        s.classList.remove('active');
    });
    // Close all overlays
    document.querySelectorAll('.sidebar-overlay').forEach(o => {
        o.classList.remove('active');
    });
}

// Close sidebar when clicking on menu item (mobile only)
document.addEventListener('DOMContentLoaded', function() {
    if (window.innerWidth <= 992) {
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                closeSidebarOnMobile();
            });
        });
    }
});

// ========================================
// IFRAME MODAL HANDLER
// ========================================
function openInModal(url, title) {
    const modal = new bootstrap.Modal(document.getElementById('iframeModal'));
    const iframe = document.getElementById('contentIframe');
    const titleText = document.getElementById('iframeModalTitleText');
    const directLink = document.getElementById('iframeDirectLink');

    // Thêm tham số modal=1 vào URL cho iframe
    const separator = url.includes('?') ? '&' : '?';
    const modalUrl = url + separator + 'modal=1';

    // Set title và URL
    titleText.textContent = title;
    iframe.src = modalUrl;

    // Set URL gốc cho nút "Mở trang mới" (không có modal=1)
    directLink.href = url;

    // Show modal
    modal.show();

    // Clear iframe khi đóng modal
    document.getElementById('iframeModal').addEventListener('hidden.bs.modal', function () {
        iframe.src = '';
        directLink.href = '#';
    }, { once: true });
}

// ========================================
// MODAL DATA LOADING (REUSE FROM OLD CODE)
// ========================================

// 1. Sắp đến hạn
document.getElementById('myDueSoonModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('myDueSoonTasksList');
    fetch('{{ url_for("hub.get_my_due_soon_tasks") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:35%;">Công Việc</th><th style="width:18%;">Hạn hoàn thành</th><th style="width:12%;">Còn Lại</th><th style="width:12%;">Trạng Thái</th><th style="width:18%;">Phân Loại</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    const statusBadge = task.status === 'PENDING' ? '<span class="badge bg-warning">Chưa Làm</span>' : '<span class="badge bg-info">Đang Làm</span>';
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';
                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong><br><small class="text-muted">Người giao: ${task.creator}</small></td>`;
                    html += `<td><span class="badge bg-warning">${task.due_date}</span></td>`;
                    html += `<td><span class="badge bg-primary">${task.time_left}</span></td>`;
                    html += `<td>${statusBadge}</td>`;
                    html += `<td>${priorityBadges}</td></tr>`;
                });
                html += '</tbody></table></div></div>';

                // MOBILE: Card layout
                html += '<div class="d-md-none">';
                data.tasks.forEach((task, index) => {
                    const statusBadge = task.status === 'PENDING' ? '<span class="badge bg-warning">Chưa Làm</span>' : '<span class="badge bg-info">Đang Làm</span>';
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `
                        <div class="card mb-3 shadow-sm" onclick="window.location.href='/tasks/${task.id}'" style="cursor:pointer;">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-2">
                                    <span class="badge bg-primary me-2" style="font-size:0.9rem;">${index + 1}</span>
                                    <h6 class="mb-0 flex-grow-1">${task.title}</h6>
                                </div>
                                <hr class="my-2">
                                <div class="small">
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-person-check"></i> Người giao:</span>
                                        <span class="text-dark">${task.creator}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-calendar-event"></i> Hạn chót:</span>
                                        <span class="badge bg-warning">${task.due_date}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-hourglass-split"></i> Còn lại:</span>
                                        <span class="badge bg-primary">${task.time_left}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-flag"></i> Trạng thái:</span>
                                        ${statusBadge}
                                    </div>
                                    <div class="d-flex">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-star"></i> Phân Loại:</span>
                                        <div>${priorityBadges}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Tuyệt vời!</h5><p class="text-muted">Bạn không có công việc nào sắp đến hạn trong 3 ngày tới</p></div>';
            }
        })
        .catch(err => {
            console.error('Error loading due soon tasks:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách. Vui lòng thử lại sau.</div>';
        });
});

// 2. Quá hạn của tôi
document.getElementById('myOverdueModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('myOverdueTasksList');
    fetch('{{ url_for("hub.get_my_overdue_tasks") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:40%;">Công Việc</th><th style="width:25%;">Hạn hoàn thành</th><th style="width:15%;">Trạng Thái</th><th style="width:15%;">Phân Loại</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    const statusBadge = task.status === 'PENDING' ? '<span class="badge bg-warning">Chưa Làm</span>' : '<span class="badge bg-info">Đang Làm</span>';
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';
                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong><br><small class="text-muted">Người giao: ${task.creator}</small></td>`;
                    html += `<td><span class="badge bg-danger">${task.due_date}</span></td>`;
                    html += `<td>${statusBadge}</td>`;
                    html += `<td>${priorityBadges}</td></tr>`;
                });
                html += '</tbody></table></div></div>';

                // MOBILE
                html += '<div class="d-md-none">';
                data.tasks.forEach((task, index) => {
                    const statusBadge = task.status === 'PENDING' ? '<span class="badge bg-warning">Chưa Làm</span>' : '<span class="badge bg-info">Đang Làm</span>';
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `
                        <div class="card mb-3 shadow-sm border-danger" onclick="window.location.href='/tasks/${task.id}'" style="cursor:pointer;">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-2">
                                    <span class="badge bg-danger me-2" style="font-size:0.9rem;">${index + 1}</span>
                                    <h6 class="mb-0 flex-grow-1">${task.title}</h6>
                                </div>
                                <hr class="my-2">
                                <div class="small">
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-person-check"></i> Người giao:</span>
                                        <span class="text-dark">${task.creator}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-calendar-event"></i> Hạn chót:</span>
                                        <span class="badge bg-danger">${task.due_date}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-flag"></i> Trạng thái:</span>
                                        ${statusBadge}
                                    </div>
                                    <div class="d-flex">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-star"></i> Phân Loại:</span>
                                        <div>${priorityBadges}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Tuyệt vời!</h5><p class="text-muted">Bạn không có công việc nào quá hạn</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// 3. Chưa làm
document.getElementById('myPendingModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('myPendingTasksList');
    fetch('{{ url_for("hub.get_my_pending_tasks_detail") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:40%;">Công Việc</th><th style="width:20%;">Hạn hoàn thành</th><th style="width:20%;">Ngày tạo</th><th style="width:15%;">Phân Loại</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong><br><small class="text-muted">Người giao: ${task.creator}</small></td>`;
                    html += `<td><span class="badge bg-primary">${task.due_date}</span></td>`;
                    html += `<td><small class="text-muted">${task.created_at}</small></td>`;
                    html += `<td>${priorityBadges}</td></tr>`;
                });
                html += '</tbody></table></div></div>';

                // MOBILE
                html += '<div class="d-md-none">';
                data.tasks.forEach((task, index) => {
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `
                        <div class="card mb-3 shadow-sm border-warning" onclick="window.location.href='/tasks/${task.id}'" style="cursor:pointer;">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-2">
                                    <span class="badge bg-warning me-2" style="font-size:0.9rem;">${index + 1}</span>
                                    <h6 class="mb-0 flex-grow-1">${task.title}</h6>
                                </div>
                                <hr class="my-2">
                                <div class="small">
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-person-check"></i> Người giao:</span>
                                        <span class="text-dark">${task.creator}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-calendar-event"></i> Hạn chót:</span>
                                        <span class="badge bg-primary">${task.due_date}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-clock"></i> Ngày tạo:</span>
                                        <span class="text-muted">${task.created_at}</span>
                                    </div>
                                    <div class="d-flex">
                                        <span class="text-muted" style="min-width:100px;"><i class="bi bi-star"></i> Phân Loại:</span>
                                        <div>${priorityBadges}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Tuyệt vời!</h5><p class="text-muted">Bạn không có công việc nào chưa làm</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// 4. Đang làm
document.getElementById('myInProgressModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('myInProgressTasksList');
    fetch('{{ url_for("hub.get_my_inprogress_tasks_detail") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:40%;">Công Việc</th><th style="width:20%;">Hạn hoàn thành</th><th style="width:20%;">Cập nhật gần nhất</th><th style="width:15%;">Phân Loại</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong><br><small class="text-muted">Người giao: ${task.creator}</small></td>`;
                    html += `<td><span class="badge bg-primary">${task.due_date}</span></td>`;
                    html += `<td><small class="text-muted">${task.updated_at}</small></td>`;
                    html += `<td>${priorityBadges}</td></tr>`;
                });
                html += '</tbody></table></div></div>';

                // MOBILE
                html += '<div class="d-md-none">';
                data.tasks.forEach((task, index) => {
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';

                    html += `
                        <div class="card mb-3 shadow-sm border-info" onclick="window.location.href='/tasks/${task.id}'" style="cursor:pointer;">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-2">
                                    <span class="badge bg-info me-2" style="font-size:0.9rem;">${index + 1}</span>
                                    <h6 class="mb-0 flex-grow-1">${task.title}</h6>
                                </div>
                                <hr class="my-2">
                                <div class="small">
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:110px;"><i class="bi bi-person-check"></i> Người giao:</span>
                                        <span class="text-dark">${task.creator}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:110px;"><i class="bi bi-calendar-event"></i> Hạn chót:</span>
                                        <span class="badge bg-primary">${task.due_date}</span>
                                    </div>
                                    <div class="d-flex mb-2">
                                        <span class="text-muted" style="min-width:110px;"><i class="bi bi-clock-history"></i> Cập nhật:</span>
                                        <span class="text-muted">${task.updated_at}</span>
                                    </div>
                                    <div class="d-flex">
                                        <span class="text-muted" style="min-width:110px;"><i class="bi bi-star"></i> Phân Loại:</span>
                                        <div>${priorityBadges}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-inbox text-muted" style="font-size:4rem;"></i><h5 class="mt-3 text-muted">Chưa có công việc nào</h5><p class="text-muted">Bạn chưa bắt đầu làm công việc nào</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// 5. Team pending
document.getElementById('teamPendingModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('teamPendingTasksList');
    fetch('{{ url_for("hub.get_team_pending_tasks") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:30%;">Công Việc</th><th style="width:15%;">Hạn hoàn thành</th><th style="width:12%;">Ngày tạo</th><th style="width:15%;">Người Làm</th><th style="width:13%;">Người Giao</th><th style="width:10%;">Phân Loại</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Thường</span>';

                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong></td>`;
                    html += `<td><span class="badge bg-primary">${task.due_date}</span></td>`;
                    html += `<td><small class="text-muted">${task.created_at}</small></td>`;
                    html += `<td><span class="text-info">${task.assignees}</span></td>`;
                    html += `<td><small class="text-muted">${task.creator}</small></td>`;
                    html += `<td>${priorityBadges}</td></tr>`;
                });
                html += '</tbody></table></div></div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Tuyệt vời!</h5><p class="text-muted">Không có công việc nào chưa làm trong hệ thống</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// 6. Team overdue
document.getElementById('teamOverdueModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('overdueTasksList');
    fetch('{{ url_for("hub.get_overdue_tasks") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:35%;">Công Việc</th><th style="width:15%;">Hạn hoàn thành</th><th style="width:15%;">Trạng Thái</th><th style="width:15%;">Phân Loại</th><th style="width:15%;">Người Làm</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    const statusBadge = task.status === 'PENDING' ? '<span class="badge bg-warning">Chưa Làm</span>' : '<span class="badge bg-info">Đang Làm</span>';
                    let priorityBadges = '';
                    if (task.is_urgent) priorityBadges += '<span class="badge bg-danger me-1">Khẩn cấp</span>';
                    if (task.is_important) priorityBadges += '<span class="badge bg-warning me-1">Quan trọng</span>';
                    if (task.is_recurring) priorityBadges += '<span class="badge bg-info me-1">Lặp lại</span>';
                    if (!priorityBadges) priorityBadges = '<span class="badge bg-secondary">Bình thường</span>';
                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong><br><small class="text-muted">Người giao: ${task.creator}</small></td>`;
                    html += `<td><span class="badge bg-danger">${task.due_date}</span></td>`;
                    html += `<td>${statusBadge}</td>`;
                    html += `<td>${priorityBadges}</td>`;
                    html += `<td>${task.assignees}</td></tr>`;
                });
                html += '</tbody></table></div></div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Tuyệt vời!</h5><p class="text-muted">Không có công việc nào quá hạn</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// 7. Need rating
document.getElementById('needRatingModal')?.addEventListener('show.bs.modal', function () {
    const listContainer = document.getElementById('unratedTasksList');
    fetch('{{ url_for("hub.get_unrated_tasks") }}')
        .then(res => res.json())
        .then(data => {
            if (data.tasks && data.tasks.length > 0) {
                let html = '';
                html += '<div class="d-none d-md-block">';
                html += '<div class="table-responsive"><table class="table table-hover align-middle">';
                html += '<thead class="table-light"><tr><th style="width:5%;">ID</th><th style="width:35%;">Công Việc</th><th style="width:15%;">Hoàn Thành</th><th style="width:20%;">Người Giao</th><th style="width:25%;">Người Thực Hiện</th></tr></thead><tbody>';
                data.tasks.forEach((task, index) => {
                    html += `<tr style="cursor:pointer;" onclick="window.location.href='/tasks/${task.id}'">`;
                    html += `<td class="text-center">${index + 1}</td>`;
                    html += `<td><strong>${task.title}</strong></td>`;
                    html += `<td><span class="badge bg-success">${task.completed_at}</span></td>`;
                    html += `<td><span class="text-primary"><i class="bi bi-person-check"></i> ${task.creator}</span></td>`;
                    html += `<td>${task.assignees}</td></tr>`;
                });
                html += '</tbody></table></div></div>';
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = '<div class="text-center py-5"><i class="bi bi-check-circle text-success" style="font-size:4rem;"></i><h5 class="mt-3 text-success">Hoàn Thành!</h5><p class="text-muted">Tất cả công việc đã được đánh giá</p></div>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            listContainer.innerHTML = '<div class="alert alert-danger">Không thể tải danh sách</div>';
        });
});

// ========================================
// MODULE MENU BUTTON TOGGLE
// ========================================
function updateModuleMenuButton() {
    const menuBtn = document.getElementById('moduleMenuBtn');
    const isInModule = document.querySelector('.module-container.active');

    if (menuBtn) {
        if (isInModule && window.innerWidth <= 992) {
            menuBtn.style.display = 'block';
        } else {
            menuBtn.style.display = 'none';
        }
    }
}

// Gắn sự kiện click cho nút menu
document.getElementById('moduleMenuBtn')?.addEventListener('click', function() {
    // Tìm module đang active
    const activeModule = document.querySelector('.module-container.active');
    if (activeModule) {
        const moduleName = activeModule.id.replace('module-', '');
        toggleSidebar(moduleName);
    }
});

// Cập nhật khi show/hide module
function showModule(moduleName) {
    document.getElementById('main-hub').style.display = 'none';
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    const module = document.getElementById('module-' + moduleName);
    if (module) {
        module.classList.add('active');
    }

    // Cập nhật nút menu
    updateModuleMenuButton();
}

function backToHub() {
    closeSidebarOnMobile();
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });
    document.getElementById('main-hub').style.display = 'grid';

    // Ẩn nút menu
    updateModuleMenuButton();
}

// Cập nhật khi resize
window.addEventListener('resize', updateModuleMenuButton);

// Khởi tạo
document.addEventListener('DOMContentLoaded', function() {
    updateModuleMenuButton();
});

// Nhấn ESC để về Hub
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const activeModule = document.querySelector('.module-container.active');
        if (activeModule) {
            backToHub();
        }
    }
});

// ========================================
// CLICK BACKDROP ĐỂ VỀ HUB (DESKTOP)
// ========================================
let backdropClickEnabled = false;

function enableBackdropClick() {
    if (backdropClickEnabled) return;
    backdropClickEnabled = true;

    document.addEventListener('click', handleBackdropClick);
}

function disableBackdropClick() {
    backdropClickEnabled = false;
    document.removeEventListener('click', handleBackdropClick);
}

function handleBackdropClick(e) {
    if (window.innerWidth > 992) {
        const activeModule = document.querySelector('.module-container.active');
        if (!activeModule) {
            disableBackdropClick();
            return;
        }

        const moduleContent = activeModule.querySelector('.module-content');
        const moduleSidebar = activeModule.querySelector('.module-sidebar');

        // Bỏ qua các vùng không cần check
        if (e.target.closest('.hub-icon-card')) return;
        if (e.target.closest('.top-navbar')) return;

        // ✅ BỎ QUA NẾU CÓ MODAL ĐANG MỞ
        if (e.target.closest('.modal')) return;
        if (e.target.classList.contains('modal')) return;
        if (document.querySelector('.modal.show')) return;

        // ✅ BỎ QUA NẾU CLICK VÀO MODAL BACKDROP
        if (e.target.classList.contains('modal-backdrop')) return;

        // Click ngoài content và sidebar → Về Hub
        if (!moduleContent.contains(e.target) && !moduleSidebar.contains(e.target)) {
            backToHub();
        }
    }
}

// Sửa lại hàm showModule
function showModule(moduleName) {
    document.getElementById('main-hub').style.display = 'none';
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });

    const module = document.getElementById('module-' + moduleName);
    if (module) {
        module.classList.add('active');
    }

    updateModuleMenuButton();

    // BẬT backdrop click SAU KHI module hiện
    setTimeout(() => {
        enableBackdropClick();
    }, 100);
}

// Sửa lại hàm backToHub
function backToHub() {
    closeSidebarOnMobile();
    document.querySelectorAll('.module-container').forEach(m => {
        m.classList.remove('active');
    });
    document.getElementById('main-hub').style.display = 'grid';

    updateModuleMenuButton();

    // TẮT backdrop click khi về Hub
    disableBackdropClick();
}

// ========================================
// REAL-TIME UPDATES: SSE + FALLBACK POLLING
// ========================================
let sseStatsConnected = false;

function startRealtimeUpdates() {
    console.log('🚀 Starting real-time stats updates...');

    // Update initial data
    updateRealtimeData();

    // Kiểm tra SSE support
    if (typeof window.sseManager === 'undefined') {
        console.warn('⚠️ SSE Manager not loaded, using polling');
        startPollingFallback();
        return;
    }

    // Kết nối SSE cho dashboard stats
    window.sseManager.connect(
        'dashboard-stats',
        '/sse/dashboard-stats',
        {
            onOpen: () => {
                console.log('✅ SSE Dashboard Stats connected');
                sseStatsConnected = true;
            },
            onError: (error, attempts) => {
                console.error('❌ SSE Stats error:', error, 'attempts:', attempts);
                sseStatsConnected = false;
            },
            events: {
                'stats_update': (data) => {
                    console.log('📊 SSE stats update:', data);
                    updateUIWithStats(data);
                },
                'heartbeat': (data) => {
                    console.log('💓 SSE stats heartbeat');
                },
                'error': (data) => {
                    console.error('❌ SSE stats error event:', data);
                },
                'close': (data) => {
                    console.log('🔌 SSE stats closed by server');
                }
            }
        },
        {
            // Fallback polling config
            url: '/hub/api/realtime-stats',
            interval: 30000, // 30 seconds
            onData: (data) => {
                console.log('📊 Polling stats:', data);
                updateUIWithStats(data);
            }
        }
    );
}

function startPollingFallback() {
    console.log('🔄 Starting polling fallback for stats (30s interval)');
    setInterval(updateRealtimeData, 30000);
}

function stopRealtimeUpdates() {
    if (window.sseManager) {
        window.sseManager.disconnect('dashboard-stats');
    }
}

// GIỮ NGUYÊN hàm updateRealtimeData() (dùng cho fallback)
function updateRealtimeData() {
    fetch('/hub/api/realtime-stats')
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            console.log('📊 Real-time update:', data);
            updateUIWithStats(data);
        })
        .catch(err => {
            console.error('❌ Real-time update error:', err);
        });
}

//  Function update UI (tách riêng để dùng chung cho SSE và Polling)
function updateUIWithStats(data) {
    // 1. Cập nhật Notification badge (navbar) - GỌI HÀM CÓ SẴN
    if (typeof updateNotifCount === 'function') {
        updateNotifCount();
    }

    // 2. Cập nhật Work Badge (Công Việc)
    const workBadge = document.getElementById('work-badge');
    if (workBadge) {
        const myWorkBadge = (data.my_overdue || 0) + (data.my_due_soon || 0);
        const tasksBadge = (data.my_tasks_need_rating || 0);
        const totalWorkBadge = myWorkBadge + tasksBadge;

        if (totalWorkBadge > 0) {
            workBadge.textContent = totalWorkBadge;
            workBadge.style.display = 'inline-block';
        } else {
            workBadge.style.display = 'none';
        }
    }

    // 3. Cập nhật Info Badge (Thông Tin)
    const infoBadge = document.getElementById('info-badge');
    if (infoBadge) {
        if (data.info_badge > 0) {
            infoBadge.textContent = data.info_badge;
            infoBadge.style.display = 'inline-block';
        } else {
            infoBadge.style.display = 'none';
        }
    }

    // 4. Cập nhật Salary Badge (Lương) - nếu có
    const salaryBadge = document.getElementById('salary-badge');
    if (salaryBadge && data.salary_badge !== undefined) {
        if (data.salary_badge > 0) {
            salaryBadge.textContent = data.salary_badge;
            salaryBadge.style.display = 'inline-block';
        } else {
            salaryBadge.style.display = 'none';
        }
    }

    // 5. Cập nhật số trong module Công Việc nếu đang mở
    updateTaskModuleStats(data);

    // 6. Cập nhật số trong module Thông Tin nếu đang mở
    updateInfoModuleStats(data);

    // 7. Cập nhật số trong module Lương nếu đang mở
    updateSalaryModuleStats(data);

    // 8. Show warning nếu có quá hạn
    if (data.my_overdue > 0) {
        console.warn(`⚠️ Bạn có ${data.my_overdue} công việc quá hạn!`);
    }
}

function updateTaskModuleStats(data) {
    const tasksModule = document.getElementById('module-tasks');
    if (tasksModule) {  //
        // Card Quá Hạn
        const overdueCard = tasksModule.querySelector('.stat-overdue h3');
        if (overdueCard) overdueCard.textContent = data.my_overdue;

        // Card Sắp Đến Hạn
        const dueSoonCard = tasksModule.querySelector('.stat-warning h3');
        if (dueSoonCard) dueSoonCard.textContent = data.my_due_soon;

        // Card Chưa Làm
        const pendingCard = tasksModule.querySelector('.stat-pending h3');
        if (pendingCard) pendingCard.textContent = data.my_pending_tasks;

        // Card Đang Làm
        const progressCard = tasksModule.querySelector('.stat-progress h3');
        if (progressCard) progressCard.textContent = data.my_in_progress;

        // Stats cho Manager/Director
        if (data.team_overdue !== undefined) {
            // Card Team Overdue
            const teamOverdueCard = tasksModule.querySelectorAll('.stat-danger h3')[0];
            if (teamOverdueCard) teamOverdueCard.textContent = data.team_overdue;

            // Card Team Pending
            const teamPendingCard = tasksModule.querySelectorAll('.stat-warning h3')[1];
            if (teamPendingCard) teamPendingCard.textContent = data.team_pending;

            // Card Need Rating
            const ratingCard = tasksModule.querySelector('.stat-primary h3');
            if (ratingCard) ratingCard.textContent = data.tasks_need_rating;

            //  Cập nhật badge trong sidebar
            updateSidebarBadge(tasksModule, 'my_tasks_need_rating', data.my_tasks_need_rating);
        }
    }
}

function updateInfoModuleStats(data) {
    const infoModule = document.getElementById('module-info');
    if (infoModule) {  // ← XÓA check .classList.contains('active')

        // Card TB Chưa Xác Nhận
        const unconfirmedCard = infoModule.querySelector('.stat-info h3');
        if (unconfirmedCard) unconfirmedCard.textContent = data.unconfirmed_news;

        // Card Nhắc Nhở Chưa Đọc
        const unreadCard = infoModule.querySelector('.stat-warning h3');
        if (unreadCard) unreadCard.textContent = data.unread_notifications;

        // Cập nhật badge trong sidebar
        updateSidebarBadge(infoModule, 'unconfirmed_news', data.unconfirmed_news);
        updateSidebarBadge(infoModule, 'unread_notifications', data.unread_notifications);
    }
}

function updateSalaryModuleStats(data) {
    const salaryModule = document.getElementById('module-salary');
    if (salaryModule) {
        // Card Phạt Chưa Trừ
        const penaltyCard = salaryModule.querySelector('.stat-danger h3');
        if (penaltyCard) penaltyCard.textContent = data.pending_penalties;

        // Card Tạm Ứng Chưa Trừ
        const advanceCard = salaryModule.querySelector('.stat-warning h3');
        if (advanceCard) advanceCard.textContent = data.pending_advances;

        // Cập nhật badge trong sidebar
        updateSidebarBadge(salaryModule, 'penalties', data.pending_penalties);
        updateSidebarBadge(salaryModule, 'advances', data.pending_advances);
    }
}

// Khởi động khi trang load
document.addEventListener('DOMContentLoaded', function() {
    startRealtimeUpdates();
});

// Dừng khi rời trang
window.addEventListener('beforeunload', function() {
    stopRealtimeUpdates();
});

// Cleanup SSE khi rời trang
window.addEventListener('beforeunload', function() {
    stopRealtimeUpdates();
});

// ============================================================
// HELPER: CẬP NHẬT BADGE TRONG SIDEBAR
// ============================================================
function updateSidebarBadge(module, badgeType, count) {
    // Tìm sidebar trong module
    const sidebar = module.querySelector('.module-sidebar');
    if (!sidebar) {
        console.warn('[Badge] Sidebar not found for module:', module.id);
        return;
    }

    // ✅ TÌM LINK DỰA VÀO data-badge-id (dễ hơn và chính xác hơn)
    const targetLink = sidebar.querySelector(`a[data-badge-id="${badgeType}"]`);

    if (!targetLink) {
        console.warn(`[Badge] Link not found for badge type: ${badgeType}`);
        return;
    }

    // Tìm badge hiện tại
    let badge = targetLink.querySelector('.badge');

    if (count > 0) {
        // Nếu có count: tạo hoặc cập nhật badge
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge bg-danger';
            targetLink.appendChild(badge);
            console.log(`[Badge] Created badge for ${badgeType}: ${count}`);
        } else {
            console.log(`[Badge] Updated badge for ${badgeType}: ${count}`);
        }
        badge.textContent = count;
        badge.style.display = 'inline-block';
    } else {
        // Nếu count = 0: xóa badge
        if (badge) {
            badge.remove();
            console.log(`[Badge] Removed badge for ${badgeType}`);
        }
    }
}

// Pause polling khi tab không active (tiết kiệm resources)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopRealtimeUpdates();
    } else {
        startRealtimeUpdates();
    }
});

// ========================================
// AUTO CENTER ICONS
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    const iconGrid = document.getElementById('main-hub');
    const iconCount = iconGrid.querySelectorAll('.hub-icon-card').length;

    // Điều chỉnh grid-template-columns và max-width dựa trên số icon
    if (iconCount === 2) {
        iconGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        iconGrid.style.maxWidth = '550px';
    } else if (iconCount === 3) {
        iconGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
        iconGrid.style.maxWidth = '750px';
    } else if (iconCount === 1) {
        iconGrid.style.gridTemplateColumns = '1fr';
        iconGrid.style.maxWidth = '250px';
    }
    // 4 icons: giữ nguyên default
});
</script>
{% endblock %}