{% extends "base.html" %}

{% block title %}Hi·ªáu ·ª®ng Theo M√πa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/seasonal-effects.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block content %}
<script>
    window.IS_SEASONAL_SETTINGS_PAGE = true;
</script>

<div class="seasonal-settings-container">
    <h2 style="margin-bottom: 30px; color: #2c3e50; font-weight: 700;">
        <i class="bi bi-palette-fill"></i> Qu·∫£n L√Ω Hi·ªáu ·ª®ng Theo M√πa
    </h2>

    <!-- ========== SNOWFALL ========== -->
    <div class="effect-card" id="card-snowfall">
        <div class="effect-header">
            <div class="effect-title">
                <i class="bi bi-snow" style="color: #4fc3f7;"></i>
                <span>Tuy·∫øt R∆°i</span>
            </div>
            <label class="effect-toggle">
                <input type="checkbox" id="toggle-snowfall" onchange="toggleEffect('snowfall')">
                <span class="effect-toggle-slider"></span>
            </label>
        </div>

        <div class="effect-controls">
            <div class="control-group">
                <label class="control-label">
                    Th·ªùi gian (gi√¢y): <span class="slider-value" id="value-snowfall-duration">0</span>
                    <small style="color: #6c757d; display: block; margin-top: 4px;">0 = Kh√¥ng gi·ªõi h·∫°n</small>
                </label>
                <input type="range" class="control-slider" id="slider-snowfall-duration"
                       min="0" max="300" value="0" step="10"
                       oninput="updateSliderValue('snowfall', 'duration', this.value)">
            </div>

            <div class="control-group">
                <label class="control-label">
                    M·∫≠t ƒë·ªô: <span class="slider-value" id="value-snowfall-intensity">50</span>
                </label>
                <input type="range" class="control-slider" id="slider-snowfall-intensity"
                       min="10" max="100" value="50"
                       oninput="updateSliderValue('snowfall', 'intensity', this.value)">
            </div>

            <div class="control-group">
                <label class="control-label">T·ªëc ƒë·ªô</label>
                <select class="control-input" id="select-snowfall-speed" onchange="updateSelectValue('snowfall', 'speed', this.value)">
                    <option value="slow">Ch·∫≠m</option>
                    <option value="medium" selected>Trung b√¨nh</option>
                    <option value="fast">Nhanh</option>
                </select>
            </div>

            <!-- PAGES SELECTOR - SNOWFALL -->
            <div class="control-group">
                <label class="control-label">Hi·ªÉn th·ªã tr√™n trang</label>
                <div class="pages-selector" id="pages-snowfall">
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="all" onchange="updatePageSelection('snowfall')">
                        <span>T·∫•t c·∫£ trang</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="hub" onchange="updatePageSelection('snowfall')">
                        <span>Trang Ch·ªß</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="tasks" onchange="updatePageSelection('snowfall')">
                        <span>Nhi·ªám V·ª•</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="news" onchange="updatePageSelection('snowfall')">
                        <span>Tin T·ª©c</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="files" onchange="updatePageSelection('snowfall')">
                        <span>T·ªáp Tin</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="notes" onchange="updatePageSelection('snowfall')">
                        <span>Ghi Ch√∫</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="salaries" onchange="updatePageSelection('snowfall')">
                        <span>L∆∞∆°ng</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="performance" onchange="updatePageSelection('snowfall')">
                        <span>Hi·ªáu Su·∫•t</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="employees" onchange="updatePageSelection('snowfall')">
                        <span>Nh√¢n Vi√™n</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SANTA ========== -->
    <div class="effect-card" id="card-santa">
        <div class="effect-header">
            <div class="effect-title">
                <span style="font-size: 2rem;">üéÖ</span>
                <span>√îng Gi√† Noel T·∫∑ng Qu√†</span>
            </div>
            <label class="effect-toggle">
                <input type="checkbox" id="toggle-santa" onchange="toggleEffect('santa')">
                <span class="effect-toggle-slider"></span>
            </label>
        </div>

        <div class="effect-controls">
            <div class="control-group">
                <label class="control-label">Tin nh·∫Øn</label>
                <input type="text" class="control-input" id="input-santa-message"
                       value="Ch√∫c M·ª´ng Gi√°ng Sinh! üéÑ"
                       placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa √¥ng gi√† Noel">
            </div>

            <div class="control-group">
                <label class="control-label">
                    Th·ªùi gian ch·ªù (gi√¢y): <span class="slider-value" id="value-santa-delay">1</span>
                    <small style="color: #6c757d; display: block; margin-top: 4px;">Delay tr∆∞·ªõc khi xu·∫•t hi·ªán</small>
                </label>
                <input type="range" class="control-slider" id="slider-santa-delay"
                       min="0" max="10" value="1" step="1"
                       oninput="updateSliderValue('santa', 'delay', this.value)">
            </div>

            <div class="control-group">
                <label class="control-label">
                    <input type="checkbox" id="checkbox-santa-sparkles" checked style="width: auto; margin-right: 8px;">
                    Hi·ªáu ·ª©ng l·∫•p l√°nh
                </label>
            </div>

            <!-- PAGES SELECTOR - SANTA -->
            <div class="control-group">
                <label class="control-label">Hi·ªÉn th·ªã tr√™n trang</label>
                <div class="pages-selector" id="pages-santa">
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="all" onchange="updatePageSelection('santa')">
                        <span>T·∫•t c·∫£ trang</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="hub" onchange="updatePageSelection('santa')">
                        <span>Trang Ch·ªß</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="tasks" onchange="updatePageSelection('santa')">
                        <span>Nhi·ªám V·ª•</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="news" onchange="updatePageSelection('santa')">
                        <span>Tin T·ª©c</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="files" onchange="updatePageSelection('santa')">
                        <span>T·ªáp Tin</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="notes" onchange="updatePageSelection('santa')">
                        <span>Ghi Ch√∫</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="salaries" onchange="updatePageSelection('santa')">
                        <span>L∆∞∆°ng</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="performance" onchange="updatePageSelection('santa')">
                        <span>Hi·ªáu Su·∫•t</span>
                    </label>
                    <label class="page-checkbox">
                        <input type="checkbox" class="page-check" value="employees" onchange="updatePageSelection('santa')">
                        <span>Nh√¢n Vi√™n</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="effect-actions">
            <button class="btn-effect btn-reset" onclick="resetSantaSession()" style="background: #ff9800; color: white;">
                <i class="bi bi-arrow-clockwise"></i> Reset Session
            </button>
        </div>
    </div>

    <!-- ========== GLOBAL ACTIONS ========== -->
    <div class="global-actions">
        <div class="current-effect-status">
            <i class="bi bi-info-circle"></i>
            Hi·ªáu ·ª©ng ƒëang b·∫≠t: <strong id="current-effect-name">Kh√¥ng c√≥</strong>
        </div>
        <button class="btn-stop-all" onclick="stopAllEffects()">
            <i class="bi bi-stop-circle"></i>
            T·∫Øt T·∫•t C·∫£ Hi·ªáu ·ª®ng
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/seasonal-effects.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/santa-effect.js') }}?v={{ config.VERSION }}"></script>

<script>
// ==========================================
// SETTINGS PAGE CONTROLLER - SNOW + SANTA ONLY
// ==========================================

const EFFECT_NAMES = ['snowfall', 'santa'];

let previewTimeout = null;

// Load current config when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        loadCurrentConfig();
    }, 1000);
});

function loadCurrentConfig() {
    if (!window.SeasonalEffects) {
        console.error('SeasonalEffects not loaded');
        return;
    }

    const config = SeasonalEffects.config;

    if (!config || !config.effects) {
        console.warn('‚ö†Ô∏è Config not ready yet, waiting...');
        setTimeout(loadCurrentConfig, 500);
        return;
    }

    // Update UI for each effect
    EFFECT_NAMES.forEach(effectName => {
        const effectConfig = config.effects[effectName];
        if (!effectConfig) return;

        // Update toggle
        const toggle = document.getElementById(`toggle-${effectName}`);
        if (toggle) {
            toggle.checked = effectConfig.active;
        }

        // Update card active state
        const card = document.getElementById(`card-${effectName}`);
        if (card && effectConfig.active) {
            card.classList.add('active');
        }

        // Update specific controls
        updateEffectControls(effectName, effectConfig);

        // Update pages checkboxes
        updatePagesCheckboxes(effectName, effectConfig.pages || ['all']);
    });

    updateCurrentEffectStatus();
}

function updateEffectControls(effectName, config) {
    if (effectName === 'snowfall') {
        updateControl('slider-snowfall-duration', config.duration || 0);
        updateControl('slider-snowfall-intensity', config.intensity || 50);
        updateControl('select-snowfall-speed', config.speed || 'medium');
    } else if (effectName === 'santa') {
        const messageInput = document.getElementById('input-santa-message');
        if (messageInput) {
            messageInput.value = config.message || 'Ch√∫c M·ª´ng Gi√°ng Sinh! üéÑ';
        }

        const delaySlider = document.getElementById('slider-santa-delay');
        const delayValue = document.getElementById('value-santa-delay');
        if (delaySlider && delayValue) {
            const delaySeconds = Math.floor((config.delay || 1000) / 1000);
            delaySlider.value = delaySeconds;
            delayValue.textContent = delaySeconds;
        }

        const sparklesCheckbox = document.getElementById('checkbox-santa-sparkles');
        if (sparklesCheckbox) {
            sparklesCheckbox.checked = config.sparkles !== false;
        }
    }
}

function updateControl(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.value = value;
        if (element.type === 'range') {
            const valueDisplay = document.getElementById('value-' + id.replace('slider-', ''));
            if (valueDisplay) {
                valueDisplay.textContent = value;
            }
        }
    }
}

// ==========================================
// PAGES SELECTOR FUNCTIONS
// ==========================================

function updatePagesCheckboxes(effectName, pages) {
    const pagesContainer = document.getElementById(`pages-${effectName}`);
    if (!pagesContainer) return;

    const checkboxes = pagesContainer.querySelectorAll('.page-check');
    checkboxes.forEach(checkbox => {
        checkbox.checked = pages.includes(checkbox.value);
    });
}

function updatePageSelection(effectName) {
    const pagesContainer = document.getElementById(`pages-${effectName}`);
    if (!pagesContainer) return;

    const checkboxes = pagesContainer.querySelectorAll('.page-check');
    let selectedPages = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

    // N·∫øu ch·ªçn "all", b·ªè ch·ªçn c√°c trang kh√°c
    if (selectedPages.includes('all')) {
        checkboxes.forEach(cb => {
            if (cb.value !== 'all') {
                cb.checked = false;
            }
        });
        selectedPages = ['all'];
    } else {
        const allCheckbox = pagesContainer.querySelector('[value="all"]');
        if (allCheckbox && selectedPages.length > 0) {
            allCheckbox.checked = false;
        }

        if (selectedPages.length === 0) {
            selectedPages = [];
        }
    }

    if (!window.SeasonalEffects.config.effects[effectName]) {
        window.SeasonalEffects.config.effects[effectName] = {};
    }
    window.SeasonalEffects.config.effects[effectName].pages = selectedPages.length > 0 ? selectedPages : ['all'];

    console.log(`üìç Pages updated for ${effectName}:`, selectedPages);
}

// ==========================================
// SLIDER & SELECT HANDLERS
// ==========================================

function updateSliderValue(effectName, param, value) {
    const valueDisplay = document.getElementById(`value-${effectName}-${param}`);
    if (valueDisplay) {
        valueDisplay.textContent = value;
    }
}

function updateSelectValue(effectName, param, value) {
    // Value updated automatically by select
}

async function toggleEffect(effectName) {
    const toggle = document.getElementById(`toggle-${effectName}`);
    const card = document.getElementById(`card-${effectName}`);

    if (!window.SeasonalEffects) {
        alert('‚ö†Ô∏è H·ªá th·ªëng hi·ªáu ·ª©ng ch∆∞a s·∫µn s√†ng!');
        toggle.checked = false;
        return;
    }

    if (toggle.checked) {
        card.classList.add('active');

        const config = getEffectConfigFromUI(effectName);
        SeasonalEffects.config.effects[effectName] = config;
        SeasonalEffects.startEffect(effectName, config);

        const saved = await SeasonalEffects.saveConfig();

        if (!saved) {
            alert('‚ö†Ô∏è C√≥ l·ªói khi l∆∞u, vui l√≤ng th·ª≠ l·∫°i!');
            toggle.checked = false;
            card.classList.remove('active');
            return;
        }

        updateCurrentEffectStatus();

        const pages = config.pages.join(', ');
        if (config.duration > 0) {
            console.log(`‚úÖ ${effectName} B·∫¨T - ${config.duration}s tr√™n: ${pages}`);
        } else {
            console.log(`‚úÖ ${effectName} B·∫¨T (v√¥ h·∫°n) tr√™n: ${pages}`);
        }

    } else {
        card.classList.remove('active');
        SeasonalEffects.stopEffect(effectName);
        await SeasonalEffects.saveConfig();
        updateCurrentEffectStatus();
        console.log(`üõë ${effectName} T·∫ÆT`);
    }
}

// ==========================================
// EFFECT ACTIONS
// ==========================================

async function stopAllEffects() {
    if (!window.SeasonalEffects) return;

    SeasonalEffects.stopAllEffects();
    await SeasonalEffects.saveConfig();
    updateCurrentEffectStatus();

    document.querySelectorAll('.effect-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelectorAll('[id^="toggle-"]').forEach(toggle => {
        toggle.checked = false;
    });

    alert('üõë ƒê√£ t·∫Øt t·∫•t c·∫£ hi·ªáu ·ª©ng!');
}

function getEffectConfigFromUI(effectName) {
    const config = { active: true };

    // Get duration
    const durationSlider = document.getElementById(`slider-${effectName}-duration`);
    if (durationSlider) {
        config.duration = parseInt(durationSlider.value);
    }

    // Get pages
    const pagesContainer = document.getElementById(`pages-${effectName}`);
    if (pagesContainer) {
        const checkboxes = pagesContainer.querySelectorAll('.page-check');
        const selectedPages = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        config.pages = selectedPages.length > 0 ? selectedPages : ['all'];
    } else {
        config.pages = ['all'];
    }

    // Effect-specific configs
    if (effectName === 'snowfall') {
        config.intensity = parseInt(document.getElementById('slider-snowfall-intensity').value);
        config.speed = document.getElementById('select-snowfall-speed').value;
    } else if (effectName === 'santa') {
        config.message = document.getElementById('input-santa-message').value || 'Ch√∫c M·ª´ng Gi√°ng Sinh! üéÑ';
        config.delay = parseInt(document.getElementById('slider-santa-delay').value) * 1000;
        config.sparkles = document.getElementById('checkbox-santa-sparkles').checked;
    }

    return config;
}

function updateCurrentEffectStatus() {
    const statusElement = document.getElementById('current-effect-name');
    if (!statusElement || !window.SeasonalEffects) return;

    const effectNames = {
        'snowfall': '‚ùÑÔ∏è Tuy·∫øt R∆°i',
        'santa': 'üéÖ √îng Gi√† Noel'
    };

    const config = SeasonalEffects.config;
    const activeEffects = [];

    EFFECT_NAMES.forEach(effectName => {
        if (config.effects[effectName] && config.effects[effectName].active) {
            activeEffects.push(effectNames[effectName]);
        }
    });

    if (activeEffects.length === 0) {
        statusElement.textContent = 'Kh√¥ng c√≥';
    } else {
        statusElement.textContent = activeEffects.join(', ');
    }
}

// ==========================================
// RESET SANTA SESSION
// ==========================================

function resetSantaSession() {
    sessionStorage.removeItem('santa_shown_today');
    alert('‚úÖ ƒê√£ x√≥a session! Santa s·∫Ω xu·∫•t hi·ªán l·∫°i khi reload trang (n·∫øu ƒë√£ b·∫≠t).');
    console.log('üóëÔ∏è Santa session cleared');
}
</script>
{% endblock %}