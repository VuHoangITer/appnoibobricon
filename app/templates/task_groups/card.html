<!-- Component: Task Group Card -->
<div class="task-group-card"
     data-group-id="{{ group.id }}"
     onclick="openGroupModal({{ group.id }})">

    <!-- Header với gradient riêng -->
    <div class="task-group-card-header">
        <div class="task-group-header-left">
            <i class="bi bi-list-check"></i>
            <span class="task-group-title">{{ group.title }}</span>
            <span class="task-group-badge">{{ group.items.count() }} mục</span>
        </div>

        <div class="task-group-header-right">
            <!-- View detail icon -->
            <a href="{{ url_for('task_groups.detail', group_id=group.id) }}"
               class="view-detail-icon"
               title="Xem chi tiết"
               onclick="event.stopPropagation();">
                <i class="bi bi-eye"></i>
            </a>
        </div>
    </div>

    <!-- Body -->
    <div class="task-group-card-body">

        <!-- Progress Bar -->
        <div class="task-group-progress-section">
            <div class="progress-bar-container">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"
                         style="width: {{ group.get_progress() }}%">
                    </div>
                </div>
                <div class="progress-text">
                    {{ group.get_progress() }}%
                </div>
            </div>

            <!-- Status counts -->
            {% set counts = group.get_status_counts() %}
            <div class="status-counts">
                <span class="status-count done">
                    <i class="bi bi-check-circle-fill"></i> {{ counts.done }}
                </span>
                <span class="status-count in-progress">
                    <i class="bi bi-hourglass-split"></i> {{ counts.in_progress }}
                </span>
                <span class="status-count pending">
                    <i class="bi bi-circle"></i> {{ counts.pending }}
                </span>
            </div>
        </div>

        <!-- Checklist Preview (4 items đầu) -->
        <div class="task-group-checklist-preview">
            {% for item in group.items.limit(4) %}
            <div class="checklist-item-preview {% if item.status == 'DONE' %}done{% endif %}">
                <i class="bi bi-{% if item.status == 'DONE' %}check-circle-fill{% elif item.status == 'IN_PROGRESS' %}hourglass-split{% else %}circle{% endif %}"></i>
                <span class="item-title">{{ item.title }}</span>

                {% if item.due_date %}
                <span class="item-deadline {% if item.due_date < now() and item.status != 'DONE' %}overdue{% endif %}">
                    {{ item.vn_due_date.strftime('%-d/%-m') if item.vn_due_date else '' }}
                </span>
                {% endif %}

                <!-- Unread badge -->
                {% if item.unread_count > 0 %}
                <span class="item-unread-badge">{{ item.unread_count }}</span>
                {% endif %}
            </div>
            {% endfor %}

            {% if group.items.count() > 4 %}
            <div class="checklist-item-more">
                <i class="bi bi-three-dots"></i>
                <span>và {{ group.items.count() - 4 }} mục khác</span>
            </div>
            {% endif %}
        </div>

        <!-- Footer: Avatar flow + Countdown -->
        <div class="task-group-footer">
            <div class="task-group-flow">
                <!-- Avatar người giao -->
                <div class="task-user">
                    <div class="task-user-avatar">
                        {% if group.creator.avatar %}
                            <img src="{{ url_for('profile.get_avatar', filename=group.creator.avatar) }}"
                                 alt="{{ group.creator.full_name }}">
                        {% else %}
                            {{ group.creator.full_name[0].upper() }}
                        {% endif %}
                    </div>
                </div>

                <div class="task-arrow">→</div>

                <!-- Avatar người làm -->
                <div class="task-user">
                    <div class="task-user-avatar">
                        {% if group.assignee.avatar %}
                            <img src="{{ url_for('profile.get_avatar', filename=group.assignee.avatar) }}"
                                 alt="{{ group.assignee.full_name }}">
                        {% else %}
                            {{ group.assignee.full_name[0].upper() }}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Countdown gần nhất -->
            {% set nearest_deadline = group.get_nearest_deadline() %}
            {% if nearest_deadline %}
            <div class="task-group-countdown"
                 data-due-date="{{ utc_to_vn(nearest_deadline).strftime('%Y-%m-%dT%H:%M:%S') }}+07:00">
                <div class="countdown-timer-small">
                    <i class="bi bi-clock"></i>
                    <span class="countdown-text">--:--:--</span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="task-group-actions">
            <button class="task-btn task-btn-discuss"
                    onclick="event.stopPropagation(); openGroupModal({{ group.id }})">
                <i class="bi bi-chat-dots"></i>
                <span>Trao đổi</span>
            </button>
        </div>
    </div>
</div>
